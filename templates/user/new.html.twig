{% extends 'base.html.twig' %}

{% block title %}Crear Nuevo Usuario{% endblock %}

{% block body %}
<div class="d-flex justify-content-between mb-4">
    <h1>Crear Nuevo Usuario</h1>
    <a href="{{ path('app_user_index') }}" class="btn btn-secondary">Volver a la Lista</a>
</div>

<div class="card">
    <div class="card-header" style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;">
        <h3 style="margin: 0; color: #333; font-size: 1.1rem; font-weight: 600;">
            ‚ûï Crear Nuevo Usuario
        </h3>
    </div>
    <div class="card-body">
        {{ form_start(form) }}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                {# Informaci√≥n B√°sica y Acceso #}
                <div>
                    <h4 style="color: var(--color-primary); margin-bottom: 1rem; border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem;">
                        üë§ Informaci√≥n B√°sica
                    </h4>
                    {{ form_row(form.nombre) }}
                    {{ form_row(form.username) }}
                    {{ form_row(form.email) }}
                    {{ form_row(form.telefono) }}
                    {{ form_row(form.dni) }}
                    {{ form_row(form.fechaNacimiento) }}
                    {{ form_row(form.sexo) }}
                </div>

                {# Acceso y Roles #}
                <div>
                    <h4 style="color: var(--color-primary); margin-bottom: 1rem; border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem;">
                        üîê Acceso y Roles
                    </h4>
                    <div class="form-group">
                        <label for="password_first" class="form-label">Contrase√±a</label>
                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            {{ form_widget(form.plainPassword.first, {'attr': {'class': 'form-control', 'id': 'password_first'}}) }}
                            <button type="button" id="generate-password-btn" class="btn btn-secondary" style="white-space: nowrap;" title="Generar contrase√±a aleatoria">
                                üé≤ Generar
                            </button>
                        </div>
                        <small class="form-text text-muted">La contrase√±a ser√° visible para que puedas copiarla y d√°rsela al alumno.</small>
                    </div>
                    {{ form_row(form.plainPassword.second, {'label': 'Repetir Contrase√±a'}) }}
                    {{ form_row(form.roles) }}
                    <div class="alert alert-info" style="margin-top: 1rem;">
                        <small>
                            <strong>üí° Nota:</strong> El usuario se crear√° como <strong>inactivo</strong> por defecto. 
                            Deber√°s activarlo manualmente desde la lista de usuarios.
                        </small>
                    </div>
                </div>

                {# Direcci√≥n #}
                <div>
                    <h4 style="color: var(--color-primary); margin-bottom: 1rem; border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem;">
                        üìç Direcci√≥n
                    </h4>
                    {{ form_row(form.direccion) }}
                    {{ form_row(form.codigoPostal) }}
                    {{ form_row(form.ciudad) }}
                    {{ form_row(form.provincia) }}
                </div>
            </div>

            {# Datos Bancarios y Notas #}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                <div>
                    <h4 style="color: var(--color-primary); margin-bottom: 1rem; border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem;">
                        üí≥ Datos Bancarios
                    </h4>
                    {{ form_row(form.iban) }}
                    {{ form_row(form.banco) }}
                </div>

                <div>
                    <h4 style="color: var(--color-primary); margin-bottom: 1rem; border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem;">
                        üìù Notas
                    </h4>
                    {{ form_row(form.notas) }}
                </div>
            </div>
            
            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary">Crear Usuario</button>
                <a href="{{ path('app_user_index') }}" class="btn btn-secondary">Cancelar</a>
            </div>
        {{ form_end(form) }}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-password-btn');
    // Buscar los campos de contrase√±a por ID o por nombre
    let passwordFirst = document.getElementById('password_first');
    let passwordSecond = document.getElementById('password_second');
    
    // Si no se encuentran por ID, buscar por nombre (Symfony puede generar IDs diferentes)
    if (!passwordFirst) {
        passwordFirst = document.querySelector('input[name*="[first]"]');
    }
    if (!passwordSecond) {
        passwordSecond = document.querySelector('input[name*="[second]"]');
    }
    
    if (generateBtn && passwordFirst && passwordSecond) {
        generateBtn.addEventListener('click', function() {
            // Generar contrase√±a aleatoria de 12 caracteres
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%&*';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            // Establecer la contrase√±a en ambos campos
            passwordFirst.value = password;
            passwordSecond.value = password;
            
            // Mostrar mensaje de √©xito
            const formGroup = generateBtn.closest('.form-group');
            if (formGroup) {
                // Eliminar alertas anteriores si existen
                const existingAlert = formGroup.querySelector('.alert-success');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.style.marginTop = '0.5rem';
                alert.innerHTML = '<strong>‚úì</strong> Contrase√±a generada. Recuerda copiarla para d√°rsela al alumno.';
                formGroup.appendChild(alert);
                
                // Eliminar el mensaje despu√©s de 5 segundos
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
        });
    }
});
</script>
{% endblock %}

