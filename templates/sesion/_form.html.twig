{{ form_start(form) }}
    <div class="card">
        <div class="card-body">
            {# Mostrar errores globales del formulario #}
            {% if form.vars.errors|length > 0 %}
                <div class="alert alert-danger">
                    <ul class="mb-0">
                        {% for error in form.vars.errors %}
                            <li>{{ error.message }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            
            {{ form_row(form.nombre) }}
            {{ form_row(form.descripcion) }}
            
            <div class="form-group mb-3">
                {{ form_label(form.tipoTema) }}
                {{ form_widget(form.tipoTema, {'attr': {'class': 'form-control', 'id': 'tipo_tema'}}) }}
                {{ form_help(form.tipoTema) }}
                {{ form_errors(form.tipoTema) }}
            </div>
            
            <div id="tema-general-group" style="display: {% if sesion is defined and sesion.id and sesion.temas|length > 0 %}block{% else %}none{% endif %};">
                <div class="form-group mb-3">
                    {{ form_label(form.temas) }}
                    {{ form_widget(form.temas, {'attr': {'class': 'form-control', 'size': '10', 'multiple': 'multiple'}}) }}
                    {{ form_errors(form.temas) }}
                    <small class="form-text text-muted">Puedes seleccionar múltiples temas. Mantén presionada la tecla Ctrl (o Cmd en Mac) para seleccionar varios.</small>
                </div>
            </div>
            
            <div id="tema-municipal-group" style="display: {% if sesion is defined and sesion.id and sesion.temasMunicipales|length > 0 %}block{% else %}none{% endif %};">
                <div class="form-group mb-3">
                    {{ form_label(form.convocatorias) }}
                    {{ form_widget(form.convocatorias, {'attr': {'class': 'form-control', 'size': '5', 'multiple': 'multiple'}}) }}
                    {{ form_errors(form.convocatorias) }}
                    <small class="form-text text-muted">Puedes seleccionar múltiples convocatorias.</small>
                </div>
                <div class="form-group mb-3">
                    {{ form_label(form.municipios) }}
                    {{ form_widget(form.municipios, {'attr': {'class': 'form-control', 'size': '5', 'multiple': 'multiple'}}) }}
                    {{ form_errors(form.municipios) }}
                    <small class="form-text text-muted">Puedes seleccionar múltiples municipios.</small>
                </div>
                <div class="form-group mb-3">
                    {{ form_label(form.temasMunicipales) }}
                    {{ form_widget(form.temasMunicipales, {'attr': {'class': 'form-control', 'size': '10', 'multiple': 'multiple'}}) }}
                    {{ form_errors(form.temasMunicipales) }}
                    <small class="form-text text-muted">Primero selecciona convocatorias, luego municipios, y finalmente los temas municipales. Puedes seleccionar múltiples temas.</small>
                </div>
            </div>
            
            {{ form_row(form.enlaceVideo) }}
        </div>
    </div>
    
    <div style="margin-top: 1rem;">
        <button type="submit" class="btn btn-primary">{{ button_label|default('Guardar') }}</button>
        <a href="{{ path('app_sesion_index') }}" class="btn btn-secondary">Cancelar</a>
    </div>
{{ form_end(form) }}

<script>
(function() {
    function initSesionForm() {
        // Buscar el selector de tipo de tema por ID explícito o por selector
        const tipoTemaSelect = document.getElementById('tipo_tema') || 
                               document.querySelector('select[name*="tipoTema"]');
        const temaGeneralGroup = document.getElementById('tema-general-group');
        const temaMunicipalGroup = document.getElementById('tema-municipal-group');
        const convocatoriasSelect = document.querySelector('select[name*="convocatorias"]');
        const municipiosSelect = document.querySelector('select[name*="municipios"]');
        const temasMunicipalesSelect = document.querySelector('select[name*="temasMunicipales"]');
        const temasGeneralesSelect = document.querySelector('select[name*="temas"]:not([name*="Municipales"])');
        
        // Verificar que los elementos críticos existen
        if (!tipoTemaSelect) {
            console.error('No se encontró el selector de tipo de tema');
            return false;
        }
        
        if (!temaGeneralGroup || !temaMunicipalGroup) {
            console.error('No se encontraron los grupos de tema');
            return false;
        }
        
        function updateFormVisibility() {
            if (!tipoTemaSelect || !temaGeneralGroup || !temaMunicipalGroup) return;
            
            const tipoTema = tipoTemaSelect.value || '';
            
            if (tipoTema === 'general') {
                temaGeneralGroup.style.display = 'block';
                temaMunicipalGroup.style.display = 'none';
                // Limpiar completamente selecciones de tema municipal
                if (convocatoriasSelect) {
                    Array.from(convocatoriasSelect.selectedOptions || []).forEach(option => {
                        option.selected = false;
                    });
                    convocatoriasSelect.dispatchEvent(new Event('change'));
                }
                if (municipiosSelect) {
                    municipiosSelect.innerHTML = '';
                    Array.from(municipiosSelect.selectedOptions || []).forEach(option => {
                        option.selected = false;
                    });
                }
                if (temasMunicipalesSelect) {
                    temasMunicipalesSelect.innerHTML = '';
                    Array.from(temasMunicipalesSelect.selectedOptions || []).forEach(option => {
                        option.selected = false;
                    });
                }
            } else if (tipoTema === 'municipal') {
                temaGeneralGroup.style.display = 'none';
                temaMunicipalGroup.style.display = 'block';
                // Limpiar completamente selección de tema general
                if (temasGeneralesSelect) {
                    Array.from(temasGeneralesSelect.selectedOptions || []).forEach(option => {
                        option.selected = false;
                    });
                }
            } else {
                temaGeneralGroup.style.display = 'none';
                temaMunicipalGroup.style.display = 'none';
                // Limpiar todo si no hay tipo seleccionado
                if (temasGeneralesSelect) {
                    Array.from(temasGeneralesSelect.selectedOptions || []).forEach(option => {
                        option.selected = false;
                    });
                }
                if (convocatoriasSelect) {
                    Array.from(convocatoriasSelect.selectedOptions || []).forEach(option => {
                        option.selected = false;
                    });
                }
                if (municipiosSelect) {
                    Array.from(municipiosSelect.selectedOptions || []).forEach(option => {
                        option.selected = false;
                    });
                }
                if (temasMunicipalesSelect) {
                    Array.from(temasMunicipalesSelect.selectedOptions || []).forEach(option => {
                        option.selected = false;
                    });
                }
            }
        }
        
        // Cargar municipios cuando se seleccionan convocatorias (AJAX)
        if (convocatoriasSelect) {
            convocatoriasSelect.addEventListener('change', function() {
                const convocatoriasIds = Array.from(this.selectedOptions).map(opt => opt.value).filter(v => v);
                if (convocatoriasIds.length > 0) {
                    // Limpiar municipios y temas municipales
                    if (municipiosSelect) {
                        municipiosSelect.innerHTML = '';
                        Array.from(municipiosSelect.selectedOptions || []).forEach(option => {
                            option.selected = false;
                        });
                    }
                    if (temasMunicipalesSelect) {
                        temasMunicipalesSelect.innerHTML = '';
                        Array.from(temasMunicipalesSelect.selectedOptions || []).forEach(option => {
                            option.selected = false;
                        });
                    }
                    
                    // Cargar municipios de todas las convocatorias seleccionadas vía AJAX
                    Promise.all(convocatoriasIds.map(id => 
                        fetch('{{ path('app_sesion_ajax_municipios', {'convocatoriaId': 0}) }}'.replace('0', id))
                            .then(response => response.json())
                            .then(data => data.municipios || [])
                    )).then(results => {
                        // Combinar y deduplicar municipios
                        const municipiosMap = new Map();
                        results.flat().forEach(municipio => {
                            if (!municipiosMap.has(municipio.id)) {
                                municipiosMap.set(municipio.id, municipio);
                            }
                        });
                        
                        // Llenar el select de municipios
                        if (municipiosSelect) {
                            municipiosSelect.innerHTML = '';
                            Array.from(municipiosMap.values()).forEach(municipio => {
                                const option = document.createElement('option');
                                option.value = municipio.id;
                                option.textContent = municipio.nombre;
                                municipiosSelect.appendChild(option);
                            });
                        }
                    }).catch(error => {
                        console.error('Error al cargar municipios:', error);
                    });
                } else {
                    // Si se deseleccionan todas las convocatorias, limpiar todo
                    if (municipiosSelect) {
                        municipiosSelect.innerHTML = '';
                        Array.from(municipiosSelect.selectedOptions || []).forEach(option => {
                            option.selected = false;
                        });
                    }
                    if (temasMunicipalesSelect) {
                        temasMunicipalesSelect.innerHTML = '';
                        Array.from(temasMunicipalesSelect.selectedOptions || []).forEach(option => {
                            option.selected = false;
                        });
                    }
                }
            });
        }
        
        // Cargar temas municipales cuando se seleccionan municipios (AJAX)
        if (municipiosSelect) {
            municipiosSelect.addEventListener('change', function() {
                const municipiosIds = Array.from(this.selectedOptions).map(opt => opt.value).filter(v => v);
                if (municipiosIds.length > 0) {
                    // Limpiar temas municipales seleccionados
                    if (temasMunicipalesSelect) {
                        Array.from(temasMunicipalesSelect.selectedOptions || []).forEach(option => {
                            option.selected = false;
                        });
                    }
                    
                    // Cargar temas municipales de todos los municipios seleccionados vía AJAX
                    Promise.all(municipiosIds.map(id => 
                        fetch('{{ path('app_sesion_ajax_temas_municipales', {'municipioId': 0}) }}'.replace('0', id))
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                console.error('Error:', data.error);
                                return;
                            }
                            
                            // Llenar el select de temas municipales
                            if (temasMunicipalesSelect && data.temasMunicipales) {
                                temasMunicipalesSelect.innerHTML = '';
                                if (data.temasMunicipales.length === 0) {
                                    const option = document.createElement('option');
                                    option.value = '';
                                    option.textContent = 'No hay temas municipales disponibles';
                                    temasMunicipalesSelect.appendChild(option);
                                } else {
                                    data.temasMunicipales.forEach(tema => {
                                        const option = document.createElement('option');
                                        option.value = tema.id;
                                        option.textContent = tema.nombre;
                                        temasMunicipalesSelect.appendChild(option);
                                    });
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error al cargar temas municipales:', error);
                        });
                } else {
                    // Si se deselecciona el municipio, limpiar temas municipales
                    if (temasMunicipalesSelect) {
                        temasMunicipalesSelect.innerHTML = '<option value="">Primero selecciona un municipio</option>';
                        Array.from(temasMunicipalesSelect.selectedOptions || []).forEach(option => {
                            option.selected = false;
                        });
                    }
                }
            });
        }
        
        if (tipoTemaSelect) {
            tipoTemaSelect.addEventListener('change', updateFormVisibility);
        }
        
        // Inicializar visibilidad al cargar la página
        // Esperar un momento para asegurar que el DOM esté completamente cargado
        setTimeout(function() {
            updateFormVisibility();
            
            // Si estamos editando, establecer el tipo de tema según los datos existentes
            {% if sesion is defined and sesion.id %}
                // Primero verificar si el campo tipoTema ya tiene un valor (del servidor)
                let tipoTemaValue = tipoTemaSelect ? tipoTemaSelect.value : '';
                
                // Si no tiene valor, determinar según los datos
                if (!tipoTemaValue) {
                    {% if sesion.temas|length > 0 %}
                        tipoTemaValue = 'general';
                    {% elseif sesion.temasMunicipales|length > 0 %}
                        tipoTemaValue = 'municipal';
                    {% endif %}
                }
                
                // Establecer el valor y actualizar visibilidad
                if (tipoTemaSelect && tipoTemaValue) {
                    tipoTemaSelect.value = tipoTemaValue;
                    updateFormVisibility();
                    
                    // Si es municipal, cargar los datos de convocatorias y municipios
                    {% if sesion.temasMunicipales|length > 0 %}
                        {% if sesion.convocatorias|length > 0 %}
                            if (convocatoriasSelect) {
                                // Seleccionar múltiples convocatorias
                                {% for convocatoria in sesion.convocatorias %}
                                    const optionConv{{ convocatoria.id }} = Array.from(convocatoriasSelect.options).find(opt => opt.value == '{{ convocatoria.id }}');
                                    if (optionConv{{ convocatoria.id }}) {
                                        optionConv{{ convocatoria.id }}.selected = true;
                                    }
                                {% endfor %}
                                // Disparar evento para cargar municipios
                                setTimeout(function() {
                                    if (convocatoriasSelect) {
                                        convocatoriasSelect.dispatchEvent(new Event('change'));
                                        
                                        // Después de cargar municipios, seleccionar los municipios de la sesión
                                        setTimeout(function() {
                                            if (municipiosSelect) {
                                                {% if sesion.municipios|length > 0 %}
                                                    {% for municipio in sesion.municipios %}
                                                        const optionMun{{ municipio.id }} = Array.from(municipiosSelect.options).find(opt => opt.value == '{{ municipio.id }}');
                                                        if (optionMun{{ municipio.id }}) {
                                                            optionMun{{ municipio.id }}.selected = true;
                                                        }
                                                    {% endfor %}
                                                    // Disparar evento para cargar temas municipales
                                                    setTimeout(function() {
                                                        if (municipiosSelect) {
                                                            municipiosSelect.dispatchEvent(new Event('change'));
                                                        }
                                                    }, 300);
                                                {% endif %}
                                            }
                                        }, 500);
                                    }
                                }, 300);
                            }
                        {% endif %}
                    {% endif %}
                }
            {% else %}
                // Si hay parámetros en la URL (nueva sesión), cargar datos iniciales
                const urlParams = new URLSearchParams(window.location.search);
                const convocatoriaId = urlParams.get('convocatoria');
                const municipioId = urlParams.get('municipio');
                
                if (convocatoriaId && convocatoriasSelect) {
                    const option = Array.from(convocatoriasSelect.options).find(opt => opt.value == convocatoriaId);
                    if (option) {
                        option.selected = true;
                        // Disparar evento para cargar municipios sin recargar página
                        setTimeout(function() {
                            convocatoriasSelect.dispatchEvent(new Event('change'));
                            
                            // Esperar a que se carguen los municipios antes de seleccionar uno
                            if (municipioId && municipiosSelect) {
                                setTimeout(function() {
                                    const optionMun = Array.from(municipiosSelect.options).find(opt => opt.value == municipioId);
                                    if (optionMun) {
                                        optionMun.selected = true;
                                        municipiosSelect.dispatchEvent(new Event('change'));
                                    }
                                }, 500);
                            }
                        }, 200);
                    }
                }
            {% endif %}
            }, 100); // Cerrar el setTimeout
        
        return true;
    }
    
    // Intentar inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initSesionForm, 100);
        });
    } else {
        setTimeout(initSesionForm, 100);
    }
})();
</script>
