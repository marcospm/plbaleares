{{ form_start(form) }}
    <div class="card">
        <div class="card-body">
            {# Mostrar errores globales del formulario #}
            {% if form.vars.errors|length > 0 %}
                <div class="alert alert-danger">
                    <ul class="mb-0">
                        {% for error in form.vars.errors %}
                            <li>{{ error.message }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            
            {{ form_row(form.nombre) }}
            {{ form_row(form.descripcion) }}
            
            <div class="form-group mb-3">
                {{ form_label(form.convocatorias) }}
                {{ form_widget(form.convocatorias, {'attr': {'class': 'form-control', 'size': '5', 'multiple': 'multiple', 'id': 'convocatorias'}}) }}
                {{ form_errors(form.convocatorias) }}
                <small class="form-text text-muted">Puedes seleccionar múltiples convocatorias.</small>
            </div>
            
            <div class="form-group mb-3">
                {{ form_label(form.municipios) }}
                {{ form_widget(form.municipios, {'attr': {'class': 'form-control', 'size': '5', 'multiple': 'multiple', 'id': 'municipios'}}) }}
                {{ form_errors(form.municipios) }}
                <small class="form-text text-muted">Puedes seleccionar múltiples municipios.</small>
            </div>
            
            <div class="form-group mb-3">
                {{ form_label(form.temasMunicipales) }}
                {{ form_widget(form.temasMunicipales, {'attr': {'class': 'form-control', 'size': '10', 'multiple': 'multiple', 'id': 'temas_municipales'}}) }}
                {{ form_errors(form.temasMunicipales) }}
                <small class="form-text text-muted">Primero selecciona convocatorias, luego municipios, y finalmente los temas municipales. Puedes seleccionar múltiples temas.</small>
            </div>
            
            {{ form_row(form.enlaceVideo) }}
        </div>
    </div>
    
    <div style="margin-top: 1rem;">
        <button type="submit" class="btn btn-primary">{{ button_label|default('Guardar') }}</button>
        <a href="{{ path('app_sesion_new') }}" class="btn btn-secondary">Cancelar</a>
    </div>
{{ form_end(form) }}

<script>
(function() {
    function initSesionForm() {
        const convocatoriasSelect = document.getElementById('convocatorias') || 
                                     document.querySelector('select[name*="convocatorias"]');
        const municipiosSelect = document.getElementById('municipios') || 
                                  document.querySelector('select[name*="municipios"]');
        const temasMunicipalesSelect = document.getElementById('temas_municipales') || 
                                        document.querySelector('select[name*="temasMunicipales"]');
        
        if (!convocatoriasSelect || !municipiosSelect || !temasMunicipalesSelect) {
            console.error('No se encontraron los elementos del formulario');
            return false;
        }
        
        // Cargar municipios cuando se seleccionan convocatorias (AJAX)
        convocatoriasSelect.addEventListener('change', function() {
            const convocatoriasIds = Array.from(this.selectedOptions).map(opt => opt.value).filter(v => v);
            if (convocatoriasIds.length > 0) {
                // Limpiar municipios y temas municipales
                municipiosSelect.innerHTML = '';
                temasMunicipalesSelect.innerHTML = '';
                Array.from(temasMunicipalesSelect.selectedOptions || []).forEach(option => {
                    option.selected = false;
                });
                
                // Cargar municipios de todas las convocatorias seleccionadas
                Promise.all(convocatoriasIds.map(id => 
                    fetch('{{ path('app_sesion_ajax_municipios', {'convocatoriaId': 0}) }}'.replace('0', id))
                        .then(response => response.json())
                        .then(data => data.municipios || [])
                )).then(results => {
                    // Combinar y deduplicar municipios
                    const municipiosMap = new Map();
                    results.flat().forEach(municipio => {
                        if (!municipiosMap.has(municipio.id)) {
                            municipiosMap.set(municipio.id, municipio);
                        }
                    });
                    
                    municipiosSelect.innerHTML = '';
                    Array.from(municipiosMap.values()).forEach(municipio => {
                        const option = document.createElement('option');
                        option.value = municipio.id;
                        option.textContent = municipio.nombre;
                        municipiosSelect.appendChild(option);
                    });
                }).catch(error => {
                    console.error('Error al cargar municipios:', error);
                });
            } else {
                municipiosSelect.innerHTML = '';
                temasMunicipalesSelect.innerHTML = '';
            }
        });
        
        // Cargar temas municipales cuando se seleccionan municipios (AJAX)
        municipiosSelect.addEventListener('change', function() {
            const municipiosIds = Array.from(this.selectedOptions).map(opt => opt.value).filter(v => v);
            if (municipiosIds.length > 0) {
                // Limpiar temas municipales seleccionados
                Array.from(temasMunicipalesSelect.selectedOptions || []).forEach(option => {
                    option.selected = false;
                });
                
                // Cargar temas de todos los municipios seleccionados
                Promise.all(municipiosIds.map(id => 
                    fetch('{{ path('app_sesion_ajax_temas_municipales', {'municipioId': 0}) }}'.replace('0', id))
                        .then(response => response.json())
                        .then(data => data.temasMunicipales || [])
                )).then(results => {
                    // Combinar y deduplicar temas
                    const temasMap = new Map();
                    results.flat().forEach(tema => {
                        if (!temasMap.has(tema.id)) {
                            temasMap.set(tema.id, tema);
                        }
                    });
                    
                    temasMunicipalesSelect.innerHTML = '';
                    Array.from(temasMap.values()).forEach(tema => {
                        const option = document.createElement('option');
                        option.value = tema.id;
                        option.textContent = tema.nombre;
                        temasMunicipalesSelect.appendChild(option);
                    });
                }).catch(error => {
                    console.error('Error al cargar temas municipales:', error);
                });
            } else {
                temasMunicipalesSelect.innerHTML = '';
            }
        });
        
        // Inicializar si hay valores pre-seleccionados
        {% if sesion is defined and sesion.id %}
            {% if sesion.convocatorias|length > 0 %}
                // Seleccionar múltiples convocatorias
                {% for convocatoria in sesion.convocatorias %}
                    const optionConv{{ convocatoria.id }} = Array.from(convocatoriasSelect.options).find(opt => opt.value == '{{ convocatoria.id }}');
                    if (optionConv{{ convocatoria.id }}) {
                        optionConv{{ convocatoria.id }}.selected = true;
                    }
                {% endfor %}
                if (convocatoriasSelect.selectedOptions.length > 0) {
                    convocatoriasSelect.dispatchEvent(new Event('change'));
                    setTimeout(function() {
                        {% if sesion.municipios|length > 0 %}
                            // Seleccionar múltiples municipios
                            {% for municipio in sesion.municipios %}
                                const optionMun{{ municipio.id }} = Array.from(municipiosSelect.options).find(opt => opt.value == '{{ municipio.id }}');
                                if (optionMun{{ municipio.id }}) {
                                    optionMun{{ municipio.id }}.selected = true;
                                }
                            {% endfor %}
                            municipiosSelect.dispatchEvent(new Event('change'));
                        {% endif %}
                    }, 500);
                }
            {% endif %}
        {% else %}
            // Si hay parámetros en la URL (nueva sesión), cargar datos iniciales
            const urlParams = new URLSearchParams(window.location.search);
            const convocatoriaId = urlParams.get('convocatoria');
            const municipioId = urlParams.get('municipio');
            
            if (convocatoriaId && convocatoriasSelect) {
                const option = Array.from(convocatoriasSelect.options).find(opt => opt.value == convocatoriaId);
                if (option) {
                    option.selected = true;
                    setTimeout(function() {
                        convocatoriasSelect.dispatchEvent(new Event('change'));
                        
                        if (municipioId && municipiosSelect) {
                            setTimeout(function() {
                                const optionMun = Array.from(municipiosSelect.options).find(opt => opt.value == municipioId);
                                if (optionMun) {
                                    optionMun.selected = true;
                                    municipiosSelect.dispatchEvent(new Event('change'));
                                }
                            }, 500);
                        }
                    }, 200);
                }
            }
        {% endif %}
        
        return true;
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initSesionForm, 100);
        });
    } else {
        setTimeout(initSesionForm, 100);
    }
})();
</script>
