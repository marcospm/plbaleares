{% extends 'base.html.twig' %}

{% block title %}BOIB - Bolet√≠n Oficial de las Islas Baleares{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .boib-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .boib-header h1 {
            color: white;
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }
        
        .boib-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 0;
        }
        
        .resultados-container {
            margin-top: 2rem;
        }
        
        .resultado-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .resultado-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: var(--color-primary);
        }
        
        .resultado-item h3 {
            color: var(--color-primary);
            margin-bottom: 0.75rem;
            font-size: 1.3rem;
        }
        
        .resultado-item .info {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .resultado-item .info span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .resultado-item .coincidencias {
            background-color: #e3f2fd;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .resultado-item .coincidencias strong {
            color: var(--color-primary);
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .resultado-item .coincidencias ul {
            margin: 0;
            padding-left: 1.5rem;
        }
        
        .resultado-item .coincidencias li {
            margin-bottom: 0.25rem;
        }
        
        .resultado-item .extractos {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #ddd;
        }
        
        .resultado-item .extractos .extracto {
            background-color: #f5f5f5;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #555;
        }
        
        .texto-boib-formateado {
            background: white;
            padding: 1.25rem;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            line-height: 1.8;
            font-size: 1rem;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: justify;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        .texto-boib-formateado mark {
            background: #ffeb3b;
            padding: 0.15rem 0.25rem;
            border-radius: 3px;
            font-weight: 600;
            color: #000;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .texto-boib-formateado .termino-destacado {
            background: #e3f2fd;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            color: #1976d2;
            display: inline-block;
            margin-bottom: 0.5rem;
        }
        
        .resultado-item .enlaces {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .resultado-item .enlace {
            display: inline-block;
            background-color: var(--color-primary);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .resultado-item .enlace:hover {
            background-color: #0056b3;
            transform: translateX(4px);
        }
        
        .resultado-item .enlace-secundario {
            background-color: #6c757d;
        }
        
        .resultado-item .enlace-secundario:hover {
            background-color: #5a6268;
        }
        
        .sin-resultados {
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }
        
        .sin-resultados h3 {
            color: #666;
            margin-bottom: 1rem;
        }
        
        .sin-resultados p {
            color: #999;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .badge-coincidencia {
            display: inline-block;
            background-color: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }
        
        @media (max-width: 768px) {
            /* Header responsive */
            .boib-header {
                padding: 1.5rem 1rem !important;
            }
            
            .boib-header h1 {
                font-size: 1.5rem !important;
                word-wrap: break-word;
            }
            
            .boib-header p {
                font-size: 1rem !important;
                word-wrap: break-word;
            }
            
            /* Cards responsive */
            .resultado-item {
                padding: 1rem !important;
            }
            
            .resultado-item h3 {
                font-size: 1.1rem !important;
                word-wrap: break-word;
            }
            
            .resultado-item .info {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .resultado-item .info span {
                word-wrap: break-word;
                display: flex;
                flex-wrap: wrap;
            }
            
            /* Botones responsive */
            .resultado-item > div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .resultado-item .btn {
                width: 100%;
                min-height: 48px;
                font-size: 16px;
                padding: 0.75rem 1rem !important;
            }
            
            /* Enlaces responsive */
            .resultado-item .enlaces {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .resultado-item .enlace {
                width: 100%;
                min-height: 48px;
                font-size: 16px;
                text-align: center;
                padding: 0.75rem 1rem !important;
            }
            
            /* Consultar sumario button */
            .consultar-sumario-btn {
                width: 100% !important;
                min-height: 48px !important;
                font-size: 16px !important;
                padding: 0.75rem 1rem !important;
            }
            
            /* Resultado consulta responsive */
            .resultado-consulta {
                margin-top: 1rem !important;
                padding: 0.75rem !important;
                font-size: 0.9rem;
            }
            
            .resultado-consulta-content {
                font-size: 0.9rem !important;
            }
            
            .texto-boib-formateado {
                padding: 1rem !important;
                font-size: 0.9rem !important;
                line-height: 1.6 !important;
            }
            
            .texto-boib-formateado mark {
                padding: 0.1rem 0.2rem !important;
                font-size: 0.9rem;
            }
            
            /* Grid de resultados */
            div[style*="display: grid"] {
                gap: 1rem !important;
            }
            
            /* Sin resultados */
            .sin-resultados {
                padding: 2rem 1rem !important;
            }
            
            .sin-resultados h3 {
                font-size: 1.2rem;
            }
            
            /* Loading y error */
            .loading,
            .error-message {
                padding: 1rem !important;
                font-size: 0.95rem;
            }
            
            /* XML content responsive */
            div[style*="background: #f8f9fa"] pre {
                font-size: 0.75rem !important;
                padding: 0.75rem !important;
                max-height: 400px !important;
            }
            
            /* Card header */
            .card-header {
                padding: 1rem !important;
            }
        }
    </style>
{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <div class="boib-header">
            <h1>üìã BOIB - Bolet√≠n Oficial de las Islas Baleares</h1>
            <p>B√∫squeda autom√°tica de entradas relacionadas con polic√≠a, polic√≠a local, proceso unificado y OEP</p>
        </div>
    </div>
    <div class="card-body">
        {% if buscando and resultados is empty and error is empty %}
            <div style="text-align: center; padding: 2rem;">
                <p style="font-size: 1.1rem; color: #666;">Cargando boletines del BOIB...</p>
            </div>
        {% endif %}

        {% if error %}
            <div class="error-message">
                <strong>Error:</strong> {{ error }}
            </div>
        {% endif %}


        {% if buscando %}
            {% if error %}
                <div class="error-message">
                    <strong>Error:</strong> {{ error }}
                </div>
            {% endif %}
            
            {% if resultados is defined and resultados|length > 0 %}
                <div style="margin-top: 2rem;">
                    <h2 style="margin-bottom: 1.5rem; color: var(--color-primary);">
                        Boletines encontrados: {{ resultados|length }}
                    </h2>
                    
                    <div style="display: grid; gap: 1rem;">
                        {% for item in resultados %}
                            <div class="resultado-item">
                                <h3 style="color: var(--color-primary); margin-bottom: 0.75rem; font-size: 1.2rem;">
                                    {{ item.titulo }}
                                </h3>
                                
                                <div class="info">
                                    {% if item.fechaFormateada %}
                                        <span>üìÖ <strong>Fecha:</strong> {{ item.fechaFormateada }}</span>
                                    {% endif %}
                                    {% if item.link %}
                                        <span>üîó <strong>Enlace:</strong> <a href="{{ item.link }}" target="_blank" style="color: var(--color-primary); text-decoration: underline;">Ver en BOIB</a></span>
                                    {% endif %}
                                </div>
                                
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    {% if item.urlSumario %}
                                        <button type="button" class="btn btn-primary consultar-sumario-btn" 
                                                data-url="{{ item.urlSumario }}" 
                                                data-titulo="{{ item.titulo|e }}"
                                                style="padding: 0.6rem 1.5rem; font-weight: 600;">
                                            üîç Consultar Sumario
                                        </button>
                                        <a href="{{ item.urlSumario }}" target="_blank" rel="noopener noreferrer" class="btn btn-secondary" style="padding: 0.6rem 1.5rem; font-weight: 600; text-decoration: none; display: inline-block;">
                                            üìÑ Ver PDF
                                        </a>
                                    {% else %}
                                        <button type="button" class="btn btn-secondary" disabled style="padding: 0.6rem 1.5rem; font-weight: 600;">
                                            üîç Consultar (URL no disponible)
                                        </button>
                                    {% endif %}
                                </div>
                                
                                <div class="resultado-consulta" id="consulta-{{ loop.index }}" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #ddd;">
                                    <div class="loading-consulta" style="text-align: center; padding: 1rem;">
                                        <p>Consultando sumario...</p>
                                    </div>
                                    <div class="resultado-consulta-content" style="display: none;"></div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% elseif xmlContent %}
                <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-top: 2rem;">
                    <h2 style="margin-bottom: 1rem; color: var(--color-primary);">XML del Feed RSS</h2>
                    <div style="background: white; padding: 1rem; border-radius: 4px; border: 1px solid #ccc;">
                        <pre style="margin: 0; overflow-x: auto; max-height: 600px; overflow-y: auto; font-size: 0.85rem; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word;">{{ xmlContent|raw }}</pre>
                    </div>
                </div>
            {% else %}
                <div class="loading">
                    <p>Cargando boletines del RSS...</p>
                    {% if error %}
                        <p style="color: red; margin-top: 0.5rem;">{{ error }}</p>
                    {% endif %}
                </div>
            {% endif %}
        {% endif %}

    </div>
</div>

<script>
    // Funci√≥n para formatear el texto del BOIB y mejorar su legibilidad
    function formatearTextoBoib(texto) {
        if (!texto) return '';
        
        // Limpiar espacios m√∫ltiples
        texto = texto.replace(/\s+/g, ' ');
        
        // Separar palabras que est√©n juntas (detectar cuando hay una min√∫scula seguida de may√∫scula)
        // Ejemplo: "ayuntamientoPolic√≠a" -> "ayuntamiento Polic√≠a"
        texto = texto.replace(/([a-z√°√©√≠√≥√∫√±√º])([A-Z√Å√â√ç√ì√ö√ë])/g, '$1 $2');
        
        // Separar palabras comunes que suelen aparecer juntas
        const palabrasComunes = [
            'ayuntamiento', 'municipio', 'polic√≠a', 'policia', 'consejo', 'gobierno',
            'comunidad', 'islas', 'baleares', 'art√≠culo', 'articulo', 'n√∫mero', 'numero',
            'subinspector', 'inspector', 'oficial', 'agente', 'proceso', 'unificado',
            'convocatoria', 'plaza', 'plazas', 'oferta', 'empleo', 'p√∫blico', 'publico',
            'plazo', 'presentaci√≥n', 'presentacion', 'solicitudes', 'requisitos',
            't√≠tulo', 'titulo', 'diploma', 'formaci√≥n', 'formacion', 'experiencia',
            'bases', 'reguladora', 'reguladoras', 'normativa', 'orden', 'decreto'
        ];
        
        // Buscar y separar patrones comunes (mejorado)
        palabrasComunes.forEach(function(palabra) {
            // Separar si aparece seguida de otra palabra sin espacio (may√∫scula)
            const regex = new RegExp('(' + palabra + ')([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±√º]{2,})', 'gi');
            texto = texto.replace(regex, '$1 $2');
            
            // Separar si aparece despu√©s de otra palabra sin espacio (min√∫scula seguida de may√∫scula)
            const regex2 = new RegExp('([a-z√°√©√≠√≥√∫√±√º]{3,})(' + palabra + ')', 'gi');
            texto = texto.replace(regex2, '$1 $2');
            
            // Caso especial: palabra com√∫n seguida de n√∫mero o art√≠culo
            const regex3 = new RegExp('(' + palabra + ')(art\.|n√∫m\.|n¬∫|n√∫mero)', 'gi');
            texto = texto.replace(regex3, '$1 $2');
        });
        
        // Separar n√∫meros de palabras (ej: "art√≠culo1" -> "art√≠culo 1")
        texto = texto.replace(/([a-z√°√©√≠√≥√∫√±√º])(\d+)/gi, '$1 $2');
        texto = texto.replace(/(\d+)([a-z√°√©√≠√≥√∫√±√º])/gi, '$1 $2');
        
        // Separar art√≠culos y n√∫meros comunes
        texto = texto.replace(/(art\.|n√∫m\.|n¬∫|n√∫mero|articulo|numero)([A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±])/gi, '$1 $2');
        
        // Agregar espacios despu√©s de signos de puntuaci√≥n si no los tienen
        texto = texto.replace(/([.,;:])([A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±])/g, '$1 $2');
        
        // Normalizar espacios alrededor de comillas y par√©ntesis
        texto = texto.replace(/\s*([()""''])\s*/g, '$1 ');
        texto = texto.replace(/\s*([()""''])\s*([.,;:!?])/g, '$1$2');
        
        // Agregar saltos de l√≠nea l√≥gicos
        // Despu√©s de puntos seguidos, puntos y comas, dos puntos, etc.
        texto = texto.replace(/([.!?])\s+([A-Z√Å√â√ç√ì√ö√ë])/g, '$1\n\n$2');
        texto = texto.replace(/([:;])\s+([A-Z√Å√â√ç√ì√ö√ë])/g, '$1\n$2');
        
        // Limpiar espacios al inicio de l√≠neas
        texto = texto.split('\n').map(function(linea) {
            return linea.trim();
        }).join('\n');
        
        // Limpiar l√≠neas vac√≠as m√∫ltiples
        texto = texto.replace(/\n{3,}/g, '\n\n');
        
        // Capitalizar la primera letra de cada p√°rrafo
        texto = texto.split('\n\n').map(function(parrafo) {
            parrafo = parrafo.trim();
            if (parrafo && parrafo.length > 0) {
                return parrafo.charAt(0).toUpperCase() + parrafo.slice(1);
            }
            return parrafo;
        }).join('\n\n');
        
        return texto.trim();
    }
    
    // Usar delegaci√≥n de eventos para que funcione incluso con contenido cargado din√°micamente
    (function() {
        function manejarClickConsultar(e) {
            const boton = e.target.closest('.consultar-sumario-btn');
            if (!boton) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const url = boton.getAttribute('data-url');
            const titulo = boton.getAttribute('data-titulo');
            const resultadoDiv = boton.closest('.resultado-item').querySelector('.resultado-consulta');
            const loadingDiv = resultadoDiv.querySelector('.loading-consulta');
            const contentDiv = resultadoDiv.querySelector('.resultado-consulta-content');
            
            // Mostrar el div de resultado
            resultadoDiv.style.display = 'block';
            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';
            
            // Deshabilitar el bot√≥n mientras se consulta
            boton.disabled = true;
            const textoOriginal = boton.textContent;
            boton.textContent = 'Consultando...';
            
            // Hacer la petici√≥n
            fetch('{{ path('app_boib_consultar') }}?consultar=' + encodeURIComponent(url))
                .then(response => response.json())
                .then(data => {
                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'block';
                    
                    if (data.success) {
                        if (data.extractos && data.extractos.length > 0) {
                            let html = '<div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; padding: 1rem; margin-bottom: 1rem;">';
                            html += '<strong style="color: #155724; display: block; margin-bottom: 0.75rem; font-size: 1.1rem;">‚úÖ Referencias encontradas (' + data.totalExtractos + '):</strong>';
                            
                            if (data.terminosEncontrados && data.terminosEncontrados.length > 0) {
                                html += '<div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 4px; border: 1px solid #c3e6cb;">';
                                html += '<strong style="color: #155724; display: block; margin-bottom: 0.5rem;">T√©rminos encontrados:</strong>';
                                html += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                                data.terminosEncontrados.forEach(function(termino) {
                                    html += '<span style="background: #28a745; color: white; padding: 0.25rem 0.75rem; border-radius: 3px; font-size: 0.85rem; font-weight: 500;">' + termino + '</span>';
                                });
                                html += '</div>';
                                html += '</div>';
                            }
                            
                            html += '<div style="display: grid; gap: 1.25rem;">';
                            data.extractos.forEach(function(extracto, index) {
                                // Formatear el texto para mejorar legibilidad
                                let textoFormateado = formatearTextoBoib(extracto.texto);
                                
                                html += '<div class="texto-boib-formateado">';
                                html += '<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #e0e0e0;">';
                                html += '<span style="background: #28a745; color: white; padding: 0.3rem 0.75rem; border-radius: 5px; font-size: 0.85rem; font-weight: 700;">#' + (index + 1) + '</span>';
                                html += '<span class="termino-destacado">üîç ' + extracto.termino + '</span>';
                                html += '</div>';
                                
                                // Resaltar el t√©rmino encontrado en el texto formateado
                                let textoResaltado = textoFormateado.replace(
                                    new RegExp('(' + extracto.termino.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'),
                                    '<mark>$1</mark>'
                                );
                                
                                html += '<div style="margin-top: 0.5rem;">' + textoResaltado + '</div>';
                                html += '</div>';
                            });
                            html += '</div>';
                            html += '</div>';
                            contentDiv.innerHTML = html;
                        } else {
                            contentDiv.innerHTML = '<div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 1rem; color: #856404;">‚ö†Ô∏è No se encontraron referencias a polic√≠a, proceso unificado u OEP en este sumario.</div>';
                        }
                    } else {
                        contentDiv.innerHTML = '<div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 1rem; color: #721c24;">‚ùå Error: ' + (data.error || 'Error desconocido') + '</div>';
                    }
                    
                    // Rehabilitar el bot√≥n
                    boton.disabled = false;
                    boton.textContent = textoOriginal;
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'block';
                    contentDiv.innerHTML = '<div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 1rem; color: #721c24;">‚ùå Error al consultar: ' + error.message + '</div>';
                    
                    // Rehabilitar el bot√≥n
                    boton.disabled = false;
                    boton.textContent = textoOriginal;
                });
        }
        
        // A√±adir el listener usando delegaci√≥n de eventos (funciona con contenido din√°mico)
        document.addEventListener('click', manejarClickConsultar);
        
        // Tambi√©n inicializar cuando se carga contenido din√°micamente (para Turbo, AJAX, etc.)
        if (typeof window.Turbo !== 'undefined') {
            document.addEventListener('turbo:load', function() {
                // El listener de delegaci√≥n ya est√° activo, pero podemos forzar una verificaci√≥n
                console.log('Turbo load - botones de consultar sumario listos');
            });
            document.addEventListener('turbo:render', function() {
                console.log('Turbo render - botones de consultar sumario listos');
            });
        }
    })();
</script>
{% endblock %}
