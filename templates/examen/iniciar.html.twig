{% extends 'base.html.twig' %}

{% block title %}Iniciar Examen{% endblock %}

{% block body %}
{% if borradores is defined and borradores|length > 0 %}
<div class="card mb-4" style="border-left: 4px solid #ffc107;">
    <div class="card-header" style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);">
        <h2 style="margin: 0; color: #856404;">üìù Ex√°menes Guardados en Borrador</h2>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">Tienes {{ borradores|length }} examen(es) guardado(s) que puedes continuar:</p>
        <div class="list-group">
            {% for borrador in borradores %}
                <div class="list-group-item d-flex justify-content-between align-items-center" style="border-left: 3px solid #ffc107; margin-bottom: 0.5rem; padding: 1rem;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="font-size: 1rem;">
                                {% if borrador.tipoExamen == 'general' %}
                                    üìö Examen General
                                {% elseif borrador.tipoExamen == 'municipal' %}
                                    üèõÔ∏è Examen Municipal
                                    {% if borrador.config.municipio_id is defined and municipios[borrador.config.municipio_id] is defined %}
                                        - {{ municipios[borrador.config.municipio_id].nombre }}
                                    {% endif %}
                                {% elseif borrador.tipoExamen == 'convocatoria' %}
                                    üìã Examen de Convocatoria
                                    {% if borrador.config.convocatoria_id is defined and convocatorias[borrador.config.convocatoria_id] is defined %}
                                        - {{ convocatorias[borrador.config.convocatoria_id].nombre }}
                                    {% endif %}
                                {% endif %}
                            </strong>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <small class="text-muted" style="display: inline-block;">
                                <strong>Dificultad:</strong> {{ borrador.config.dificultad|capitalize }}
                            </small>
                            <small class="text-muted" style="display: inline-block;">
                                <strong>Preguntas:</strong> {{ borrador.preguntasIds|length }}
                            </small>
                            <small class="text-muted" style="display: inline-block;">
                                <strong>Respondidas:</strong> {{ borrador.respuestas|length }}
                            </small>
                            <small class="text-muted" style="display: inline-block;">
                                <strong>Progreso:</strong> {{ borrador.preguntaActual }}/{{ borrador.preguntasIds|length }}
                            </small>
                            {% if borrador.tiempoRestante %}
                                <small class="text-muted" style="display: inline-block;">
                                    <strong>‚è±Ô∏è Tiempo restante:</strong> {{ (borrador.tiempoRestante / 60)|round }} min
                                </small>
                            {% endif %}
                        </div>
                        <small class="text-muted" style="display: block; font-size: 0.85rem;">
                            üíæ Guardado: {{ borrador.fechaActualizacion|date('d/m/Y H:i') }}
                        </small>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center; margin-left: 1rem;">
                        <a href="{{ path('app_examen_continuar', {'id': borrador.id}) }}" class="btn btn-warning btn-sm">
                            ‚ñ∂Ô∏è Continuar
                        </a>
                        <form method="post" action="{{ path('app_examen_borrador_eliminar', {'id': borrador.id}) }}" style="display: inline;" onsubmit="return confirm('¬øEst√°s seguro de que quieres eliminar este borrador?');">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete_borrador_' ~ borrador.id) }}">
                            <button type="submit" class="btn btn-danger btn-sm" title="Eliminar borrador">
                                üóëÔ∏è
                            </button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <h1>Nuevo Examen</h1>
    </div>
    <div class="card-body">
        {% if not form.vars.valid %}
            <div class="alert alert-danger">
                <strong>Errores en el formulario:</strong>
                {{ form_errors(form) }}
            </div>
        {% endif %}

        {{ form_start(form, {'attr': {'id': 'examen_form', 'novalidate': 'novalidate'}}) }}
            <div class="form-group mb-4">
                <label for="tipo_examen_select" class="form-label fw-bold">Tipo de Examen</label>
                {{ form_widget(form.tipoExamen, {'attr': {'class': 'form-select form-select-lg', 'id': 'tipo_examen_select'}}) }}
                <div class="form-errors" style="display: none;">
                    {{ form_errors(form.tipoExamen) }}
                </div>
            </div>

            <div class="form-group mb-4" id="municipio_group" style="display: none;">
                <label for="municipio_select" class="form-label fw-bold">Selecciona el Municipio</label>
                {{ form_widget(form.municipio, {'attr': {'class': 'form-select form-select-lg', 'id': 'municipio_select'}}) }}
                {{ form_errors(form.municipio) }}
            </div>

            <div class="form-group mb-4" id="convocatoria_group" style="display: none;">
                <label for="convocatoria_select" class="form-label fw-bold">Selecciona la Convocatoria</label>
                {{ form_widget(form.convocatoria, {'attr': {'class': 'form-select form-select-lg', 'id': 'convocatoria_select'}}) }}
                {{ form_errors(form.convocatoria) }}
            </div>

            <div class="form-group mb-4" id="temas_general_group" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <label class="form-label fw-bold mb-0">Selecciona los Temas del Temario General</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="seleccionar_todos_general" style="font-size: 0.85rem;">‚úì Seleccionar todos</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="deseleccionar_todos_general" style="font-size: 0.85rem;">‚úó Deseleccionar todos</button>
                    </div>
                </div>
                <div class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;" id="temas_general_container">
                    {% if form.temas.vars.choices|length > 0 %}
                        {% for tema in form.temas %}
                            <div class="form-check mb-2">
                                {{ form_widget(tema, {'attr': {'class': 'form-check-input tema-general-checkbox'}}) }}
                                {{ form_label(tema, null, {'label_attr': {'class': 'form-check-label'}}) }}
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mb-0">No hay temas disponibles.</p>
                    {% endif %}
                </div>
                <div class="form-errors" style="display: none;">
                    {{ form_errors(form.temas) }}
                </div>
            </div>

            <div class="form-group mb-4" id="temas_municipales_group" style="display: none !important; visibility: hidden !important; height: 0 !important; max-height: 0 !important; overflow: hidden !important; margin: 0 !important; padding: 0 !important; opacity: 0 !important;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <label class="form-label fw-bold mb-0" id="temas_municipales_label">Selecciona los Temas Municipales</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="seleccionar_todos_municipal" style="font-size: 0.85rem;">‚úì Seleccionar todos</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="deseleccionar_todos_municipal" style="font-size: 0.85rem;">‚úó Deseleccionar todos</button>
                    </div>
                </div>
                {% if form.temasMunicipales.vars.choices|length > 0 %}
                    <div class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;" id="temas_municipales_container">
                        {% for tema in form.temasMunicipales %}
                            <div class="form-check mb-2">
                                {{ form_widget(tema, {'attr': {'class': 'form-check-input tema-municipal-checkbox'}}) }}
                                <label for="{{ tema.vars.id }}" class="form-check-label">
                                    {% set temaId = tema.vars.value %}
                                    {% set temaMunicipal = null %}
                                    {% for choice in form.temasMunicipales.vars.choices %}
                                        {% if choice.value == temaId %}
                                            {% set temaMunicipal = choice.data %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if temaMunicipal and temaMunicipal.municipio %}
                                        <strong>{{ temaMunicipal.municipio.nombre }}</strong> - {{ temaMunicipal.nombre }}
                                    {% else %}
                                        {{ tema.vars.label }}
                                    {% endif %}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-warning mb-0">
                        <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Primero debes seleccionar un municipio arriba para ver los temas municipales disponibles.
                    </div>
                {% endif %}
                <div class="form-errors" style="display: none;">
                    {{ form_errors(form.temasMunicipales) }}
                </div>
            </div>

            <div class="form-group mb-3">
                {{ form_row(form.dificultad) }}
            </div>

            <div class="form-group mb-3">
                {{ form_row(form.numeroPreguntas) }}
            </div>

            <div class="form-group mb-3">
                {{ form_row(form.tiempoLimite) }}
            </div>

            <div class="form-group mb-3">
                <div class="form-check">
                    {{ form_widget(form.modoEstudio, {'attr': {'class': 'form-check-input'}}) }}
                    {{ form_label(form.modoEstudio, null, {'label_attr': {'class': 'form-check-label'}}) }}
                    {% if form.modoEstudio.vars.help is defined %}
                        <small class="form-text text-muted">{{ form.modoEstudio.vars.help }}</small>
                    {% endif %}
                </div>
                {{ form_errors(form.modoEstudio) }}
            </div>

            {% if preguntasDisponibles is defined and preguntasDisponibles is not null %}
                {% if preguntasDisponibles > 0 %}
                    <div class="alert alert-info">
                        <strong>Preguntas disponibles:</strong> {{ preguntasDisponibles }}
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <strong>No hay preguntas disponibles</strong> para la selecci√≥n actual. Por favor, cambia los temas o la dificultad.
                    </div>
                {% endif %}
            {% endif %}

            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary">Iniciar Examen</button>
                <a href="{{ path('app_dashboard') }}" class="btn btn-secondary">Cancelar</a>
            </div>
        {{ form_end(form) }}
    </div>
</div>

<style>
/* Estilos para todos los selectores - tipo de examen, municipio y convocatoria */
#tipo_examen_select,
#municipio_select,
#convocatoria_select,
select[name="examen_iniciar[tipoExamen]"],
select[name="examen_iniciar[municipio]"],
select[name="examen_iniciar[convocatoria]"] {
    min-height: 45px !important;
    font-size: 1rem !important;
    padding: 0.5rem 0.75rem !important;
    border: 1px solid #ced4da !important;
    border-radius: 0.375rem !important;
    width: 100% !important;
    background-color: #fff !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e") !important;
    background-repeat: no-repeat !important;
    background-position: right 0.75rem center !important;
    background-size: 16px 12px !important;
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    line-height: 1.5 !important;
}

#tipo_examen_select:focus,
#municipio_select:focus,
#convocatoria_select:focus,
select[name="examen_iniciar[tipoExamen]"]:focus,
select[name="examen_iniciar[municipio]"]:focus,
select[name="examen_iniciar[convocatoria]"]:focus {
    border-color: #86b7fe !important;
    outline: 0 !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}

.form-select option {
    padding: 0.5rem;
}

/* Asegurar que el grupo de temas municipales est√© completamente oculto por defecto */
#temas_municipales_group {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
    opacity: 0 !important;
    max-height: 0 !important;
    border: none !important;
}

/* Solo mostrar cuando el JavaScript lo activa expl√≠citamente */
#temas_municipales_group.show-temas-municipales {
    display: block !important;
    visibility: visible !important;
    height: auto !important;
    overflow: visible !important;
    margin: 0 0 1.5rem 0 !important;
    padding: 0 !important;
    opacity: 1 !important;
    max-height: none !important;
}

/* Estilos responsivos para m√≥viles (iPhone) */
@media (max-width: 768px) {
    /* Card de borradores */
    .list-group-item {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 1rem !important;
    }
    
    .list-group-item > div:last-child {
        width: 100% !important;
        margin-left: 0 !important;
        flex-direction: column !important;
        gap: 0.5rem !important;
    }
    
    .list-group-item > div:last-child > a,
    .list-group-item > div:last-child > form {
        width: 100% !important;
    }
    
    .list-group-item > div:last-child > form button {
        width: 100% !important;
    }
    
    /* Informaci√≥n de borradores - apilar verticalmente */
    .list-group-item > div:first-child > div:first-child {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.25rem !important;
    }
    
    .list-group-item > div:first-child > div:nth-child(2) {
        flex-direction: column !important;
        gap: 0.5rem !important;
        align-items: flex-start !important;
    }
    
    /* Card principal */
    .card {
        margin: 0.5rem !important;
    }
    
    .card-header h1 {
        font-size: 1.3rem !important;
    }
    
    .card-body {
        padding: 1rem !important;
    }
    
    /* Formulario */
    .form-group {
        margin-bottom: 1.5rem !important;
    }
    
    .form-label {
        font-size: 1rem !important;
        margin-bottom: 0.5rem !important;
    }
    
    /* Selectores m√°s grandes para facilitar el toque */
    #tipo_examen_select,
    #municipio_select,
    #convocatoria_select,
    select[name="examen_iniciar[tipoExamen]"],
    select[name="examen_iniciar[municipio]"],
    select[name="examen_iniciar[convocatoria]"] {
        min-height: 48px !important;
        font-size: 16px !important; /* Previene zoom en iOS */
    }
    
    /* Botones de seleccionar todos */
    .form-group > div[style*="display: flex; justify-content: space-between"] {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.5rem !important;
    }
    
    .form-group > div[style*="display: flex; justify-content: space-between"] > div {
        width: 100% !important;
        flex-direction: column !important;
        gap: 0.5rem !important;
    }
    
    .form-group > div[style*="display: flex; justify-content: space-between"] > div button {
        width: 100% !important;
    }
    
    /* Contenedor de temas */
    .border.rounded.p-3.bg-light {
        max-height: 250px !important;
        padding: 0.75rem !important;
    }
    
    /* Checkboxes m√°s grandes */
    .form-check-input {
        width: 22px !important;
        height: 22px !important;
        margin-right: 0.75rem !important;
    }
    
    .form-check-label {
        font-size: 0.95rem !important;
        line-height: 1.5 !important;
    }
    
    /* Botones del formulario */
    .d-flex.gap-2.mt-4 {
        flex-direction: column !important;
        width: 100% !important;
    }
    
    .d-flex.gap-2.mt-4 button,
    .d-flex.gap-2.mt-4 a {
        width: 100% !important;
        padding: 0.75rem 1rem !important;
        font-size: 1rem !important;
        min-height: 48px !important;
    }
    
    /* Alertas */
    .alert {
        padding: 0.75rem !important;
        font-size: 0.9rem !important;
    }
    
    /* Inputs num√©ricos y de tiempo */
    input[type="number"],
    input[type="text"],
    textarea {
        font-size: 16px !important; /* Previene zoom en iOS */
        min-height: 48px !important;
        padding: 0.75rem !important;
    }
    
    /* Asegurar que todo el texto sea legible */
    * {
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
    }
    
    /* Botones m√°s grandes para facilitar el toque */
    button, .btn, a.btn {
        min-height: 48px !important;
        touch-action: manipulation !important;
    }
}

/* Estilos espec√≠ficos para iPhone (pantallas muy peque√±as) */
@media (max-width: 480px) {
    .card-header h1 {
        font-size: 1.2rem !important;
    }
    
    .list-group-item > div:first-child > div:first-child strong {
        font-size: 0.95rem !important;
    }
    
    .form-label {
        font-size: 0.95rem !important;
    }
    
    .border.rounded.p-3.bg-light {
        max-height: 200px !important;
    }
}
</style>

<script>
(function() {
    'use strict';
    
    function inicializarFormulario() {
        // Buscar elementos usando m√∫ltiples m√©todos
        const tipoExamenSelect = document.getElementById('tipo_examen_select') || 
                                 document.querySelector('select[name="examen_iniciar[tipoExamen]"]');
        const municipioGroup = document.getElementById('municipio_group');
        const municipioSelect = document.getElementById('municipio_select') || 
                               document.querySelector('select[name="examen_iniciar[municipio]"]');
        const convocatoriaGroup = document.getElementById('convocatoria_group');
        const convocatoriaSelect = document.getElementById('convocatoria_select') || 
                                  document.querySelector('select[name="examen_iniciar[convocatoria]"]');
        const temasGeneralGroup = document.getElementById('temas_general_group');
        const temasMunicipalesGroup = document.getElementById('temas_municipales_group');
        
        if (!tipoExamenSelect) {
            console.error('No se encontr√≥ el select de tipo de examen');
            return;
        }
        
        // Obtener municipio de la URL si existe
        const urlParams = new URLSearchParams(window.location.search);
        const municipioIdFromUrl = urlParams.get('municipio');
        
        function actualizarVista(limpiarSelecciones = false) {
            const tipoSeleccionado = tipoExamenSelect ? tipoExamenSelect.value : '';
            const municipioSeleccionado = municipioSelect ? municipioSelect.value : null;
            const convocatoriaSeleccionada = convocatoriaSelect ? convocatoriaSelect.value : null;
            const tieneMunicipio = municipioIdFromUrl || (municipioSeleccionado && municipioSeleccionado !== '' && municipioSeleccionado !== '0');
            const tieneConvocatoria = convocatoriaSeleccionada && convocatoriaSeleccionada !== '' && convocatoriaSeleccionada !== '0';
            
            // Ocultar todo primero
            if (municipioGroup) municipioGroup.style.display = 'none';
            if (convocatoriaGroup) convocatoriaGroup.style.display = 'none';
            if (temasGeneralGroup) temasGeneralGroup.style.display = 'none';
            if (temasMunicipalesGroup) {
                temasMunicipalesGroup.classList.remove('show-temas-municipales');
                temasMunicipalesGroup.style.setProperty('display', 'none', 'important');
                temasMunicipalesGroup.style.setProperty('visibility', 'hidden', 'important');
                temasMunicipalesGroup.style.setProperty('height', '0', 'important');
                temasMunicipalesGroup.style.setProperty('overflow', 'hidden', 'important');
                temasMunicipalesGroup.style.setProperty('opacity', '0', 'important');
            }
            
            // Solo desmarcar checkboxes si se solicita expl√≠citamente (al cambiar de tipo de examen)
            if (limpiarSelecciones) {
                const todosLosCheckboxes = document.querySelectorAll('input[type="checkbox"]');
                todosLosCheckboxes.forEach(input => {
                    input.checked = false;
                    input.required = false;
                });
            } else {
                // Solo quitar el atributo required, no desmarcar
                const todosLosCheckboxes = document.querySelectorAll('input[type="checkbox"]');
                todosLosCheckboxes.forEach(input => {
                    input.required = false;
                });
            }
            
            // Quitar requerido del municipio y convocatoria
            if (municipioSelect) municipioSelect.required = false;
            if (convocatoriaSelect) convocatoriaSelect.required = false;
            
            if (tipoSeleccionado === 'general') {
                // Mostrar temas generales
                if (temasGeneralGroup) {
                    temasGeneralGroup.style.display = 'block';
                }
            } else if (tipoSeleccionado === 'municipal') {
                // Mostrar selector de municipio
                if (municipioGroup) {
                    municipioGroup.style.display = 'block';
                }
                // Hacer requerido el municipio solo si no hay uno ya seleccionado
                if (municipioSelect && !municipioSelect.value) {
                    municipioSelect.required = true;
                }
                
                // Mostrar temas municipales solo si hay municipio seleccionado
                if (tieneMunicipio) {
                    if (temasMunicipalesGroup) {
                        temasMunicipalesGroup.classList.add('show-temas-municipales');
                        temasMunicipalesGroup.style.setProperty('display', 'block', 'important');
                        temasMunicipalesGroup.style.setProperty('visibility', 'visible', 'important');
                        temasMunicipalesGroup.style.setProperty('height', 'auto', 'important');
                        temasMunicipalesGroup.style.setProperty('overflow', 'visible', 'important');
                        temasMunicipalesGroup.style.setProperty('opacity', '1', 'important');
                        temasMunicipalesGroup.style.setProperty('max-height', 'none', 'important');
                    }
                    // Actualizar label
                    const labelMunicipales = document.getElementById('temas_municipales_label');
                    if (labelMunicipales) {
                        labelMunicipales.textContent = 'Selecciona los Temas Municipales';
                    }
                }
            } else if (tipoSeleccionado === 'convocatoria') {
                // Mostrar selector de convocatoria
                if (convocatoriaGroup) {
                    convocatoriaGroup.style.display = 'block';
                }
                // Hacer requerido la convocatoria solo si no hay una ya seleccionada
                if (convocatoriaSelect && !convocatoriaSelect.value) {
                    convocatoriaSelect.required = true;
                }
                
                // Mostrar temas municipales solo si hay convocatoria seleccionada
                if (tieneConvocatoria) {
                    if (temasMunicipalesGroup) {
                        temasMunicipalesGroup.classList.add('show-temas-municipales');
                        temasMunicipalesGroup.style.setProperty('display', 'block', 'important');
                        temasMunicipalesGroup.style.setProperty('visibility', 'visible', 'important');
                        temasMunicipalesGroup.style.setProperty('height', 'auto', 'important');
                        temasMunicipalesGroup.style.setProperty('overflow', 'visible', 'important');
                        temasMunicipalesGroup.style.setProperty('opacity', '1', 'important');
                        temasMunicipalesGroup.style.setProperty('max-height', 'none', 'important');
                    }
                    // Actualizar label para indicar que son temas de todos los municipios de la convocatoria
                    const labelMunicipales = document.getElementById('temas_municipales_label');
                    if (labelMunicipales) {
                        labelMunicipales.textContent = 'Selecciona los Temas Municipales (de todos los municipios de la convocatoria)';
                    }
                }
            }
        }
        
        // Event listener para el tipo de examen
        tipoExamenSelect.addEventListener('change', function() {
            const tipoSeleccionado = this.value;
            
            if (tipoSeleccionado === 'general') {
                // Limpiar municipio y convocatoria si estaban seleccionados
                if (municipioSelect) {
                    municipioSelect.value = '';
                }
                if (convocatoriaSelect) {
                    convocatoriaSelect.value = '';
                }
                // Limpiar par√°metros de la URL sin recargar
                const url = new URL(window.location.href);
                url.searchParams.delete('municipio');
                url.searchParams.delete('convocatoria');
                window.history.replaceState({}, '', url.toString());
                // Actualizar vista para mostrar temas generales, limpiando selecciones municipales
                actualizarVista(true);
            } else if (tipoSeleccionado === 'municipal') {
                // Limpiar convocatoria si estaba seleccionada
                if (convocatoriaSelect) {
                    convocatoriaSelect.value = '';
                }
                // Limpiar par√°metro de convocatoria de la URL
                const url = new URL(window.location.href);
                url.searchParams.delete('convocatoria');
                window.history.replaceState({}, '', url.toString());
                // Limpiar municipio si hab√≠a uno seleccionado y actualizar vista inmediatamente
                if (municipioSelect) {
                    municipioSelect.value = '';
                }
                // Actualizar vista para mostrar el selector de municipio, limpiando selecciones generales
                actualizarVista(true);
            } else if (tipoSeleccionado === 'convocatoria') {
                // Limpiar municipio si estaba seleccionado
                if (municipioSelect) {
                    municipioSelect.value = '';
                }
                // Limpiar par√°metro de municipio de la URL
                const url = new URL(window.location.href);
                url.searchParams.delete('municipio');
                window.history.replaceState({}, '', url.toString());
                // Actualizar vista para mostrar el selector de convocatoria, limpiando selecciones generales
                actualizarVista(true);
            } else {
                // Si vuelve al placeholder, ocultar todo y limpiar selecciones
                actualizarVista(true);
            }
        });
        
        // Event listener para el municipio
        if (municipioSelect) {
            municipioSelect.addEventListener('change', function() {
                const municipioId = this.value;
                if (municipioId && municipioId !== '') {
                    // Asegurar que el tipo municipal est√© seleccionado
                    if (tipoExamenSelect && tipoExamenSelect.value !== 'municipal') {
                        tipoExamenSelect.value = 'municipal';
                    }
                    
                    // Limpiar convocatoria si estaba seleccionada
                    if (convocatoriaSelect) {
                        convocatoriaSelect.value = '';
                    }
                    
                    // Recargar la p√°gina con el municipio seleccionado para cargar los temas
                    const url = new URL(window.location.href);
                    url.searchParams.set('municipio', municipioId);
                    url.searchParams.delete('convocatoria');
                    window.location.href = url.toString();
                } else {
                    // Si se deselecciona, limpiar la URL
                    const url = new URL(window.location.href);
                    url.searchParams.delete('municipio');
                    window.location.href = url.toString();
                }
            });
        }
        
        // Event listener para la convocatoria
        if (convocatoriaSelect) {
            convocatoriaSelect.addEventListener('change', function() {
                const convocatoriaId = this.value;
                if (convocatoriaId && convocatoriaId !== '') {
                    // Asegurar que el tipo convocatoria est√© seleccionado
                    if (tipoExamenSelect && tipoExamenSelect.value !== 'convocatoria') {
                        tipoExamenSelect.value = 'convocatoria';
                    }
                    
                    // Limpiar municipio si estaba seleccionado
                    if (municipioSelect) {
                        municipioSelect.value = '';
                    }
                    
                    // Recargar la p√°gina con la convocatoria seleccionada para cargar los temas
                    const url = new URL(window.location.href);
                    url.searchParams.set('convocatoria', convocatoriaId);
                    url.searchParams.delete('municipio');
                    window.location.href = url.toString();
                } else {
                    // Si se deselecciona, limpiar la URL
                    const url = new URL(window.location.href);
                    url.searchParams.delete('convocatoria');
                    window.location.href = url.toString();
                }
            });
        }
        
        // Obtener convocatoria de la URL si existe
        const convocatoriaIdFromUrl = urlParams.get('convocatoria');
        
        // Si hay municipio en la URL, establecer el tipo a municipal
        if (municipioIdFromUrl && tipoExamenSelect) {
            tipoExamenSelect.value = 'municipal';
        }
        
        // Si hay convocatoria en la URL, establecer el tipo a convocatoria
        if (convocatoriaIdFromUrl && tipoExamenSelect) {
            tipoExamenSelect.value = 'convocatoria';
        }
        
        // Asegurar que el grupo de temas municipales est√© oculto al inicio (antes de cualquier otra cosa)
        if (temasMunicipalesGroup) {
            temasMunicipalesGroup.classList.remove('show-temas-municipales');
            temasMunicipalesGroup.style.setProperty('display', 'none', 'important');
            temasMunicipalesGroup.style.setProperty('visibility', 'hidden', 'important');
            temasMunicipalesGroup.style.setProperty('height', '0', 'important');
            temasMunicipalesGroup.style.setProperty('overflow', 'hidden', 'important');
            temasMunicipalesGroup.style.setProperty('opacity', '0', 'important');
        }
        
        // Inicializar vista al cargar
        actualizarVista();
        
        // Prevenir que los checkboxes disparen validaci√≥n al hacer clic
        // No remover el atributo required aqu√≠, solo prevenir la propagaci√≥n
        document.addEventListener('click', function(e) {
            if (e.target.type === 'checkbox') {
                // Prevenir que el evento cause validaci√≥n inmediata
                e.stopPropagation();
            }
        }, true);
        
        // Validaci√≥n personalizada al enviar el formulario
        const form = document.getElementById('examen_form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const tipoSeleccionado = tipoExamenSelect ? tipoExamenSelect.value : '';
                let isValid = true;
                let errorMessage = '';
                
                // Asegurarse de que los campos ocultos se env√≠en correctamente
                // Mostrar temporalmente los campos ocultos para que se env√≠en
                const gruposOcultos = [];
                if (tipoSeleccionado === 'general') {
                    // Si es general, asegurar que temas municipales se env√≠en vac√≠os
                    if (temasMunicipalesGroup && temasMunicipalesGroup.style.display === 'none') {
                        // Desmarcar todos los temas municipales antes de enviar
                        const temasMunicipalesInputs = temasMunicipalesGroup.querySelectorAll('input[type="checkbox"]');
                        temasMunicipalesInputs.forEach(input => input.checked = false);
                    }
                } else if (tipoSeleccionado === 'municipal') {
                    // Si es municipal, asegurar que temas generales se env√≠en vac√≠os
                    if (temasGeneralGroup && temasGeneralGroup.style.display === 'none') {
                        // Desmarcar todos los temas generales antes de enviar
                        const temasGeneralInputs = temasGeneralGroup.querySelectorAll('input[type="checkbox"]');
                        temasGeneralInputs.forEach(input => input.checked = false);
                    }
                }
                
                if (!tipoSeleccionado || tipoSeleccionado === '') {
                    isValid = false;
                    errorMessage = 'Debes seleccionar un tipo de examen.';
                } else if (tipoSeleccionado === 'general') {
                    // Verificar que haya al menos un tema general seleccionado
                    const temasGeneralInputs = document.querySelectorAll('input[name^="examen_iniciar[temas]"][type="checkbox"]:checked');
                    if (temasGeneralInputs.length === 0) {
                        isValid = false;
                        errorMessage = 'Debes seleccionar al menos un tema del temario general.';
                    }
                } else if (tipoSeleccionado === 'municipal') {
                    // Verificar que haya un municipio seleccionado
                    if (!municipioSelect || !municipioSelect.value) {
                        isValid = false;
                        errorMessage = 'Debes seleccionar un municipio.';
                    } else {
                        // Verificar que haya al menos un tema municipal seleccionado
                        const temasMunicipalesInputs = document.querySelectorAll('input[name^="examen_iniciar[temasMunicipales]"][type="checkbox"]:checked');
                        if (temasMunicipalesInputs.length === 0) {
                            isValid = false;
                            errorMessage = 'Debes seleccionar al menos un tema municipal.';
                        }
                    }
                } else if (tipoSeleccionado === 'convocatoria') {
                    // Verificar que haya una convocatoria seleccionada
                    if (!convocatoriaSelect || !convocatoriaSelect.value) {
                        isValid = false;
                        errorMessage = 'Debes seleccionar una convocatoria.';
                    } else {
                        // Verificar que haya al menos un tema municipal seleccionado
                        const temasMunicipalesInputs = document.querySelectorAll('input[name^="examen_iniciar[temasMunicipales]"][type="checkbox"]:checked');
                        if (temasMunicipalesInputs.length === 0) {
                            isValid = false;
                            errorMessage = 'Debes seleccionar al menos un tema municipal.';
                        }
                    }
                }
                
                if (!isValid) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Mostrar mensaje de error
                    alert(errorMessage);
                    // Mostrar errores de Symfony si existen
                    const formErrors = form.querySelectorAll('.form-errors');
                    formErrors.forEach(errorDiv => {
                        if (errorDiv.innerHTML.trim() !== '') {
                            errorDiv.style.display = 'block';
                        }
                    });
                    return false;
                } else {
                    // Ocultar errores si la validaci√≥n pasa
                    const formErrors = form.querySelectorAll('.form-errors');
                    formErrors.forEach(errorDiv => {
                        errorDiv.style.display = 'none';
                    });
                }
            }, true); // Usar capture phase para interceptar antes que otros listeners
        }
        
        // Ocultar errores de validaci√≥n al hacer clic en cualquier checkbox
        document.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox') {
                const formErrors = document.querySelectorAll('.form-errors');
                formErrors.forEach(errorDiv => {
                    errorDiv.style.display = 'none';
                });
            }
        });
        
        // Funcionalidad para seleccionar/deseleccionar todos los temas generales
        const btnSeleccionarTodosGeneral = document.getElementById('seleccionar_todos_general');
        const btnDeseleccionarTodosGeneral = document.getElementById('deseleccionar_todos_general');
        
        if (btnSeleccionarTodosGeneral) {
            btnSeleccionarTodosGeneral.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('#temas_general_container .tema-general-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
            });
        }
        
        if (btnDeseleccionarTodosGeneral) {
            btnDeseleccionarTodosGeneral.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('#temas_general_container .tema-general-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            });
        }
        
        // Funcionalidad para seleccionar/deseleccionar todos los temas municipales
        const btnSeleccionarTodosMunicipal = document.getElementById('seleccionar_todos_municipal');
        const btnDeseleccionarTodosMunicipal = document.getElementById('deseleccionar_todos_municipal');
        
        if (btnSeleccionarTodosMunicipal) {
            btnSeleccionarTodosMunicipal.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('#temas_municipales_container .tema-municipal-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
            });
        }
        
        if (btnDeseleccionarTodosMunicipal) {
            btnDeseleccionarTodosMunicipal.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('#temas_municipales_container .tema-municipal-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            });
        }
    }
    
    // Funci√≥n para enfocar el selector de tipo de examen
    function enfocarTipoExamen() {
        const tipoExamenSelect = document.getElementById('tipo_examen_select') || 
                                 document.querySelector('select[name="examen_iniciar[tipoExamen]"]');
        if (tipoExamenSelect) {
            // Usar setTimeout para asegurar que el DOM est√© completamente renderizado
            setTimeout(function() {
                tipoExamenSelect.focus();
            }, 100);
        }
    }
    
    // Ejecutar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            inicializarFormulario();
            enfocarTipoExamen();
        });
    } else {
        // DOM ya est√° listo
        inicializarFormulario();
        enfocarTipoExamen();
    }
    
    // Tambi√©n enfocar en eventos de Turbo (si se usa)
    document.addEventListener('turbo:load', function() {
        enfocarTipoExamen();
    });
    
    // Limpiar temporizador al iniciar un nuevo examen
    // IMPORTANTE: Solo limpiar si NO estamos en medio de un examen activo
    // Verificar primero si hay un examen activo en la sesi√≥n antes de limpiar
    // Esto evita que se limpie el localStorage cuando el usuario solo visita la p√°gina sin iniciar examen
    // Nota: La limpieza real del temporizador se hace cuando se inicia un nuevo examen en el controlador
})();
</script>
{% endblock %}
