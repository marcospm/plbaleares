{% extends 'base.html.twig' %}

{% block title %}Resultado del Examen{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <h1>Resultado del Examen</h1>
    </div>
    <div class="card-body">
        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%); color: white; border-radius: 8px; margin-bottom: 2rem;">
            <h2 style="margin: 0; font-size: 3rem;">{{ nota|number_format(2, ',', '.') }}</h2>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h3 style="color: var(--color-success); font-size: 2rem; margin: 0;">{{ aciertos }}</h3>
                    <p style="margin: 0.5rem 0 0 0;">Aciertos</p>
                </div>
            </div>
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h3 style="color: var(--color-danger); font-size: 2rem; margin: 0;">{{ errores }}</h3>
                    <p style="margin: 0.5rem 0 0 0;">Errores</p>
                </div>
            </div>
            {% if enBlanco > 0 %}
                <div class="card" style="text-align: center;">
                    <div class="card-body">
                        <h3 style="color: #999; font-size: 2rem; margin: 0;">{{ enBlanco }}</h3>
                        <p style="margin: 0.5rem 0 0 0;">En blanco</p>
                    </div>
                </div>
            {% endif %}
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h3 style="color: var(--color-primary); font-size: 2rem; margin: 0;">{{ total }}</h3>
                    <p style="margin: 0.5rem 0 0 0;">Total</p>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <strong>Dificultad:</strong> <span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span>
        </div>

        <div class="mb-4">
            {% if examen.convocatoria %}
                <strong>Convocatoria:</strong> <span class="badge" style="background-color: #9C27B0;">{{ examen.convocatoria.nombre }}</span>
            {% elseif examen.municipio %}
                <strong>Municipio:</strong> <span class="badge" style="background-color: #2196F3;">{{ examen.municipio.nombre }}</span><br>
                <strong>Temas Municipales:</strong>
                {% for temaMunicipal in examen.temasMunicipales %}
                    <span class="badge badge-facil">{{ temaMunicipal.nombre }}</span>
                {% endfor %}
            {% else %}
                <strong>Temas:</strong>
                {% for tema in examen.temas %}
                    <span class="badge badge-facil">{{ tema.nombre }}</span>
                {% endfor %}
            {% endif %}
        </div>

        <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Detalle de Preguntas</h3>

        {% for item in preguntas %}
            <div class="card mb-3" style="{% if item.esCorrecta is null %}border-left: 4px solid #999;{% elseif item.esCorrecta %}border-left: 4px solid var(--color-success);{% else %}border-left: 4px solid var(--color-danger);{% endif %}">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0;">Pregunta {{ loop.index }}</h4>
                            {# Informaci√≥n discreta del tema y ley #}
                            <div style="margin-top: 0.25rem; font-size: 0.75rem; color: #666;">
                                {% if esMunicipal %}
                                    {% if item.pregunta.temaMunicipal %}
                                        <span style="background-color: #f0f0f0; padding: 0.15rem 0.4rem; border-radius: 3px; margin-right: 0.5rem;">
                                            üìö Tema: {{ item.pregunta.temaMunicipal.nombre }}
                                        </span>
                                    {% endif %}
                                {% else %}
                                    {% if item.pregunta.tema %}
                                        <span style="background-color: #f0f0f0; padding: 0.15rem 0.4rem; border-radius: 3px; margin-right: 0.5rem;">
                                            üìö Tema: {{ item.pregunta.tema.nombre }}
                                        </span>
                                    {% endif %}
                                    {% if item.pregunta.ley %}
                                        <span style="background-color: #f0f0f0; padding: 0.15rem 0.4rem; border-radius: 3px;">
                                            ‚öñÔ∏è Ley: {{ item.pregunta.ley.nombre }}
                                        </span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% if item.esCorrecta is null %}
                            <span class="badge" style="background-color: #999; color: white;">‚óã Sin responder</span>
                        {% elseif item.esCorrecta %}
                            <span class="badge badge-facil">‚úì Correcta</span>
                        {% else %}
                            <span class="badge badge-dificil">‚úó Incorrecta</span>
                        {% endif %}
                    </div>

                    <p><strong>{{ item.pregunta.texto }}</strong></p>

                    <div style="margin: 1rem 0;">
                        {# Opci√≥n A #}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if item.respuestaAlumno == 'A' and not item.esCorrecta %}background: #ffebee;{% elseif item.pregunta.respuestaCorrecta == 'A' and (item.esCorrecta == false or item.esCorrecta is null) %}background: #e8f5e9; border-left: 3px solid var(--color-success);{% elseif item.pregunta.respuestaCorrecta == 'A' and item.esCorrecta %}background: #e8f5e9;{% endif %}">
                            <strong>A)</strong> {{ item.pregunta.opcionA }}
                            {% if item.esCorrecta is not null %}
                                {% if item.respuestaAlumno == 'A' and not item.esCorrecta %}<span style="color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>{% endif %}
                            {% endif %}
                            {% if item.pregunta.respuestaCorrecta == 'A' and (item.esCorrecta == false or item.esCorrecta is null) %}
                                <span style="color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                            {% elseif item.pregunta.respuestaCorrecta == 'A' and item.esCorrecta %}
                                <span style="color: var(--color-success);">‚Üê Correcta</span>
                            {% endif %}
                        </div>
                        {# Opci√≥n B #}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if item.respuestaAlumno == 'B' and not item.esCorrecta %}background: #ffebee;{% elseif item.pregunta.respuestaCorrecta == 'B' and (item.esCorrecta == false or item.esCorrecta is null) %}background: #e8f5e9; border-left: 3px solid var(--color-success);{% elseif item.pregunta.respuestaCorrecta == 'B' and item.esCorrecta %}background: #e8f5e9;{% endif %}">
                            <strong>B)</strong> {{ item.pregunta.opcionB }}
                            {% if item.esCorrecta is not null %}
                                {% if item.respuestaAlumno == 'B' and not item.esCorrecta %}<span style="color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>{% endif %}
                            {% endif %}
                            {% if item.pregunta.respuestaCorrecta == 'B' and (item.esCorrecta == false or item.esCorrecta is null) %}
                                <span style="color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                            {% elseif item.pregunta.respuestaCorrecta == 'B' and item.esCorrecta %}
                                <span style="color: var(--color-success);">‚Üê Correcta</span>
                            {% endif %}
                        </div>
                        {# Opci√≥n C #}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if item.respuestaAlumno == 'C' and not item.esCorrecta %}background: #ffebee;{% elseif item.pregunta.respuestaCorrecta == 'C' and (item.esCorrecta == false or item.esCorrecta is null) %}background: #e8f5e9; border-left: 3px solid var(--color-success);{% elseif item.pregunta.respuestaCorrecta == 'C' and item.esCorrecta %}background: #e8f5e9;{% endif %}">
                            <strong>C)</strong> {{ item.pregunta.opcionC }}
                            {% if item.esCorrecta is not null %}
                                {% if item.respuestaAlumno == 'C' and not item.esCorrecta %}<span style="color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>{% endif %}
                            {% endif %}
                            {% if item.pregunta.respuestaCorrecta == 'C' and (item.esCorrecta == false or item.esCorrecta is null) %}
                                <span style="color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                            {% elseif item.pregunta.respuestaCorrecta == 'C' and item.esCorrecta %}
                                <span style="color: var(--color-success);">‚Üê Correcta</span>
                            {% endif %}
                        </div>
                        {# Opci√≥n D #}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if item.respuestaAlumno == 'D' and not item.esCorrecta %}background: #ffebee;{% elseif item.pregunta.respuestaCorrecta == 'D' and (item.esCorrecta == false or item.esCorrecta is null) %}background: #e8f5e9; border-left: 3px solid var(--color-success);{% elseif item.pregunta.respuestaCorrecta == 'D' and item.esCorrecta %}background: #e8f5e9;{% endif %}">
                            <strong>D)</strong> {{ item.pregunta.opcionD }}
                            {% if item.esCorrecta is not null %}
                                {% if item.respuestaAlumno == 'D' and not item.esCorrecta %}<span style="color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>{% endif %}
                            {% endif %}
                            {% if item.pregunta.respuestaCorrecta == 'D' and (item.esCorrecta == false or item.esCorrecta is null) %}
                                <span style="color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                            {% elseif item.pregunta.respuestaCorrecta == 'D' and item.esCorrecta %}
                                <span style="color: var(--color-success);">‚Üê Correcta</span>
                            {% endif %}
                        </div>
                        {% if item.esCorrecta is null %}
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: #f5f5f5; border-radius: 4px; color: #666; font-style: italic;">
                                Esta pregunta no fue respondida y no afecta tu calificaci√≥n.
                            </div>
                        {% endif %}
                    </div>

                    {% if item.pregunta.retroalimentacion %}
                        <div class="alert alert-info" style="margin-top: 1rem; line-height: 1.6;">
                            <strong>Retroalimentaci√≥n:</strong> 
                            <div style="margin-top: 0.5rem;">{{ item.pregunta.retroalimentacion|markdown|raw }}</div>
                        </div>
                    {% endif %}

                    {% if not esMunicipal and item.pregunta.articulo %}
                        {% if item.pregunta.articulo.explicacion or item.pregunta.articulo.textoLegal %}
                        <details style="margin-top: 1rem;">
                            <summary style="cursor: pointer; font-weight: bold; color: var(--color-primary);">Ver Informaci√≥n del Art√≠culo</summary>
                            <div style="margin-top: 0.5rem;">
                                <p><strong>Art√≠culo {{ item.pregunta.articulo.getNumeroCompleto() }} - {{ item.pregunta.ley.nombre }}</strong></p>
                                {% if item.pregunta.articulo.explicacion %}
                                <div style="background: #e3f2fd; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; border-left: 4px solid var(--color-secondary); line-height: 1.6;">
                                    <strong>Explicaci√≥n para el Opositor:</strong>
                                    <div style="margin-top: 0.5rem;">{{ item.pregunta.articulo.explicacion|markdown|raw }}</div>
                                </div>
                                {% endif %}
                                {% if item.pregunta.articulo.textoLegal %}
                                <div style="background: #fff3cd; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; border-left: 4px solid #ffc107; line-height: 1.6;">
                                    <strong>Texto Legal:</strong>
                                    <div style="margin-top: 0.5rem;">{{ item.pregunta.articulo.textoLegal|raw }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </details>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        {% endfor %}

        <div class="d-flex gap-2 mt-4">
            <a href="{{ path('app_examen_iniciar') }}" class="btn btn-primary">Nuevo Examen</a>
            <a href="{{ path('app_examen_historial') }}" class="btn btn-secondary">Ver Historial</a>
            <a href="{{ path('app_dashboard') }}" class="btn btn-secondary">Volver al Dashboard</a>
        </div>
    </div>
</div>
{% endblock %}

