{% extends 'base.html.twig' %}

{% block title %}Resultado del Examen{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <h1>Resultado del Examen</h1>
    </div>
    <div class="card-body">
        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%); color: white; border-radius: 8px; margin-bottom: 2rem;">
            <h2 style="margin: 0; font-size: 3rem;">{{ nota|number_format(2, ',', '.') }}</h2>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h3 style="color: var(--color-success); font-size: 2rem; margin: 0;">{{ aciertos }}</h3>
                    <p style="margin: 0.5rem 0 0 0;">Aciertos</p>
                </div>
            </div>
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h3 style="color: var(--color-danger); font-size: 2rem; margin: 0;">{{ errores }}</h3>
                    <p style="margin: 0.5rem 0 0 0;">Errores</p>
                </div>
            </div>
            {% if enBlanco > 0 %}
                <div class="card" style="text-align: center;">
                    <div class="card-body">
                        <h3 style="color: #999; font-size: 2rem; margin: 0;">{{ enBlanco }}</h3>
                        <p style="margin: 0.5rem 0 0 0;">En blanco</p>
                    </div>
                </div>
            {% endif %}
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h3 style="color: var(--color-primary); font-size: 2rem; margin: 0;">{{ total }}</h3>
                    <p style="margin: 0.5rem 0 0 0;">Total</p>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <strong>Dificultad:</strong> <span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span>
        </div>

        <div class="mb-4">
            {% if examen.convocatoria %}
                <strong>Convocatoria:</strong> <span class="badge" style="background-color: #9C27B0;">{{ examen.convocatoria.nombre }}</span>
            {% elseif examen.municipio %}
                <strong>Municipio:</strong> <span class="badge" style="background-color: #2196F3;">{{ examen.municipio.nombre }}</span><br>
                <strong>Temas Municipales:</strong>
                {% for temaMunicipal in examen.temasMunicipales %}
                    <span class="badge badge-facil">{{ temaMunicipal.nombre }}</span>
                {% endfor %}
            {% else %}
                <strong>Temas:</strong>
                {% for tema in examen.temas %}
                    <span class="badge badge-facil">{{ tema.nombre }}</span>
                {% endfor %}
            {% endif %}
        </div>

        <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Detalle de Preguntas</h3>

        {% for item in preguntas %}
            <div class="card mb-3" style="{% if item.esCorrecta is null %}border-left: 4px solid #999;{% elseif item.esCorrecta %}border-left: 4px solid var(--color-success);{% else %}border-left: 4px solid var(--color-danger);{% endif %}">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0;">Pregunta {{ loop.index }}</h4>
                        </div>
                        {% if item.esCorrecta is null %}
                            <span class="badge" style="background-color: #999; color: white;">‚óã Sin responder</span>
                        {% elseif item.esCorrecta %}
                            <span class="badge badge-facil">‚úì Correcta</span>
                        {% else %}
                            <span class="badge badge-dificil">‚úó Incorrecta</span>
                        {% endif %}
                    </div>

                    {# Informaci√≥n Legal: Tema, Ley y Art√≠culo en secci√≥n amarilla - Organizado verticalmente #}
                    {% if not esMunicipal %}
                        {% set esTema17 = (item.pregunta.tema and ('Tema 17' in item.pregunta.tema.nombre or 'accidente de tr√°fico' in item.pregunta.tema.nombre|lower)) or (item.pregunta.ley and item.pregunta.ley.nombre == 'Accidentes de Tr√°fico') %}
                        {% if item.pregunta.ley or (item.pregunta.articulo and not esTema17 and item.pregunta.articulo.numero != 0) or item.pregunta.tema %}
                            <div class="form-group mb-3">
                                <div style="padding: 0.75rem 1rem; background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 4px solid #ffc107; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 0.75rem;">
                                    <div style="color: #856404; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(133, 100, 4, 0.2); padding-bottom: 0.5rem; margin-bottom: 0.25rem;">
                                        üìã Informaci√≥n de la pregunta
                                    </div>
                                    {% if item.pregunta.tema %}
                                        <div style="color: #856404; font-size: 0.9rem; font-weight: 500;">üè∑Ô∏è <strong>{{ item.pregunta.tema.nombre }}</strong></div>
                                    {% endif %}
                                    {% if item.pregunta.ley %}
                                        <div style="color: #856404; font-size: 0.9rem; font-weight: 600;">üìú {{ item.pregunta.ley.nombre }}</div>
                                    {% endif %}
                                    {% if item.pregunta.articulo and not esTema17 and item.pregunta.articulo.numero != 0 %}
                                        <div style="color: #856404; font-size: 0.9rem; font-weight: 600;">
                                            üìÑ Art. {{ item.pregunta.articulo.getNumeroCompleto() }}
                                            {% if item.pregunta.articulo.nombre %}
                                                - {{ item.pregunta.articulo.nombre }}
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    {% elseif item.pregunta.temaMunicipal %}
                        {# Para municipales, mostrar solo el tema en una secci√≥n similar #}
                        <div class="form-group mb-3">
                            <div style="padding: 0.75rem 1rem; background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 4px solid #ffc107; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 0.75rem;">
                                <div style="color: #856404; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(133, 100, 4, 0.2); padding-bottom: 0.5rem; margin-bottom: 0.25rem;">
                                    üìã Informaci√≥n de la pregunta
                                </div>
                                <span style="color: #856404; font-size: 0.9rem; font-weight: 500;">üè∑Ô∏è <strong>{{ item.pregunta.temaMunicipal.nombre }}</strong></span>
                            </div>
                        </div>
                    {% endif %}

                    <p><strong>{{ item.pregunta.texto }}</strong></p>

                    <div style="margin: 1rem 0;">
                        {# Opci√≥n A #}
                        {% set esCorrectaA = item.pregunta.respuestaCorrecta == 'A' %}
                        {% set esSeleccionadaA = item.respuestaAlumno == 'A' %}
                        {% set esIncorrectaA = esSeleccionadaA and not item.esCorrecta %}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if esIncorrectaA %}background: #ffebee;{% elseif esCorrectaA %}background: #e8f5e9; border-left: 3px solid var(--color-success);{% endif %}">
                            <strong>A)</strong> {{ item.pregunta.opcionA }}
                            {% if esIncorrectaA %}
                                <span style="color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>
                            {% endif %}
                            {% if esCorrectaA %}
                                <span style="color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                            {% endif %}
                        </div>
                        {# Opci√≥n B #}
                        {% set esCorrectaB = item.pregunta.respuestaCorrecta == 'B' %}
                        {% set esSeleccionadaB = item.respuestaAlumno == 'B' %}
                        {% set esIncorrectaB = esSeleccionadaB and not item.esCorrecta %}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if esIncorrectaB %}background: #ffebee;{% elseif esCorrectaB %}background: #e8f5e9; border-left: 3px solid var(--color-success);{% endif %}">
                            <strong>B)</strong> {{ item.pregunta.opcionB }}
                            {% if esIncorrectaB %}
                                <span style="color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>
                            {% endif %}
                            {% if esCorrectaB %}
                                <span style="color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                            {% endif %}
                        </div>
                        {# Opci√≥n C #}
                        {% set esCorrectaC = item.pregunta.respuestaCorrecta == 'C' %}
                        {% set esSeleccionadaC = item.respuestaAlumno == 'C' %}
                        {% set esIncorrectaC = esSeleccionadaC and not item.esCorrecta %}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if esIncorrectaC %}background: #ffebee;{% elseif esCorrectaC %}background: #e8f5e9; border-left: 3px solid var(--color-success);{% endif %}">
                            <strong>C)</strong> {{ item.pregunta.opcionC }}
                            {% if esIncorrectaC %}
                                <span style="color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>
                            {% endif %}
                            {% if esCorrectaC %}
                                <span style="color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                            {% endif %}
                        </div>
                        {# Opci√≥n D #}
                        {% set esCorrectaD = item.pregunta.respuestaCorrecta == 'D' %}
                        {% set esSeleccionadaD = item.respuestaAlumno == 'D' %}
                        {% set esIncorrectaD = esSeleccionadaD and not item.esCorrecta %}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if esIncorrectaD %}background: #ffebee;{% elseif esCorrectaD %}background: #e8f5e9; border-left: 3px solid var(--color-success);{% endif %}">
                            <strong>D)</strong> {{ item.pregunta.opcionD }}
                            {% if esIncorrectaD %}
                                <span style="color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>
                            {% endif %}
                            {% if esCorrectaD %}
                                <span style="color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                            {% endif %}
                        </div>
                        {% if item.esCorrecta is null %}
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: #f5f5f5; border-radius: 4px; color: #666; font-style: italic;">
                                Esta pregunta no fue respondida y no afecta tu calificaci√≥n.
                            </div>
                        {% endif %}
                    </div>

                    {% if item.pregunta.retroalimentacion %}
                        <div class="alert alert-info" style="margin-top: 1rem; line-height: 1.6;">
                            <strong>Retroalimentaci√≥n:</strong> 
                            <div style="margin-top: 0.5rem;">{{ item.pregunta.retroalimentacion|markdown|raw }}</div>
                        </div>
                    {% endif %}

                    {% if not esMunicipal and item.pregunta.articulo %}
                        {% if item.pregunta.articulo.explicacion or item.pregunta.articulo.textoLegal %}
                        <details style="margin-top: 1rem;">
                            <summary style="cursor: pointer; font-weight: bold; color: var(--color-primary);">Ver Informaci√≥n del Art√≠culo</summary>
                            <div style="margin-top: 0.5rem;">
                                <p><strong>Art√≠culo {{ item.pregunta.articulo.getNumeroCompleto() }} - {{ item.pregunta.ley.nombre }}</strong></p>
                                {% if item.pregunta.articulo.explicacion %}
                                <div style="background: #e3f2fd; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; border-left: 4px solid var(--color-secondary); line-height: 1.6;">
                                    <strong>Explicaci√≥n para el Opositor:</strong>
                                    <div style="margin-top: 0.5rem;">{{ item.pregunta.articulo.explicacion|markdown|raw }}</div>
                                </div>
                                {% endif %}
                                {% if item.pregunta.articulo.textoLegal %}
                                <div style="background: #fff3cd; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; border-left: 4px solid #ffc107; line-height: 1.6;">
                                    <strong>Texto Legal:</strong>
                                    <div style="margin-top: 0.5rem;">{{ item.pregunta.articulo.textoLegal|raw }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </details>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        {% endfor %}

        <div class="d-flex gap-2 mt-4">
            <a href="{{ path('app_examen_iniciar') }}" class="btn btn-primary">Nuevo Examen</a>
            <a href="{{ path('app_examen_historial') }}" class="btn btn-secondary">Ver Historial</a>
            <a href="{{ path('app_dashboard') }}" class="btn btn-secondary">Volver al Dashboard</a>
        </div>
    </div>
</div>

<style>
/* Estilos responsivos para m√≥viles (iPhone) */
@media (max-width: 768px) {
    /* Card principal */
    .card {
        margin: 0.5rem !important;
    }
    
    .card-header h1 {
        font-size: 1.3rem !important;
    }
    
    .card-body {
        padding: 1rem !important;
    }
    
    /* Nota destacada */
    .card-body > div[style*="text-align: center; padding: 2rem"] {
        padding: 1.5rem !important;
        margin-bottom: 1.5rem !important;
    }
    
    .card-body > div[style*="text-align: center; padding: 2rem"] h2 {
        font-size: 2.5rem !important;
    }
    
    /* Grid de estad√≠sticas */
    .card-body > div[style*="display: grid"] {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.75rem !important;
        margin-bottom: 1.5rem !important;
    }
    
    .card-body > div[style*="display: grid"] .card {
        margin: 0 !important;
    }
    
    .card-body > div[style*="display: grid"] .card-body h3 {
        font-size: 1.5rem !important;
    }
    
    .card-body > div[style*="display: grid"] .card-body p {
        font-size: 0.9rem !important;
    }
    
    /* Informaci√≥n de dificultad y temas */
    .mb-3, .mb-4 {
        font-size: 0.95rem !important;
        line-height: 1.6 !important;
    }
    
    .mb-4 .badge {
        display: inline-block !important;
        margin: 0.25rem 0.25rem 0.25rem 0 !important;
        font-size: 0.85rem !important;
    }
    
    /* T√≠tulo de detalle */
    h3[style*="margin-top: 2rem"] {
        font-size: 1.2rem !important;
        margin-top: 1.5rem !important;
    }
    
    /* Cards de preguntas */
    .card.mb-3 {
        margin-bottom: 1rem !important;
    }
    
    .card.mb-3 .card-body {
        padding: 1rem !important;
    }
    
    /* Header de pregunta */
    .card-body > div[style*="display: flex; justify-content: space-between"] {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.75rem !important;
    }
    
    .card-body > div[style*="display: flex; justify-content: space-between"] > div:first-child h4 {
        font-size: 1.1rem !important;
    }
    
    .card-body > div[style*="display: flex; justify-content: space-between"] > div:first-child > div {
        font-size: 0.7rem !important;
        margin-top: 0.5rem !important;
    }
    
    .card-body > div[style*="display: flex; justify-content: space-between"] > div:first-child > div span {
        display: block !important;
        margin: 0.25rem 0 !important;
    }
    
    /* Texto de pregunta */
    .card-body p strong {
        font-size: 1rem !important;
        line-height: 1.5 !important;
        word-wrap: break-word !important;
    }
    
    /* Opciones de respuesta */
    .card-body > div[style*="margin: 1rem 0"] > div {
        padding: 0.75rem !important;
        font-size: 0.9rem !important;
        line-height: 1.5 !important;
        word-wrap: break-word !important;
    }
    
    .card-body > div[style*="margin: 1rem 0"] > div span {
        display: block !important;
        margin-top: 0.5rem !important;
        font-size: 0.85rem !important;
    }
    
    /* Alertas y retroalimentaci√≥n */
    .alert {
        padding: 0.75rem !important;
        font-size: 0.9rem !important;
        line-height: 1.5 !important;
    }
    
    /* Details/Summary */
    details {
        font-size: 0.9rem !important;
    }
    
    details summary {
        font-size: 0.95rem !important;
        padding: 0.5rem !important;
    }
    
    details > div {
        padding: 0.75rem !important;
    }
    
    details > div > div {
        padding: 0.75rem !important;
        font-size: 0.9rem !important;
    }
    
    /* Botones de acci√≥n */
    .d-flex.gap-2.mt-4 {
        flex-direction: column !important;
        width: 100% !important;
    }
    
    .d-flex.gap-2.mt-4 a {
        width: 100% !important;
        padding: 0.75rem 1rem !important;
        font-size: 1rem !important;
        min-height: 48px !important;
        margin: 0 !important;
    }
    
    /* Asegurar que el texto no se desborde */
    * {
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
    }
    
    /* Botones m√°s grandes para facilitar el toque */
    button, .btn, a.btn {
        min-height: 48px !important;
        touch-action: manipulation !important;
    }
}

/* Estilos espec√≠ficos para iPhone (pantallas muy peque√±as) */
@media (max-width: 480px) {
    .card-header h1 {
        font-size: 1.2rem !important;
    }
    
    .card-body > div[style*="text-align: center; padding: 2rem"] h2 {
        font-size: 2rem !important;
    }
    
    .card-body > div[style*="display: grid"] {
        grid-template-columns: 1fr !important;
    }
    
    .card-body > div[style*="display: grid"] .card-body h3 {
        font-size: 1.3rem !important;
    }
    
    .card-body > div[style*="display: flex; justify-content: space-between"] > div:first-child h4 {
        font-size: 1rem !important;
    }
    
    .card-body p strong {
        font-size: 0.95rem !important;
    }
}
</style>
{% endblock %}

