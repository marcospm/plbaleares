{% extends 'base.html.twig' %}

{% block title %}Pregunta {{ numero }} de {{ total }}{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <h2 style="margin: 0; color: white;">Pregunta {{ numero }} de {{ total }}</h2>
            <div id="examen-timer-container" style="display: flex; align-items: center; gap: 0.75rem;">
                <div id="examen-timer" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                    <span style="font-size: 1.3rem;">‚è±Ô∏è</span>
                    <span id="timer-display">--:--</span>
                </div>
                <button id="timer-pause-btn" type="button" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.9rem;" title="Pausar/Reanudar temporizador">
                    ‚è∏Ô∏è Pausar
                </button>
            </div>
            <div style="flex: 1; min-width: 200px; margin: 0;">
                <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div id="progress-bar" style="background: var(--color-primary); height: 100%; width: {{ (numero / total * 100) }}%; transition: width 0.3s;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        {# Listado de preguntas - Navegaci√≥n r√°pida #}
        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 0.75rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-size: 0.85rem; color: #666; font-weight: 500;">üìã Navegaci√≥n r√°pida:</span>
                <span style="font-size: 0.75rem; color: #999;">(Haz clic en cualquier n√∫mero para ir a esa pregunta)</span>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 0.35rem; justify-content: flex-start;">
                {% for num, estado in estadoPreguntas %}
                    <a href="javascript:void(0);" 
                       data-pregunta-num="{{ num }}"
                       class="pregunta-link"
                       style="display: inline-flex; align-items: center; justify-content: center; 
                              min-width: 32px; height: 32px; 
                              border-radius: 4px; 
                              text-decoration: none; 
                              font-weight: 500; 
                              font-size: 0.8rem;
                              transition: all 0.2s;
                              cursor: pointer;
                              user-select: none;
                              {% if estado.esActual %}
                                  background: var(--color-primary);
                                  color: white;
                                  border: 2px solid var(--color-primary);
                                  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                  transform: scale(1.1);
                              {% elseif modoEstudio is defined and modoEstudio and estado.esCorrecta is not null %}
                                  {% if estado.esCorrecta %}
                                      background: #28a745;
                                      color: white;
                                      border: 2px solid #28a745;
                                  {% else %}
                                      background: #dc3545;
                                      color: white;
                                      border: 2px solid #dc3545;
                                  {% endif %}
                              {% elseif estado.tieneRespuesta %}
                                  background: #28a745;
                                  color: white;
                                  border: 2px solid #28a745;
                              {% else %}
                                  background: white;
                                  color: #666;
                                  border: 2px solid #dee2e6;
                              {% endif %}"
                       onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)';"
                       onmouseout="this.style.transform='{% if estado.esActual %}scale(1.1){% else %}scale(1){% endif %}'; this.style.boxShadow='{% if estado.esActual %}0 2px 4px rgba(0,0,0,0.2){% else %}none{% endif %}';">
                        {{ num }}
                    </a>
                {% endfor %}
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.75rem; color: #666; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 0.4rem;">
                    <span style="display: inline-block; width: 14px; height: 14px; background: var(--color-primary); border-radius: 3px; border: 2px solid var(--color-primary);"></span>
                    <span>Actual</span>
                </div>
                {% if modoEstudio is defined and modoEstudio %}
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                        <span style="display: inline-block; width: 14px; height: 14px; background: #28a745; border-radius: 3px; border: 2px solid #28a745;"></span>
                        <span>Correcta</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                        <span style="display: inline-block; width: 14px; height: 14px; background: #dc3545; border-radius: 3px; border: 2px solid #dc3545;"></span>
                        <span>Incorrecta</span>
                    </div>
                {% else %}
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                        <span style="display: inline-block; width: 14px; height: 14px; background: #28a745; border-radius: 3px; border: 2px solid #28a745;"></span>
                        <span>Respondida</span>
                    </div>
                {% endif %}
                <div style="display: flex; align-items: center; gap: 0.4rem;">
                    <span style="display: inline-block; width: 14px; height: 14px; background: white; border-radius: 3px; border: 2px solid #dee2e6;"></span>
                    <span>Sin responder</span>
                </div>
            </div>
        </div>
        {% if esMunicipal is defined and esMunicipal %}
            <div class="mb-3" style="padding: 1rem; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid #2196F3; border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">üèõÔ∏è</span>
                    <strong style="color: #1565C0;">Tipo de Examen:</strong> 
                    <span class="badge" style="background-color: #2196F3; color: white; padding: 0.5rem 1rem; font-size: 0.95rem; font-weight: bold;">EXAMEN MUNICIPAL</span>
                </div>
            </div>
        {% else %}
            <div class="mb-3" style="padding: 0.75rem; background: linear-gradient(135deg, #f1f8f4 0%, #c8e6c9 100%); border-left: 4px solid #4CAF50; border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                        <span style="font-size: 1rem;">üìö</span>
                        <strong style="color: #2E7D32; font-size: 0.9rem;">Tipo de Examen:</strong> 
                        <span class="badge" style="background-color: #4CAF50; color: white; padding: 0.25rem 0.75rem; font-size: 0.85rem; font-weight: bold;">TEMARIO GENERAL</span>
                    </div>
                    {% if porcentajesPorTema|length > 0 %}
                        <button type="button" class="btn btn-sm btn-info" id="btnVerPorcentajes" style="font-size: 0.85rem; padding: 0.4rem 1rem;" onclick="event.stopPropagation(); return false;">
                            üìä Ver % por Tema
                        </button>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {# Informaci√≥n Legal: Tema, Ley y Art√≠culo en secci√≥n amarilla - Organizado verticalmente #}
        {% if not esMunicipal is defined or not esMunicipal %}
            {% set esTema17 = (pregunta.tema is defined and pregunta.tema and ('Tema 17' in pregunta.tema.nombre or 'accidente de tr√°fico' in pregunta.tema.nombre|lower)) or (pregunta.ley is defined and pregunta.ley and pregunta.ley.nombre == 'Accidentes de Tr√°fico') %}
            {% if pregunta.ley is defined and pregunta.ley or (pregunta.articulo is defined and pregunta.articulo and not esTema17) or (pregunta.tema is defined and pregunta.tema) %}
                <div class="form-group mb-3" id="informacion-pregunta">
                    <div style="padding: 0.75rem 1rem; background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 4px solid #ffc107; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="color: #856404; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(133, 100, 4, 0.2); padding-bottom: 0.5rem; margin-bottom: 0.25rem;">
                            üìã Informaci√≥n de la pregunta
                        </div>
                        {% if pregunta.tema is defined and pregunta.tema %}
                            <div style="color: #856404; font-size: 0.9rem; font-weight: 500;">üè∑Ô∏è <strong>{{ pregunta.tema.nombre }}</strong></div>
                        {% endif %}
                        {% if pregunta.ley is defined and pregunta.ley %}
                            <div style="color: #856404; font-size: 0.9rem; font-weight: 600;">üìú {{ pregunta.ley.nombre }}</div>
                        {% endif %}
                        {% if pregunta.articulo is defined and pregunta.articulo and not esTema17 and pregunta.articulo.numero != 0 %}
                            <div style="color: #856404; font-size: 0.9rem; font-weight: 600;">
                                üìÑ Art. {{ pregunta.articulo.getNumeroCompleto() }}
                                {% if pregunta.articulo.nombre %}
                                    - {{ pregunta.articulo.nombre }}
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        {# Checkbox "Me la juego" #}
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(133, 100, 4, 0.2);">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #856404; font-size: 0.95rem; font-weight: 500;">
                                    <input 
                                        type="checkbox" 
                                        id="me_la_juego"
                                        {% if preguntaMarcadaComoRiesgo is defined and preguntaMarcadaComoRiesgo %}checked{% endif %}
                                        style="width: 18px; height: 18px; cursor: pointer; accent-color: #ffc107;"
                                        onchange="actualizarCheckboxRiesgo(this);"
                                    >
                                    <span>üé≤ Me la juego</span>
                                </label>
                                <span style="color: #856404; font-size: 0.75rem; opacity: 0.8; font-style: italic;">Se guarda para ver tu porcentaje de acierto</span>
                            </div>
                        </div>
                        
                        {# Porcentajes de acierto por tema para preguntas de riesgo - SOLO del tema actual #}
                        {% if porcentajesRiesgoPorTema is defined and porcentajesRiesgoPorTema|length > 0 %}
                            {% if not esMunicipal %}
                                {# Para temas generales, mostrar solo el porcentaje del tema de la pregunta actual #}
                                {% if pregunta.tema %}
                                    {% set temaIdActual = pregunta.tema.id %}
                                    {% if porcentajesRiesgoPorTema[temaIdActual] is defined %}
                                        {% set porcentaje = porcentajesRiesgoPorTema[temaIdActual] %}
                                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(133, 100, 4, 0.2);">
                                            <div style="color: #856404; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">
                                                üìä % Acierto (Preguntas de Riesgo)
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; flex-wrap: wrap; gap: 0.5rem;">
                                                <span style="color: #856404;">{{ pregunta.tema.nombre }}:</span>
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <span style="font-weight: 600; color: {% if porcentaje >= 70 %}#28a745{% elseif porcentaje >= 50 %}#ffc107{% else %}#dc3545{% endif %};">
                                                        {{ porcentaje|number_format(1, ',', '.') }}%
                                                    </span>
                                                    <span style="color: #856404; font-size: 0.75rem; opacity: 0.8; font-style: italic;">(es tu porcentaje de acierto de este tema de las preguntas marcadas como riesgo)</span>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                {# Para municipales, mostrar porcentajes por tema municipal #}
                                {% if pregunta.temaMunicipal %}
                                    {% set temaMunicipalId = pregunta.temaMunicipal.id %}
                                    {% if porcentajesRiesgoPorTema[temaMunicipalId] is defined %}
                                        {% set porcentaje = porcentajesRiesgoPorTema[temaMunicipalId] %}
                                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(133, 100, 4, 0.2);">
                                            <div style="color: #856404; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">
                                                üìä % Acierto (Preguntas de Riesgo)
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; flex-wrap: wrap; gap: 0.5rem;">
                                                <span style="color: #856404;">{{ pregunta.temaMunicipal.nombre }}:</span>
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <span style="font-weight: 600; color: {% if porcentaje >= 70 %}#28a745{% elseif porcentaje >= 50 %}#ffc107{% else %}#dc3545{% endif %};">
                                                        {{ porcentaje|number_format(1, ',', '.') }}%
                                                    </span>
                                                    <span style="color: #856404; font-size: 0.75rem; opacity: 0.8; font-style: italic;">(es tu porcentaje de acierto de este tema de las preguntas marcadas como riesgo)</span>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% elseif pregunta.temaMunicipal is defined and pregunta.temaMunicipal %}
            {# Para municipales, mostrar solo el tema en una secci√≥n similar #}
            <div class="form-group mb-3" id="informacion-pregunta">
                <div style="padding: 0.75rem 1rem; background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 4px solid #ffc107; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 0.75rem;">
                    <div style="color: #856404; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(133, 100, 4, 0.2); padding-bottom: 0.5rem; margin-bottom: 0.25rem;">
                        üìã Informaci√≥n de la pregunta
                    </div>
                    <span style="color: #856404; font-size: 0.9rem; font-weight: 500;">üè∑Ô∏è <strong>{{ pregunta.temaMunicipal.nombre }}</strong></span>
                    
                    {# Checkbox "Me la juego" #}
                    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(133, 100, 4, 0.2);">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #856404; font-size: 0.95rem; font-weight: 500;">
                                <input 
                                    type="checkbox" 
                                    id="me_la_juego_municipal"
                                    {% if preguntaMarcadaComoRiesgo is defined and preguntaMarcadaComoRiesgo %}checked{% endif %}
                                    style="width: 18px; height: 18px; cursor: pointer; accent-color: #ffc107;"
                                    onchange="actualizarCheckboxRiesgo(this);"
                                >
                                <span>üé≤ Me la juego</span>
                            </label>
                            <span style="color: #856404; font-size: 0.75rem; opacity: 0.8; font-style: italic;">Se guarda para ver tu porcentaje de acierto</span>
                        </div>
                    </div>
                    
                    {# Porcentajes de acierto por tema municipal para preguntas de riesgo - SOLO del tema actual #}
                    {% if porcentajesRiesgoPorTema is defined and porcentajesRiesgoPorTema|length > 0 %}
                        {% if pregunta.temaMunicipal %}
                            {% set temaMunicipalId = pregunta.temaMunicipal.id %}
                            {% if porcentajesRiesgoPorTema[temaMunicipalId] is defined %}
                                {% set porcentaje = porcentajesRiesgoPorTema[temaMunicipalId] %}
                                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(133, 100, 4, 0.2);">
                                    <div style="color: #856404; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">
                                        üìä % Acierto (Preguntas de Riesgo)
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
                                        <span style="color: #856404;">{{ pregunta.temaMunicipal.nombre }}:</span>
                                        <span style="font-weight: 600; color: {% if porcentaje >= 70 %}#28a745{% elseif porcentaje >= 50 %}#ffc107{% else %}#dc3545{% endif %};">
                                            {{ porcentaje|number_format(1, ',', '.') }}%
                                        </span>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {# Pregunta #}
        <div class="form-group mb-4" id="pregunta-texto">
            <h3 style="color: var(--color-primary); margin-bottom: 1rem;"><span style="font-weight: 600;">Pregunta {{ numero }}:</span> {{ pregunta.texto }}</h3>
        </div>

        <form method="post" action="{{ path('app_examen_pregunta', {'numero': numero}) }}" id="formPregunta">
            {# Input hidden para sincronizar el checkbox "Me la juego" que est√° fuera del formulario #}
            <input type="hidden" name="me_la_juego" id="me_la_juego_hidden" value="{% if preguntaMarcadaComoRiesgo is defined and preguntaMarcadaComoRiesgo %}1{% else %}0{% endif %}">
            <div class="form-group">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    {% set opciones = {'A': pregunta.opcionA, 'B': pregunta.opcionB, 'C': pregunta.opcionC, 'D': pregunta.opcionD} %}
                    {% set mostrarRespuestas = (modoEstudio is defined and modoEstudio and preguntaBloqueada is defined and preguntaBloqueada and respuestaCorrecta is defined and respuestaCorrecta is not null and respuestaCorrecta != '') %}
                    {# Determinar si la respuesta del alumno es correcta #}
                    {% set respuestaCorrectaStr = mostrarRespuestas ? (respuestaCorrecta|trim|upper) : '' %}
                    {% set respuestaAlumnoStr = respuestaActual ? (respuestaActual|trim|upper) : '' %}
                    {% set alumnoAcerto = mostrarRespuestas and respuestaCorrectaStr == respuestaAlumnoStr %}
                    {% set alumnoErro = mostrarRespuestas and respuestaAlumnoStr != '' and respuestaCorrectaStr != respuestaAlumnoStr %}
                    {% set alumnoNoContesto = mostrarRespuestas and respuestaAlumnoStr == '' %}
                    {% for letra, texto in opciones %}
                        {% set esSeleccionada = (respuestaActual == letra) %}
                        {# Comparar respuestaCorrecta con letra, asegurando que ambos sean strings y comparando directamente #}
                        {% set esCorrecta = false %}
                        {% if mostrarRespuestas %}
                            {% set letraStr = letra|trim|upper %}
                            {% if respuestaCorrectaStr == letraStr %}
                                {% set esCorrecta = true %}
                            {% endif %}
                        {% endif %}
                        {# En modo estudio, solo marcar como incorrecta la opci√≥n que el alumno seleccion√≥ si es incorrecta #}
                        {% set esIncorrecta = false %}
                        {% if mostrarRespuestas %}
                            {% set letraStr = letra|trim|upper %}
                            {# Solo marcar como incorrecta si el alumno la seleccion√≥ Y es incorrecta #}
                            {% if esSeleccionada and letraStr == respuestaAlumnoStr and not esCorrecta %}
                                {% set esIncorrecta = true %}
                            {% endif %}
                        {% endif %}
                        {# Determinar si es la respuesta correcta y fue seleccionada (acierto) #}
                        {% set esCorrectaYSeleccionada = esCorrecta and esSeleccionada %}
                        
                        <label style="display: flex; align-items: start; padding: 1rem; border: 2px solid var(--color-border); border-radius: 4px; cursor: {% if preguntaBloqueada is defined and preguntaBloqueada %}not-allowed{% else %}pointer{% endif %}; transition: all 0.3s; 
                               {% if esCorrecta %}background: #e8f5e9 !important; border-left: 3px solid var(--color-success) !important;{% elseif esIncorrecta %}background: #ffebee !important; border-left: 3px solid var(--color-danger) !important;{% elseif esSeleccionada and not mostrarRespuestas %}background: #e3f2fd; border-color: var(--color-primary);{% endif %}
                               {% if preguntaBloqueada is defined and preguntaBloqueada and not esCorrecta and not esIncorrecta %}opacity: 0.7;{% endif %}">
                            <input type="radio" name="respuesta" value="{{ letra }}" 
                                   style="margin-right: 1rem; margin-top: 0.25rem;" 
                                   {% if esSeleccionada %}checked{% endif %}
                                   {% if preguntaBloqueada is defined and preguntaBloqueada %}disabled{% endif %}
                                   data-opcion="{{ letra }}">
                            <div style="flex: 1;">
                                <strong style="color: var(--color-primary);">{{ letra }})</strong> {{ texto }}
                                {% if mostrarRespuestas %}
                                    {% if esCorrectaYSeleccionada %}
                                        <span style="display: block; margin-top: 0.5rem; color: var(--color-success); font-weight: bold;">‚Üê Tu respuesta (correcta)</span>
                                    {% elseif esIncorrecta %}
                                        <span style="display: block; margin-top: 0.5rem; color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>
                                    {% endif %}
                                    {% if esCorrecta %}
                                        {% if not esCorrectaYSeleccionada %}
                                            <span style="display: block; margin-top: 0.5rem; color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </div>
                        </label>
                    {% endfor %}
                </div>
                
                {# Bot√≥n Anular Respuesta - Solo disponible cuando NO est√° en modo estudio #}
                {% if not (modoEstudio is defined and modoEstudio) %}
                <div id="btnAnularRespuestaContainer" style="margin-top: 1rem; display: {% if respuestaActual %}flex{% else %}none{% endif %}; justify-content: center;">
                    <button type="button" id="btnAnularRespuesta" class="btn btn-outline-danger" style="padding: 0.75rem 1.5rem; font-size: 1rem; border-radius: 8px; transition: all 0.2s; min-height: 44px; touch-action: manipulation;">
                        <span style="margin-right: 0.5rem;">‚Ü∫</span> Anular Respuesta
                    </button>
                </div>
                {% endif %}
                
                {# Mostrar retroalimentaci√≥n en modo estudio cuando la pregunta est√° bloqueada (despu√©s de responder) #}
                {% if modoEstudio is defined and modoEstudio and preguntaBloqueada is defined and preguntaBloqueada %}
                    {% if retroalimentacion %}
                    <div id="retroalimentacion-container" style="margin-top: 1.5rem; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px; overflow: hidden;">
                        <div class="collapsible-header" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; cursor: pointer; user-select: none; transition: background-color 0.2s;" onclick="toggleCollapsible('retroalimentacion-content', 'retroalimentacion-arrow')" onmouseover="this.style.backgroundColor='rgba(33,150,243,0.1)'" onmouseout="this.style.backgroundColor='transparent'">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üí°</span>
                                <strong style="color: #1565C0;">Retroalimentaci√≥n:</strong>
                            </div>
                            <span id="retroalimentacion-arrow" style="font-size: 1.2rem; transition: transform 0.3s; color: #1565C0;">‚ñº</span>
                        </div>
                        <div id="retroalimentacion-content" class="collapsible-content" style="display: none; padding: 0 1rem 1rem 1rem; color: #333; line-height: 1.6;">{{ retroalimentacion|markdown|raw }}</div>
                    </div>
                    {% endif %}
                    
                    {# Mostrar explicaci√≥n y texto legal del art√≠culo #}
                    {% if not esMunicipal is defined or not esMunicipal %}
                        {% if pregunta.articulo and (pregunta.articulo.explicacion or pregunta.articulo.textoLegal) %}
                        <div style="margin-top: 1.5rem;">
                            {% if pregunta.articulo.explicacion %}
                            <div style="background: #e3f2fd; border-left: 4px solid var(--color-secondary); border-radius: 4px; margin-bottom: 0.5rem; overflow: hidden;">
                                <div class="collapsible-header" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; cursor: pointer; user-select: none; transition: background-color 0.2s;" onclick="toggleCollapsible('explicacion-content', 'explicacion-arrow')" onmouseover="this.style.backgroundColor='rgba(33,150,243,0.1)'" onmouseout="this.style.backgroundColor='transparent'">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1.2rem;">üìñ</span>
                                        <strong style="color: #1565C0;">Explicaci√≥n para el Opositor:</strong>
                                    </div>
                                    <span id="explicacion-arrow" style="font-size: 1.2rem; transition: transform 0.3s; color: #1565C0;">‚ñº</span>
                                </div>
                                <div id="explicacion-content" class="collapsible-content" style="display: none; padding: 0 1rem 1rem 1rem; color: #333; line-height: 1.6;">{{ pregunta.articulo.explicacion|markdown|raw }}</div>
                            </div>
                            {% endif %}
                            
                            {% if pregunta.articulo.textoLegal %}
                            <div style="background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; overflow: hidden;">
                                <div class="collapsible-header" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; cursor: pointer; user-select: none; transition: background-color 0.2s;" onclick="toggleCollapsible('texto-legal-content', 'texto-legal-arrow')" onmouseover="this.style.backgroundColor='rgba(255,193,7,0.1)'" onmouseout="this.style.backgroundColor='transparent'">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1.2rem;">‚öñÔ∏è</span>
                                        <strong style="color: #856404;">Texto Legal:</strong>
                                    </div>
                                    <span id="texto-legal-arrow" style="font-size: 1.2rem; transition: transform 0.3s; color: #856404;">‚ñº</span>
                                </div>
                                <div id="texto-legal-content" class="collapsible-content" style="display: none; padding: 0 1rem 1rem 1rem; color: #333; line-height: 1.6;">{{ pregunta.articulo.textoLegal|raw }}</div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>

            <div class="d-flex gap-2 mt-4">
                {% if not esPrimera %}
                    <button type="submit" name="accion" value="anterior" class="btn btn-secondary">Anterior</button>
                {% endif %}
                {% if not esUltima %}
                    <button type="submit" name="accion" value="siguiente" class="btn btn-primary">Siguiente</button>
                {% endif %}
                {# Bot√≥n Finalizar Examen siempre visible #}
                <button type="submit" name="accion" value="finalizar" class="btn btn-success" onclick="return confirm('¬øEst√°s seguro de que deseas finalizar el examen?');">Finalizar Examen</button>
                <button type="submit" name="accion" value="guardar_borrador" class="btn btn-secondary" id="btnGuardarBorrador" style="margin-left: auto;">üíæ Guardar y continuar m√°s tarde</button>
            </div>
        </form>


        {% if is_granted('ROLE_USER') and not is_granted('ROLE_PROFESOR') and not is_granted('ROLE_ADMIN') %}
        <div style="margin-top: 2rem; border-top: 2px solid #ddd; padding-top: 1.5rem;">
            <div class="d-flex gap-2 align-items-center mb-3">
                <button type="button" class="btn btn-info position-relative btn-sm" id="btnVerMensajes" data-pregunta-id="{{ pregunta.id }}">
                    <span>üí¨ Ver Mensajes</span>
                    <span class="badge bg-danger position-absolute top-0 start-100 translate-middle" id="contadorMensajes" style="display: none; font-size: 0.65rem; padding: 0.2rem 0.4rem; color: white;">0</span>
                </button>
            </div>
            
            <div class="card" style="border-left: 4px solid #FF9800; max-width: 500px;">
                <div class="card-header" style="background-color: #fff3cd; padding: 0.75rem;">
                    <h5 style="margin: 0; color: #856404; font-size: 0.9rem;">‚ö†Ô∏è Reportar Error en esta Pregunta</h5>
                </div>
                <div class="card-body" style="padding: 1rem;">
                    <form method="post" id="formReportePregunta" data-pregunta-id="{{ pregunta.id }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('reportar_error_pregunta_' ~ pregunta.id) }}">
                        <div class="form-group mb-2">
                            <textarea name="mensaje" class="form-control" rows="3" placeholder="Describe el error que encontraste en esta pregunta..." required style="width: 100%; font-size: 0.85rem;"></textarea>
                            <small style="color: #666; font-size: 0.7rem;">Los profesores y administradores ser√°n notificados de tu solicitud.</small>
                        </div>
                        <button type="submit" class="btn btn-warning btn-sm">Enviar Reporte</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para mostrar mensajes -->
        <div id="modalMensajesPregunta" style="display: none; position: fixed; z-index: 99999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto;">
            <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; border-radius: 8px; width: 90%; max-width: 800px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); max-height: 80vh; display: flex; flex-direction: column; position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: var(--color-primary); font-size: 1.1rem;">üí¨ Mensajes sobre esta Pregunta</h3>
                    <span id="cerrarModalMensajesPregunta" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; user-select: none;" onclick="cerrarModalMensajesPregunta()">&times;</span>
                </div>
                <div id="contenidoMensajesPregunta" style="padding: 1.5rem; overflow-y: auto; flex: 1; min-height: 200px;">
                    <div style="text-align: center; padding: 2rem;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 1rem; color: #666;">Cargando...</p>
                    </div>
                </div>
                <div style="padding: 1rem; border-top: 1px solid #ddd; text-align: right;">
                    <button onclick="cerrarModalMensajesPregunta()" class="btn btn-secondary btn-sm">Cerrar</button>
                </div>
            </div>
        </div>

        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>

        <script>
        (function() {
            'use strict';
            let contenidoMensajesPregunta = null;
            let contadorMensajesPregunta = null;
            const preguntaId = {{ pregunta.id }};

        function cargarMensajesPregunta() {
            if (!contenidoMensajesPregunta) {
                contenidoMensajesPregunta = document.getElementById('contenidoMensajesPregunta');
            }
            
            if (!contenidoMensajesPregunta) {
                console.error('No se encontr√≥ el elemento contenidoMensajesPregunta');
                return;
            }
            
            contenidoMensajesPregunta.innerHTML = '<div style="text-align: center; padding: 2rem;"><div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 1rem; color: #666;">Cargando...</p></div>';
            
            fetch(`/pregunta/${preguntaId}/mensajes`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.mensajes && data.mensajes.length === 0) {
                        contenidoMensajesPregunta.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No hay mensajes a√∫n sobre esta pregunta.</p>';
                    } else if (data.mensajes) {
                        let html = '<div style="display: grid; gap: 1rem;">';
                        data.mensajes.forEach(function(mensaje) {
                            const autor = mensaje.autor || 'Usuario eliminado';
                            const fecha = mensaje.fechaCreacion || '';
                            const mensajeTexto = mensaje.mensaje || '';
                            const esProfesor = mensaje.esProfesor || false;
                            const mensajeId = mensaje.id;
                            const respuestas = mensaje.respuestas || [];
                            const tieneRespuestas = mensaje.tieneRespuestas || false;
                            
                            const borderColor = esProfesor ? '#28a745' : 'var(--color-primary)';
                            const bgColor = esProfesor ? '#f0f9f4' : '#fff';
                            const badgeColor = esProfesor ? '#28a745' : 'var(--color-primary)';
                            
                            html += `
                                <div style="padding: 1rem; border: 1px solid #ddd; border-left: 4px solid ${borderColor}; border-radius: 4px; background-color: ${bgColor}; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <strong style="color: ${badgeColor}; font-size: 0.9rem;">
                                                ${autor}
                                                ${esProfesor ? '<span style="background-color: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 0.5rem;">Profesor</span>' : '<span style="background-color: var(--color-primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 0.5rem;">Alumno</span>'}
                                            </strong>
                                        </div>
                                        <small style="color: #999; font-size: 0.8rem;">${fecha}</small>
                                    </div>
                                    <p style="margin: 0 0 1rem 0; color: #333; white-space: pre-wrap; line-height: 1.5; font-size: 0.9rem;">${mensajeTexto}</p>
                                    
                                    ${tieneRespuestas ? `
                                        <div style="margin-left: 1rem; margin-top: 1rem; padding-left: 1rem; border-left: 3px solid #ddd;">
                                            <strong style="color: #666; font-size: 0.85rem; margin-bottom: 0.5rem; display: block;">Respuestas:</strong>
                                    ` : ''}
                                    
                                    ${respuestas.map(function(respuesta) {
                                        const respuestaEsProfesor = respuesta.esProfesor || false;
                                        const respuestaBorderColor = respuestaEsProfesor ? '#28a745' : 'var(--color-primary)';
                                        const respuestaBgColor = respuestaEsProfesor ? '#f0f9f4' : '#fff';
                                        return `
                                            <div style="padding: 0.75rem; border: 1px solid #ddd; border-left: 4px solid ${respuestaBorderColor}; border-radius: 4px; background-color: ${respuestaBgColor}; margin-bottom: 0.75rem;">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                    <strong style="color: ${respuestaBorderColor}; font-size: 0.85rem;">
                                                        ${respuesta.autor}
                                                        ${respuestaEsProfesor ? '<span style="background-color: #28a745; color: white; padding: 2px 6px; border-radius: 12px; font-size: 0.65rem; margin-left: 0.5rem;">Profesor</span>' : ''}
                                                    </strong>
                                                    <small style="color: #999; font-size: 0.8rem;">${respuesta.fechaCreacion}</small>
                                                </div>
                                                <p style="margin: 0; color: #333; white-space: pre-wrap; line-height: 1.5; font-size: 0.85rem;">${respuesta.mensaje}</p>
                                            </div>
                                        `;
                                    }).join('')}
                                    
                                    ${tieneRespuestas ? '</div>' : ''}
                                </div>
                            `;
                        });
                        html += '</div>';
                        contenidoMensajesPregunta.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    contenidoMensajesPregunta.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 2rem;">Error al cargar los mensajes.</p>';
                });
        }

        function abrirModalMensajesPregunta(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            const modal = document.getElementById('modalMensajesPregunta');
            if (modal) {
                modal.style.display = 'block';
                cargarMensajesPregunta();
            } else {
                console.error('No se encontr√≥ el modal modalMensajesPregunta');
            }
        }

        function cerrarModalMensajesPregunta() {
            const modal = document.getElementById('modalMensajesPregunta');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Cerrar modal al hacer clic fuera de √©l
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('modalMensajesPregunta');
            if (modal && event.target == modal) {
                cerrarModalMensajesPregunta();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const btnVerMensajes = document.getElementById('btnVerMensajes');
            contadorMensajesPregunta = document.getElementById('contadorMensajes');
            contenidoMensajesPregunta = document.getElementById('contenidoMensajesPregunta');
            const formReporte = document.getElementById('formReportePregunta');
            
            function cargarContador() {
                fetch(`/pregunta/${preguntaId}/contador-mensajes`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (contadorMensajesPregunta) {
                            if (data.contador > 0) {
                                contadorMensajesPregunta.textContent = data.contador;
                                contadorMensajesPregunta.style.display = 'inline-block';
                            } else {
                                contadorMensajesPregunta.style.display = 'none';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error al cargar contador:', error);
                    });
            }

            if (btnVerMensajes) {
                btnVerMensajes.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    abrirModalMensajesPregunta(e);
                });
            } else {
                console.warn('No se encontr√≥ el bot√≥n btnVerMensajes');
            }

            if (formReporte) {
                formReporte.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const formData = new FormData(formReporte);
                    const submitBtn = formReporte.querySelector('button[type="submit"]');
                    const originalText = submitBtn ? submitBtn.textContent : 'Enviar Reporte';
                    
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Enviando...';
                    }
                    
                    fetch(`/pregunta/${preguntaId}/reportar-error`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Mostrar mensaje de √©xito sin alert
                            const mensajeExito = document.createElement('div');
                            mensajeExito.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 1rem; border-radius: 4px; z-index: 100000; box-shadow: 0 4px 6px rgba(0,0,0,0.3);';
                            mensajeExito.textContent = '‚úì Error reportado correctamente. Los profesores han sido notificados.';
                            document.body.appendChild(mensajeExito);
                            setTimeout(() => mensajeExito.remove(), 3000);
                            
                            // Limpiar formulario
                            const textarea = formReporte.querySelector('[name="mensaje"]');
                            if (textarea) {
                                textarea.value = '';
                            }
                            
                            // Recargar contador y mensajes
                            setTimeout(cargarContador, 500);
                            if (document.getElementById('modalMensajesPregunta') && document.getElementById('modalMensajesPregunta').style.display === 'block') {
                                setTimeout(cargarMensajesPregunta, 500);
                            }
                        } else {
                            alert(data.error || 'Error al enviar el reporte.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al enviar el reporte. Por favor, int√©ntalo de nuevo.');
                    })
                    .finally(() => {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    });
                });
            } else {
                console.warn('No se encontr√≥ el formulario formReportePregunta');
            }

            cargarContador();
        });
        
        // Exponer funciones necesarias globalmente
        window.abrirModalMensajesPregunta = abrirModalMensajesPregunta;
        window.cerrarModalMensajesPregunta = cerrarModalMensajesPregunta;
        })();
        </script>
        {% endif %}

        <!-- Modal para mostrar porcentajes por tema -->
        {% if porcentajesPorTema|length > 0 %}
        <div id="modalPorcentajes" style="display: none; position: fixed; z-index: 99999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto;">
            <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: var(--color-primary); font-size: 1.2rem;">üìä Distribuci√≥n de Preguntas por Tema</h3>
                    <span id="cerrarModalPorcentajes" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; user-select: none;" onclick="cerrarModalPorcentajes()">&times;</span>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="display: grid; gap: 0.75rem;">
                        {% for temaId, datos in porcentajesPorTema %}
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; border-left: 4px solid var(--color-primary);">
                                <div>
                                    <strong style="color: #333;">{{ datos.nombre }}</strong>
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">{{ datos.cantidad }} pregunta{{ datos.cantidad != 1 ? 's' : '' }}</div>
                                </div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--color-primary);">
                                    {{ datos.porcentaje }}%
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div style="padding: 1rem; border-top: 1px solid #ddd; text-align: right;">
                    <button onclick="cerrarModalPorcentajes()" class="btn btn-secondary btn-sm">Cerrar</button>
                </div>
            </div>
        </div>

        <script>
        function abrirModalPorcentajes() {
            const modal = document.getElementById('modalPorcentajes');
            if (!modal) {
                console.error('No se encontr√≥ el modal modalPorcentajes');
                return;
            }
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function cerrarModalPorcentajes() {
            const modal = document.getElementById('modalPorcentajes');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // Cerrar modal al hacer clic fuera de √©l
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalPorcentajes');
            if (modal && event.target === modal) {
                cerrarModalPorcentajes();
            }
        });

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('modalPorcentajes');
                if (modal && modal.style.display === 'block') {
                    cerrarModalPorcentajes();
                }
            }
        });

        // Funci√≥n para inicializar el bot√≥n (se ejecuta tanto en carga inicial como en navegaciones Turbo)
        function inicializarBotonPorcentajes() {
            const btnVerPorcentajes = document.getElementById('btnVerPorcentajes');
            if (btnVerPorcentajes) {
                // Verificar si ya tiene un listener asignado para evitar duplicados
                if (!btnVerPorcentajes.dataset.listenerAsignado) {
                    btnVerPorcentajes.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        abrirModalPorcentajes();
                        return false;
                    });
                    btnVerPorcentajes.dataset.listenerAsignado = 'true';
                }
            } else {
                console.warn('No se encontr√≥ el bot√≥n btnVerPorcentajes');
            }
            
            // Tambi√©n asignar la funci√≥n global para el onclick del span de cerrar
            window.cerrarModalPorcentajes = cerrarModalPorcentajes;
        }

        // Ejecutar en carga inicial
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarBotonPorcentajes);
        } else {
            // Si el DOM ya est√° cargado, ejecutar inmediatamente
            inicializarBotonPorcentajes();
        }

        // Ejecutar tambi√©n en navegaciones de Turbo
        document.addEventListener('turbo:load', inicializarBotonPorcentajes);
        document.addEventListener('turbo:frame-load', inicializarBotonPorcentajes);
        </script>
        {% endif %}

        {# Script para modo estudio y temporizador #}
        <script>
        // Funci√≥n global para actualizar checkbox de riesgo usando AJAX
        window.actualizarCheckboxRiesgo = function(checkbox) {
            const form = document.getElementById('formPregunta');
            const hidden = document.getElementById('me_la_juego_hidden');
            
            if (!form || !checkbox) {
                return;
            }
            
            // Actualizar el input hidden para sincronizar
            if (hidden) {
                hidden.value = checkbox.checked ? '1' : '0';
            }
            
            // Crear FormData del formulario
            const formData = new FormData(form);
            
            // Asegurar que me_la_juego est√© en el FormData
            formData.set('me_la_juego', checkbox.checked ? '1' : '0');
            
            // Enviar petici√≥n AJAX
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                // Verificar el Content-Type de la respuesta
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // Si no es JSON, puede ser un error HTML
                    return response.text().then(text => {
                        throw new Error('El servidor devolvi√≥ HTML en lugar de JSON. Esto puede ser un error de CSRF o validaci√≥n.');
                    });
                }
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Error en la respuesta del servidor: ' + response.status);
            })
            .then(data => {
                if (data && data.success) {
                    // Checkbox actualizado correctamente, no recargar la p√°gina
                    console.log('Checkbox de riesgo actualizado:', data.esRiesgo);
                }
            })
            .catch(error => {
                console.error('Error al actualizar checkbox de riesgo:', error);
                // Si hay error, revertir el estado del checkbox
                checkbox.checked = !checkbox.checked;
            });
        };
        
        // Funci√≥n global para plegar/desplegar secciones
        function toggleCollapsible(contentId, arrowId) {
            const content = document.getElementById(contentId);
            const arrow = document.getElementById(arrowId);
            
            if (!content || !arrow) {
                return;
            }
            
            const isHidden = content.style.display === 'none' || content.style.display === '';
            
            if (isHidden) {
                // Desplegar
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
                arrow.textContent = '‚ñ≤';
            } else {
                // Plegar
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
                arrow.textContent = '‚ñº';
            }
        }
        
        (function() {
            'use strict';
            
            // Funci√≥n para hacer scroll a la pregunta (siempre activa)
            function scrollToPregunta() {
                const preguntaElement = document.getElementById('pregunta-texto');
                if (preguntaElement) {
                    // Obtener la posici√≥n del elemento
                    const elementPosition = preguntaElement.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - 100; // 100px de offset desde arriba
                    
                    // Hacer scroll suave
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            }
            
            // Hacer scroll a la pregunta al cargar (siempre, no solo en modo estudio)
            // Intentar hacer scroll inmediatamente si el DOM ya est√° listo
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                // Esperar un poco m√°s para asegurar que todo est√© renderizado
                setTimeout(scrollToPregunta, 300);
            } else {
                // Si a√∫n se est√° cargando, esperar al DOMContentLoaded
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(scrollToPregunta, 300);
                });
            }
            
            // Tambi√©n intentar despu√©s de que la ventana se cargue completamente
            window.addEventListener('load', function() {
                setTimeout(scrollToPregunta, 200);
            });
            
            // Modo estudio: manejar selecci√≥n de respuesta
            {% if modoEstudio is defined and modoEstudio %}
            const modoEstudioActivo = true;
            let preguntaBloqueada = {{ preguntaBloqueada is defined and preguntaBloqueada ? 'true' : 'false' }};
            const preguntaId = {{ pregunta.id }};
            
            if (!preguntaBloqueada) {
                // Agregar listeners a los radio buttons
                const radioButtons = document.querySelectorAll('input[name="respuesta"]');
                let enviandoRespuesta = false;
                
                radioButtons.forEach(function(radio) {
                    radio.addEventListener('change', function() {
                        if (this.checked && !preguntaBloqueada && !enviandoRespuesta) {
                            enviandoRespuesta = true;
                            // Deshabilitar todos los radio buttons mientras se env√≠a
                            radioButtons.forEach(function(rb) {
                                rb.disabled = true;
                            });
                            
                            // Enviar respuesta inmediatamente
                            enviarRespuestaModoEstudio(this.value);
                        }
                    });
                });
            }
            
            function enviarRespuestaModoEstudio(respuesta) {
                const form = document.getElementById('formPregunta');
                if (!form) {
                    enviandoRespuesta = false;
                    return;
                }
                
                // Crear FormData con todos los campos del formulario
                const formData = new FormData(form);
                formData.set('respuesta', respuesta);
                
                // Enviar formulario con AJAX
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.redirected) {
                        // Si hay redirecci√≥n, seguirla para mostrar la respuesta correcta
                        window.location.href = response.url;
                    } else if (response.ok) {
                        // Intentar parsear como JSON primero (modo estudio con AJAX)
                        return response.json().then(data => {
                            if (data.success) {
                                // Actualizar UI din√°micamente sin recargar
                                actualizarUIModoEstudio(data, respuesta);
                            } else {
                                // Si no es JSON v√°lido o no tiene success, recargar
                                window.location.reload();
                            }
                        }).catch(() => {
                            // Si no es JSON, recargar la p√°gina
                            window.location.reload();
                        });
                    } else {
                        throw new Error('Error en la respuesta del servidor');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // En caso de error, recargar la p√°gina
                    window.location.reload();
                });
            }
            
            // Funci√≥n para actualizar la UI en modo estudio sin recargar
            function actualizarUIModoEstudio(data, respuestaSeleccionada) {
                const respuestaCorrecta = data.respuestaCorrecta ? data.respuestaCorrecta.trim().toUpperCase() : '';
                const respuestaAlumno = data.respuestaAlumno ? data.respuestaAlumno.trim().toUpperCase() : '';
                const esCorrecta = data.esCorrecta;
                
                // Actualizar estilos de las opciones
                const radioButtons = document.querySelectorAll('input[name="respuesta"]');
                radioButtons.forEach(function(radio) {
                    const letra = radio.value.trim().toUpperCase();
                    const label = radio.closest('label');
                    if (!label) return;
                    
                    // Deshabilitar todos los radio buttons
                    radio.disabled = true;
                    
                    // Determinar si es la respuesta correcta
                    const esCorrectaOpcion = (letra === respuestaCorrecta);
                    // Determinar si es la respuesta del alumno
                    const esRespuestaAlumno = (letra === respuestaAlumno);
                    // Determinar si es incorrecta (seleccionada pero no correcta)
                    const esIncorrectaOpcion = esRespuestaAlumno && !esCorrectaOpcion;
                    
                    // Actualizar estilos del label
                    if (esCorrectaOpcion) {
                        label.style.background = '#e8f5e9';
                        label.style.border = '2px solid var(--color-border)';
                        label.style.borderLeft = '3px solid var(--color-success)';
                    } else if (esIncorrectaOpcion) {
                        label.style.background = '#ffebee';
                        label.style.border = '2px solid var(--color-border)';
                        label.style.borderLeft = '3px solid var(--color-danger)';
                    } else {
                        label.style.background = '';
                        label.style.border = '2px solid var(--color-border)';
                        label.style.borderLeft = '2px solid var(--color-border)';
                        label.style.opacity = '0.7';
                    }
                    
                    // Actualizar mensajes dentro del label
                    const divTexto = label.querySelector('div[style*="flex: 1"]');
                    if (divTexto) {
                        // Eliminar mensajes anteriores
                        const mensajesAnteriores = divTexto.querySelectorAll('span[style*="display: block"]');
                        mensajesAnteriores.forEach(function(span) {
                            span.remove();
                        });
                        
                        // Agregar mensajes seg√∫n corresponda
                        if (esCorrectaOpcion && esRespuestaAlumno) {
                            const mensaje = document.createElement('span');
                            mensaje.style.cssText = 'display: block; margin-top: 0.5rem; color: var(--color-success); font-weight: bold;';
                            mensaje.textContent = '‚Üê Tu respuesta (correcta)';
                            divTexto.appendChild(mensaje);
                        } else if (esIncorrectaOpcion) {
                            const mensaje = document.createElement('span');
                            mensaje.style.cssText = 'display: block; margin-top: 0.5rem; color: var(--color-danger);';
                            mensaje.textContent = '‚Üê Tu respuesta (incorrecta)';
                            divTexto.appendChild(mensaje);
                        } else if (esCorrectaOpcion && !esRespuestaAlumno) {
                            const mensaje = document.createElement('span');
                            mensaje.style.cssText = 'display: block; margin-top: 0.5rem; color: var(--color-success); font-weight: bold;';
                            mensaje.textContent = '‚Üê Respuesta correcta';
                            divTexto.appendChild(mensaje);
                        }
                    }
                });
                
                // Actualizar colores de los n√∫meros en la gu√≠a de navegaci√≥n
                if (data.estadoPreguntas) {
                    Object.keys(data.estadoPreguntas).forEach(function(numStr) {
                        const num = parseInt(numStr);
                        const estado = data.estadoPreguntas[num];
                        const preguntaLink = document.querySelector(`.pregunta-link[data-pregunta-num="${num}"]`);
                        
                        if (preguntaLink) {
                            if (estado.esActual) {
                                preguntaLink.style.background = 'var(--color-primary)';
                                preguntaLink.style.color = 'white';
                                preguntaLink.style.border = '2px solid var(--color-primary)';
                            } else if (estado.esCorrecta !== undefined && estado.esCorrecta) {
                                preguntaLink.style.background = '#28a745';
                                preguntaLink.style.color = 'white';
                                preguntaLink.style.border = '2px solid #28a745';
                            } else if (estado.tieneRespuesta && estado.esCorrecta !== undefined && !estado.esCorrecta) {
                                preguntaLink.style.background = '#dc3545';
                                preguntaLink.style.color = 'white';
                                preguntaLink.style.border = '2px solid #dc3545';
                            } else if (estado.tieneRespuesta) {
                                preguntaLink.style.background = '#28a745';
                                preguntaLink.style.color = 'white';
                                preguntaLink.style.border = '2px solid #28a745';
                            } else {
                                preguntaLink.style.background = 'white';
                                preguntaLink.style.color = '#666';
                                preguntaLink.style.border = '2px solid #dee2e6';
                            }
                        }
                    });
                }
                
                // Mostrar retroalimentaci√≥n si existe
                if (data.retroalimentacion) {
                    mostrarRetroalimentacion(data.retroalimentacion);
                }
                
                // Mostrar explicaci√≥n y texto legal si existen
                if (data.explicacion || data.textoLegal) {
                    mostrarExplicacionYTextoLegal(data.explicacion, data.textoLegal);
                }
                
                // Marcar pregunta como bloqueada
                preguntaBloqueada = true;
                enviandoRespuesta = false;
            }
            
            // Funci√≥n para mostrar retroalimentaci√≥n
            function mostrarRetroalimentacion(retroalimentacion) {
                let container = document.getElementById('retroalimentacion-container');
                if (!container) {
                    // Crear el contenedor si no existe
                    const formGroup = document.querySelector('.form-group');
                    if (formGroup) {
                        container = document.createElement('div');
                        container.id = 'retroalimentacion-container';
                        container.style.cssText = 'margin-top: 1.5rem; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px; overflow: hidden;';
                        formGroup.appendChild(container);
                    } else {
                        return;
                    }
                }
                
                // Crear o actualizar el contenido
                let header = container.querySelector('.collapsible-header');
                if (!header) {
                    header = document.createElement('div');
                    header.className = 'collapsible-header';
                    header.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 1rem; cursor: pointer; user-select: none; transition: background-color 0.2s;';
                    header.onclick = function() { toggleCollapsible('retroalimentacion-content', 'retroalimentacion-arrow'); };
                    header.onmouseover = function() { this.style.backgroundColor = 'rgba(33,150,243,0.1)'; };
                    header.onmouseout = function() { this.style.backgroundColor = 'transparent'; };
                    header.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">üí°</span>
                            <strong style="color: #1565C0;">Retroalimentaci√≥n:</strong>
                        </div>
                        <span id="retroalimentacion-arrow" style="font-size: 1.2rem; transition: transform 0.3s; color: #1565C0;">‚ñº</span>
                    `;
                    container.appendChild(header);
                }
                
                let content = container.querySelector('#retroalimentacion-content');
                if (!content) {
                    content = document.createElement('div');
                    content.id = 'retroalimentacion-content';
                    content.className = 'collapsible-content';
                    content.style.cssText = 'display: none; padding: 0 1rem 1rem 1rem; color: #333; line-height: 1.6;';
                    container.appendChild(content);
                }
                
                // Convertir markdown b√°sico a HTML (simplificado)
                // Reemplazar saltos de l√≠nea por <br> y preservar formato b√°sico
                let htmlRetro = retroalimentacion
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');
                if (!htmlRetro.startsWith('<p>')) {
                    htmlRetro = '<p>' + htmlRetro + '</p>';
                }
                content.innerHTML = htmlRetro;
            }
            
            // Funci√≥n para mostrar explicaci√≥n y texto legal
            function mostrarExplicacionYTextoLegal(explicacion, textoLegal) {
                const formGroup = document.querySelector('.form-group');
                if (!formGroup) return;
                
                // Eliminar contenedores anteriores si existen
                const contenedorAnterior = document.getElementById('explicacion-texto-legal-container');
                if (contenedorAnterior) {
                    contenedorAnterior.remove();
                }
                
                const container = document.createElement('div');
                container.id = 'explicacion-texto-legal-container';
                container.style.cssText = 'margin-top: 1.5rem;';
                
                if (explicacion) {
                    const explicacionDiv = document.createElement('div');
                    explicacionDiv.style.cssText = 'background: #e3f2fd; border-left: 4px solid var(--color-secondary); border-radius: 4px; margin-bottom: 0.5rem; overflow: hidden;';
                    explicacionDiv.innerHTML = `
                        <div class="collapsible-header" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; cursor: pointer; user-select: none; transition: background-color 0.2s;" onclick="toggleCollapsible('explicacion-content', 'explicacion-arrow')" onmouseover="this.style.backgroundColor='rgba(33,150,243,0.1)'" onmouseout="this.style.backgroundColor='transparent'">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üìñ</span>
                                <strong style="color: #1565C0;">Explicaci√≥n para el Opositor:</strong>
                            </div>
                            <span id="explicacion-arrow" style="font-size: 1.2rem; transition: transform 0.3s; color: #1565C0;">‚ñº</span>
                        </div>
                        <div id="explicacion-content" class="collapsible-content" style="display: none; padding: 0 1rem 1rem 1rem; color: #333; line-height: 1.6;">${explicacion ? explicacion.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') : ''}</div>
                    `;
                    container.appendChild(explicacionDiv);
                }
                
                if (textoLegal) {
                    const textoLegalDiv = document.createElement('div');
                    textoLegalDiv.style.cssText = 'background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; overflow: hidden;';
                    textoLegalDiv.innerHTML = `
                        <div class="collapsible-header" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; cursor: pointer; user-select: none; transition: background-color 0.2s;" onclick="toggleCollapsible('texto-legal-content', 'texto-legal-arrow')" onmouseover="this.style.backgroundColor='rgba(255,193,7,0.1)'" onmouseout="this.style.backgroundColor='transparent'">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">‚öñÔ∏è</span>
                                <strong style="color: #856404;">Texto Legal:</strong>
                            </div>
                            <span id="texto-legal-arrow" style="font-size: 1.2rem; transition: transform 0.3s; color: #856404;">‚ñº</span>
                        </div>
                        <div id="texto-legal-content" class="collapsible-content" style="display: none; padding: 0 1rem 1rem 1rem; color: #333; line-height: 1.6;">${textoLegal}</div>
                    `;
                    container.appendChild(textoLegalDiv);
                }
                
                formGroup.appendChild(container);
            }
            {% else %}
            const modoEstudioActivo = false;
            {% endif %}
            
            
            // Variables del temporizador
            let tiempoInicio = null;
            let tiempoLimite = null; // En segundos
            let tiempoPausado = 0; // Tiempo acumulado en pausa
            let tiempoUltimaPausa = null; // Timestamp de cuando se paus√≥
            let intervalo = null;
            let estaPausado = false;
            
            // Obtener tiempo l√≠mite de la configuraci√≥n (en minutos, convertir a segundos)
            // Obtener tiempo l√≠mite o tiempo restante del borrador
            const tiempoRestanteBorrador = {{ (config.tiempo_restante ?? null)|default('null') }};
            const tiempoLimiteMinutos = {{ (config.tiempo_limite ?? 60)|default(60) }};
            
            // Validar que tiempoLimiteMinutos sea un n√∫mero v√°lido y positivo
            const tiempoLimiteMinutosValidado = (typeof tiempoLimiteMinutos === 'number' && tiempoLimiteMinutos > 0) 
                ? tiempoLimiteMinutos 
                : 60;
            
            if (tiempoRestanteBorrador !== null && tiempoRestanteBorrador > 0) {
                // Si hay tiempo restante del borrador, usarlo
                tiempoLimite = tiempoRestanteBorrador;
            } else {
                // Si no, usar el tiempo l√≠mite configurado (convertir minutos a segundos)
                tiempoLimite = tiempoLimiteMinutosValidado * 60;
            }
            
            // Validar que tiempoLimite sea un n√∫mero v√°lido y positivo
            if (!tiempoLimite || tiempoLimite <= 0 || !isFinite(tiempoLimite)) {
                console.error('Error: tiempoLimite inv√°lido:', tiempoLimite, 'tiempoLimiteMinutos:', tiempoLimiteMinutos);
                tiempoLimite = 60 * 60; // Fallback a 60 minutos en segundos
            }
            
            console.log('Temporizador inicializado:', {
                tiempoLimiteMinutos: tiempoLimiteMinutos,
                tiempoLimiteMinutosValidado: tiempoLimiteMinutosValidado,
                tiempoLimiteSegundos: tiempoLimite,
                tiempoRestanteBorrador: tiempoRestanteBorrador,
                tiempoLimiteStorage: localStorage.getItem('examen_tiempo_limite'),
                tiempoInicioStorage: localStorage.getItem('examen_tiempo_inicio')
            });
            
            // Funci√≥n para formatear el tiempo
            function formatearTiempo(segundos) {
                const horas = Math.floor(segundos / 3600);
                const minutos = Math.floor((segundos % 3600) / 60);
                const segs = segundos % 60;
                
                if (horas > 0) {
                    return `${horas}:${String(minutos).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;
                }
                return `${String(minutos).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;
            }
            
            // Funci√≥n para actualizar el temporizador
            function actualizarTemporizador() {
                if (!tiempoInicio || !tiempoLimite || estaPausado) return;
                
                const ahora = Date.now();
                const tiempoTranscurrido = Math.floor((ahora - tiempoInicio - tiempoPausado) / 1000);
                const tiempoRestante = Math.max(0, tiempoLimite - tiempoTranscurrido);
                
                const timerDisplay = document.getElementById('timer-display');
                if (timerDisplay) {
                    timerDisplay.textContent = formatearTiempo(tiempoRestante);
                    
                    // Cambiar color cuando quedan menos de 5 minutos
                    const timerContainer = document.getElementById('examen-timer');
                    if (timerContainer) {
                        if (tiempoRestante <= 300 && tiempoRestante > 0) {
                            timerContainer.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                            timerContainer.style.animation = tiempoRestante <= 60 ? 'pulse 1s infinite' : 'none';
                        } else if (tiempoRestante === 0) {
                            timerContainer.style.background = 'linear-gradient(135deg, #ff0000 0%, #cc0000 100%)';
                            // Finalizar examen autom√°ticamente
                            finalizarExamenPorTiempo();
                        } else {
                            timerContainer.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                            timerContainer.style.animation = 'none';
                        }
                    }
                }
            }
            
            // Funci√≥n para finalizar examen por tiempo
            function finalizarExamenPorTiempo() {
                if (intervalo) {
                    clearInterval(intervalo);
                    intervalo = null;
                }
                
                // Mostrar alerta y luego finalizar autom√°ticamente
                alert('‚è±Ô∏è Se ha agotado el tiempo del examen. El examen se finalizar√° autom√°ticamente.');
                const formPregunta = document.getElementById('formPregunta');
                if (formPregunta) {
                    const inputFinalizar = document.createElement('input');
                    inputFinalizar.type = 'hidden';
                    inputFinalizar.name = 'accion';
                    inputFinalizar.value = 'finalizar';
                    formPregunta.appendChild(inputFinalizar);
                    formPregunta.submit();
                }
            }
            
            // Funci√≥n para pausar/reanudar
            function togglePausa() {
                const btnPausa = document.getElementById('timer-pause-btn');
                const timerDisplay = document.getElementById('timer-display');
                
                if (!btnPausa) {
                    console.error('No se encontr√≥ el bot√≥n timer-pause-btn en togglePausa');
                    return;
                }
                
                if (estaPausado) {
                    // Reanudar
                    if (tiempoUltimaPausa) {
                        const tiempoEnPausa = Date.now() - tiempoUltimaPausa;
                        tiempoPausado += tiempoEnPausa;
                        tiempoUltimaPausa = null;
                        localStorage.setItem('examen_tiempo_pausado_total', tiempoPausado.toString());
                    }
                    estaPausado = false;
                    btnPausa.textContent = '‚è∏Ô∏è Pausar';
                    btnPausa.style.background = '#6c757d';
                    btnPausa.title = 'Pausar temporizador';
                    if (timerDisplay) {
                        timerDisplay.style.opacity = '1';
                    }
                    // Guardar estado en localStorage
                    localStorage.setItem('examen_timer_pausado', 'false');
                    localStorage.removeItem('examen_timer_ultima_pausa');
                } else {
                    // Pausar
                    tiempoUltimaPausa = Date.now();
                    estaPausado = true;
                    btnPausa.textContent = '‚ñ∂Ô∏è Reanudar';
                    btnPausa.style.background = '#28a745';
                    btnPausa.title = 'Reanudar temporizador';
                    if (timerDisplay) {
                        timerDisplay.style.opacity = '0.6';
                    }
                    // Guardar estado en localStorage
                    localStorage.setItem('examen_timer_pausado', 'true');
                    localStorage.setItem('examen_timer_ultima_pausa', tiempoUltimaPausa.toString());
                }
                
                // Actualizar el temporizador inmediatamente
                actualizarTemporizador();
            }
            
            // Inicializar temporizador
            function inicializarTemporizador() {
                // Limpiar intervalo anterior si existe
                if (intervalo) {
                    clearInterval(intervalo);
                    intervalo = null;
                }
                
                // Obtener tiempo de inicio desde localStorage o crear uno nuevo
                const tiempoInicioStorage = localStorage.getItem('examen_tiempo_inicio');
                const tiempoLimiteStorage = localStorage.getItem('examen_tiempo_limite');
                const tiempoPausadoStorage = localStorage.getItem('examen_tiempo_pausado_total');
                const estaPausadoStorage = localStorage.getItem('examen_timer_pausado');
                const ultimaPausaStorage = localStorage.getItem('examen_timer_ultima_pausa');
                
                // Verificar si el tiempo l√≠mite del localStorage coincide con el tiempo l√≠mite actual
                // Si no coincide, significa que es un examen nuevo y debemos limpiar el localStorage
                const tiempoLimiteStorageNum = tiempoLimiteStorage ? parseInt(tiempoLimiteStorage) : null;
                const tiempoLimiteCoincide = tiempoLimiteStorageNum === tiempoLimite;
                
                // Verificar si hay un tiempo de inicio v√°lido y si el tiempo transcurrido es razonable
                let debeReiniciar = false;
                if (tiempoInicioStorage && tiempoLimiteCoincide) {
                    // Calcular tiempo transcurrido para verificar si es v√°lido
                    const tiempoInicioTemp = parseInt(tiempoInicioStorage);
                    const tiempoPausadoTemp = tiempoPausadoStorage ? parseInt(tiempoPausadoStorage) : 0;
                    const ahora = Date.now();
                    const tiempoTranscurridoTemp = Math.floor((ahora - tiempoInicioTemp - tiempoPausadoTemp) / 1000);
                    
                    // Si el tiempo transcurrido es mayor que el tiempo l√≠mite, es un examen nuevo
                    // Tambi√©n verificamos que el tiempo transcurrido no sea negativo (error de c√°lculo)
                    if (tiempoTranscurridoTemp >= tiempoLimite || tiempoTranscurridoTemp < 0) {
                        debeReiniciar = true;
                        console.log('Tiempo transcurrido inv√°lido o agotado. Reiniciando examen:', {
                            tiempoTranscurrido: tiempoTranscurridoTemp,
                            tiempoLimite: tiempoLimite
                        });
                    }
                }
                
                // Si no hay tiempo de inicio, el tiempo l√≠mite no coincide, o el tiempo transcurrido es inv√°lido, iniciar nuevo examen
                if (!tiempoInicioStorage || !tiempoLimiteCoincide || debeReiniciar) {
                    // Nuevo examen o tiempo l√≠mite diferente: limpiar localStorage y establecer tiempo de inicio
                    localStorage.removeItem('examen_tiempo_inicio');
                    localStorage.removeItem('examen_tiempo_limite');
                    localStorage.removeItem('examen_tiempo_pausado_total');
                    localStorage.removeItem('examen_timer_pausado');
                    localStorage.removeItem('examen_timer_ultima_pausa');
                    
                    tiempoInicio = Date.now();
                    tiempoPausado = 0;
                    estaPausado = false;
                    tiempoUltimaPausa = null;
                    
                    localStorage.setItem('examen_tiempo_inicio', tiempoInicio.toString());
                    localStorage.setItem('examen_tiempo_limite', tiempoLimite.toString());
                    localStorage.setItem('examen_tiempo_pausado_total', '0');
                    localStorage.setItem('examen_timer_pausado', 'false');
                    
                    console.log('Nuevo examen iniciado. Tiempo l√≠mite:', tiempoLimite, 'segundos');
                } else {
                    // Continuar con el examen existente (desde borrador)
                    tiempoInicio = parseInt(tiempoInicioStorage);
                    tiempoPausado = tiempoPausadoStorage ? parseInt(tiempoPausadoStorage) : 0;
                    estaPausado = estaPausadoStorage === 'true';
                    
                    if (estaPausado && ultimaPausaStorage) {
                        tiempoUltimaPausa = parseInt(ultimaPausaStorage);
                    }
                    
                    // Verificar si el tiempo ha expirado
                    const ahora = Date.now();
                    // Si est√° pausado, calcular el tiempo pausado hasta ahora
                    let tiempoPausadoActual = tiempoPausado;
                    if (estaPausado && tiempoUltimaPausa) {
                        tiempoPausadoActual += (ahora - tiempoUltimaPausa);
                    }
                    const tiempoTranscurrido = Math.floor((ahora - tiempoInicio - tiempoPausadoActual) / 1000);
                    
                    console.log('Continuando examen existente:', {
                        tiempoInicio: tiempoInicio,
                        tiempoTranscurrido: tiempoTranscurrido,
                        tiempoLimite: tiempoLimite,
                        tiempoRestante: tiempoLimite - tiempoTranscurrido
                    });
                    
                    if (tiempoTranscurrido >= tiempoLimite) {
                        console.warn('Tiempo agotado al continuar examen');
                        finalizarExamenPorTiempo();
                        return;
                    }
                }
                
                // Actualizar bot√≥n de pausa
                const btnPausa = document.getElementById('timer-pause-btn');
                if (btnPausa) {
                    if (estaPausado) {
                        btnPausa.textContent = '‚ñ∂Ô∏è Reanudar';
                        btnPausa.style.background = '#28a745';
                        btnPausa.title = 'Reanudar temporizador';
                    } else {
                        btnPausa.textContent = '‚è∏Ô∏è Pausar';
                        btnPausa.style.background = '#6c757d';
                        btnPausa.title = 'Pausar temporizador';
                    }
                }
                
                // Actualizar cada segundo
                intervalo = setInterval(function() {
                    if (!estaPausado) {
                        actualizarTemporizador();
                    } else {
                        // Si est√° pausado, actualizar el tiempo pausado acumulado
                        if (tiempoUltimaPausa) {
                            const tiempoEnPausa = Date.now() - tiempoUltimaPausa;
                            localStorage.setItem('examen_tiempo_pausado_total', (tiempoPausado + tiempoEnPausa).toString());
                        }
                    }
                }, 1000);
                
                actualizarTemporizador(); // Llamar inmediatamente
            }
            
            // Limpiar temporizador al finalizar examen
            function limpiarTemporizador() {
                if (intervalo) {
                    clearInterval(intervalo);
                    intervalo = null;
                }
                localStorage.removeItem('examen_tiempo_inicio');
                localStorage.removeItem('examen_tiempo_limite');
                localStorage.removeItem('examen_tiempo_pausado_total');
                localStorage.removeItem('examen_timer_pausado');
                localStorage.removeItem('examen_timer_ultima_pausa');
            }
            
            // Inicializar cuando el DOM est√© listo
            function inicializarTodo() {
                // Inicializar temporizador
                inicializarTemporizador();
                
                // Bot√≥n de pausa/reanudar
                const btnPausa = document.getElementById('timer-pause-btn');
                if (btnPausa) {
                    // Usar onclick directamente para evitar problemas con m√∫ltiples listeners
                    btnPausa.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        console.log('Bot√≥n de pausa clickeado');
                        togglePausa();
                        return false;
                    };
                } else {
                    console.error('No se encontr√≥ el bot√≥n timer-pause-btn');
                }
                
                // Limpiar al enviar el formulario
                const formPregunta = document.getElementById('formPregunta');
                if (formPregunta) {
                    formPregunta.addEventListener('submit', function(e) {
                        const accion = document.querySelector('button[name="accion"][value="finalizar"]');
                        if (accion && accion.form === formPregunta) {
                            limpiarTemporizador();
                        }
                        
                        // Si es guardar borrador, a√±adir tiempo restante
                        const btnGuardar = document.getElementById('btnGuardarBorrador');
                        if (btnGuardar && btnGuardar.form === formPregunta && document.querySelector('button[name="accion"][value="guardar_borrador"]:focus')) {
                            // Calcular tiempo restante
                            const tiempoRestante = tiempoLimite - (Date.now() - tiempoInicio) / 1000 + tiempoPausado;
                            const inputTiempo = document.createElement('input');
                            inputTiempo.type = 'hidden';
                            inputTiempo.name = 'tiempo_restante';
                            inputTiempo.value = Math.max(0, Math.floor(tiempoRestante));
                            formPregunta.appendChild(inputTiempo);
                        }
                    });
                    
                    // Navegaci√≥n r√°pida de preguntas
                    const preguntaLinks = document.querySelectorAll('.pregunta-link');
                    
                    preguntaLinks.forEach(function(link) {
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            
                            const numeroDestino = parseInt(this.getAttribute('data-pregunta-num'));
                            const numeroActual = {{ numero }};
                            
                            // Si es la misma pregunta, no hacer nada
                            if (numeroDestino === numeroActual || isNaN(numeroDestino)) {
                                return false;
                            }
                            
                            // Guardar respuesta actual si hay alguna seleccionada
                            const respuestaSeleccionada = formPregunta.querySelector('input[name="respuesta"]:checked');
                            
                            // Eliminar cualquier input destino existente
                            const inputDestinoExistente = formPregunta.querySelector('input[name="numero_destino"]');
                            if (inputDestinoExistente) {
                                inputDestinoExistente.remove();
                            }
                            
                            // Crear un input oculto para el n√∫mero destino
                            const inputDestino = document.createElement('input');
                            inputDestino.type = 'hidden';
                            inputDestino.name = 'numero_destino';
                            inputDestino.value = numeroDestino;
                            formPregunta.appendChild(inputDestino);
                            
                            // Enviar el formulario directamente
                            try {
                                formPregunta.submit();
                            } catch (error) {
                                console.error('Error al enviar el formulario:', error);
                                // Si falla el submit, redirigir directamente
                        window.location.href = '{{ path('app_examen_pregunta', {'numero': '__NUM__'}) }}'.replace('__NUM__', numeroDestino);
                            }
                            
                            return false;
                        });
                    });
                    
                    // Bot√≥n Anular Respuesta
                    const btnAnularRespuesta = document.getElementById('btnAnularRespuesta');
                    
                    // Funci√≥n para manejar el clic del bot√≥n anular respuesta (sin recargar p√°gina)
                    function manejarClicAnularRespuesta(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (!btnAnularRespuesta) return;
                        
                        // Deshabilitar el bot√≥n mientras se procesa
                        btnAnularRespuesta.disabled = true;
                        const textoOriginal = btnAnularRespuesta.innerHTML;
                        btnAnularRespuesta.innerHTML = '<span style="margin-right: 0.5rem;">‚è≥</span> Anulando...';
                        
                        // Deseleccionar todos los radio buttons visualmente
                        const radioButtons = formPregunta.querySelectorAll('input[name="respuesta"]');
                        radioButtons.forEach(function(radio) {
                            radio.checked = false;
                            // Remover el estilo de selecci√≥n del label padre
                            const label = radio.closest('label');
                            if (label) {
                                // Restaurar el borde gris original completo (incluyendo el izquierdo)
                                label.style.background = '';
                                label.style.border = '2px solid var(--color-border)';
                                label.style.borderLeft = '2px solid var(--color-border)';
                            }
                        });
                        
                        // Ocultar el bot√≥n inmediatamente
                        const btnAnularRespuestaContainer = document.getElementById('btnAnularRespuestaContainer');
                        if (btnAnularRespuestaContainer) {
                            btnAnularRespuestaContainer.style.display = 'none';
                        }
                        
                        // Enviar petici√≥n AJAX para guardar el cambio en el servidor
                        fetch('{{ path('app_examen_anular_respuesta_ajax', {'numero': numero}) }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Actualizar el estado visual de la navegaci√≥n r√°pida si es necesario
                                // La respuesta ya fue eliminada del servidor, solo actualizamos la UI
                                console.log('Respuesta anulada correctamente');
                            } else {
                                // Si hay error, volver a mostrar el bot√≥n y restaurar la selecci√≥n
                                console.error('Error al anular respuesta:', data.error);
                                if (btnAnularRespuestaContainer) {
                                    btnAnularRespuestaContainer.style.display = 'flex';
                                }
                                btnAnularRespuesta.disabled = false;
                                btnAnularRespuesta.innerHTML = textoOriginal;
                            }
                        })
                        .catch(error => {
                            console.error('Error en la petici√≥n:', error);
                            // En caso de error, volver a mostrar el bot√≥n
                            if (btnAnularRespuestaContainer) {
                                btnAnularRespuestaContainer.style.display = 'flex';
                            }
                            btnAnularRespuesta.disabled = false;
                            btnAnularRespuesta.innerHTML = textoOriginal;
                        });
                    }
                    
                    if (btnAnularRespuesta) {
                        btnAnularRespuesta.addEventListener('click', manejarClicAnularRespuesta);
                    }
                    
                    // Agregar listeners a los radio buttons para mostrar/ocultar el bot√≥n din√°micamente
                    // Solo si NO estamos en modo estudio
                    {% if not (modoEstudio is defined and modoEstudio) %}
                    const radioButtons = formPregunta.querySelectorAll('input[name="respuesta"]');
                    const btnAnularRespuestaContainer = document.getElementById('btnAnularRespuestaContainer');
                    
                    // Funci√≥n para restaurar el estado del bot√≥n a su estado normal
                    function restaurarEstadoBotonAnular() {
                        if (!btnAnularRespuesta) return;
                        
                        // Restaurar el texto original del bot√≥n
                        btnAnularRespuesta.innerHTML = '<span style="margin-right: 0.5rem;">‚Ü∫</span> Anular Respuesta';
                        // Habilitar el bot√≥n
                        btnAnularRespuesta.disabled = false;
                    }
                    
                    // Funci√≥n para mostrar/ocultar el bot√≥n seg√∫n si hay respuesta seleccionada
                    function actualizarVisibilidadBotonAnular() {
                        if (!btnAnularRespuestaContainer) return;
                        
                        const hayRespuestaSeleccionada = Array.from(radioButtons).some(function(radio) {
                            return radio.checked;
                        });
                        
                        if (hayRespuestaSeleccionada) {
                            // Restaurar el estado del bot√≥n antes de mostrarlo
                            restaurarEstadoBotonAnular();
                            btnAnularRespuestaContainer.style.display = 'flex';
                        } else {
                            btnAnularRespuestaContainer.style.display = 'none';
                        }
                    }
                    
                    // Funci√≥n para actualizar estilos de los labels cuando se selecciona/deselecciona una opci√≥n
                    function actualizarEstilosLabels() {
                        radioButtons.forEach(function(radio) {
                            const label = radio.closest('label');
                            if (!label) return;
                            
                            if (radio.checked) {
                                // Aplicar estilo de selecci√≥n
                                label.style.background = '#e3f2fd';
                                label.style.border = '2px solid var(--color-primary)';
                                label.style.borderLeft = '2px solid var(--color-primary)';
                            } else {
                                // Restaurar el borde gris original completo (solo si no est√° en modo estudio con retroalimentaci√≥n)
                                {% if not (modoEstudio is defined and modoEstudio and preguntaBloqueada is defined and preguntaBloqueada) %}
                                label.style.background = '';
                                label.style.border = '2px solid var(--color-border)';
                                label.style.borderLeft = '2px solid var(--color-border)';
                                {% endif %}
                            }
                        });
                    }
                    
                    // Agregar listener a cada radio button para mostrar el bot√≥n cuando se selecciona una opci√≥n
                    radioButtons.forEach(function(radio) {
                        radio.addEventListener('change', function() {
                            actualizarVisibilidadBotonAnular();
                            actualizarEstilosLabels();
                        });
                    });
                    
                    // Verificar estado inicial (por si hay una respuesta ya guardada al cargar la p√°gina)
                    actualizarVisibilidadBotonAnular();
                    actualizarEstilosLabels();
                    {% endif %}
                } else {
                    console.error('No se encontr√≥ el formulario formPregunta');
                }
            }
            
            // Sincronizar checkbox "Me la juego" con input hidden
            function sincronizarCheckboxRiesgo() {
                const checkbox = document.getElementById('me_la_juego') || document.getElementById('me_la_juego_municipal');
                const hidden = document.getElementById('me_la_juego_hidden');
                if (checkbox && hidden) {
                    hidden.value = checkbox.checked ? '1' : '0';
                }
            }
            
            // Inicializar cuando el DOM est√© listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    inicializarTodo();
                    sincronizarCheckboxRiesgo();
                });
            } else {
                inicializarTodo();
                sincronizarCheckboxRiesgo();
            }
            
            // Tambi√©n inicializar en eventos de Turbo
            document.addEventListener('turbo:load', inicializarTodo);
            document.addEventListener('turbo:frame-load', function() {
                if (document.getElementById('formPregunta')) {
                    inicializarTodo();
                }
            });
        })();
        </script>
        
        <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        #timer-pause-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        #timer-pause-btn:active {
            transform: scale(0.98);
        }
        
        /* Estilos responsivos para m√≥viles (iPhone) */
        @media (max-width: 768px) {
            /* Header del examen - apilar elementos verticalmente */
            .card-header > div {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 1rem !important;
            }
            
            .card-header h2 {
                font-size: 1.2rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            /* Timer y bot√≥n de pausa - hacer m√°s compactos */
            #examen-timer-container {
                flex-direction: column !important;
                width: 100% !important;
                gap: 0.5rem !important;
            }
            
            #examen-timer {
                width: 100% !important;
                justify-content: center !important;
                font-size: 1rem !important;
                padding: 0.75rem !important;
            }
            
            #timer-pause-btn {
                width: 100% !important;
                font-size: 0.9rem !important;
                padding: 0.75rem !important;
            }
            
            /* Barra de progreso */
            .card-header > div > div[style*="flex: 1"] {
                width: 100% !important;
                min-width: 100% !important;
            }
            
            /* Navegaci√≥n r√°pida de preguntas */
            .card-body > div[style*="background: #f8f9fa"] {
                padding: 0.5rem !important;
            }
            
            .card-body > div[style*="background: #f8f9fa"] > div:first-child {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.25rem !important;
            }
            
            .card-body > div[style*="background: #f8f9fa"] > div:first-child span:last-child {
                font-size: 0.7rem !important;
            }
            
            /* Botones de navegaci√≥n r√°pida - hacer m√°s peque√±os pero t√°ctiles */
            .pregunta-link {
                min-width: 36px !important;
                height: 36px !important;
                font-size: 0.85rem !important;
            }
            
            /* Leyenda de colores - apilar verticalmente */
            .card-body > div[style*="background: #f8f9fa"] > div:last-child {
                flex-direction: column !important;
                gap: 0.5rem !important;
                align-items: flex-start !important;
            }
            
            /* Tipo de examen badge */
            .card-body > div[style*="padding: 1rem"] {
                padding: 0.75rem !important;
            }
            
            .card-body > div[style*="padding: 1rem"] > div {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.5rem !important;
            }
            
            /* Informaci√≥n de Ley y Tema */
            .card-body > .form-group > div[style*="padding: 0.75rem 1rem"] {
                padding: 0.75rem !important;
            }
            
            .card-body > .form-group > div[style*="padding: 0.75rem 1rem"] > div {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.5rem !important;
            }
            
            /* Texto de la pregunta */
            #pregunta-texto h3 {
                font-size: 1.1rem !important;
                line-height: 1.5 !important;
                word-wrap: break-word !important;
            }
            
            /* Opciones de respuesta - hacer m√°s t√°ctiles */
            .form-group > div[style*="display: flex; flex-direction: column"] > label {
                padding: 1rem !important;
                min-height: 60px !important;
                font-size: 0.95rem !important;
            }
            
            .form-group > div[style*="display: flex; flex-direction: column"] > label input[type="radio"] {
                width: 24px !important;
                height: 24px !important;
                margin-right: 0.75rem !important;
                margin-top: 0.5rem !important;
            }
            
            /* Bot√≥n Anular Respuesta - m√≥vil */
            #btnAnularRespuesta {
                width: 100% !important;
                padding: 0.875rem 1.25rem !important;
                font-size: 1rem !important;
                min-height: 48px !important;
                touch-action: manipulation !important;
                border-width: 2px !important;
            }
            
            /* Botones de navegaci√≥n - apilar verticalmente */
            .d-flex.gap-2.mt-4 {
                flex-direction: column !important;
                width: 100% !important;
            }
            
            .d-flex.gap-2.mt-4 button,
            .d-flex.gap-2.mt-4 a {
                width: 100% !important;
                padding: 0.75rem 1rem !important;
                font-size: 1rem !important;
                margin: 0 !important;
            }
            
            /* Bot√≥n guardar borrador */
            #btnGuardarBorrador {
                margin-left: 0 !important;
                margin-top: 0.5rem !important;
            }
            
            /* Secci√≥n de reportar error */
            .card[style*="border-left: 4px solid #FF9800"] {
                max-width: 100% !important;
            }
            
            /* Modal de mensajes */
            #modalMensajesPregunta > div {
                width: 95% !important;
                margin: 2% auto !important;
                max-height: 90vh !important;
            }
            
            #modalMensajesPregunta > div > div:first-child {
                padding: 1rem !important;
            }
            
            #modalMensajesPregunta > div > div:first-child h3 {
                font-size: 1rem !important;
            }
            
            /* Modal de porcentajes */
            #modalPorcentajes > div {
                width: 95% !important;
                margin: 2% auto !important;
            }
            
            #modalPorcentajes > div > div:first-child {
                padding: 1rem !important;
            }
            
            #modalPorcentajes > div > div:first-child h3 {
                font-size: 1rem !important;
            }
            
            /* Retroalimentaci√≥n y explicaciones */
            #retroalimentacion-container,
            .card-body > div[style*="margin-top: 1.5rem"] > div {
                padding: 0.75rem !important;
                font-size: 0.9rem !important;
            }
            
            /* Encabezados colapsables */
            .collapsible-header {
                min-height: 44px !important;
                touch-action: manipulation !important;
            }
            
            .collapsible-content {
                font-size: 0.9rem !important;
            }
            
            /* Ajustes generales del card */
            .card {
                margin: 0.5rem !important;
                border-radius: 8px !important;
            }
            
            .card-body {
                padding: 1rem !important;
            }
            
            .card-header {
                padding: 1rem !important;
            }
            
            /* Asegurar que el texto no se desborde */
            * {
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
            }
            
            /* Botones m√°s grandes para facilitar el toque */
            button, .btn, a.btn {
                min-height: 44px !important;
                touch-action: manipulation !important;
            }
            
            /* Inputs y selects m√°s grandes */
            input, select, textarea {
                font-size: 16px !important; /* Previene zoom en iOS */
                min-height: 44px !important;
            }
        }
        
        /* Estilos espec√≠ficos para iPhone (pantallas muy peque√±as) */
        @media (max-width: 480px) {
            .card-header h2 {
                font-size: 1.1rem !important;
            }
            
            #examen-timer {
                font-size: 0.9rem !important;
                padding: 0.6rem !important;
            }
            
            #pregunta-texto h3 {
                font-size: 1rem !important;
            }
            
            .form-group > div[style*="display: flex; flex-direction: column"] > label {
                padding: 0.75rem !important;
                font-size: 0.9rem !important;
            }
            
            .pregunta-link {
                min-width: 32px !important;
                height: 32px !important;
                font-size: 0.8rem !important;
            }
            
            /* Bot√≥n Anular Respuesta - pantallas muy peque√±as */
            #btnAnularRespuesta {
                padding: 0.75rem 1rem !important;
                font-size: 0.95rem !important;
                min-height: 44px !important;
            }
        }
        
        /* Estilos generales para el bot√≥n Anular Respuesta */
        #btnAnularRespuesta {
            transition: all 0.2s ease !important;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2) !important;
        }
        
        #btnAnularRespuesta:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3) !important;
            background-color: #dc3545 !important;
            color: white !important;
        }
        
        #btnAnularRespuesta:active {
            transform: translateY(0) !important;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2) !important;
        }
        </style>
    </div>
</div>

<script>
    // Scroll autom√°tico a la secci√≥n de informaci√≥n de la pregunta al cargar
    document.addEventListener('DOMContentLoaded', function() {
        const informacionPregunta = document.getElementById('informacion-pregunta');
        if (informacionPregunta) {
            informacionPregunta.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Tambi√©n hacer focus para mejor accesibilidad
            informacionPregunta.setAttribute('tabindex', '-1');
            informacionPregunta.focus();
        }
    });
</script>
{% endblock %}

