{% extends 'base.html.twig' %}

{% block title %}Pregunta {{ numero }} de {{ total }}{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <h2 style="margin: 0;">Pregunta {{ numero }} de {{ total }}</h2>
            <div id="examen-timer-container" style="display: flex; align-items: center; gap: 0.75rem;">
                <div id="examen-timer" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                    <span style="font-size: 1.3rem;">‚è±Ô∏è</span>
                    <span id="timer-display">--:--</span>
                </div>
                <button id="timer-pause-btn" type="button" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.9rem;" title="Pausar/Reanudar temporizador">
                    ‚è∏Ô∏è Pausar
                </button>
            </div>
            <div style="flex: 1; min-width: 200px; margin: 0;">
                <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div id="progress-bar" style="background: var(--color-primary); height: 100%; width: {{ (numero / total * 100) }}%; transition: width 0.3s;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        {# Listado de preguntas - Navegaci√≥n r√°pida #}
        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 0.75rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-size: 0.85rem; color: #666; font-weight: 500;">üìã Navegaci√≥n r√°pida:</span>
                <span style="font-size: 0.75rem; color: #999;">(Haz clic en cualquier n√∫mero para ir a esa pregunta)</span>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 0.35rem; justify-content: flex-start;">
                {% for num, estado in estadoPreguntas %}
                    <a href="javascript:void(0);" 
                       data-pregunta-num="{{ num }}"
                       class="pregunta-link"
                       style="display: inline-flex; align-items: center; justify-content: center; 
                              min-width: 32px; height: 32px; 
                              border-radius: 4px; 
                              text-decoration: none; 
                              font-weight: 500; 
                              font-size: 0.8rem;
                              transition: all 0.2s;
                              cursor: pointer;
                              user-select: none;
                              {% if estado.esActual %}
                                  background: var(--color-primary);
                                  color: white;
                                  border: 2px solid var(--color-primary);
                                  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                  transform: scale(1.1);
                              {% elseif modoEstudio is defined and modoEstudio and estado.esCorrecta is not null %}
                                  {% if estado.esCorrecta %}
                                      background: #28a745;
                                      color: white;
                                      border: 2px solid #28a745;
                                  {% else %}
                                      background: #dc3545;
                                      color: white;
                                      border: 2px solid #dc3545;
                                  {% endif %}
                              {% elseif estado.tieneRespuesta %}
                                  background: #28a745;
                                  color: white;
                                  border: 2px solid #28a745;
                              {% else %}
                                  background: white;
                                  color: #666;
                                  border: 2px solid #dee2e6;
                              {% endif %}"
                       onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)';"
                       onmouseout="this.style.transform='{% if estado.esActual %}scale(1.1){% else %}scale(1){% endif %}'; this.style.boxShadow='{% if estado.esActual %}0 2px 4px rgba(0,0,0,0.2){% else %}none{% endif %}';">
                        {{ num }}
                    </a>
                {% endfor %}
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.75rem; color: #666; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 0.4rem;">
                    <span style="display: inline-block; width: 14px; height: 14px; background: var(--color-primary); border-radius: 3px; border: 2px solid var(--color-primary);"></span>
                    <span>Actual</span>
                </div>
                {% if modoEstudio is defined and modoEstudio %}
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                        <span style="display: inline-block; width: 14px; height: 14px; background: #28a745; border-radius: 3px; border: 2px solid #28a745;"></span>
                        <span>Correcta</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                        <span style="display: inline-block; width: 14px; height: 14px; background: #dc3545; border-radius: 3px; border: 2px solid #dc3545;"></span>
                        <span>Incorrecta</span>
                    </div>
                {% else %}
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                        <span style="display: inline-block; width: 14px; height: 14px; background: #28a745; border-radius: 3px; border: 2px solid #28a745;"></span>
                        <span>Respondida</span>
                    </div>
                {% endif %}
                <div style="display: flex; align-items: center; gap: 0.4rem;">
                    <span style="display: inline-block; width: 14px; height: 14px; background: white; border-radius: 3px; border: 2px solid #dee2e6;"></span>
                    <span>Sin responder</span>
                </div>
            </div>
        </div>
        {% if esMunicipal is defined and esMunicipal %}
            <div class="mb-3" style="padding: 1rem; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid #2196F3; border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">üèõÔ∏è</span>
                    <strong style="color: #1565C0;">Tipo de Examen:</strong> 
                    <span class="badge" style="background-color: #2196F3; padding: 0.5rem 1rem; font-size: 0.95rem; font-weight: bold;">EXAMEN MUNICIPAL</span>
                </div>
            </div>
        {% else %}
            <div class="mb-3" style="padding: 0.75rem; background: linear-gradient(135deg, #f1f8f4 0%, #c8e6c9 100%); border-left: 4px solid #4CAF50; border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                        <span style="font-size: 1rem;">üìö</span>
                        <strong style="color: #2E7D32; font-size: 0.9rem;">Tipo de Examen:</strong> 
                        <span class="badge" style="background-color: #4CAF50; padding: 0.25rem 0.75rem; font-size: 0.85rem; font-weight: bold;">TEMARIO GENERAL</span>
                    </div>
                    {% if porcentajesPorTema|length > 0 %}
                        <button type="button" class="btn btn-sm btn-info" id="btnVerPorcentajes" style="font-size: 0.85rem; padding: 0.4rem 1rem;" onclick="event.stopPropagation(); return false;">
                            üìä Ver % por Tema
                        </button>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {# Tema y Ley #}
        <div class="form-group mb-4">
            <div style="padding: 0.75rem 1rem; background: linear-gradient(135deg, #e3f2fd 0%, #f5f5f5 100%); border-left: 4px solid var(--color-primary); border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                    {% if pregunta.ley is defined and pregunta.ley %}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.1rem;">üìú</span>
                            <strong style="color: var(--color-primary); font-size: 1rem; font-weight: 600;">{{ pregunta.ley.nombre }}</strong>
                        </div>
                        {% if pregunta.tema is defined and pregunta.tema %}
                            <span style="color: #999; font-size: 0.85rem;">‚Ä¢</span>
                            <span style="color: #666; font-size: 0.9rem; font-weight: 500; background: rgba(255,255,255,0.7); padding: 0.25rem 0.5rem; border-radius: 4px;">{{ pregunta.tema.nombre }}</span>
                        {% endif %}
                    {% elseif pregunta.temaMunicipal is defined and pregunta.temaMunicipal %}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.1rem;">üèõÔ∏è</span>
                            <strong style="color: var(--color-primary); font-size: 1rem; font-weight: 600;">{{ pregunta.municipio.nombre }}</strong>
                        </div>
                        <span style="color: #999; font-size: 0.85rem;">‚Ä¢</span>
                        <span style="color: #666; font-size: 0.9rem; font-weight: 500; background: rgba(255,255,255,0.7); padding: 0.25rem 0.5rem; border-radius: 4px;">{{ pregunta.temaMunicipal.nombre }}</span>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Pregunta #}
        <div class="form-group mb-4">
            <h3 style="color: var(--color-primary); margin-bottom: 1rem;">{{ pregunta.texto }}</h3>
        </div>

        <form method="post" action="{{ path('app_examen_pregunta', {'numero': numero}) }}" id="formPregunta">
            <div class="form-group">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    {% set opciones = {'A': pregunta.opcionA, 'B': pregunta.opcionB, 'C': pregunta.opcionC, 'D': pregunta.opcionD} %}
                    {% set mostrarRespuestas = (modoEstudio is defined and modoEstudio and preguntaBloqueada is defined and preguntaBloqueada and respuestaCorrecta is defined and respuestaCorrecta is not null and respuestaCorrecta != '') %}
                    {% for letra, texto in opciones %}
                        {% set esSeleccionada = (respuestaActual == letra) %}
                        {# Comparar respuestaCorrecta con letra, asegurando que ambos sean strings y comparando directamente #}
                        {% set esCorrecta = false %}
                        {% if mostrarRespuestas %}
                            {% set respuestaCorrectaStr = respuestaCorrecta|trim|upper %}
                            {% set letraStr = letra|trim|upper %}
                            {% if respuestaCorrectaStr == letraStr %}
                                {% set esCorrecta = true %}
                            {% endif %}
                        {% endif %}
                        {# En modo estudio, todas las opciones incorrectas se marcan como incorrectas #}
                        {% set esIncorrecta = (mostrarRespuestas and not esCorrecta) %}
                        
                        <label style="display: flex; align-items: start; padding: 1rem; border: 2px solid var(--color-border); border-radius: 4px; cursor: {% if preguntaBloqueada is defined and preguntaBloqueada %}not-allowed{% else %}pointer{% endif %}; transition: all 0.3s; 
                               {% if esCorrecta %}background: #d4edda !important; border-color: #28a745 !important;{% elseif esIncorrecta %}background: #f8d7da !important; border-color: #dc3545 !important;{% elseif esSeleccionada and not mostrarRespuestas %}background: #e3f2fd; border-color: var(--color-primary);{% endif %}
                               {% if preguntaBloqueada is defined and preguntaBloqueada and not esCorrecta and not esIncorrecta %}opacity: 0.7;{% endif %}">
                            <input type="radio" name="respuesta" value="{{ letra }}" 
                                   style="margin-right: 1rem; margin-top: 0.25rem;" 
                                   {% if esSeleccionada %}checked{% endif %}
                                   {% if preguntaBloqueada is defined and preguntaBloqueada %}disabled{% endif %}
                                   data-opcion="{{ letra }}">
                            <div style="flex: 1;">
                                <strong style="color: var(--color-primary);">{{ letra }})</strong> {{ texto }}
                                {% if esCorrecta %}
                                    <span style="display: inline-block; margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: #28a745; color: white; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">‚úì Correcta</span>
                                {% elseif esIncorrecta %}
                                    <span style="display: inline-block; margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: #dc3545; color: white; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">‚úó Incorrecta</span>
                                {% endif %}
                            </div>
                        </label>
                    {% endfor %}
                </div>
                
                {# Mostrar retroalimentaci√≥n en modo estudio cuando la pregunta est√° bloqueada (despu√©s de responder) #}
                {% if modoEstudio is defined and modoEstudio and preguntaBloqueada is defined and preguntaBloqueada and retroalimentacion %}
                    <div id="retroalimentacion-container" style="margin-top: 1.5rem; padding: 1rem; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.2rem;">üí°</span>
                            <strong style="color: #1565C0;">Retroalimentaci√≥n:</strong>
                        </div>
                        <div style="margin: 0; color: #333; line-height: 1.6;">{{ retroalimentacion|markdown|raw }}</div>
                    </div>
                {% endif %}
            </div>

            <div class="d-flex gap-2 mt-4">
                {% if not esPrimera %}
                    <button type="submit" name="accion" value="anterior" class="btn btn-secondary">Anterior</button>
                {% endif %}
                {% if not esUltima %}
                    <button type="submit" name="accion" value="siguiente" class="btn btn-primary">Siguiente</button>
                {% else %}
                    <button type="submit" name="accion" value="finalizar" class="btn btn-success" id="btnFinalizarExamen" onclick="return confirm('¬øEst√°s seguro de finalizar el examen?');">Finalizar Examen</button>
                {% endif %}
                {% if modoEstudio is defined and modoEstudio and not esUltima %}
                    <button type="submit" name="accion" value="finalizar" class="btn btn-success" id="btnFinalizarExamenModoEstudio" onclick="return confirm('¬øEst√°s seguro de finalizar el examen?');">Finalizar Examen</button>
                {% endif %}
                <button type="submit" name="accion" value="guardar_borrador" class="btn btn-secondary" id="btnGuardarBorrador" style="margin-left: auto;">üíæ Guardar y continuar m√°s tarde</button>
            </div>
        </form>

        {% if is_granted('ROLE_USER') and not is_granted('ROLE_PROFESOR') and not is_granted('ROLE_ADMIN') %}
        <div style="margin-top: 2rem; border-top: 2px solid #ddd; padding-top: 1.5rem;">
            <div class="d-flex gap-2 align-items-center mb-3">
                <button type="button" class="btn btn-info position-relative btn-sm" id="btnVerMensajes" data-pregunta-id="{{ pregunta.id }}">
                    <span>üí¨ Ver Mensajes</span>
                    <span class="badge bg-danger position-absolute top-0 start-100 translate-middle" id="contadorMensajes" style="display: none; font-size: 0.65rem; padding: 0.2rem 0.4rem;">0</span>
                </button>
            </div>
            
            <div class="card" style="border-left: 4px solid #FF9800; max-width: 500px;">
                <div class="card-header" style="background-color: #fff3cd; padding: 0.75rem;">
                    <h5 style="margin: 0; color: #856404; font-size: 0.9rem;">‚ö†Ô∏è Reportar Error en esta Pregunta</h5>
                </div>
                <div class="card-body" style="padding: 1rem;">
                    <form method="post" id="formReportePregunta" data-pregunta-id="{{ pregunta.id }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('reportar_error_pregunta_' ~ pregunta.id) }}">
                        <div class="form-group mb-2">
                            <textarea name="mensaje" class="form-control" rows="3" placeholder="Describe el error que encontraste en esta pregunta..." required style="width: 100%; font-size: 0.85rem;"></textarea>
                            <small style="color: #666; font-size: 0.7rem;">Los profesores y administradores ser√°n notificados de tu solicitud.</small>
                        </div>
                        <button type="submit" class="btn btn-warning btn-sm">Enviar Reporte</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para mostrar mensajes -->
        <div id="modalMensajesPregunta" style="display: none; position: fixed; z-index: 99999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto;">
            <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; border-radius: 8px; width: 90%; max-width: 800px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); max-height: 80vh; display: flex; flex-direction: column; position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: var(--color-primary); font-size: 1.1rem;">üí¨ Mensajes sobre esta Pregunta</h3>
                    <span id="cerrarModalMensajesPregunta" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; user-select: none;" onclick="cerrarModalMensajesPregunta()">&times;</span>
                </div>
                <div id="contenidoMensajesPregunta" style="padding: 1.5rem; overflow-y: auto; flex: 1; min-height: 200px;">
                    <div style="text-align: center; padding: 2rem;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 1rem; color: #666;">Cargando...</p>
                    </div>
                </div>
                <div style="padding: 1rem; border-top: 1px solid #ddd; text-align: right;">
                    <button onclick="cerrarModalMensajesPregunta()" class="btn btn-secondary btn-sm">Cerrar</button>
                </div>
            </div>
        </div>

        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>

        <script>
        (function() {
            'use strict';
            let contenidoMensajesPregunta = null;
            let contadorMensajesPregunta = null;
            const preguntaId = {{ pregunta.id }};

        function cargarMensajesPregunta() {
            if (!contenidoMensajesPregunta) {
                contenidoMensajesPregunta = document.getElementById('contenidoMensajesPregunta');
            }
            
            if (!contenidoMensajesPregunta) {
                console.error('No se encontr√≥ el elemento contenidoMensajesPregunta');
                return;
            }
            
            contenidoMensajesPregunta.innerHTML = '<div style="text-align: center; padding: 2rem;"><div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 1rem; color: #666;">Cargando...</p></div>';
            
            fetch(`/pregunta/${preguntaId}/mensajes`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.mensajes && data.mensajes.length === 0) {
                        contenidoMensajesPregunta.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No hay mensajes a√∫n sobre esta pregunta.</p>';
                    } else if (data.mensajes) {
                        let html = '<div style="display: grid; gap: 1rem;">';
                        data.mensajes.forEach(function(mensaje) {
                            const autor = mensaje.autor || 'Usuario eliminado';
                            const fecha = mensaje.fechaCreacion || '';
                            const mensajeTexto = mensaje.mensaje || '';
                            const esProfesor = mensaje.esProfesor || false;
                            const mensajeId = mensaje.id;
                            const respuestas = mensaje.respuestas || [];
                            const tieneRespuestas = mensaje.tieneRespuestas || false;
                            
                            const borderColor = esProfesor ? '#28a745' : 'var(--color-primary)';
                            const bgColor = esProfesor ? '#f0f9f4' : '#fff';
                            const badgeColor = esProfesor ? '#28a745' : 'var(--color-primary)';
                            
                            html += `
                                <div style="padding: 1rem; border: 1px solid #ddd; border-left: 4px solid ${borderColor}; border-radius: 4px; background-color: ${bgColor}; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <strong style="color: ${badgeColor}; font-size: 0.9rem;">
                                                ${autor}
                                                ${esProfesor ? '<span style="background-color: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 0.5rem;">Profesor</span>' : '<span style="background-color: var(--color-primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 0.5rem;">Alumno</span>'}
                                            </strong>
                                        </div>
                                        <small style="color: #999; font-size: 0.8rem;">${fecha}</small>
                                    </div>
                                    <p style="margin: 0 0 1rem 0; color: #333; white-space: pre-wrap; line-height: 1.5; font-size: 0.9rem;">${mensajeTexto}</p>
                                    
                                    ${tieneRespuestas ? `
                                        <div style="margin-left: 1rem; margin-top: 1rem; padding-left: 1rem; border-left: 3px solid #ddd;">
                                            <strong style="color: #666; font-size: 0.85rem; margin-bottom: 0.5rem; display: block;">Respuestas:</strong>
                                    ` : ''}
                                    
                                    ${respuestas.map(function(respuesta) {
                                        const respuestaEsProfesor = respuesta.esProfesor || false;
                                        const respuestaBorderColor = respuestaEsProfesor ? '#28a745' : 'var(--color-primary)';
                                        const respuestaBgColor = respuestaEsProfesor ? '#f0f9f4' : '#fff';
                                        return `
                                            <div style="padding: 0.75rem; border: 1px solid #ddd; border-left: 4px solid ${respuestaBorderColor}; border-radius: 4px; background-color: ${respuestaBgColor}; margin-bottom: 0.75rem;">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                    <strong style="color: ${respuestaBorderColor}; font-size: 0.85rem;">
                                                        ${respuesta.autor}
                                                        ${respuestaEsProfesor ? '<span style="background-color: #28a745; color: white; padding: 2px 6px; border-radius: 12px; font-size: 0.65rem; margin-left: 0.5rem;">Profesor</span>' : ''}
                                                    </strong>
                                                    <small style="color: #999; font-size: 0.8rem;">${respuesta.fechaCreacion}</small>
                                                </div>
                                                <p style="margin: 0; color: #333; white-space: pre-wrap; line-height: 1.5; font-size: 0.85rem;">${respuesta.mensaje}</p>
                                            </div>
                                        `;
                                    }).join('')}
                                    
                                    ${tieneRespuestas ? '</div>' : ''}
                                </div>
                            `;
                        });
                        html += '</div>';
                        contenidoMensajesPregunta.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    contenidoMensajesPregunta.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 2rem;">Error al cargar los mensajes.</p>';
                });
        }

        function abrirModalMensajesPregunta(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            const modal = document.getElementById('modalMensajesPregunta');
            if (modal) {
                modal.style.display = 'block';
                cargarMensajesPregunta();
            } else {
                console.error('No se encontr√≥ el modal modalMensajesPregunta');
            }
        }

        function cerrarModalMensajesPregunta() {
            const modal = document.getElementById('modalMensajesPregunta');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Cerrar modal al hacer clic fuera de √©l
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('modalMensajesPregunta');
            if (modal && event.target == modal) {
                cerrarModalMensajesPregunta();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const btnVerMensajes = document.getElementById('btnVerMensajes');
            contadorMensajesPregunta = document.getElementById('contadorMensajes');
            contenidoMensajesPregunta = document.getElementById('contenidoMensajesPregunta');
            const formReporte = document.getElementById('formReportePregunta');
            
            function cargarContador() {
                fetch(`/pregunta/${preguntaId}/contador-mensajes`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (contadorMensajesPregunta) {
                            if (data.contador > 0) {
                                contadorMensajesPregunta.textContent = data.contador;
                                contadorMensajesPregunta.style.display = 'inline-block';
                            } else {
                                contadorMensajesPregunta.style.display = 'none';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error al cargar contador:', error);
                    });
            }

            if (btnVerMensajes) {
                btnVerMensajes.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    abrirModalMensajesPregunta(e);
                });
            } else {
                console.warn('No se encontr√≥ el bot√≥n btnVerMensajes');
            }

            if (formReporte) {
                formReporte.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const formData = new FormData(formReporte);
                    const submitBtn = formReporte.querySelector('button[type="submit"]');
                    const originalText = submitBtn ? submitBtn.textContent : 'Enviar Reporte';
                    
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Enviando...';
                    }
                    
                    fetch(`/pregunta/${preguntaId}/reportar-error`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Mostrar mensaje de √©xito sin alert
                            const mensajeExito = document.createElement('div');
                            mensajeExito.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 1rem; border-radius: 4px; z-index: 100000; box-shadow: 0 4px 6px rgba(0,0,0,0.3);';
                            mensajeExito.textContent = '‚úì Error reportado correctamente. Los profesores han sido notificados.';
                            document.body.appendChild(mensajeExito);
                            setTimeout(() => mensajeExito.remove(), 3000);
                            
                            // Limpiar formulario
                            const textarea = formReporte.querySelector('[name="mensaje"]');
                            if (textarea) {
                                textarea.value = '';
                            }
                            
                            // Recargar contador y mensajes
                            setTimeout(cargarContador, 500);
                            if (document.getElementById('modalMensajesPregunta') && document.getElementById('modalMensajesPregunta').style.display === 'block') {
                                setTimeout(cargarMensajesPregunta, 500);
                            }
                        } else {
                            alert(data.error || 'Error al enviar el reporte.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al enviar el reporte. Por favor, int√©ntalo de nuevo.');
                    })
                    .finally(() => {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    });
                });
            } else {
                console.warn('No se encontr√≥ el formulario formReportePregunta');
            }

            cargarContador();
        });
        
        // Exponer funciones necesarias globalmente
        window.abrirModalMensajesPregunta = abrirModalMensajesPregunta;
        window.cerrarModalMensajesPregunta = cerrarModalMensajesPregunta;
        })();
        </script>
        {% endif %}

        <!-- Modal para mostrar porcentajes por tema -->
        {% if porcentajesPorTema|length > 0 %}
        <div id="modalPorcentajes" style="display: none; position: fixed; z-index: 99999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto;">
            <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0; color: var(--color-primary); font-size: 1.2rem;">üìä Distribuci√≥n de Preguntas por Tema</h3>
                    <span id="cerrarModalPorcentajes" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; user-select: none;" onclick="cerrarModalPorcentajes()">&times;</span>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="display: grid; gap: 0.75rem;">
                        {% for temaId, datos in porcentajesPorTema %}
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; border-left: 4px solid var(--color-primary);">
                                <div>
                                    <strong style="color: #333;">{{ datos.nombre }}</strong>
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">{{ datos.cantidad }} pregunta{{ datos.cantidad != 1 ? 's' : '' }}</div>
                                </div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--color-primary);">
                                    {{ datos.porcentaje }}%
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div style="padding: 1rem; border-top: 1px solid #ddd; text-align: right;">
                    <button onclick="cerrarModalPorcentajes()" class="btn btn-secondary btn-sm">Cerrar</button>
                </div>
            </div>
        </div>

        <script>
        function abrirModalPorcentajes() {
            const modal = document.getElementById('modalPorcentajes');
            if (!modal) {
                console.error('No se encontr√≥ el modal modalPorcentajes');
                return;
            }
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function cerrarModalPorcentajes() {
            const modal = document.getElementById('modalPorcentajes');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // Cerrar modal al hacer clic fuera de √©l
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalPorcentajes');
            if (modal && event.target === modal) {
                cerrarModalPorcentajes();
            }
        });

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('modalPorcentajes');
                if (modal && modal.style.display === 'block') {
                    cerrarModalPorcentajes();
                }
            }
        });

        // Funci√≥n para inicializar el bot√≥n (se ejecuta tanto en carga inicial como en navegaciones Turbo)
        function inicializarBotonPorcentajes() {
            const btnVerPorcentajes = document.getElementById('btnVerPorcentajes');
            if (btnVerPorcentajes) {
                // Verificar si ya tiene un listener asignado para evitar duplicados
                if (!btnVerPorcentajes.dataset.listenerAsignado) {
                    btnVerPorcentajes.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        abrirModalPorcentajes();
                        return false;
                    });
                    btnVerPorcentajes.dataset.listenerAsignado = 'true';
                }
            } else {
                console.warn('No se encontr√≥ el bot√≥n btnVerPorcentajes');
            }
            
            // Tambi√©n asignar la funci√≥n global para el onclick del span de cerrar
            window.cerrarModalPorcentajes = cerrarModalPorcentajes;
        }

        // Ejecutar en carga inicial
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarBotonPorcentajes);
        } else {
            // Si el DOM ya est√° cargado, ejecutar inmediatamente
            inicializarBotonPorcentajes();
        }

        // Ejecutar tambi√©n en navegaciones de Turbo
        document.addEventListener('turbo:load', inicializarBotonPorcentajes);
        document.addEventListener('turbo:frame-load', inicializarBotonPorcentajes);
        </script>
        {% endif %}

        {# Script para modo estudio y temporizador #}
        <script>
        (function() {
            'use strict';
            
            // Modo estudio: manejar selecci√≥n de respuesta
            {% if modoEstudio is defined and modoEstudio %}
            const modoEstudioActivo = true;
            let preguntaBloqueada = {{ preguntaBloqueada is defined and preguntaBloqueada ? 'true' : 'false' }};
            const preguntaId = {{ pregunta.id }};
            
            if (!preguntaBloqueada) {
                // Agregar listeners a los radio buttons
                const radioButtons = document.querySelectorAll('input[name="respuesta"]');
                let enviandoRespuesta = false;
                
                radioButtons.forEach(function(radio) {
                    radio.addEventListener('change', function() {
                        if (this.checked && !preguntaBloqueada && !enviandoRespuesta) {
                            enviandoRespuesta = true;
                            // Deshabilitar todos los radio buttons mientras se env√≠a
                            radioButtons.forEach(function(rb) {
                                rb.disabled = true;
                            });
                            
                            // Enviar respuesta inmediatamente
                            enviarRespuestaModoEstudio(this.value);
                        }
                    });
                });
            }
            
            function enviarRespuestaModoEstudio(respuesta) {
                const form = document.getElementById('formPregunta');
                if (!form) {
                    enviandoRespuesta = false;
                    return;
                }
                
                // Crear FormData con todos los campos del formulario
                const formData = new FormData(form);
                formData.set('respuesta', respuesta);
                
                // Enviar formulario con AJAX
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.redirected) {
                        // Si hay redirecci√≥n, seguirla para mostrar la respuesta correcta
                        window.location.href = response.url;
                    } else if (response.ok) {
                        // Si la respuesta es OK pero no hay redirecci√≥n, recargar la p√°gina
                        window.location.reload();
                    } else {
                        throw new Error('Error en la respuesta del servidor');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // En caso de error, recargar la p√°gina
                    window.location.reload();
                });
            }
            {% else %}
            const modoEstudioActivo = false;
            {% endif %}
            
            
            // Variables del temporizador
            let tiempoInicio = null;
            let tiempoLimite = null; // En segundos
            let tiempoPausado = 0; // Tiempo acumulado en pausa
            let tiempoUltimaPausa = null; // Timestamp de cuando se paus√≥
            let intervalo = null;
            let estaPausado = false;
            
            // Obtener tiempo l√≠mite de la configuraci√≥n (en minutos, convertir a segundos)
            // Obtener tiempo l√≠mite o tiempo restante del borrador
            const tiempoRestanteBorrador = {{ (config.tiempo_restante ?? null)|default('null') }};
            const tiempoLimiteMinutos = {{ (config.tiempo_limite ?? 60)|default(60) }};
            
            if (tiempoRestanteBorrador !== null && tiempoRestanteBorrador > 0) {
                // Si hay tiempo restante del borrador, usarlo
                tiempoLimite = tiempoRestanteBorrador;
            } else {
                // Si no, usar el tiempo l√≠mite configurado
                tiempoLimite = tiempoLimiteMinutos * 60;
            }
            
            // Funci√≥n para formatear el tiempo
            function formatearTiempo(segundos) {
                const horas = Math.floor(segundos / 3600);
                const minutos = Math.floor((segundos % 3600) / 60);
                const segs = segundos % 60;
                
                if (horas > 0) {
                    return `${horas}:${String(minutos).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;
                }
                return `${String(minutos).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;
            }
            
            // Funci√≥n para actualizar el temporizador
            function actualizarTemporizador() {
                if (!tiempoInicio || !tiempoLimite || estaPausado) return;
                
                const ahora = Date.now();
                const tiempoTranscurrido = Math.floor((ahora - tiempoInicio - tiempoPausado) / 1000);
                const tiempoRestante = Math.max(0, tiempoLimite - tiempoTranscurrido);
                
                const timerDisplay = document.getElementById('timer-display');
                if (timerDisplay) {
                    timerDisplay.textContent = formatearTiempo(tiempoRestante);
                    
                    // Cambiar color cuando quedan menos de 5 minutos
                    const timerContainer = document.getElementById('examen-timer');
                    if (timerContainer) {
                        if (tiempoRestante <= 300 && tiempoRestante > 0) {
                            timerContainer.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                            timerContainer.style.animation = tiempoRestante <= 60 ? 'pulse 1s infinite' : 'none';
                        } else if (tiempoRestante === 0) {
                            timerContainer.style.background = 'linear-gradient(135deg, #ff0000 0%, #cc0000 100%)';
                            // Finalizar examen autom√°ticamente
                            finalizarExamenPorTiempo();
                        } else {
                            timerContainer.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                            timerContainer.style.animation = 'none';
                        }
                    }
                }
            }
            
            // Funci√≥n para finalizar examen por tiempo
            function finalizarExamenPorTiempo() {
                if (intervalo) {
                    clearInterval(intervalo);
                    intervalo = null;
                }
                
                if (window.confirm) {
                    if (confirm('‚è±Ô∏è Se ha agotado el tiempo del examen. El examen se finalizar√° autom√°ticamente.')) {
            const formPregunta = document.getElementById('formPregunta');
                        if (formPregunta) {
                            const inputFinalizar = document.createElement('input');
                            inputFinalizar.type = 'hidden';
                            inputFinalizar.name = 'accion';
                            inputFinalizar.value = 'finalizar';
                            formPregunta.appendChild(inputFinalizar);
                            formPregunta.submit();
                        }
                    }
                }
            }
            
            // Funci√≥n para pausar/reanudar
            function togglePausa() {
                const btnPausa = document.getElementById('timer-pause-btn');
                const timerDisplay = document.getElementById('timer-display');
                
                if (!btnPausa) {
                    console.error('No se encontr√≥ el bot√≥n timer-pause-btn en togglePausa');
                    return;
                }
                
                if (estaPausado) {
                    // Reanudar
                    if (tiempoUltimaPausa) {
                        const tiempoEnPausa = Date.now() - tiempoUltimaPausa;
                        tiempoPausado += tiempoEnPausa;
                        tiempoUltimaPausa = null;
                        localStorage.setItem('examen_tiempo_pausado_total', tiempoPausado.toString());
                    }
                    estaPausado = false;
                    btnPausa.textContent = '‚è∏Ô∏è Pausar';
                    btnPausa.style.background = '#6c757d';
                    btnPausa.title = 'Pausar temporizador';
                    if (timerDisplay) {
                        timerDisplay.style.opacity = '1';
                    }
                    // Guardar estado en localStorage
                    localStorage.setItem('examen_timer_pausado', 'false');
                    localStorage.removeItem('examen_timer_ultima_pausa');
                } else {
                    // Pausar
                    tiempoUltimaPausa = Date.now();
                    estaPausado = true;
                    btnPausa.textContent = '‚ñ∂Ô∏è Reanudar';
                    btnPausa.style.background = '#28a745';
                    btnPausa.title = 'Reanudar temporizador';
                    if (timerDisplay) {
                        timerDisplay.style.opacity = '0.6';
                    }
                    // Guardar estado en localStorage
                    localStorage.setItem('examen_timer_pausado', 'true');
                    localStorage.setItem('examen_timer_ultima_pausa', tiempoUltimaPausa.toString());
                }
                
                // Actualizar el temporizador inmediatamente
                actualizarTemporizador();
            }
            
            // Inicializar temporizador
            function inicializarTemporizador() {
                // Limpiar intervalo anterior si existe
                if (intervalo) {
                    clearInterval(intervalo);
                    intervalo = null;
                }
                
                // Obtener tiempo de inicio desde localStorage o crear uno nuevo
                const tiempoInicioStorage = localStorage.getItem('examen_tiempo_inicio');
                const tiempoPausadoStorage = localStorage.getItem('examen_tiempo_pausado_total');
                const estaPausadoStorage = localStorage.getItem('examen_timer_pausado');
                const ultimaPausaStorage = localStorage.getItem('examen_timer_ultima_pausa');
                
                if (tiempoInicioStorage) {
                    tiempoInicio = parseInt(tiempoInicioStorage);
                    tiempoPausado = tiempoPausadoStorage ? parseInt(tiempoPausadoStorage) : 0;
                    estaPausado = estaPausadoStorage === 'true';
                    
                    if (estaPausado && ultimaPausaStorage) {
                        tiempoUltimaPausa = parseInt(ultimaPausaStorage);
                    }
                    
                    // Verificar si el tiempo ha expirado
                    const ahora = Date.now();
                    // Si est√° pausado, calcular el tiempo pausado hasta ahora
                    let tiempoPausadoActual = tiempoPausado;
                    if (estaPausado && tiempoUltimaPausa) {
                        tiempoPausadoActual += (ahora - tiempoUltimaPausa);
                    }
                    const tiempoTranscurrido = Math.floor((ahora - tiempoInicio - tiempoPausadoActual) / 1000);
                    if (tiempoTranscurrido >= tiempoLimite) {
                        finalizarExamenPorTiempo();
                        return;
                    }
                } else {
                    // Primera vez: establecer tiempo de inicio
                    tiempoInicio = Date.now();
                    tiempoPausado = 0;
                    estaPausado = false;
                    localStorage.setItem('examen_tiempo_inicio', tiempoInicio.toString());
                    localStorage.setItem('examen_tiempo_limite', tiempoLimite.toString());
                    localStorage.setItem('examen_tiempo_pausado_total', '0');
                    localStorage.setItem('examen_timer_pausado', 'false');
                }
                
                // Actualizar bot√≥n de pausa
                const btnPausa = document.getElementById('timer-pause-btn');
                if (btnPausa) {
                    if (estaPausado) {
                        btnPausa.textContent = '‚ñ∂Ô∏è Reanudar';
                        btnPausa.style.background = '#28a745';
                        btnPausa.title = 'Reanudar temporizador';
                    } else {
                        btnPausa.textContent = '‚è∏Ô∏è Pausar';
                        btnPausa.style.background = '#6c757d';
                        btnPausa.title = 'Pausar temporizador';
                    }
                }
                
                // Actualizar cada segundo
                intervalo = setInterval(function() {
                    if (!estaPausado) {
                        actualizarTemporizador();
                    } else {
                        // Si est√° pausado, actualizar el tiempo pausado acumulado
                        if (tiempoUltimaPausa) {
                            const tiempoEnPausa = Date.now() - tiempoUltimaPausa;
                            localStorage.setItem('examen_tiempo_pausado_total', (tiempoPausado + tiempoEnPausa).toString());
                        }
                    }
                }, 1000);
                
                actualizarTemporizador(); // Llamar inmediatamente
            }
            
            // Limpiar temporizador al finalizar examen
            function limpiarTemporizador() {
                if (intervalo) {
                    clearInterval(intervalo);
                    intervalo = null;
                }
                localStorage.removeItem('examen_tiempo_inicio');
                localStorage.removeItem('examen_tiempo_limite');
                localStorage.removeItem('examen_tiempo_pausado_total');
                localStorage.removeItem('examen_timer_pausado');
                localStorage.removeItem('examen_timer_ultima_pausa');
            }
            
            // Inicializar cuando el DOM est√© listo
            function inicializarTodo() {
                // Inicializar temporizador
                inicializarTemporizador();
                
                // Bot√≥n de pausa/reanudar
                const btnPausa = document.getElementById('timer-pause-btn');
                if (btnPausa) {
                    // Usar onclick directamente para evitar problemas con m√∫ltiples listeners
                    btnPausa.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        console.log('Bot√≥n de pausa clickeado');
                        togglePausa();
                        return false;
                    };
                } else {
                    console.error('No se encontr√≥ el bot√≥n timer-pause-btn');
                }
                
                // Limpiar temporizador al hacer clic en "Finalizar Examen"
                const btnFinalizar = document.getElementById('btnFinalizarExamen') || document.querySelector('button[name="accion"][value="finalizar"]');
                if (btnFinalizar) {
                    btnFinalizar.addEventListener('click', function() {
                        limpiarTemporizador();
                    });
                }
                
                // Tambi√©n limpiar al enviar el formulario con acci√≥n finalizar
                const formPregunta = document.getElementById('formPregunta');
                if (formPregunta) {
                    formPregunta.addEventListener('submit', function(e) {
                        const accion = document.querySelector('button[name="accion"][value="finalizar"]');
                        if (accion && accion.form === formPregunta) {
                            limpiarTemporizador();
                        }
                        
                        // Si es guardar borrador, a√±adir tiempo restante
                        const btnGuardar = document.getElementById('btnGuardarBorrador');
                        if (btnGuardar && btnGuardar.form === formPregunta && document.querySelector('button[name="accion"][value="guardar_borrador"]:focus')) {
                            // Calcular tiempo restante
                            const tiempoRestante = tiempoLimite - (Date.now() - tiempoInicio) / 1000 + tiempoPausado;
                            const inputTiempo = document.createElement('input');
                            inputTiempo.type = 'hidden';
                            inputTiempo.name = 'tiempo_restante';
                            inputTiempo.value = Math.max(0, Math.floor(tiempoRestante));
                            formPregunta.appendChild(inputTiempo);
                        }
                    });
                    
                    // Navegaci√≥n r√°pida de preguntas
                    const preguntaLinks = document.querySelectorAll('.pregunta-link');
                    
                    preguntaLinks.forEach(function(link) {
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            
                            const numeroDestino = parseInt(this.getAttribute('data-pregunta-num'));
                            const numeroActual = {{ numero }};
                            
                            // Si es la misma pregunta, no hacer nada
                            if (numeroDestino === numeroActual || isNaN(numeroDestino)) {
                                return false;
                            }
                            
                            // Guardar respuesta actual si hay alguna seleccionada
                            const respuestaSeleccionada = formPregunta.querySelector('input[name="respuesta"]:checked');
                            
                            // Eliminar cualquier input destino existente
                            const inputDestinoExistente = formPregunta.querySelector('input[name="numero_destino"]');
                            if (inputDestinoExistente) {
                                inputDestinoExistente.remove();
                            }
                            
                            // Crear un input oculto para el n√∫mero destino
                            const inputDestino = document.createElement('input');
                            inputDestino.type = 'hidden';
                            inputDestino.name = 'numero_destino';
                            inputDestino.value = numeroDestino;
                            formPregunta.appendChild(inputDestino);
                            
                            // Enviar el formulario directamente
                            try {
                                formPregunta.submit();
                            } catch (error) {
                                console.error('Error al enviar el formulario:', error);
                                // Si falla el submit, redirigir directamente
                        window.location.href = '{{ path('app_examen_pregunta', {'numero': '__NUM__'}) }}'.replace('__NUM__', numeroDestino);
                            }
                            
                            return false;
                        });
                    });
                } else {
                    console.error('No se encontr√≥ el formulario formPregunta');
                }
            }
            
            // Inicializar cuando el DOM est√© listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', inicializarTodo);
            } else {
                inicializarTodo();
            }
            
            // Tambi√©n inicializar en eventos de Turbo
            document.addEventListener('turbo:load', inicializarTodo);
            document.addEventListener('turbo:frame-load', function() {
                if (document.getElementById('formPregunta')) {
                    inicializarTodo();
                }
            });
        })();
        </script>
        
        <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        #timer-pause-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        #timer-pause-btn:active {
            transform: scale(0.98);
        }
        </style>
    </div>
</div>
{% endblock %}

