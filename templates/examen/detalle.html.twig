{% extends 'base.html.twig' %}

{% block title %}Detalle del Examen{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <h1>Examen del {{ examen.fecha|date('d/m/Y H:i') }}</h1>
        {% if is_granted('ROLE_PROFESOR') or is_granted('ROLE_ADMIN') %}
            <p style="margin: 0.5rem 0 0 0; font-size: 1rem; opacity: 0.9;">
                Alumno: <strong>{{ examen.usuario.username }}</strong>
            </p>
        {% endif %}
    </div>
    <div class="card-body">
        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%); color: white; border-radius: 8px; margin-bottom: 2rem;">
            <h2 style="margin: 0; font-size: 3rem;">{{ examen.nota|number_format(2, ',', '.') }}</h2>
            <p style="margin: 0.5rem 0 0 0; font-size: 1.2rem;">sobre 20 puntos</p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h3 style="color: var(--color-success); font-size: 2rem; margin: 0;">{{ examen.aciertos }}</h3>
                    <p style="margin: 0.5rem 0 0 0;">Aciertos</p>
                </div>
            </div>
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h3 style="color: var(--color-danger); font-size: 2rem; margin: 0;">{{ examen.errores }}</h3>
                    <p style="margin: 0.5rem 0 0 0;">Errores</p>
                </div>
            </div>
            {% if examen.enBlanco > 0 %}
                <div class="card" style="text-align: center;">
                    <div class="card-body">
                        <h3 style="color: #999; font-size: 2rem; margin: 0;">{{ examen.enBlanco }}</h3>
                        <p style="margin: 0.5rem 0 0 0;">En blanco</p>
                    </div>
                </div>
            {% endif %}
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h3 style="color: var(--color-primary); font-size: 2rem; margin: 0;">{{ examen.numeroPreguntas }}</h3>
                    <p style="margin: 0.5rem 0 0 0;">Total</p>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <strong>Dificultad:</strong> <span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span>
        </div>

        <div class="mb-4">
            {% if examen.municipio %}
                <strong>Municipio:</strong> <span class="badge" style="background-color: #2196F3;">{{ examen.municipio.nombre }}</span><br>
                <strong>Temas Municipales:</strong>
                {% for temaMunicipal in examen.temasMunicipales %}
                    <span class="badge badge-facil">{{ temaMunicipal.nombre }}</span>
                {% endfor %}
            {% else %}
                <strong>Temas:</strong>
                {% for tema in examen.temas %}
                    <span class="badge badge-facil">{{ tema.nombre }}</span>
                {% endfor %}
            {% endif %}
        </div>

        <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Detalle de Preguntas</h3>

        {% for item in preguntas %}
            <div class="card mb-3" style="{% if item.esCorrecta is null %}border-left: 4px solid #999;{% elseif item.esCorrecta %}border-left: 4px solid var(--color-success);{% else %}border-left: 4px solid var(--color-danger);{% endif %}">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <h4 style="margin: 0;">Pregunta {{ loop.index }}</h4>
                        {% if item.esCorrecta is null %}
                            <span class="badge" style="background-color: #999; color: white;">○ Sin responder</span>
                        {% elseif item.esCorrecta %}
                            <span class="badge badge-facil">✓ Correcta</span>
                        {% else %}
                            <span class="badge badge-dificil">✗ Incorrecta</span>
                        {% endif %}
                    </div>

                    <p><strong>{{ item.pregunta.texto }}</strong></p>

                    <div style="margin: 1rem 0;">
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if item.esCorrecta is null %}{% elseif item.respuestaAlumno == 'A' and not item.esCorrecta %}background: #ffebee;{% elseif item.pregunta.respuestaCorrecta == 'A' %}background: #e8f5e9;{% endif %}">
                            <strong>A)</strong> {{ item.pregunta.opcionA }}
                            {% if item.esCorrecta is not null %}
                                {% if item.respuestaAlumno == 'A' and not item.esCorrecta %}<span style="color: var(--color-danger);">← Respuesta del alumno (incorrecta)</span>{% endif %}
                                {% if item.pregunta.respuestaCorrecta == 'A' %}<span style="color: var(--color-success);">← Correcta</span>{% endif %}
                            {% endif %}
                        </div>
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if item.esCorrecta is null %}{% elseif item.respuestaAlumno == 'B' and not item.esCorrecta %}background: #ffebee;{% elseif item.pregunta.respuestaCorrecta == 'B' %}background: #e8f5e9;{% endif %}">
                            <strong>B)</strong> {{ item.pregunta.opcionB }}
                            {% if item.esCorrecta is not null %}
                                {% if item.respuestaAlumno == 'B' and not item.esCorrecta %}<span style="color: var(--color-danger);">← Respuesta del alumno (incorrecta)</span>{% endif %}
                                {% if item.pregunta.respuestaCorrecta == 'B' %}<span style="color: var(--color-success);">← Correcta</span>{% endif %}
                            {% endif %}
                        </div>
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if item.esCorrecta is null %}{% elseif item.respuestaAlumno == 'C' and not item.esCorrecta %}background: #ffebee;{% elseif item.pregunta.respuestaCorrecta == 'C' %}background: #e8f5e9;{% endif %}">
                            <strong>C)</strong> {{ item.pregunta.opcionC }}
                            {% if item.esCorrecta is not null %}
                                {% if item.respuestaAlumno == 'C' and not item.esCorrecta %}<span style="color: var(--color-danger);">← Respuesta del alumno (incorrecta)</span>{% endif %}
                                {% if item.pregunta.respuestaCorrecta == 'C' %}<span style="color: var(--color-success);">← Correcta</span>{% endif %}
                            {% endif %}
                        </div>
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if item.esCorrecta is null %}{% elseif item.respuestaAlumno == 'D' and not item.esCorrecta %}background: #ffebee;{% elseif item.pregunta.respuestaCorrecta == 'D' %}background: #e8f5e9;{% endif %}">
                            <strong>D)</strong> {{ item.pregunta.opcionD }}
                            {% if item.esCorrecta is not null %}
                                {% if item.respuestaAlumno == 'D' and not item.esCorrecta %}<span style="color: var(--color-danger);">← Respuesta del alumno (incorrecta)</span>{% endif %}
                                {% if item.pregunta.respuestaCorrecta == 'D' %}<span style="color: var(--color-success);">← Correcta</span>{% endif %}
                            {% endif %}
                        </div>
                        {% if item.esCorrecta is null %}
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: #f5f5f5; border-radius: 4px; color: #666; font-style: italic;">
                                Esta pregunta no fue respondida y no afecta la calificación.
                            </div>
                        {% endif %}
                    </div>

                    {% if item.pregunta.retroalimentacion %}
                        <div class="alert alert-info" style="margin-top: 1rem;">
                            <strong>Retroalimentación:</strong> {{ item.pregunta.retroalimentacion }}
                        </div>
                    {% endif %}

                    {% if not examen.municipio and item.pregunta.articulo and item.pregunta.articulo.explicacion %}
                        <details style="margin-top: 1rem;">
                            <summary style="cursor: pointer; font-weight: bold; color: var(--color-primary);">Ver Explicación del Artículo</summary>
                            <div style="background: #e3f2fd; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; border-left: 4px solid var(--color-secondary); line-height: 1.6;">
                                <p><strong>Artículo {{ item.pregunta.articulo.numero }} - {{ item.pregunta.ley.nombre }}</strong></p>
                                <div>{{ item.pregunta.articulo.explicacion|markdown|raw }}</div>
                            </div>
                        </details>
                    {% endif %}
                </div>
            </div>
        {% endfor %}

        <div class="d-flex gap-2 mt-4">
            {% if is_granted('ROLE_PROFESOR') or is_granted('ROLE_ADMIN') %}
                <a href="{{ path('app_examen_profesor') }}" class="btn btn-secondary">Volver a Exámenes</a>
            {% else %}
                <a href="{{ path('app_examen_historial') }}" class="btn btn-secondary">Volver al Historial</a>
            {% endif %}
            <a href="{{ path('app_dashboard') }}" class="btn btn-secondary">Volver al Dashboard</a>
        </div>
    </div>
</div>
{% endblock %}

