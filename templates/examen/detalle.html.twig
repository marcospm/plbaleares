{% extends 'base.html.twig' %}

{% block title %}Detalle del Examen{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <h1>Examen del {{ examen.fecha|date('d/m/Y H:i') }}</h1>
        {% if is_granted('ROLE_PROFESOR') or is_granted('ROLE_ADMIN') %}
            <p style="margin: 0.5rem 0 0 0; font-size: 1rem; opacity: 0.9;">
                Alumno: <strong>{{ examen.usuario.nombreDisplay }}</strong>
            </p>
        {% endif %}
    </div>
    <div class="card-body">
        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%); color: white; border-radius: 8px; margin-bottom: 2rem;">
            <h2 style="margin: 0; font-size: 3rem;">{{ examen.nota|number_format(2, ',', '.') }}</h2>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h3 style="color: var(--color-success); font-size: 2rem; margin: 0;">{{ examen.aciertos }}</h3>
                    <p style="margin: 0.5rem 0 0 0;">Aciertos</p>
                </div>
            </div>
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h3 style="color: var(--color-danger); font-size: 2rem; margin: 0;">{{ examen.errores }}</h3>
                    <p style="margin: 0.5rem 0 0 0;">Errores</p>
                </div>
            </div>
            {% if examen.enBlanco > 0 %}
                <div class="card" style="text-align: center;">
                    <div class="card-body">
                        <h3 style="color: #999; font-size: 2rem; margin: 0;">{{ examen.enBlanco }}</h3>
                        <p style="margin: 0.5rem 0 0 0;">En blanco</p>
                    </div>
                </div>
            {% endif %}
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h3 style="color: var(--color-primary); font-size: 2rem; margin: 0;">{{ examen.numeroPreguntas }}</h3>
                    <p style="margin: 0.5rem 0 0 0;">Total</p>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <strong>Dificultad:</strong> <span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span>
        </div>

        <details class="mb-4" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem;">
            <summary style="cursor: pointer; font-weight: bold; color: var(--color-primary); font-size: 1.1rem; user-select: none; outline: none;">
                üìö Informaci√≥n del Examen
            </summary>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                {% if examen.convocatoria %}
                    <div style="margin-bottom: 0.75rem;">
                        <strong>Convocatoria:</strong> <span class="badge" style="background-color: #9C27B0;">{{ examen.convocatoria.nombre }}</span>
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                        <strong>Municipios de la Convocatoria:</strong>
                        {% if examen.convocatoria.municipios|length > 0 %}
                            {% for municipio in examen.convocatoria.municipios %}
                                <span class="badge" style="background-color: #2196F3;">{{ municipio.nombre }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">No hay municipios asignados</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong>Temas Municipales:</strong>
                        {% if examen.temasMunicipales|length > 0 %}
                            <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                {% for temaMunicipal in examen.temasMunicipales %}
                                    <span class="badge badge-facil">{{ temaMunicipal.nombre }} ({{ temaMunicipal.municipio.nombre }})</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="text-muted">No hay temas municipales asignados</span>
                        {% endif %}
                    </div>
                {% elseif examen.municipio %}
                    <div style="margin-bottom: 0.75rem;">
                        <strong>Municipio:</strong> <span class="badge" style="background-color: #2196F3;">{{ examen.municipio.nombre }}</span>
                    </div>
                    <div>
                        <strong>Temas Municipales:</strong>
                        {% if examen.temasMunicipales|length > 0 %}
                            <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                {% for temaMunicipal in examen.temasMunicipales %}
                                    <span class="badge badge-facil">{{ temaMunicipal.nombre }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="text-muted">No hay temas municipales asignados</span>
                        {% endif %}
                    </div>
                {% else %}
                    <div>
                        <strong>Temas:</strong>
                        {% if examen.temas|length > 0 %}
                            <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                {% for tema in examen.temas %}
                                    <span class="badge badge-facil">{{ tema.nombre }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="text-muted">No hay temas asignados</span>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </details>

        <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Detalle de Preguntas</h3>

        {# Lista de n√∫meros de preguntas clicables #}
        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 0.75rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-size: 0.85rem; color: #666; font-weight: 500;">üìã Navegaci√≥n r√°pida:</span>
                <span style="font-size: 0.75rem; color: #999;">(Haz clic en cualquier n√∫mero para ir a esa pregunta)</span>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 0.35rem; justify-content: flex-start;">
                {% for item in preguntas %}
                    <a href="#pregunta-{{ loop.index }}" 
                       class="pregunta-link-detalle"
                       style="display: inline-flex; align-items: center; justify-content: center; 
                              min-width: 32px; height: 32px; 
                              border-radius: 4px; 
                              text-decoration: none; 
                              font-weight: 500; 
                              font-size: 0.8rem;
                              transition: all 0.2s;
                              cursor: pointer;
                              user-select: none;
                              {% if item.esCorrecta is null %}
                                  background: #e0e0e0;
                                  color: #666;
                                  border: 2px solid #999;
                              {% elseif item.esCorrecta %}
                                  background: #28a745;
                                  color: white;
                                  border: 2px solid #28a745;
                              {% else %}
                                  background: #dc3545;
                                  color: white;
                                  border: 2px solid #dc3545;
                              {% endif %}"
                       onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)';"
                       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                        {{ loop.index }}
                    </a>
                {% endfor %}
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.75rem; color: #666; flex-wrap: wrap;">
                <span style="display: flex; align-items: center; gap: 0.25rem;">
                    <span style="display: inline-block; width: 16px; height: 16px; background: #28a745; border-radius: 3px; border: 1px solid #28a745;"></span>
                    <span>Correcta</span>
                </span>
                <span style="display: flex; align-items: center; gap: 0.25rem;">
                    <span style="display: inline-block; width: 16px; height: 16px; background: #dc3545; border-radius: 3px; border: 1px solid #dc3545;"></span>
                    <span>Incorrecta</span>
                </span>
                <span style="display: flex; align-items: center; gap: 0.25rem;">
                    <span style="display: inline-block; width: 16px; height: 16px; background: #e0e0e0; border-radius: 3px; border: 1px solid #999;"></span>
                    <span>Sin responder</span>
                </span>
            </div>
        </div>

        {% for item in preguntas %}
            <div id="pregunta-{{ loop.index }}" class="card mb-3" style="{% if item.esCorrecta is null %}border-left: 4px solid #999;{% elseif item.esCorrecta %}border-left: 4px solid var(--color-success);{% else %}border-left: 4px solid var(--color-danger);{% endif %}">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0;">Pregunta {{ loop.index }}</h4>
                            {# Informaci√≥n discreta del tema y ley #}
                            <div style="margin-top: 0.25rem; font-size: 0.75rem; color: #666;">
                                {% if esMunicipal or esConvocatoria %}
                                    {% if item.pregunta.temaMunicipal %}
                                        <span style="background-color: #f0f0f0; padding: 0.15rem 0.4rem; border-radius: 3px; margin-right: 0.5rem;">
                                            üìö Tema: {{ item.pregunta.temaMunicipal.nombre }}
                                        </span>
                                    {% endif %}
                                {% else %}
                                    {% if item.pregunta.tema %}
                                        <span style="background-color: #f0f0f0; padding: 0.15rem 0.4rem; border-radius: 3px; margin-right: 0.5rem;">
                                            üìö Tema: {{ item.pregunta.tema.nombre }}
                                        </span>
                                    {% endif %}
                                    {% if item.pregunta.ley %}
                                        <span style="background-color: #f0f0f0; padding: 0.15rem 0.4rem; border-radius: 3px;">
                                            ‚öñÔ∏è Ley: {{ item.pregunta.ley.nombre }}
                                        </span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% if item.esCorrecta is null %}
                            <span class="badge" style="background-color: #999; color: white;">‚óã Sin responder</span>
                        {% elseif item.esCorrecta %}
                            <span class="badge badge-facil">‚úì Correcta</span>
                        {% else %}
                            <span class="badge badge-dificil">‚úó Incorrecta</span>
                        {% endif %}
                    </div>

                    <p><strong>{{ item.pregunta.texto }}</strong></p>

                    <div style="margin: 1rem 0;">
                        {# Opci√≥n A #}
                        {% set esCorrectaA = item.pregunta.respuestaCorrecta == 'A' %}
                        {% set esSeleccionadaA = item.respuestaAlumno == 'A' %}
                        {% set esIncorrectaA = esSeleccionadaA and not item.esCorrecta %}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if esIncorrectaA %}background: #ffebee;{% elseif esCorrectaA %}background: #e8f5e9; border-left: 3px solid var(--color-success);{% endif %}">
                            <strong>A)</strong> {{ item.pregunta.opcionA }}
                            {% if esIncorrectaA %}
                                <span style="color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>
                            {% endif %}
                            {% if esCorrectaA %}
                                <span style="color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                            {% endif %}
                        </div>
                        {# Opci√≥n B #}
                        {% set esCorrectaB = item.pregunta.respuestaCorrecta == 'B' %}
                        {% set esSeleccionadaB = item.respuestaAlumno == 'B' %}
                        {% set esIncorrectaB = esSeleccionadaB and not item.esCorrecta %}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if esIncorrectaB %}background: #ffebee;{% elseif esCorrectaB %}background: #e8f5e9; border-left: 3px solid var(--color-success);{% endif %}">
                            <strong>B)</strong> {{ item.pregunta.opcionB }}
                            {% if esIncorrectaB %}
                                <span style="color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>
                            {% endif %}
                            {% if esCorrectaB %}
                                <span style="color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                            {% endif %}
                        </div>
                        {# Opci√≥n C #}
                        {% set esCorrectaC = item.pregunta.respuestaCorrecta == 'C' %}
                        {% set esSeleccionadaC = item.respuestaAlumno == 'C' %}
                        {% set esIncorrectaC = esSeleccionadaC and not item.esCorrecta %}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if esIncorrectaC %}background: #ffebee;{% elseif esCorrectaC %}background: #e8f5e9; border-left: 3px solid var(--color-success);{% endif %}">
                            <strong>C)</strong> {{ item.pregunta.opcionC }}
                            {% if esIncorrectaC %}
                                <span style="color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>
                            {% endif %}
                            {% if esCorrectaC %}
                                <span style="color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                            {% endif %}
                        </div>
                        {# Opci√≥n D #}
                        {% set esCorrectaD = item.pregunta.respuestaCorrecta == 'D' %}
                        {% set esSeleccionadaD = item.respuestaAlumno == 'D' %}
                        {% set esIncorrectaD = esSeleccionadaD and not item.esCorrecta %}
                        <div style="padding: 0.5rem; margin: 0.25rem 0; {% if esIncorrectaD %}background: #ffebee;{% elseif esCorrectaD %}background: #e8f5e9; border-left: 3px solid var(--color-success);{% endif %}">
                            <strong>D)</strong> {{ item.pregunta.opcionD }}
                            {% if esIncorrectaD %}
                                <span style="color: var(--color-danger);">‚Üê Tu respuesta (incorrecta)</span>
                            {% endif %}
                            {% if esCorrectaD %}
                                <span style="color: var(--color-success); font-weight: bold;">‚Üê Respuesta correcta</span>
                            {% endif %}
                        </div>
                        {% if item.esCorrecta is null %}
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: #f5f5f5; border-radius: 4px; color: #666; font-style: italic;">
                                Esta pregunta no fue respondida y no afecta la calificaci√≥n.
                            </div>
                        {% endif %}
                    </div>

                    {% if item.pregunta.retroalimentacion %}
                        <div class="alert alert-info" style="margin-top: 1rem; line-height: 1.6;">
                            <strong>Retroalimentaci√≥n:</strong> 
                            <div style="margin-top: 0.5rem;">{{ item.pregunta.retroalimentacion|markdown|raw }}</div>
                        </div>
                    {% endif %}

                    {% if not esMunicipal and not esConvocatoria and item.pregunta.articulo is defined and item.pregunta.articulo %}
                        {% if item.pregunta.articulo.explicacion or item.pregunta.articulo.textoLegal %}
                        <details style="margin-top: 1rem;">
                            <summary style="cursor: pointer; font-weight: bold; color: var(--color-primary);">Ver Informaci√≥n del Art√≠culo</summary>
                            <div style="margin-top: 0.5rem;">
                                <p><strong>Art√≠culo {{ item.pregunta.articulo.getNumeroCompleto() }} - {{ item.pregunta.ley.nombre }}</strong></p>
                                {% if item.pregunta.articulo.explicacion %}
                                <div style="background: #e3f2fd; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; border-left: 4px solid var(--color-secondary); line-height: 1.6;">
                                    <strong>Explicaci√≥n para el Opositor:</strong>
                                    <div style="margin-top: 0.5rem;">{{ item.pregunta.articulo.explicacion|markdown|raw }}</div>
                                </div>
                                {% endif %}
                                {% if item.pregunta.articulo.textoLegal %}
                                <div style="background: #fff3cd; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; border-left: 4px solid #ffc107; line-height: 1.6;">
                                    <strong>Texto Legal:</strong>
                                    <div style="margin-top: 0.5rem;">{{ item.pregunta.articulo.textoLegal|raw }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </details>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        {% endfor %}

        <div class="d-flex gap-2 mt-4">
            {% if is_granted('ROLE_PROFESOR') or is_granted('ROLE_ADMIN') %}
                <a href="{{ path('app_examen_profesor') }}" class="btn btn-secondary">Volver a Ex√°menes</a>
            {% else %}
                <a href="{{ path('app_examen_historial') }}" class="btn btn-secondary">Volver al Historial</a>
            {% endif %}
            <a href="{{ path('app_dashboard') }}" class="btn btn-secondary">Volver al Dashboard</a>
        </div>
    </div>
</div>

<script>
    // Scroll suave al hacer clic en los n√∫meros de preguntas
    document.addEventListener('DOMContentLoaded', function() {
        const preguntaLinks = document.querySelectorAll('.pregunta-link-detalle');
        preguntaLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    // Calcular offset para que la pregunta quede visible (considerando header fijo si existe)
                    const offset = 80; // Ajustar seg√∫n sea necesario
                    const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - offset;
                    
                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                    
                    // Resaltar brevemente la pregunta al llegar
                    setTimeout(() => {
                        targetElement.style.transition = 'box-shadow 0.3s';
                        targetElement.style.boxShadow = '0 0 0 3px rgba(0, 113, 181, 0.3)';
                        setTimeout(() => {
                            targetElement.style.boxShadow = '';
                        }, 1000);
                    }, 500);
                }
            });
        });
    });
</script>
{% endblock %}

