{% extends 'base.html.twig' %}

{% block title %}Ex√°menes Semanales{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <h1>Ex√°menes Semanales</h1>
    </div>
    <div class="card-body">
        {% set totalDisponibles = examenesGenerales|length + examenesMunicipales|length + examenesConvocatorias|length %}
        
        {% if totalDisponibles > 0 %}
            {% if examenesGenerales|length > 0 %}
                <h2 style="margin-top: 0; margin-bottom: 1rem; color: #2E7D32; font-size: 1.5rem;">üìö Ex√°menes Generales</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    {% for examen in examenesGenerales %}
                        <div class="card" style="border-left: 6px solid #4CAF50; background: linear-gradient(135deg, #f1f8f4 0%, #ffffff 100%); box-shadow: 0 4px 6px rgba(76, 175, 80, 0.1);">
                            <div class="card-body">
                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                            <span class="badge" style="background-color: #4CAF50; padding: 0.5rem 1rem; font-size: 0.9rem; font-weight: bold;">üìö TEMARIO GENERAL</span>
                                            {% if examen.numeroPreguntas %}
                                                <span class="badge" style="background-color: #2196F3; padding: 0.4rem 0.8rem; font-size: 0.85rem;">{{ examen.numeroPreguntas }} preguntas</span>
                                            {% endif %}
                                        </div>
                                        <h3 style="margin-top: 0; color: #2E7D32; font-weight: 600; font-size: 1.2rem;">{{ examen.nombre }}</h3>
                                        {% if examen.descripcion %}
                                            <p style="color: #666; margin-bottom: 1rem; font-size: 0.95rem;">{{ examen.descripcion }}</p>
                                        {% endif %}
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                                            <div>
                                                <strong>Dificultad:</strong> 
                                                <span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span>
                                            </div>
                                            <div>
                                                <strong>Apertura:</strong> {{ examen.fechaApertura|date('d/m/Y H:i') }}
                                            </div>
                                            <div>
                                                <strong>Cierre:</strong> {{ examen.fechaCierre|date('d/m/Y H:i') }}
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        {% if examen.estaDisponible() %}
                                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                {% if borradoresSemanales[examen.id] is defined %}
                                                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 0.75rem; margin-bottom: 0.5rem;">
                                                        <small style="display: block; color: #856404;">
                                                            <strong>üìù Examen guardado en borrador</strong><br>
                                                            Pregunta: {{ borradoresSemanales[examen.id].preguntaActual }}/{{ borradoresSemanales[examen.id].preguntasIds|length }} | 
                                                            Respondidas: {{ borradoresSemanales[examen.id].respuestas|length }}
                                                            {% if borradoresSemanales[examen.id].tiempoRestante %}
                                                                | Tiempo restante: {{ (borradoresSemanales[examen.id].tiempoRestante / 60)|round }} min
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                {% endif %}
                                                <a href="{{ path('app_examen_semanal_alumno_realizar', {'id': examen.id}) }}" class="btn btn-success" style="font-size: 1rem; padding: 0.75rem 1.5rem; width: 100%;">{{ borradoresSemanales[examen.id] is defined ? 'Continuar examen online' : 'Realizar Examen Online' }}</a>
                                                {% if examenesPDFPorSemanal[examen.id] is defined %}
                                                    <a href="{{ path('app_examen_semanal_alumno_introducir_pdf', {'id': examen.id}) }}" class="btn btn-warning" style="font-size: 0.9rem; padding: 0.5rem 1rem; width: 100%;">Editar Resultados PDF</a>
                                                {% else %}
                                                    <a href="{{ path('app_examen_semanal_alumno_introducir_pdf', {'id': examen.id}) }}" class="btn btn-outline-secondary" style="font-size: 0.9rem; padding: 0.5rem 1rem; width: 100%;">Introducir Resultados PDF</a>
                                                {% endif %}
                                            </div>
                                        {% elseif examen.estaPendiente() %}
                                            <span class="badge" style="background-color: #ffc107; padding: 0.5rem 1rem; font-size: 1rem; width: 100%; text-align: center;">Pendiente</span>
                                        {% else %}
                                            <span class="badge" style="background-color: #6c757d; padding: 0.5rem 1rem; font-size: 1rem; width: 100%; text-align: center;">Cerrado</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if examenesMunicipales|length > 0 %}
                <h2 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #1565C0; font-size: 1.5rem;">üèõÔ∏è Ex√°menes Municipales</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    {% for examen in examenesMunicipales %}
                        <div class="card" style="border-left: 6px solid #2196F3; background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); box-shadow: 0 4px 6px rgba(33, 150, 243, 0.1);">
                            <div class="card-body">
                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                            <span class="badge" style="background-color: #2196F3; padding: 0.5rem 1rem; font-size: 0.9rem; font-weight: bold;">üèõÔ∏è EXAMEN MUNICIPAL</span>
                                            {% if examen.numeroPreguntas %}
                                                <span class="badge" style="background-color: #4CAF50; padding: 0.4rem 0.8rem; font-size: 0.85rem;">{{ examen.numeroPreguntas }} preguntas</span>
                                            {% endif %}
                                        </div>
                                        <h3 style="margin-top: 0; color: #1565C0; font-weight: 600; font-size: 1.2rem;">{{ examen.nombre }}</h3>
                                        {% if examen.descripcion %}
                                            <p style="color: #666; margin-bottom: 1rem; font-size: 0.95rem;">{{ examen.descripcion }}</p>
                                        {% endif %}
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                                            <div>
                                                <strong>Dificultad:</strong> 
                                                <span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span>
                                            </div>
                                            <div>
                                                <strong>Apertura:</strong> {{ examen.fechaApertura|date('d/m/Y H:i') }}
                                            </div>
                                            <div>
                                                <strong>Cierre:</strong> {{ examen.fechaCierre|date('d/m/Y H:i') }}
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1rem;">
                                            <span class="badge" style="background-color: #1976D2; padding: 0.5rem 1rem; font-size: 0.9rem; font-weight: bold;">üìç {{ examen.municipio.nombre }}</span>
                                        </div>
                                    </div>
                                    <div>
                                        {% if examen.estaDisponible() %}
                                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                {% if borradoresSemanales[examen.id] is defined %}
                                                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 0.75rem; margin-bottom: 0.5rem;">
                                                        <small style="display: block; color: #856404;">
                                                            <strong>üìù Examen guardado en borrador</strong><br>
                                                            Pregunta: {{ borradoresSemanales[examen.id].preguntaActual }}/{{ borradoresSemanales[examen.id].preguntasIds|length }} | 
                                                            Respondidas: {{ borradoresSemanales[examen.id].respuestas|length }}
                                                            {% if borradoresSemanales[examen.id].tiempoRestante %}
                                                                | Tiempo restante: {{ (borradoresSemanales[examen.id].tiempoRestante / 60)|round }} min
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                {% endif %}
                                                <a href="{{ path('app_examen_semanal_alumno_realizar', {'id': examen.id}) }}" class="btn btn-success" style="font-size: 1rem; padding: 0.75rem 1.5rem; width: 100%;">{{ borradoresSemanales[examen.id] is defined ? 'Continuar examen online' : 'Realizar Examen Online' }}</a>
                                                {% if examenesPDFPorSemanal[examen.id] is defined %}
                                                    <a href="{{ path('app_examen_semanal_alumno_introducir_pdf', {'id': examen.id}) }}" class="btn btn-warning" style="font-size: 0.9rem; padding: 0.5rem 1rem; width: 100%;">Editar Resultados PDF</a>
                                                {% else %}
                                                    <a href="{{ path('app_examen_semanal_alumno_introducir_pdf', {'id': examen.id}) }}" class="btn btn-outline-secondary" style="font-size: 0.9rem; padding: 0.5rem 1rem; width: 100%;">Introducir Resultados PDF</a>
                                                {% endif %}
                                            </div>
                                        {% elseif examen.estaPendiente() %}
                                            <span class="badge" style="background-color: #ffc107; padding: 0.5rem 1rem; font-size: 1rem; width: 100%; text-align: center;">Pendiente</span>
                                        {% else %}
                                            <span class="badge" style="background-color: #6c757d; padding: 0.5rem 1rem; font-size: 1rem; width: 100%; text-align: center;">Cerrado</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if examenesConvocatorias|length > 0 %}
                <h2 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #7B1FA2; font-size: 1.5rem;">üìã Ex√°menes de Convocatoria</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    {% for examen in examenesConvocatorias %}
                        <div class="card" style="border-left: 6px solid #9C27B0; background: linear-gradient(135deg, #f3e5f5 0%, #ffffff 100%); box-shadow: 0 4px 6px rgba(156, 39, 176, 0.1);">
                            <div class="card-body">
                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                            <span class="badge" style="background-color: #9C27B0; padding: 0.5rem 1rem; font-size: 0.9rem; font-weight: bold;">üìã EXAMEN DE CONVOCATORIA</span>
                                            {% if examen.numeroPreguntas %}
                                                <span class="badge" style="background-color: #4CAF50; padding: 0.4rem 0.8rem; font-size: 0.85rem;">{{ examen.numeroPreguntas }} preguntas</span>
                                            {% endif %}
                                        </div>
                                        <h3 style="margin-top: 0; color: #7B1FA2; font-weight: 600; font-size: 1.2rem;">{{ examen.nombre }}</h3>
                                        {% if examen.descripcion %}
                                            <p style="color: #666; margin-bottom: 1rem; font-size: 0.95rem;">{{ examen.descripcion }}</p>
                                        {% endif %}
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                                            <div>
                                                <strong>Dificultad:</strong> 
                                                <span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span>
                                            </div>
                                            <div>
                                                <strong>Apertura:</strong> {{ examen.fechaApertura|date('d/m/Y H:i') }}
                                            </div>
                                            <div>
                                                <strong>Cierre:</strong> {{ examen.fechaCierre|date('d/m/Y H:i') }}
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1rem;">
                                            <span class="badge" style="background-color: #7B1FA2; padding: 0.5rem 1rem; font-size: 0.9rem; font-weight: bold;">üìã {{ examen.convocatoria.nombre }}</span>
                                            {% if examen.convocatoria.municipios|length > 0 %}
                                                <div style="margin-top: 0.5rem;">
                                                    {% for municipio in examen.convocatoria.municipios %}
                                                        <span class="badge" style="background-color: #2196F3; padding: 0.4rem 0.8rem; font-size: 0.85rem; margin-right: 0.5rem; margin-bottom: 0.25rem;">üìç {{ municipio.nombre }}</span>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div>
                                        {% if examen.estaDisponible() %}
                                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                {% if borradoresSemanales[examen.id] is defined %}
                                                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 0.75rem; margin-bottom: 0.5rem;">
                                                        <small style="display: block; color: #856404;">
                                                            <strong>üìù Examen guardado en borrador</strong><br>
                                                            Pregunta: {{ borradoresSemanales[examen.id].preguntaActual }}/{{ borradoresSemanales[examen.id].preguntasIds|length }} | 
                                                            Respondidas: {{ borradoresSemanales[examen.id].respuestas|length }}
                                                            {% if borradoresSemanales[examen.id].tiempoRestante %}
                                                                | Tiempo restante: {{ (borradoresSemanales[examen.id].tiempoRestante / 60)|round }} min
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                {% endif %}
                                                <a href="{{ path('app_examen_semanal_alumno_realizar', {'id': examen.id}) }}" class="btn btn-success" style="font-size: 1rem; padding: 0.75rem 1.5rem; width: 100%;">{{ borradoresSemanales[examen.id] is defined ? 'Continuar examen online' : 'Realizar Examen Online' }}</a>
                                                {% if examenesPDFPorSemanal[examen.id] is defined %}
                                                    <a href="{{ path('app_examen_semanal_alumno_introducir_pdf', {'id': examen.id}) }}" class="btn btn-warning" style="font-size: 0.9rem; padding: 0.5rem 1rem; width: 100%;">Editar Resultados PDF</a>
                                                {% else %}
                                                    <a href="{{ path('app_examen_semanal_alumno_introducir_pdf', {'id': examen.id}) }}" class="btn btn-outline-secondary" style="font-size: 0.9rem; padding: 0.5rem 1rem; width: 100%;">Introducir Resultados PDF</a>
                                                {% endif %}
                                            </div>
                                        {% elseif examen.estaPendiente() %}
                                            <span class="badge" style="background-color: #ffc107; padding: 0.5rem 1rem; font-size: 1rem; width: 100%; text-align: center;">Pendiente</span>
                                        {% else %}
                                            <span class="badge" style="background-color: #6c757d; padding: 0.5rem 1rem; font-size: 1rem; width: 100%; text-align: center;">Cerrado</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% else %}
            <div class="alert alert-info" style="text-align: center; padding: 2rem;">
                <p style="font-size: 1.1rem; margin: 0;">No hay ex√°menes semanales disponibles en este momento.</p>
            </div>
        {% endif %}

        {% if examenesRealizados|length > 0 %}
            <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Historial de Ex√°menes Semanales</h3>
            <div class="card">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Examen</th>
                            <th>Fecha</th>
                            <th>Nota</th>
                            <th>Aciertos</th>
                            <th>Errores</th>
                            <th>En blanco</th>
                            <th>Tipo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for examen in examenesRealizados %}
                            <tr>
                                <td><strong>{{ examen.examenSemanal.nombre }}</strong></td>
                                <td>{{ examen.fecha|date('d/m/Y H:i') }}</td>
                                <td>
                                    <strong style="font-size: 1.2rem; color: {% if examen.nota >= 10 %}var(--color-success){% else %}var(--color-danger){% endif %};">{{ examen.nota|number_format(2, ',', '.') }}</strong>
                                </td>
                                <td style="color: var(--color-success);"><strong>{{ examen.aciertos }}</strong></td>
                                <td style="color: var(--color-danger);"><strong>{{ examen.errores }}</strong></td>
                                <td style="color: #999;"><strong>{{ examen.enBlanco }}</strong></td>
                                <td>
                                    {% if examen.realizadoEnPDF %}
                                        <span class="badge" style="background-color: #ff9800;">PDF</span>
                                    {% else %}
                                        <span class="badge" style="background-color: #4caf50;">Online</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ path('app_examen_detalle', {'id': examen.id}) }}" class="btn btn-secondary btn-sm">Ver Detalle</a>
                                    <a href="{{ path('app_examen_semanal_alumno_ranking', {'id': examen.examenSemanal.id}) }}" class="btn btn-primary btn-sm">Ver Ranking</a>
                                    {% if examen.realizadoEnPDF and examen.examenSemanal.estaDisponible() %}
                                        <a href="{{ path('app_examen_semanal_alumno_introducir_pdf', {'id': examen.examenSemanal.id}) }}" class="btn btn-warning btn-sm">Editar PDF</a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>
</div>

<style>
/* Estilos responsivos para m√≥viles */
@media (max-width: 768px) {
    .card {
        margin: 0.5rem !important;
    }
    
    .card-header h1 {
        font-size: 1.3rem !important;
    }
    
    .card-body {
        padding: 1rem !important;
    }
    
    h2 {
        font-size: 1.3rem !important;
    }
    
    /* Grid de ex√°menes - una columna en m√≥vil */
    .card-body > div[style*="display: grid"] {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
        margin-bottom: 1.5rem !important;
    }
    
    /* Cards de ex√°menes */
    .card[style*="border-left: 6px"] {
        margin: 0 !important;
    }
    
    .card[style*="border-left: 6px"] .card-body {
        padding: 1rem !important;
    }
    
    /* Botones de acci√≥n */
    .card-body .btn {
        width: 100% !important;
        padding: 0.75rem 1rem !important;
        font-size: 0.95rem !important;
        min-height: 48px !important;
        margin: 0.25rem 0 !important;
    }
    
    /* Tabla de historial */
    .table {
        font-size: 0.85rem !important;
    }
    
    .table th,
    .table td {
        padding: 0.5rem !important;
    }
    
    /* Ocultar columnas menos importantes en m√≥vil */
    .table th:nth-child(6),
    .table td:nth-child(6),
    .table th:nth-child(7),
    .table td:nth-child(7) {
        display: none !important;
    }
    
    .table .btn {
        padding: 0.4rem 0.6rem !important;
        font-size: 0.8rem !important;
        min-height: 36px !important;
        margin: 0.25rem 0 !important;
    }
}

@media (max-width: 480px) {
    .card-header h1 {
        font-size: 1.2rem !important;
    }
    
    h2 {
        font-size: 1.2rem !important;
    }
    
    h3[style*="margin-top: 0"] {
        font-size: 1rem !important;
    }
    
    .table {
        font-size: 0.8rem !important;
    }
    
    .table th,
    .table td {
        padding: 0.4rem !important;
    }
    
    .table th:nth-child(5),
    .table td:nth-child(5) {
        display: none !important;
    }
}
</style>
{% endblock %}
