{% extends 'base.html.twig' %}

{% block title %}Nuevo Examen Semanal - Crear Preguntas{% endblock %}

{% block body %}
<style>
    .examen-form-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 1rem;
    }
    
    .examen-form-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .examen-form-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 2rem;
        text-align: center;
    }
    
    .examen-form-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 1.75rem;
        font-weight: 600;
    }
    
    .examen-form-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 1rem;
    }
    
    .examen-form-body {
        padding: 2rem;
    }
    
    .form-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e9ecef;
    }
    
    .form-section-title::before {
        content: '';
        width: 4px;
        height: 24px;
        background: #f5576c;
        border-radius: 2px;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-group {
        margin-bottom: 1.25rem;
    }
    
    .form-group label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
        display: block;
        font-size: 0.95rem;
    }
    
    .form-group .form-control {
        border-radius: 6px;
        border: 1px solid #dee2e6;
        padding: 0.625rem 0.875rem;
        font-size: 0.95rem;
        transition: all 0.2s;
        width: 100%;
    }
    
    .form-group .form-control:focus {
        border-color: #f5576c;
        box-shadow: 0 0 0 0.2rem rgba(245, 87, 108, 0.25);
        outline: none;
    }
    
    .form-group textarea.form-control {
        resize: vertical;
        min-height: 60px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 6px;
        font-weight: 500;
        color: white;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        color: white;
    }
    
    .btn-success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 6px;
        font-weight: 500;
        color: white;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 6px;
        font-weight: 500;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-size: 0.875rem;
        color: white;
    }
    
    .preguntas-lista-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 1.5rem;
    }
    
    .preguntas-lista-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px 8px 0 0;
    }
    
    .preguntas-lista-header h5 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .preguntas-lista-body {
        padding: 1.5rem;
    }
    
    .pregunta-item {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s;
    }
    
    .pregunta-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transform: translateX(4px);
    }
    
    .pregunta-item:last-child {
        margin-bottom: 0;
    }
    
    .pregunta-item strong {
        color: #495057;
        font-size: 1rem;
    }
    
    .pregunta-item p {
        margin: 0.5rem 0;
        color: #6c757d;
        font-size: 0.95rem;
    }
    
    .pregunta-item small {
        color: #868e96;
        font-size: 0.85rem;
    }
    
    .actions-bar {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px solid #e9ecef;
        flex-wrap: wrap;
    }
    
    .btn-lg {
        padding: 0.875rem 2.5rem;
        font-size: 1rem;
    }
    
    @media (max-width: 768px) {
        .examen-form-container {
            padding: 0.5rem;
        }
        
        .examen-form-header {
            padding: 1.5rem 1rem;
        }
        
        .examen-form-header h1 {
            font-size: 1.5rem;
        }
        
        .examen-form-body {
            padding: 1.5rem 1rem;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .actions-bar {
            flex-direction: column;
        }
        
        .btn-primary, .btn-success, .btn-secondary {
            width: 100%;
        }
        
        .pregunta-item {
            padding: 0.875rem;
        }
    }
</style>

<div class="examen-form-container">
    <div class="examen-form-card">
        <div class="examen-form-header">
            <h1>‚ú® Nuevo Examen Semanal - Crear Preguntas en Tiempo Real</h1>
            <p>Tipo: {{ tipoExamen == 'municipal' ? 'Municipal' : 'General' }}</p>
        </div>
        <div class="examen-form-body">
            <div id="examenForm">
                <div class="form-section">
                    <div class="form-section-title">üìã Datos del Examen</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre del Examen *</label>
                            <input type="text" id="nombreExamen" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Dificultad *</label>
                            <select id="dificultadExamen" class="form-control" required>
                                <option value="">Selecciona...</option>
                                <option value="facil">F√°cil</option>
                                <option value="moderada">Moderada</option>
                                <option value="dificil">Dif√≠cil</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n (opcional)</label>
                        <textarea id="descripcionExamen" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha de Apertura *</label>
                            <input type="datetime-local" id="fechaApertura" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Cierre *</label>
                            <input type="datetime-local" id="fechaCierre" class="form-control" required>
                        </div>
                    </div>
                    {% if tipoExamen == 'municipal' %}
                    <div class="form-group">
                        <label>Municipio *</label>
                        <select id="municipioSelect" class="form-control" required>
                            <option value="">Selecciona un municipio...</option>
                            {% for municipio in municipios %}
                                <option value="{{ municipio.id }}">{{ municipio.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <button type="button" id="crearExamenBtn" class="btn btn-primary">Crear Examen</button>
                </div>
            </div>

            <div id="preguntasSection" style="display: none;">
                <div class="form-section">
                    <div class="form-section-title">‚ûï Crear Preguntas</div>
                    <div id="preguntaForm">
                        {% if tipoExamen == 'municipal' %}
                            <div class="form-group">
                                <label>Tema Municipal *</label>
                                <select id="temaMunicipalSelect" class="form-control" required>
                                    <option value="">Selecciona un tema...</option>
                                </select>
                            </div>
                        {% else %}
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tema *</label>
                                    <select id="temaSelect" class="form-control" required>
                                        <option value="">Selecciona un tema...</option>
                                        {% for tema in temas %}
                                            <option value="{{ tema.id }}">{{ tema.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ley *</label>
                                    <select id="leySelect" class="form-control" required>
                                        <option value="">Selecciona una ley...</option>
                                        {% for ley in leyes %}
                                            <option value="{{ ley.id }}">{{ ley.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Art√≠culo *</label>
                                    <select id="articuloSelect" class="form-control" required>
                                        <option value="">Primero selecciona una ley...</option>
                                    </select>
                                </div>
                            </div>
                        {% endif %}
                        <div class="form-group">
                            <label>Texto de la Pregunta *</label>
                            <textarea id="textoPregunta" class="form-control" rows="3" required></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Opci√≥n A *</label>
                                <textarea id="opcionA" class="form-control" rows="2" required></textarea>
                            </div>
                            <div class="form-group">
                                <label>Opci√≥n B *</label>
                                <textarea id="opcionB" class="form-control" rows="2" required></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Opci√≥n C *</label>
                                <textarea id="opcionC" class="form-control" rows="2" required></textarea>
                            </div>
                            <div class="form-group">
                                <label>Opci√≥n D *</label>
                                <textarea id="opcionD" class="form-control" rows="2" required></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Respuesta Correcta *</label>
                                <select id="respuestaCorrecta" class="form-control" required>
                                    <option value="">Selecciona...</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Dificultad *</label>
                                <select id="dificultadPregunta" class="form-control" required>
                                    <option value="">Selecciona...</option>
                                    <option value="facil">F√°cil</option>
                                    <option value="moderada">Moderada</option>
                                    <option value="dificil">Dif√≠cil</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Retroalimentaci√≥n (opcional)</label>
                            <textarea id="retroalimentacion" class="form-control" rows="2"></textarea>
                        </div>
                        <button type="button" id="agregarPreguntaBtn" class="btn btn-success">‚ûï Agregar Pregunta</button>
                    </div>
                </div>

                <div class="preguntas-lista-card">
                    <div class="preguntas-lista-header">
                        <h5>üìù Preguntas A√±adidas (<span id="contadorPreguntas">0</span>)</h5>
                    </div>
                    <div class="preguntas-lista-body">
                        <div id="listaPreguntas">
                            <p style="color: #6c757d; margin: 0;">A√∫n no hay preguntas a√±adidas. Crea la primera pregunta arriba.</p>
                        </div>
                    </div>
                </div>

                <div class="actions-bar">
                    <button type="button" id="finalizarExamenBtn" class="btn btn-primary btn-lg">‚úì Finalizar Examen</button>
                    <a href="{{ path('app_examen_semanal_index') }}" class="btn btn-secondary btn-lg">‚Üê Cancelar</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Usar window para evitar conflictos con Turbo cuando se recarga la p√°gina
if (typeof window.examenId === 'undefined') {
    window.examenId = null;
}
const tipoExamen = '{{ tipoExamen }}';

document.addEventListener('DOMContentLoaded', function() {
    // Crear examen
    const crearExamenBtn = document.getElementById('crearExamenBtn');
    if (crearExamenBtn) {
        crearExamenBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Bot√≥n crear examen clickeado');
            crearExamen();
        });
    } else {
        console.error('No se encontr√≥ el bot√≥n crearExamenBtn');
    }
    
    // Agregar pregunta (solo si existe el bot√≥n)
    const agregarPreguntaBtn = document.getElementById('agregarPreguntaBtn');
    if (agregarPreguntaBtn) {
        agregarPreguntaBtn.addEventListener('click', agregarPregunta);
    }
    
    // Finalizar examen (solo si existe el bot√≥n)
    const finalizarExamenBtn = document.getElementById('finalizarExamenBtn');
    if (finalizarExamenBtn) {
        finalizarExamenBtn.addEventListener('click', finalizarExamen);
    }

    // Cargar art√≠culos cuando se selecciona una ley
    if (tipoExamen === 'general') {
        const leySelect = document.getElementById('leySelect');
        if (leySelect) {
            leySelect.addEventListener('change', function() {
                const leyId = this.value;
                if (leyId) {
                    cargarArticulos(leyId);
                } else {
                    const articuloSelect = document.getElementById('articuloSelect');
                    if (articuloSelect) {
                        articuloSelect.innerHTML = '<option value="">Primero selecciona una ley...</option>';
                    }
                }
            });
        }
    }

    // Cargar temas municipales cuando se selecciona un municipio
    if (tipoExamen === 'municipal') {
        const municipioSelect = document.getElementById('municipioSelect');
        if (municipioSelect) {
            municipioSelect.addEventListener('change', function() {
                const municipioId = this.value;
                if (municipioId) {
                    cargarTemasMunicipales(municipioId);
                } else {
                    const temaMunicipalSelect = document.getElementById('temaMunicipalSelect');
                    if (temaMunicipalSelect) {
                        temaMunicipalSelect.innerHTML = '<option value="">Selecciona un tema...</option>';
                    }
                }
            });
        }
    }
});

function crearExamen() {
    console.log('Funci√≥n crearExamen llamada');
    
    const datos = {
        nombre: document.getElementById('nombreExamen').value,
        descripcion: document.getElementById('descripcionExamen').value,
        fechaApertura: document.getElementById('fechaApertura').value,
        fechaCierre: document.getElementById('fechaCierre').value,
        dificultad: document.getElementById('dificultadExamen').value
    };

    if (tipoExamen === 'municipal') {
        datos.municipioId = document.getElementById('municipioSelect').value;
    }

    console.log('Datos del examen:', datos);

    if (!datos.nombre || !datos.fechaApertura || !datos.fechaCierre || !datos.dificultad) {
        alert('Por favor completa todos los campos requeridos del examen');
        return;
    }

    if (tipoExamen === 'municipal' && !datos.municipioId) {
        alert('Por favor selecciona un municipio');
        return;
    }

    const url = '{{ path('app_examen_semanal_new_con_preguntas', {'tipo': tipoExamen}) }}';
    console.log('URL:', url);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(datos)
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            window.examenId = data.examenId;
            document.getElementById('examenForm').style.display = 'none';
            document.getElementById('preguntasSection').style.display = 'block';
            alert('Examen creado correctamente. Ahora puedes agregar preguntas.');
        } else {
            alert('Error: ' + (data.error || 'No se pudo crear el examen'));
        }
    })
    .catch(error => {
        console.error('Error completo:', error);
        alert('Error al crear el examen: ' + error.message);
    });
}

function agregarPregunta() {
    if (!window.examenId) {
        alert('Primero debes crear el examen');
        return;
    }

    const datos = {
        texto: document.getElementById('textoPregunta').value,
        opcionA: document.getElementById('opcionA').value,
        opcionB: document.getElementById('opcionB').value,
        opcionC: document.getElementById('opcionC').value,
        opcionD: document.getElementById('opcionD').value,
        respuestaCorrecta: document.getElementById('respuestaCorrecta').value,
        dificultad: document.getElementById('dificultadPregunta').value,
        retroalimentacion: document.getElementById('retroalimentacion').value || null
    };

    if (tipoExamen === 'municipal') {
        datos.temaMunicipalId = document.getElementById('temaMunicipalSelect').value;
        if (!datos.temaMunicipalId) {
            alert('Por favor selecciona un tema municipal');
            return;
        }
    } else {
        datos.temaId = document.getElementById('temaSelect').value;
        datos.leyId = document.getElementById('leySelect').value;
        datos.articuloId = document.getElementById('articuloSelect').value;
        if (!datos.temaId || !datos.leyId || !datos.articuloId) {
            alert('Por favor completa tema, ley y art√≠culo');
            return;
        }
    }

    // Validar campos requeridos
    if (!datos.texto || !datos.opcionA || !datos.opcionB || !datos.opcionC || !datos.opcionD || !datos.respuestaCorrecta || !datos.dificultad) {
        alert('Por favor completa todos los campos requeridos');
        return;
    }

    fetch(`/examen-semanal/${window.examenId}/agregar-pregunta`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(datos)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            agregarPreguntaALista(data.preguntaId, datos);
            limpiarFormularioPregunta();
            actualizarContador();
            alert('Pregunta agregada correctamente');
        } else {
            alert('Error: ' + (data.error || 'No se pudo agregar la pregunta'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al agregar la pregunta');
    });
}

function agregarPreguntaALista(preguntaId, datos) {
    const lista = document.getElementById('listaPreguntas');
    if (lista.querySelector('p')) {
        lista.innerHTML = '';
    }

    const div = document.createElement('div');
    div.className = 'pregunta-item';
    div.id = `pregunta-${preguntaId}`;
    div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
            <div style="flex: 1;">
                <strong>Pregunta #${document.getElementById('listaPreguntas').children.length + 1}</strong>
                <p>${datos.texto.substring(0, 100)}${datos.texto.length > 100 ? '...' : ''}</p>
                <small>Respuesta correcta: ${datos.respuestaCorrecta} | Dificultad: ${datos.dificultad}</small>
            </div>
            <button type="button" class="btn btn-danger" onclick="eliminarPregunta(${preguntaId})">Eliminar</button>
        </div>
    `;
    lista.appendChild(div);
}

function eliminarPregunta(preguntaId) {
    if (!confirm('¬øEst√°s seguro de eliminar esta pregunta del examen?')) {
        return;
    }

    fetch(`/examen-semanal/${window.examenId}/eliminar-pregunta/${preguntaId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`pregunta-${preguntaId}`).remove();
            actualizarContador();
            if (document.getElementById('listaPreguntas').children.length === 0) {
                document.getElementById('listaPreguntas').innerHTML = '<p style="color: #6c757d; margin: 0;">A√∫n no hay preguntas a√±adidas. Crea la primera pregunta arriba.</p>';
            }
        } else {
            alert('Error: ' + (data.error || 'No se pudo eliminar la pregunta'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar la pregunta');
    });
}

function finalizarExamen() {
    if (!window.examenId) {
        alert('No hay un examen para finalizar');
        return;
    }

    if (document.getElementById('contadorPreguntas').textContent === '0') {
        alert('Debes agregar al menos una pregunta antes de finalizar');
        return;
    }

    if (!confirm('¬øEst√°s seguro de finalizar el examen? No podr√°s agregar m√°s preguntas despu√©s.')) {
        return;
    }

    fetch(`/examen-semanal/${window.examenId}/finalizar`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Examen finalizado correctamente');
            window.location.href = data.redirect || '{{ path('app_examen_semanal_index') }}';
        } else {
            alert('Error: ' + (data.error || 'No se pudo finalizar el examen'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al finalizar el examen');
    });
}

function limpiarFormularioPregunta() {
    document.getElementById('textoPregunta').value = '';
    document.getElementById('opcionA').value = '';
    document.getElementById('opcionB').value = '';
    document.getElementById('opcionC').value = '';
    document.getElementById('opcionD').value = '';
    document.getElementById('respuestaCorrecta').value = '';
    document.getElementById('dificultadPregunta').value = '';
    document.getElementById('retroalimentacion').value = '';
}

function actualizarContador() {
    const contador = document.getElementById('listaPreguntas').querySelectorAll('.pregunta-item').length;
    document.getElementById('contadorPreguntas').textContent = contador;
}

function cargarArticulos(leyId) {
    fetch(`/examen-semanal/articulos/${leyId}`)
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('articuloSelect');
            select.innerHTML = '<option value="">Selecciona un art√≠culo...</option>';
            data.forEach(articulo => {
                const option = document.createElement('option');
                option.value = articulo.id;
                option.textContent = `Art. ${articulo.numeroCompleto || articulo.numero}${articulo.nombre ? ' - ' + articulo.nombre : ''}`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error al cargar art√≠culos:', error);
        });
}

function cargarTemasMunicipales(municipioId) {
    fetch(`/examen-semanal/temas-municipales/${municipioId}`)
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('temaMunicipalSelect');
            select.innerHTML = '<option value="">Selecciona un tema...</option>';
            data.forEach(tema => {
                const option = document.createElement('option');
                option.value = tema.id;
                option.textContent = tema.nombre;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error al cargar temas municipales:', error);
        });
}
</script>
{% endblock %}
