<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Planificaci√≥n Mensual - {{ usuario.nombreDisplay }} - {{ primerDiaMes|date('F Y') }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 10pt;
            color: #333;
            line-height: 1.5;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #007bff;
        }
        
        .header h1 {
            font-size: 22pt;
            color: #007bff;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            font-size: 13pt;
            color: #666;
        }
        
        .info-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 9pt;
        }
        
        .info-box strong {
            color: #007bff;
        }
        
        .activities-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .activities-table thead th {
            background: #007bff;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #0056b3;
            font-size: 10pt;
        }
        
        .activities-table tbody td {
            border: 1px solid #dee2e6;
            padding: 8px;
            vertical-align: top;
        }
        
        .activities-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .activities-table tbody tr:hover {
            background: #e7f3ff;
        }
        
        .day-header {
            font-weight: bold;
            font-size: 11pt;
            color: #007bff;
            width: 12%;
        }
        
        .day-date {
            font-size: 9pt;
            color: #666;
            margin-top: 2px;
        }
        
        .activity-item {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-left: 4px solid;
            border-radius: 4px;
            page-break-inside: avoid;
        }
        
        .activity-item:last-child {
            margin-bottom: 0;
        }
        
        .activity-time {
            font-weight: bold;
            font-size: 10pt;
            color: #333;
            margin-bottom: 4px;
        }
        
        .activity-type {
            font-size: 9pt;
            color: #666;
            margin-bottom: 4px;
            font-style: italic;
        }
        
        .activity-description {
            font-size: 9pt;
            color: #555;
            line-height: 1.4;
            margin-top: 4px;
        }
        
        .activity.repaso {
            border-left-color: #2196F3;
            background: #e3f2fd;
        }
        
        .activity.estudio {
            border-left-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .activity.examenes {
            border-left-color: #FF9800;
            background: #fff3e0;
        }
        
        .no-activities {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 15px;
        }
        
        .tasks-section {
            margin-top: 25px;
            page-break-inside: avoid;
        }
        
        .tasks-section h2 {
            color: #007bff;
            font-size: 14pt;
            margin-bottom: 10px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        
        .task-item {
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
        }
        
        .task-item.completed {
            border-left-color: #28a745;
            opacity: 0.7;
        }
        
        .task-title {
            font-weight: bold;
            color: #333;
        }
        
        .task-date {
            font-size: 9pt;
            color: #666;
            margin-top: 3px;
        }
        
        .footer {
            margin-top: 30px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
            text-align: center;
            font-size: 8pt;
            color: #666;
        }
        
        @page {
            margin: 1.5cm;
        }
        
        .page-break {
            page-break-after: always;
        }
        
        .day-section {
            page-break-inside: avoid;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÖ Planificaci√≥n Mensual</h1>
        <div class="subtitle">
            <strong>{{ usuario.nombreDisplay }}</strong><br>
            {% set meses = {1: 'Enero', 2: 'Febrero', 3: 'Marzo', 4: 'Abril', 5: 'Mayo', 6: 'Junio', 7: 'Julio', 8: 'Agosto', 9: 'Septiembre', 10: 'Octubre', 11: 'Noviembre', 12: 'Diciembre'} %}
            {{ meses[mes] }} {{ anio }}
        </div>
    </div>
    
    <div class="info-box">
        <strong>Informaci√≥n:</strong> Este documento contiene tu planificaci√≥n personalizada para el mes de 
        {% set meses = {1: 'Enero', 2: 'Febrero', 3: 'Marzo', 4: 'Abril', 5: 'Mayo', 6: 'Junio', 7: 'Julio', 8: 'Agosto', 9: 'Septiembre', 10: 'Octubre', 11: 'Noviembre', 12: 'Diciembre'} %}
        {{ meses[mes] }} {{ anio }}.
        {% if planificaciones|length > 1 %}
            Tienes {{ planificaciones|length }} planificaciones activas.
        {% endif %}
    </div>
    
    <table class="activities-table">
        <thead>
            <tr>
                <th style="width: 12%;">D√≠a</th>
                <th style="width: 15%;">Horario</th>
                <th style="width: 15%;">Tipo</th>
                <th style="width: 58%;">Descripci√≥n de la Actividad</th>
            </tr>
        </thead>
        <tbody>
            {% set hoy = 'now'|date('Y-m-d') %}
            {% set diasConActividades = 0 %}
            {% set diasEspanol = {'Monday': 'Lunes', 'Tuesday': 'Martes', 'Wednesday': 'Mi√©rcoles', 'Thursday': 'Jueves', 'Friday': 'Viernes', 'Saturday': 'S√°bado', 'Sunday': 'Domingo'} %}
            
            {# Calcular n√∫mero de d√≠as del mes #}
            {% set numDias = ultimoDiaMes|date('d') %}
            
            {# Iterar sobre todos los d√≠as del mes #}
            {% for dia in 1..numDias %}
                {% set fechaActual = primerDiaMes|date_modify('+' ~ (dia - 1) ~ ' days') %}
                {% set fechaDiaStr = fechaActual|date('Y-m-d') %}
                {% set franjasDelDia = franjasPorDia[fechaDiaStr] ?? [] %}
                
                {% if franjasDelDia|length > 0 %}
                    {% set diasConActividades = diasConActividades + 1 %}
                    {% set nombreDia = fechaActual|date('l') %}
                    {% set nombreDiaEspanol = diasEspanol[nombreDia] %}
                    
                    {% for franja in franjasDelDia %}
                        <tr class="day-section">
                            {% if loop.first %}
                                <td class="day-header" rowspan="{{ franjasDelDia|length }}">
                                    <div>{{ nombreDiaEspanol }}</div>
                                    <div class="day-date">{{ fechaActual|date('d/m/Y') }}</div>
                                    {% if fechaDiaStr == hoy %}
                                        <div style="color: #28a745; font-size: 8pt; margin-top: 3px;">‚óè Hoy</div>
                                    {% endif %}
                                </td>
                            {% endif %}
                            
                            <td>
                                <div class="activity-time">
                                    {{ franja.horaInicio|date('H:i') }} - {{ franja.horaFin|date('H:i') }}
                                </div>
                            </td>
                            
                            <td>
                                <div class="activity-type">
                                    {% if franja.tipoActividad == 'repaso_basico' %}
                                        üìö Repaso
                                    {% elseif franja.tipoActividad == 'realizar_examenes' %}
                                        üìù Ex√°menes
                                    {% else %}
                                        üìñ Estudio
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td>
                                <div class="activity-description">
                                    {% if franja.descripcionRepaso %}
                                        <strong>{{ franja.descripcionRepaso }}</strong>
                                    {% else %}
                                        <em>Sin descripci√≥n espec√≠fica</em>
                                    {% endif %}
                                    
                                    {% if franja.temas %}
                                        <div style="margin-top: 4px; font-size: 8pt; color: #666;">
                                            <strong>Temas:</strong> {{ franja.temas }}
                                        </div>
                                    {% endif %}
                                    
                                    {% if franja.recursos %}
                                        <div style="margin-top: 4px; font-size: 8pt; color: #666;">
                                            <strong>Recursos:</strong> {{ franja.recursos }}
                                        </div>
                                    {% endif %}
                                    
                                    {% if franja.notas %}
                                        <div style="margin-top: 4px; font-size: 8pt; color: #666; font-style: italic;">
                                            <strong>Notas:</strong> {{ franja.notas }}
                                        </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% endif %}
            {% endfor %}
            
            {% if diasConActividades == 0 %}
                <tr>
                    <td colspan="4" class="no-activities">
                        No hay actividades planificadas para este mes.
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
    
    {% if tareasDelMes|length > 0 %}
        <div class="tasks-section">
            <h2>üìã Tareas del Mes</h2>
            {% for tareaAsignada in tareasDelMes %}
                <div class="task-item {% if tareaAsignada.isCompletada() %}completed{% endif %}">
                    <div class="task-title">
                        {% if tareaAsignada.isCompletada() %}‚úì {% endif %}{{ tareaAsignada.tarea.nombre }}
                    </div>
                    {% if tareaAsignada.tarea.descripcion %}
                        <div style="font-size: 9pt; color: #555; margin-top: 3px;">
                            {{ tareaAsignada.tarea.descripcion }}
                        </div>
                    {% endif %}
                    <div class="task-date">
                        Semana: {{ tareaAsignada.tarea.semanaAsignacion|date('d/m/Y') }}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
    
    <div class="footer">
        <p>Generado el {{ 'now'|date('d/m/Y H:i') }} - {{ usuario.nombreDisplay }}</p>
    </div>
</body>
</html>
