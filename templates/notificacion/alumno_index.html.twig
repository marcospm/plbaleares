{% extends 'base.html.twig' %}

{% block title %}Notificaciones{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Mis Notificaciones</h1>
            {% if noLeidas > 0 %}
                <span class="badge" style="background-color: #dc3545; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 1rem;">
                    {{ noLeidas }} sin leer
                </span>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        {% if notificaciones|length > 0 %}
            <div style="margin-bottom: 1rem;">
                <form method="post" action="{{ path('app_notificacion_alumno_marcar_todas_leidas') }}" style="display: inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('marcar_todas_leidas_alumno') }}">
                    <button type="submit" class="btn btn-secondary">Marcar todas como le√≠das</button>
                </form>
            </div>

            <div style="display: grid; gap: 1rem;">
                {% for notificacion in notificaciones %}
                    {% set icono = notificacion.tipo == 'planificacion_creada' ? 'üìÖ' : 
                                    (notificacion.tipo == 'planificacion_editada' ? '‚úèÔ∏è' : 
                                    (notificacion.tipo == 'planificacion_eliminada' ? 'üóëÔ∏è' : 
                                    (notificacion.tipo == 'tarea_creada' ? 'üìù' : 
                                    (notificacion.tipo == 'tarea_editada' ? '‚úèÔ∏è' : 
                                    (notificacion.tipo == 'tarea_eliminada' ? 'üóëÔ∏è' :
                                    (notificacion.tipo == 'examen_semanal' ? 'üìã' : 
                                    (notificacion.tipo == 'respuesta_articulo' ? 'üí¨' : 
                                    (notificacion.tipo == 'respuesta_pregunta' ? 'üí¨' : 'üìã')))))))) %}
                    {% set color = 'planificacion' in notificacion.tipo ? '#2196F3' : 
                                    (notificacion.tipo == 'examen_semanal' ? '#9C27B0' : 
                                    (notificacion.tipo == 'respuesta_articulo' or notificacion.tipo == 'respuesta_pregunta' ? '#9C27B0' : '#4CAF50')) %}
                    
                    <div style="padding: 1rem; border: 1px solid #ddd; border-left: 4px solid {{ color }}; border-radius: 4px; background-color: {% if notificacion.leida %}#f8f9fa{% else %}#fff{% endif %};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.2rem;">{{ icono }}</span>
                                    <strong style="color: {{ color }};">
                                        {{ notificacion.titulo }}
                                    </strong>
                                    {% if not notificacion.leida %}
                                        <span class="badge" style="background-color: #dc3545; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem;">Nueva</span>
                                    {% endif %}
                                </div>
                                <p style="margin: 0.5rem 0; color: #666;">{{ notificacion.mensaje }}</p>
                                <small style="color: #999;">
                                    {{ notificacion.fechaCreacion|date('d/m/Y H:i') }}
                                </small>
                                {% if notificacion.planificacionSemanal %}
                                    <div style="margin-top: 0.5rem;">
                                        <a href="{{ path('app_planificacion_alumno_index') }}" class="btn btn-sm btn-primary">
                                            Ver Planificaci√≥n
                                        </a>
                                    </div>
                                {% endif %}
                                {% if notificacion.tarea %}
                                    <div style="margin-top: 0.5rem;">
                                        <a href="{{ path('app_planificacion_alumno_index') }}" class="btn btn-sm btn-primary">
                                            Ver Tarea
                                        </a>
                                    </div>
                                {% endif %}
                                {% if notificacion.examenSemanal %}
                                    <div style="margin-top: 0.5rem;">
                                        <a href="{{ path('app_examen_semanal_alumno_index') }}" class="btn btn-sm btn-primary">
                                            Ver Examen Semanal
                                        </a>
                                    </div>
                                {% endif %}
                                {% if notificacion.articulo %}
                                    <div style="margin-top: 0.5rem;">
                                        <a href="{{ path('app_articulo_publico_show', {'id': notificacion.articulo.id}) }}" class="btn btn-sm btn-primary">
                                            Ver Art√≠culo
                                        </a>
                                    </div>
                                {% endif %}
                                {% if notificacion.tipo == 'respuesta_pregunta' or notificacion.tipo == 'respuesta_articulo' %}
                                    <div style="margin-top: 0.75rem; padding: 0.75rem; background-color: #f0f7ff; border-left: 3px solid #9C27B0; border-radius: 4px;">
                                        <small style="color: #666; font-weight: bold; display: block; margin-bottom: 0.5rem;">üí¨ Respuesta del profesor:</small>
                                        {% set mensajeCompleto = notificacion.mensaje %}
                                        {% set inicioRespuesta = mensajeCompleto|split(': "') %}
                                        {% if inicioRespuesta|length > 1 %}
                                            {% set respuesta = inicioRespuesta[1]|trim %}
                                            {% if respuesta|slice(-1) == '"' %}
                                                {% set respuesta = respuesta|slice(0, -1) %}
                                            {% endif %}
                                            <div style="background-color: white; padding: 0.75rem; border-radius: 4px; border: 1px solid #ddd;">
                                                <p style="margin: 0; color: #333; white-space: pre-wrap; line-height: 1.6; font-size: 0.95rem;">{{ respuesta }}</p>
                                            </div>
                                        {% else %}
                                            <div style="background-color: white; padding: 0.75rem; border-radius: 4px; border: 1px solid #ddd;">
                                                <p style="margin: 0; color: #333; white-space: pre-wrap; line-height: 1.6; font-size: 0.95rem;">{{ mensajeCompleto }}</p>
                                            </div>
                                        {% endif %}
                                        {% if notificacion.tipo == 'respuesta_pregunta' and notificacion.pregunta %}
                                            <div style="margin-top: 0.75rem;">
                                                <a href="{{ path('app_pregunta_publica_show', {'id': notificacion.pregunta.id}) }}" class="btn btn-sm btn-primary">
                                                    üìã Ver Pregunta y Mensajes
                                                </a>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                            {% if not notificacion.leida %}
                                <div style="margin-left: 1rem;">
                                    <a href="{{ path('app_notificacion_alumno_marcar_leida_get', {'id': notificacion.id, '_token': csrf_token('marcar_leida_alumno' ~ notificacion.id)}) }}" class="btn btn-sm btn-secondary">
                                        Marcar como le√≠da
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 3rem;">
                <p style="color: #666; font-size: 1.1rem;">No tienes notificaciones.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

