{% extends 'base.html.twig' %}

{% block title %}Nueva Pregunta{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <h1>Nueva Pregunta</h1>
    </div>
    <div class="card-body">
        {{ form_start(form) }}
            {{ form_row(form.texto) }}
            {{ form_row(form.dificultad) }}
            {{ form_row(form.tema) }}
            {{ form_row(form.plantilla) }}
            {{ form_row(form.ley) }}
            {{ form_row(form.articulo) }}
            {{ form_row(form.opcionA) }}
            {{ form_row(form.opcionB) }}
            {{ form_row(form.opcionC) }}
            {{ form_row(form.opcionD) }}
            {{ form_row(form.respuestaCorrecta) }}
            {{ form_row(form.retroalimentacion) }}
            
            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary">Guardar</button>
                <a href="{{ path('app_pregunta_index') }}" class="btn btn-secondary">Cancelar</a>
            </div>
        {{ form_end(form) }}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const temaSelect = document.querySelector('select[name="pregunta[tema]"]');
    const dificultadSelect = document.querySelector('select[name="pregunta[dificultad]"]');
    const plantillaSelect = document.querySelector('select[name="pregunta[plantilla]"]');
    const leySelect = document.querySelector('select[name="pregunta[ley]"]');
    const articuloSelect = document.querySelector('select[name="pregunta[articulo]"]');
    
    // Función para cargar leyes por tema
    function cargarLeyesPorTema(temaId) {
        if (!temaId || temaId === '') {
            leySelect.innerHTML = '<option value="">Selecciona una ley</option>';
            articuloSelect.innerHTML = '<option value="">Selecciona un artículo</option>';
            leySelect.disabled = true;
            articuloSelect.disabled = true;
            return;
        }
        
        fetch(`/pregunta/api/leyes-por-tema/${temaId}`)
            .then(response => response.json())
            .then(data => {
                const leySeleccionada = leySelect.value;
                leySelect.innerHTML = '<option value="">Selecciona una ley</option>';
                data.forEach(ley => {
                    const option = document.createElement('option');
                    option.value = ley.id;
                    option.textContent = ley.nombre;
                    if (ley.id == leySeleccionada) {
                        option.selected = true;
                    }
                    leySelect.appendChild(option);
                });
                leySelect.disabled = false;
                
                // Si hay una ley seleccionada, cargar sus artículos
                if (leySeleccionada) {
                    cargarArticulosPorLey(leySeleccionada);
                } else {
                    articuloSelect.innerHTML = '<option value="">Selecciona un artículo</option>';
                    articuloSelect.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error al cargar leyes:', error);
            });
    }
    
    // Función para cargar artículos por ley
    function cargarArticulosPorLey(leyId) {
        if (!leyId || leyId === '') {
            articuloSelect.innerHTML = '<option value="">Selecciona un artículo</option>';
            articuloSelect.disabled = true;
            return;
        }
        
        fetch(`/pregunta/api/articulos-por-ley/${leyId}`)
            .then(response => response.json())
            .then(data => {
                const articuloSeleccionado = articuloSelect.value;
                articuloSelect.innerHTML = '<option value="">Selecciona un artículo</option>';
                data.forEach(articulo => {
                    const option = document.createElement('option');
                    option.value = articulo.id;
                    option.textContent = articulo.label;
                    if (articulo.id == articuloSeleccionado) {
                        option.selected = true;
                    }
                    articuloSelect.appendChild(option);
                });
                articuloSelect.disabled = false;
            })
            .catch(error => {
                console.error('Error al cargar artículos:', error);
            });
    }
    
    // Función para cargar plantillas por tema y dificultad
    function cargarPlantillasPorTemaYDificultad(temaId, dificultad) {
        if (!temaId || !dificultad) {
            if (plantillaSelect) {
                plantillaSelect.innerHTML = '<option value="">Selecciona una plantilla</option>';
                plantillaSelect.disabled = true;
            }
            return;
        }
        
        fetch(`/plantilla/api/por-tema-dificultad?tema=${temaId}&dificultad=${dificultad}`)
            .then(response => response.json())
            .then(data => {
                if (plantillaSelect) {
                    const plantillaSeleccionada = plantillaSelect.value;
                    plantillaSelect.innerHTML = '<option value="">Selecciona una plantilla</option>';
                    if (data.plantillas && data.plantillas.length > 0) {
                        data.plantillas.forEach(plantilla => {
                            const option = document.createElement('option');
                            option.value = plantilla.id;
                            const label = plantilla.numeroPreguntas !== undefined 
                                ? `${plantilla.nombre} (${plantilla.numeroPreguntas} preguntas)`
                                : plantilla.nombre;
                            option.textContent = label;
                            if (plantilla.id == plantillaSeleccionada) {
                                option.selected = true;
                            }
                            plantillaSelect.appendChild(option);
                        });
                        plantillaSelect.disabled = false;
                    } else {
                        plantillaSelect.disabled = true;
                    }
                }
            })
            .catch(error => {
                console.error('Error al cargar plantillas:', error);
            });
    }
    
    // Event listeners
    if (temaSelect) {
        temaSelect.addEventListener('change', function() {
            cargarLeyesPorTema(this.value);
            if (dificultadSelect && dificultadSelect.value) {
                cargarPlantillasPorTemaYDificultad(this.value, dificultadSelect.value);
            }
        });
        
        // Cargar leyes si ya hay un tema seleccionado
        if (temaSelect.value) {
            cargarLeyesPorTema(temaSelect.value);
        }
    }
    
    if (dificultadSelect) {
        dificultadSelect.addEventListener('change', function() {
            if (temaSelect && temaSelect.value) {
                cargarPlantillasPorTemaYDificultad(temaSelect.value, this.value);
            }
        });
        
        // Cargar plantillas si ya hay tema y dificultad seleccionados
        if (dificultadSelect.value && temaSelect && temaSelect.value) {
            cargarPlantillasPorTemaYDificultad(temaSelect.value, dificultadSelect.value);
        }
    }
    
    if (leySelect) {
        leySelect.addEventListener('change', function() {
            cargarArticulosPorLey(this.value);
        });
        
        // Cargar artículos si ya hay una ley seleccionada y no está deshabilitado
        if (leySelect.value && !leySelect.disabled) {
            cargarArticulosPorLey(leySelect.value);
        }
    }
    
    // Inicializar editor para retroalimentación (CKEditor)
    const editorElement = document.querySelector('.tinymce-editor');
    if (editorElement && typeof ClassicEditor !== 'undefined') {
        ClassicEditor
            .create(editorElement, {
                toolbar: {
                    items: [
                        'heading', '|',
                        'bold', 'italic', 'underline', '|',
                        'bulletedList', 'numberedList', '|',
                        'alignment', '|',
                        'link', '|',
                        'undo', 'redo'
                    ]
                },
                language: 'es',
                heading: {
                    options: [
                        { model: 'paragraph', title: 'Párrafo', class: 'ck-heading_paragraph' },
                        { model: 'heading1', view: 'h1', title: 'Título 1', class: 'ck-heading_heading1' },
                        { model: 'heading2', view: 'h2', title: 'Título 2', class: 'ck-heading_heading2' },
                        { model: 'heading3', view: 'h3', title: 'Título 3', class: 'ck-heading_heading3' }
                    ]
                }
            })
            .then(editor => {
                console.log('CKEditor inicializado correctamente para retroalimentación');
            })
            .catch(error => {
                console.error('Error al inicializar CKEditor:', error);
            });
    }
});
</script>
{% endblock %}

