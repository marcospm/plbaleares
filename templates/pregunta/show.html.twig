{% extends 'base.html.twig' %}

{% block title %}Pregunta #{{ pregunta.id }}{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <h1>Pregunta #{{ pregunta.id }}</h1>
    </div>
    <div class="card-body">
        <div class="form-group">
            <label class="form-label"><strong>Texto de la Pregunta:</strong></label>
            <div style="background-color: #f5f5f5; padding: 1rem; border-radius: 4px; border-left: 4px solid var(--color-primary); font-size: 1.1rem;">
                {{ pregunta.texto|nl2br }}
            </div>
        </div>

        <div class="form-group">
            <label class="form-label"><strong>Opciones de Respuesta:</strong></label>
            {% set respuestaCorrectaNormalizada = pregunta.respuestaCorrecta ? (pregunta.respuestaCorrecta|trim|upper) : '' %}
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div style="padding: 0.75rem; background: #f5f5f5; border-radius: 4px; {% if respuestaCorrectaNormalizada == 'A' %}border-left: 4px solid var(--color-success);{% endif %}">
                    <strong style="color: var(--color-primary);">A)</strong> {{ pregunta.opcionA }}
                    {% if respuestaCorrectaNormalizada == 'A' %}<span class="badge badge-facil" style="margin-left: 1rem; background-color: var(--color-success); color: white;">Correcta</span>{% endif %}
                </div>
                <div style="padding: 0.75rem; background: #f5f5f5; border-radius: 4px; {% if respuestaCorrectaNormalizada == 'B' %}border-left: 4px solid var(--color-success);{% endif %}">
                    <strong style="color: var(--color-primary);">B)</strong> {{ pregunta.opcionB }}
                    {% if respuestaCorrectaNormalizada == 'B' %}<span class="badge badge-facil" style="margin-left: 1rem; background-color: var(--color-success); color: white;">Correcta</span>{% endif %}
                </div>
                <div style="padding: 0.75rem; background: #f5f5f5; border-radius: 4px; {% if respuestaCorrectaNormalizada == 'C' %}border-left: 4px solid var(--color-success);{% endif %}">
                    <strong style="color: var(--color-primary);">C)</strong> {{ pregunta.opcionC }}
                    {% if respuestaCorrectaNormalizada == 'C' %}<span class="badge badge-facil" style="margin-left: 1rem; background-color: var(--color-success); color: white;">Correcta</span>{% endif %}
                </div>
                <div style="padding: 0.75rem; background: #f5f5f5; border-radius: 4px; {% if respuestaCorrectaNormalizada == 'D' %}border-left: 4px solid var(--color-success);{% endif %}">
                    <strong style="color: var(--color-primary);">D)</strong> {{ pregunta.opcionD }}
                    {% if respuestaCorrectaNormalizada == 'D' %}<span class="badge badge-facil" style="margin-left: 1rem; background-color: var(--color-success); color: white;">Correcta</span>{% endif %}
                </div>
            </div>
            {% if not respuestaCorrectaNormalizada %}
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: #fff3e0; border-radius: 4px; font-size: 0.9rem; color: #ff9800; border-left: 4px solid #ff9800;">
                    <strong>‚ö†Ô∏è Advertencia:</strong> Esta pregunta no tiene una respuesta correcta definida.
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label class="form-label"><strong>Dificultad:</strong></label>
            <p><span class="badge badge-{{ pregunta.dificultad }}">{{ pregunta.getDificultadLabel() }}</span></p>
        </div>

        <div class="form-group">
            <label class="form-label"><strong>Tema:</strong></label>
            <p><a href="{{ path('app_tema_show', {'id': pregunta.tema.id}) }}">{{ pregunta.tema.nombre }}</a></p>
        </div>

        <div class="form-group">
            <label class="form-label"><strong>Ley:</strong></label>
            <p><a href="{{ path('app_ley_show', {'id': pregunta.ley.id}) }}">{{ pregunta.ley.nombre }}</a></p>
        </div>

        <div class="form-group">
            <label class="form-label"><strong>Art√≠culo:</strong></label>
            <p><a href="{{ path('app_articulo_show', {'id': pregunta.articulo.id}) }}">Art. {{ pregunta.articulo.numero }}</a></p>
        </div>

        {% if pregunta.retroalimentacion %}
            <div class="form-group">
                <label class="form-label"><strong>Retroalimentaci√≥n:</strong></label>
                <div style="background-color: #e3f2fd; padding: 1rem; border-radius: 4px; border-left: 4px solid var(--color-secondary);">
                    {{ pregunta.retroalimentacion|nl2br }}
                </div>
            </div>
        {% endif %}

        <!-- Secci√≥n de Mensajes y Comentarios -->
        <div class="form-group mt-4" style="border-top: 2px solid #ddd; padding-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0; color: var(--color-primary);">
                    üí¨ Mensajes y Comentarios
                    {% if totalMensajes > 0 %}
                        <span class="badge bg-primary" style="margin-left: 0.5rem;">{{ totalMensajes }}</span>
                    {% endif %}
                </h3>
            </div>

            {% if mensajes|length > 0 %}
                <div style="display: grid; gap: 1rem;">
                    {% for mensaje in mensajes %}
                        {% set esProfesorMensaje = mensaje.autor.roles|filter(v => v in ['ROLE_PROFESOR', 'ROLE_ADMIN'])|length > 0 %}
                        <div class="card" style="border-left: 4px solid {% if esProfesorMensaje %}#28a745{% else %}var(--color-primary){% endif %}; background-color: {% if esProfesorMensaje %}#f0f9f4{% else %}#fff{% endif %};">
                            <div class="card-header" style="background-color: {% if esProfesorMensaje %}#f0f9f4{% else %}#fff{% endif %}; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: {% if esProfesorMensaje %}#28a745{% else %}var(--color-primary){% endif %};">
                                        {{ mensaje.autor.username }}
                                    </strong>
                                    {% if esProfesorMensaje %}
                                        <span class="badge bg-success" style="margin-left: 0.5rem;">Profesor</span>
                                    {% else %}
                                        <span class="badge bg-primary" style="margin-left: 0.5rem;">Alumno</span>
                                    {% endif %}
                                </div>
                                <small style="color: #999;">{{ mensaje.fechaCreacion|date('d/m/Y H:i') }}</small>
                            </div>
                            <div class="card-body">
                                <p style="margin: 0; white-space: pre-wrap; line-height: 1.6;">{{ mensaje.mensaje }}</p>
                                
                                {% if mensaje.respuestas|length > 0 %}
                                    <div style="margin-top: 1rem; margin-left: 1rem; padding-left: 1rem; border-left: 3px solid #ddd;">
                                        <strong style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; display: block;">Respuestas:</strong>
                                        {% for respuesta in mensaje.respuestas|sort((a, b) => a.fechaCreacion <=> b.fechaCreacion) %}
                                            {% set esProfesorRespuesta = respuesta.autor.roles|filter(v => v in ['ROLE_PROFESOR', 'ROLE_ADMIN'])|length > 0 %}
                                            <div class="card mb-2" style="border-left: 4px solid {% if esProfesorRespuesta %}#28a745{% else %}var(--color-primary){% endif %}; background-color: {% if esProfesorRespuesta %}#f0f9f4{% else %}#fff{% endif %};">
                                                <div class="card-body" style="padding: 0.75rem;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                        <div>
                                                            <strong style="color: {% if esProfesorRespuesta %}#28a745{% else %}var(--color-primary){% endif %}; font-size: 0.9rem;">
                                                                {{ respuesta.autor.username }}
                                                            </strong>
                                                            {% if esProfesorRespuesta %}
                                                                <span class="badge bg-success" style="font-size: 0.7rem; margin-left: 0.5rem;">Profesor</span>
                                                            {% else %}
                                                                <span class="badge bg-primary" style="font-size: 0.7rem; margin-left: 0.5rem;">Alumno</span>
                                                            {% endif %}
                                                        </div>
                                                        <small style="color: #999; font-size: 0.85rem;">{{ respuesta.fechaCreacion|date('d/m/Y H:i') }}</small>
                                                    </div>
                                                    <p style="margin: 0; white-space: pre-wrap; line-height: 1.5; font-size: 0.9rem;">{{ respuesta.mensaje }}</p>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                {% if not esProfesorMensaje %}
                                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                                        <form class="form-responder-mensaje" data-mensaje-id="{{ mensaje.id }}" style="display: flex; gap: 0.5rem; align-items: flex-start;">
                                            <input type="hidden" name="_token" value="{{ csrf_token('responder_mensaje_pregunta_' ~ mensaje.id) }}">
                                            <textarea name="respuesta" class="form-control" rows="2" placeholder="Escribe tu respuesta..." required style="flex: 1;"></textarea>
                                            <button type="submit" class="btn btn-success btn-sm" style="white-space: nowrap;">Responder</button>
                                        </form>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    No hay mensajes sobre esta pregunta a√∫n.
                </div>
            {% endif %}
        </div>

        <div class="d-flex gap-2 mt-4">
            <a href="{{ path('app_pregunta_edit', {'id': pregunta.id}|merge(filtros|default({}))) }}" class="btn btn-primary">Editar</a>
            <a href="{{ path('app_pregunta_index', filtros|default({})) }}" class="btn btn-secondary">Volver</a>
            <form method="post" action="{{ path('app_pregunta_delete', {'id': pregunta.id}|merge(filtros|default({}))) }}" onsubmit="return confirm('¬øEst√°s seguro de eliminar esta pregunta?');" style="display: inline;">
                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ pregunta.id) }}">
                <button type="submit" class="btn btn-danger">Eliminar</button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejar env√≠o de respuestas
    document.addEventListener('submit', function(e) {
        if (e.target.classList.contains('form-responder-mensaje')) {
            e.preventDefault();
            
            const form = e.target;
            const mensajeId = form.dataset.mensajeId;
            const textarea = form.querySelector('[name="respuesta"]');
            const respuestaTexto = textarea ? textarea.value.trim() : '';
            
            if (!respuestaTexto) {
                alert('Por favor, escribe una respuesta.');
                return;
            }
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : 'Responder';
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Enviando...';
            }
            
            const formData = new FormData(form);
            
            fetch(`/pregunta/mensaje/${mensajeId}/responder`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Limpiar formulario
                    if (textarea) {
                        textarea.value = '';
                    }
                    // Recargar la p√°gina para ver la nueva respuesta
                    window.location.reload();
                } else {
                    alert(data.error || 'Error al enviar la respuesta.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al enviar la respuesta. Por favor, int√©ntalo de nuevo.');
            })
            .finally(() => {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        }
    });
});
</script>
{% endblock %}


