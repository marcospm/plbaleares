{% extends 'base.html.twig' %}

{% block title %}Pregunta del Art√≠culo {{ pregunta.articulo.numero }}{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <h1>Pregunta del Art√≠culo {{ pregunta.articulo.numero }}{% if pregunta.articulo.nombre %} - {{ pregunta.articulo.nombre }}{% endif %}</h1>
    </div>
    <div class="card-body">
        <div class="form-group mb-4">
            <label class="form-label"><strong>Texto de la Pregunta:</strong></label>
            <div style="background-color: #f5f5f5; padding: 1rem; border-radius: 4px; border-left: 4px solid var(--color-primary); font-size: 1.1rem;">
                {{ pregunta.texto|nl2br }}
            </div>
        </div>

        <div class="form-group mb-4">
            <label class="form-label"><strong>Opciones de Respuesta:</strong></label>
            {% set respuestaCorrectaNormalizada = pregunta.respuestaCorrecta ? (pregunta.respuestaCorrecta|trim|upper) : '' %}
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div style="padding: 0.75rem; background: #f5f5f5; border-radius: 4px; {% if respuestaCorrectaNormalizada == 'A' %}border-left: 4px solid var(--color-success);{% endif %}">
                    <strong style="color: var(--color-primary);">A)</strong> {{ pregunta.opcionA }}
                    {% if respuestaCorrectaNormalizada == 'A' %}<span class="badge badge-facil" style="margin-left: 1rem; background-color: var(--color-success); color: white;">Correcta</span>{% endif %}
                </div>
                <div style="padding: 0.75rem; background: #f5f5f5; border-radius: 4px; {% if respuestaCorrectaNormalizada == 'B' %}border-left: 4px solid var(--color-success);{% endif %}">
                    <strong style="color: var(--color-primary);">B)</strong> {{ pregunta.opcionB }}
                    {% if respuestaCorrectaNormalizada == 'B' %}<span class="badge badge-facil" style="margin-left: 1rem; background-color: var(--color-success); color: white;">Correcta</span>{% endif %}
                </div>
                <div style="padding: 0.75rem; background: #f5f5f5; border-radius: 4px; {% if respuestaCorrectaNormalizada == 'C' %}border-left: 4px solid var(--color-success);{% endif %}">
                    <strong style="color: var(--color-primary);">C)</strong> {{ pregunta.opcionC }}
                    {% if respuestaCorrectaNormalizada == 'C' %}<span class="badge badge-facil" style="margin-left: 1rem; background-color: var(--color-success); color: white;">Correcta</span>{% endif %}
                </div>
                <div style="padding: 0.75rem; background: #f5f5f5; border-radius: 4px; {% if respuestaCorrectaNormalizada == 'D' %}border-left: 4px solid var(--color-success);{% endif %}">
                    <strong style="color: var(--color-primary);">D)</strong> {{ pregunta.opcionD }}
                    {% if respuestaCorrectaNormalizada == 'D' %}<span class="badge badge-facil" style="margin-left: 1rem; background-color: var(--color-success); color: white;">Correcta</span>{% endif %}
                </div>
            </div>
        </div>

        <div class="form-group mb-4">
            <label class="form-label"><strong>Dificultad:</strong></label>
            <p><span class="badge badge-{{ pregunta.dificultad }}">{{ pregunta.getDificultadLabel() }}</span></p>
        </div>

        {% if pregunta.retroalimentacion %}
            <div class="form-group mb-4">
                <label class="form-label"><strong>Retroalimentaci√≥n:</strong></label>
                <div style="background-color: #e3f2fd; padding: 1rem; border-radius: 4px; border-left: 4px solid var(--color-secondary);">
                    {{ pregunta.retroalimentacion|nl2br }}
                </div>
            </div>
        {% endif %}

        <!-- Secci√≥n de Mensajes y Comentarios -->
        <div class="form-group mt-4" style="border-top: 2px solid #ddd; padding-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0; color: var(--color-primary);">
                    üí¨ Mensajes y Comentarios
                    {% if totalMensajes > 0 %}
                        <span class="badge bg-primary" style="margin-left: 0.5rem;">{{ totalMensajes }}</span>
                    {% endif %}
                </h3>
            </div>

            {% if mensajes|length > 0 %}
                <div style="display: grid; gap: 1rem;">
                    {% for mensaje in mensajes %}
                        {% set esProfesorMensaje = mensaje.autor.roles|filter(v => v in ['ROLE_PROFESOR', 'ROLE_ADMIN'])|length > 0 %}
                        <div class="card" style="border-left: 4px solid {% if esProfesorMensaje %}#28a745{% else %}var(--color-primary){% endif %}; background-color: {% if esProfesorMensaje %}#f0f9f4{% else %}#fff{% endif %};">
                            <div class="card-header" style="background-color: {% if esProfesorMensaje %}#f0f9f4{% else %}#fff{% endif %}; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: {% if esProfesorMensaje %}#28a745{% else %}var(--color-primary){% endif %};">
                                        {{ mensaje.autor.username }}
                                    </strong>
                                    {% if esProfesorMensaje %}
                                        <span class="badge bg-success" style="margin-left: 0.5rem;">Profesor</span>
                                    {% else %}
                                        <span class="badge bg-primary" style="margin-left: 0.5rem;">Alumno</span>
                                    {% endif %}
                                </div>
                                <small style="color: #999;">{{ mensaje.fechaCreacion|date('d/m/Y H:i') }}</small>
                            </div>
                            <div class="card-body">
                                <p style="margin: 0; white-space: pre-wrap; line-height: 1.6;">{{ mensaje.mensaje }}</p>
                                
                                {% if mensaje.respuestas|length > 0 %}
                                    <div style="margin-top: 1rem; margin-left: 1rem; padding-left: 1rem; border-left: 3px solid #ddd;">
                                        <strong style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; display: block;">Respuestas:</strong>
                                        {% for respuesta in mensaje.respuestas|sort((a, b) => a.fechaCreacion <=> b.fechaCreacion) %}
                                            {% set esProfesorRespuesta = respuesta.autor.roles|filter(v => v in ['ROLE_PROFESOR', 'ROLE_ADMIN'])|length > 0 %}
                                            <div class="card mb-2" style="border-left: 4px solid {% if esProfesorRespuesta %}#28a745{% else %}var(--color-primary){% endif %}; background-color: {% if esProfesorRespuesta %}#f0f9f4{% else %}#fff{% endif %};">
                                                <div class="card-body" style="padding: 0.75rem;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                        <div>
                                                            <strong style="color: {% if esProfesorRespuesta %}#28a745{% else %}var(--color-primary){% endif %}; font-size: 0.9rem;">
                                                                {{ respuesta.autor.username }}
                                                            </strong>
                                                            {% if esProfesorRespuesta %}
                                                                <span class="badge bg-success" style="font-size: 0.7rem; margin-left: 0.5rem;">Profesor</span>
                                                            {% else %}
                                                                <span class="badge bg-primary" style="font-size: 0.7rem; margin-left: 0.5rem;">Alumno</span>
                                                            {% endif %}
                                                        </div>
                                                        <small style="color: #999; font-size: 0.85rem;">{{ respuesta.fechaCreacion|date('d/m/Y H:i') }}</small>
                                                    </div>
                                                    <p style="margin: 0; white-space: pre-wrap; line-height: 1.5; font-size: 0.9rem;">{{ respuesta.mensaje }}</p>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    No hay mensajes sobre esta pregunta a√∫n.
                </div>
            {% endif %}
        </div>

        <div class="d-flex gap-2 mt-4">
            <a href="{{ path('app_articulo_publico_show', {'id': pregunta.articulo.id}) }}" class="btn btn-secondary">Volver al Art√≠culo</a>
        </div>
    </div>
</div>
{% endblock %}


