{% extends 'base.html.twig' %}

{% block title %}Inicio - Sistema de Oposiciones - Polic√≠a Local Illes Balears{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Funci√≥n para plegar/desplegar secciones
            function toggleSection(sectionId) {
                const section = document.getElementById(sectionId);
                const icon = document.querySelector(`[data-section="${sectionId}"] .toggle-icon`);
                
                if (section) {
                    const isCollapsed = section.style.display === 'none';
                    section.style.display = isCollapsed ? 'block' : 'none';
                    
                    if (icon) {
                        icon.textContent = isCollapsed ? '‚ñº' : '‚ñ∂';
                    }
                    
                    // Guardar preferencia en localStorage
                    localStorage.setItem(`dashboard_section_${sectionId}`, isCollapsed ? 'expanded' : 'collapsed');
                }
            }
            
            // Restaurar estado de las secciones desde localStorage
            // Secciones principales
            const mainSections = ['convocatorias', 'ranking-general', 'mis-examenes', 'mis-tareas', 'historial-examenes'];
            mainSections.forEach(sectionId => {
                const savedState = localStorage.getItem(`dashboard_section_${sectionId}`);
                if (savedState === 'collapsed') {
                    const section = document.getElementById(sectionId);
                    const icon = document.querySelector(`[data-section="${sectionId}"] .toggle-icon`);
                    if (section) {
                        section.style.display = 'none';
                    }
                    if (icon) {
                        icon.textContent = '‚ñ∂';
                    }
                }
            });
            
            // Rankings por municipio (IDs din√°micos)
            const rankingMunicipioHeaders = document.querySelectorAll('[data-section^="ranking-municipio-"]');
            rankingMunicipioHeaders.forEach(header => {
                const sectionId = header.getAttribute('data-section');
                const savedState = localStorage.getItem(`dashboard_section_${sectionId}`);
                if (savedState === 'collapsed') {
                    const section = document.getElementById(sectionId);
                    const icon = header.querySelector('.toggle-icon');
                    if (section) {
                        section.style.display = 'none';
                    }
                    if (icon) {
                        icon.textContent = '‚ñ∂';
                    }
                }
            });
            
            // Hacer la funci√≥n global para que pueda ser llamada desde onclick
            window.toggleSection = toggleSection;
        });
    </script>
{% endblock %}

{% block body %}
{% if isProfesor %}
    {# Dashboard Profesor #}
    <h1 style="margin-bottom: 2rem; color: var(--color-primary);">Panel de Profesor</h1>

    {# Informaci√≥n de Alumnos Asignados #}
    {% if esAdmin %}
        <div class="card" style="margin-bottom: 2rem; border-left: 4px solid #dc3545; background-color: #ffe6e6;">
            <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0; color: #dc3545; font-size: 1.1rem;">üëë Administrador</h3>
                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">Tienes acceso a todos los alumnos del sistema.</p>
                    </div>
                    <a href="{{ path('app_user_index') }}" class="btn btn-primary">Gestionar Usuarios</a>
                </div>
            </div>
        </div>
    {% else %}
        <div class="card" style="margin-bottom: 2rem; border-left: 4px solid var(--color-primary); background-color: #e3f2fd;">
            <div class="card-header" style="background-color: var(--color-primary); color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: white; font-size: 1.2rem;">üë• Mis Alumnos Asignados</h2>
                    {% if is_granted('ROLE_ADMIN') %}
                        <a href="{{ path('app_user_index') }}" class="btn btn-sm" style="background-color: white; color: var(--color-primary); border: none;">Gestionar Asignaciones</a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if misAlumnos|length > 0 %}
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                        {% for alumno in misAlumnos %}
                            <div style="padding: 1rem; border: 1px solid #ddd; border-radius: 4px; background-color: white;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <strong style="color: var(--color-primary);">{{ alumno.username }}</strong>
                                    {% if not alumno.isActivo %}
                                        <span class="badge badge-danger" style="background-color: var(--color-danger); font-size: 0.7rem;">Inactivo</span>
                                    {% endif %}
                                </div>
                                <div style="font-size: 0.85rem; color: #666;">
                                    <a href="{{ path('app_examen_profesor', {'usuario': alumno.id}) }}" class="btn btn-sm btn-secondary" style="margin-top: 0.5rem;">Ver Ex√°menes</a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                        <p style="margin: 0; color: #666; font-size: 0.9rem;">
                            <strong>Total:</strong> {{ misAlumnos|length }} alumno(s) asignado(s).
                            {% if is_granted('ROLE_ADMIN') %}
                                <a href="{{ path('app_user_index') }}" style="margin-left: 1rem; color: var(--color-primary);">Gestionar asignaciones</a>
                            {% endif %}
                        </p>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: #666; margin-bottom: 1rem;">No tienes alumnos asignados actualmente.</p>
                        {% if is_granted('ROLE_ADMIN') %}
                            <a href="{{ path('app_user_index') }}" class="btn btn-primary">Asignar Alumnos</a>
                        {% else %}
                            <p style="color: #999; font-size: 0.85rem;">Contacta con el administrador para que te asigne alumnos.</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}

    {# Estad√≠sticas Generales #}
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="card" style="border-left: 4px solid #2196F3; background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: #2196F3; margin-bottom: 0.5rem;">üë•</div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--color-primary); margin-bottom: 0.25rem;">{{ totalAlumnos }}</div>
                <div style="font-size: 0.9rem; color: #666;">Alumnos Activos</div>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid #4CAF50; background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%);">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: #4CAF50; margin-bottom: 0.5rem;">üìù</div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--color-success); margin-bottom: 0.25rem;">{{ totalExamenes }}</div>
                <div style="font-size: 0.9rem; color: #666;">Total Ex√°menes</div>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid #FF9800; background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%);">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: #FF9800; margin-bottom: 0.5rem;">‚≠ê</div>
                <div style="font-size: 2rem; font-weight: bold; color: #FF9800; margin-bottom: 0.25rem;">{{ promedioGeneral|default(0)|number_format(2, ',', '.') }}</div>
                <div style="font-size: 0.9rem; color: #666;">Promedio General</div>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid #9C27B0; background: linear-gradient(135deg, #f3e5f5 0%, #ffffff 100%);">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: #9C27B0; margin-bottom: 0.5rem;">üìÖ</div>
                <div style="font-size: 2rem; font-weight: bold; color: #9C27B0; margin-bottom: 0.25rem;">{{ examenesHoy|default(0) }}</div>
                <div style="font-size: 0.9rem; color: #666;">Ex√°menes Hoy</div>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid #00BCD4; background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%);">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: #00BCD4; margin-bottom: 0.5rem;">üìä</div>
                <div style="font-size: 2rem; font-weight: bold; color: #00BCD4; margin-bottom: 0.25rem;">{{ examenesSemana|default(0) }}</div>
                <div style="font-size: 0.9rem; color: #666;">Esta Semana</div>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        {# Actividad Reciente #}
        <div class="card">
            <div class="card-header" style="background-color: var(--color-primary); color: white;">
                <h2 style="margin: 0; color: white; font-size: 1.2rem;">üìã √öltimos Ex√°menes Realizados</h2>
            </div>
            <div class="card-body">
                {% if ultimosExamenes|length > 0 %}
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="table" style="font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th>Alumno</th>
                                    <th>Fecha</th>
                                    <th>Dificultad</th>
                                    <th>Nota</th>
                                    <th>Tipo</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for examen in ultimosExamenes %}
                                    <tr>
                                        <td><strong>{{ examen.usuario.username }}</strong></td>
                                        <td>{{ examen.fecha|date('d/m/Y H:i') }}</td>
                                        <td>
                                            <span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span>
                                        </td>
                                        <td><strong style="color: var(--color-primary); font-size: 1.1rem;">{{ examen.nota|number_format(2, ',', '.') }}</strong></td>
                                        <td>
                                            {% if examen.municipio %}
                                                <span class="badge" style="background-color: #2196F3;">{{ examen.municipio.nombre }}</span>
                                            {% else %}
                                                <span class="badge badge-facil">General</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ path('app_examen_detalle', {'id': examen.id}) }}" class="btn btn-sm btn-secondary">Ver</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 1rem;">
                        <a href="{{ path('app_examen_profesor') }}" class="btn btn-primary">Ver Todos los Ex√°menes</a>
                    </div>
                {% else %}
                    <p style="text-align: center; color: #666; padding: 2rem;">No hay ex√°menes realizados a√∫n.</p>
                {% endif %}
            </div>
        </div>

        {# Alumnos M√°s Activos #}
        <div class="card">
            <div class="card-header" style="background-color: var(--color-success); color: white;">
                <h2 style="margin: 0; color: white; font-size: 1.2rem;">üèÜ Alumnos M√°s Activos</h2>
            </div>
            <div class="card-body">
                {% if alumnosActivos|length > 0 %}
                    <div style="max-height: 400px; overflow-y: auto;">
                        {% for alumno in alumnosActivos %}
                            <div style="padding: 1rem; margin-bottom: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <strong style="color: var(--color-primary);">{{ alumno['username'] }}</strong>
                                    <span class="badge" style="background-color: var(--color-primary);">{{ alumno['totalExamenes'] }} ex√°menes</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #666;">
                                    Promedio: <strong style="color: var(--color-success);">{{ alumno['promedio']|number_format(2, ',', '.') }}</strong>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p style="text-align: center; color: #666; padding: 2rem;">No hay datos disponibles.</p>
                {% endif %}
            </div>
        </div>
    </div>

    {# Estad√≠sticas de Contenido #}
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header" style="background-color: var(--color-secondary); color: white;">
            <h2 style="margin: 0; color: white; font-size: 1.2rem;">üìö Estad√≠sticas de Contenido</h2>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                <div style="text-align: center; padding: 1rem; background-color: #e3f2fd; border-radius: 4px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìñ</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: var(--color-primary);">{{ totalTemas }}</div>
                    <div style="font-size: 0.85rem; color: #666;">Temas Generales</div>
                </div>

                <div style="text-align: center; padding: 1rem; background-color: #fff3e0; border-radius: 4px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ùì</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #FF9800;">{{ totalPreguntas }}</div>
                    <div style="font-size: 0.85rem; color: #666;">Total Preguntas</div>
                </div>

                <div style="text-align: center; padding: 1rem; background-color: #e8f5e9; border-radius: 4px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìÑ</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: var(--color-success);">{{ totalArticulos }}</div>
                    <div style="font-size: 0.85rem; color: #666;">Art√≠culos</div>
                </div>

                <div style="text-align: center; padding: 1rem; background-color: #e1f5fe; border-radius: 4px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üèõÔ∏è</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #2196F3;">{{ totalMunicipios }}</div>
                    <div style="font-size: 0.85rem; color: #666;">Municipios Activos</div>
                </div>

                <div style="text-align: center; padding: 1rem; background-color: #f3e5f5; border-radius: 4px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìë</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #9C27B0;">{{ totalTemasMunicipales }}</div>
                    <div style="font-size: 0.85rem; color: #666;">Temas Municipales</div>
                </div>

                <div style="text-align: center; padding: 1rem; background-color: #fff9c4; border-radius: 4px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìÖ</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #F57F17;">{{ totalConvocatorias }}</div>
                    <div style="font-size: 0.85rem; color: #666;">Convocatorias</div>
                </div>
            </div>
        </div>
    </div>

    {# Accesos R√°pidos #}
    <div class="card">
        <div class="card-header">
            <h2 style="margin: 0; font-size: 1.2rem;">‚ö° Accesos R√°pidos</h2>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <a href="{{ path('app_tema_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üìö</span>
                    <span>Temas</span>
                </a>

                <a href="{{ path('app_pregunta_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">‚ùì</span>
                    <span>Preguntas</span>
                </a>

                <a href="{{ path('app_articulo_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üìÑ</span>
                    <span>Art√≠culos</span>
                </a>

                <a href="{{ path('app_user_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üë•</span>
                    <span>Usuarios</span>
                </a>

                <a href="{{ path('app_examen_profesor') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üìù</span>
                    <span>Ex√°menes</span>
                </a>

                <a href="{{ path('app_convocatoria_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üìÖ</span>
                    <span>Convocatorias</span>
                </a>

                <a href="{{ path('app_municipio_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üèõÔ∏è</span>
                    <span>Municipios</span>
                </a>

                <a href="{{ path('app_planificacion_semanal_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üìã</span>
                    <span>Planificaciones</span>
                </a>
            </div>
        </div>
    </div>
{% else %}
    {# Dashboard Usuario Normal #}
    
    {# Informaci√≥n del Profesor Asignado #}
    {% if app.user.profesores|length > 0 %}
        <div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid var(--color-primary); background-color: #e3f2fd;">
            <div class="card-body">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 2rem;">üë®‚Äçüè´</div>
                        <div>
                            <h3 style="margin: 0; color: var(--color-primary); font-size: 1.1rem;">Profesor Asignado</h3>
                            <div style="margin-top: 0.5rem;">
                                {% for profesor in app.user.profesores %}
                                    <span class="badge" style="background-color: var(--color-primary); color: white; padding: 0.5rem 1rem; font-size: 0.9rem; margin-right: 0.5rem;">
                                        {{ profesor.username }}
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <a href="{{ path('app_mensaje_alumno_index') }}" 
                       class="btn btn-primary" 
                       style="background-color: var(--color-primary); color: white; padding: 0.5rem 1.5rem; border-radius: 4px; text-decoration: none; border: none; cursor: pointer; font-size: 0.9rem; white-space: nowrap;">
                        üí¨ Enviar Mensaje
                    </a>
                </div>
            </div>
        </div>
    {% else %}
        <div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid #ff9800; background-color: #fff3e0;">
            <div class="card-body">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="font-size: 2rem;">‚ö†Ô∏è</div>
                    <div>
                        <h3 style="margin: 0; color: #ff9800; font-size: 1.1rem;">Sin Profesor Asignado</h3>
                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">Contacta con el administrador para que te asigne un profesor.</p>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    {# Secci√≥n de Convocatorias #}
    {% if convocatorias|length > 0 %}
        <div class="card" style="margin-bottom: 1.5rem; border: 2px solid var(--color-primary); background-color: #f0f7ff;">
            <div class="card-header" style="background-color: var(--color-primary); color: white; cursor: pointer;" data-section="convocatorias" onclick="toggleSection('convocatorias')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: white;">üìÖ Mis Convocatorias</h2>
                    <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
                </div>
            </div>
            <div class="card-body" id="convocatorias">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    {% for convocatoria in convocatorias %}
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; background-color: white; border-left: 4px solid #2196F3;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 style="color: var(--color-primary); margin: 0; font-size: 1.1rem;">
                                    {{ convocatoria.nombre }}
                                    {% for municipio in convocatoria.municipios %}
                                        <span class="badge" style="background-color: #2196F3; margin-left: 0.5rem; font-size: 0.8rem;">{{ municipio.nombre }}</span>
                                    {% endfor %}
                                </h3>
                                {% if convocatoria.isActivo %}
                                    <span class="badge" style="background-color: #28a745; color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem;">Activa</span>
                                {% endif %}
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                                <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Te√≥rico</div>
                                    {% if convocatoria.fechaTeorico %}
                                        {% set diasTeorico = (convocatoria.fechaTeorico|date('U') - 'now'|date('U')) / 86400 %}
                                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">{{ convocatoria.fechaTeorico|date('d/m/Y') }}</div>
                                        <div style="font-size: 1.3rem; font-weight: bold; color: {% if diasTeorico < 0 %}#dc3545{% elseif diasTeorico <= 30 %}#ff9800{% else %}#28a745{% endif %};">
                                            {% if diasTeorico < 0 %}
                                                {{ (diasTeorico * -1)|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% else %}
                                                {{ diasTeorico|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div style="font-size: 0.9rem; color: #999; margin-bottom: 0.5rem; font-style: italic;">Pendiente</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: #999;">
                                            ‚Äî<br><small style="font-size: 0.7rem;">por definir</small>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">F√≠sicas</div>
                                    {% if convocatoria.fechaFisicas %}
                                        {% set diasFisicas = (convocatoria.fechaFisicas|date('U') - 'now'|date('U')) / 86400 %}
                                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">{{ convocatoria.fechaFisicas|date('d/m/Y') }}</div>
                                        <div style="font-size: 1.3rem; font-weight: bold; color: {% if diasFisicas < 0 %}#dc3545{% elseif diasFisicas <= 30 %}#ff9800{% else %}#28a745{% endif %};">
                                            {% if diasFisicas < 0 %}
                                                {{ (diasFisicas * -1)|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% else %}
                                                {{ diasFisicas|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div style="font-size: 0.9rem; color: #999; margin-bottom: 0.5rem; font-style: italic;">Pendiente</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: #999;">
                                            ‚Äî<br><small style="font-size: 0.7rem;">por definir</small>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Psicot√©cnico</div>
                                    {% if convocatoria.fechaPsicotecnico %}
                                        {% set diasPsicotecnico = (convocatoria.fechaPsicotecnico|date('U') - 'now'|date('U')) / 86400 %}
                                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">{{ convocatoria.fechaPsicotecnico|date('d/m/Y') }}</div>
                                        <div style="font-size: 1.3rem; font-weight: bold; color: {% if diasPsicotecnico < 0 %}#dc3545{% elseif diasPsicotecnico <= 30 %}#ff9800{% else %}#28a745{% endif %};">
                                            {% if diasPsicotecnico < 0 %}
                                                {{ (diasPsicotecnico * -1)|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% else %}
                                                {{ diasPsicotecnico|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div style="font-size: 0.9rem; color: #999; margin-bottom: 0.5rem; font-style: italic;">Pendiente</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: #999;">
                                            ‚Äî<br><small style="font-size: 0.7rem;">por definir</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% else %}
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid #ddd; background-color: #f8f9fa;">
            <div class="card-body" style="text-align: center; padding: 2rem;">
                <p style="color: #666; margin: 0;">No tienes convocatorias asignadas. Contacta con tu profesor para m√°s informaci√≥n.</p>
            </div>
        </div>
    {% endif %}

    {# Secci√≥n peque√±a de ranking general #}
    {% if posicionesUsuario %}
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header" style="cursor: pointer;" data-section="ranking-general" onclick="toggleSection('ranking-general')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <h3 style="margin: 0;">üèÜ Mi Ranking (Temario General)</h3>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="cantidad-ranking-select" style="margin-right: 0.5rem; font-size: 0.9rem;">√öltimos:</label>
                            <select id="cantidad-ranking-select" class="form-control" style="display: inline-block; width: auto; font-size: 0.9rem;" onchange="window.location.href='{{ path('app_dashboard') }}?cantidad=' + this.value" onclick="event.stopPropagation();">
                                <option value="2" {% if cantidadRanking == 2 %}selected{% endif %}>2 ex√°menes</option>
                                <option value="3" {% if cantidadRanking == 3 %}selected{% endif %}>3 ex√°menes</option>
                                <option value="4" {% if cantidadRanking == 4 %}selected{% endif %}>4 ex√°menes</option>
                                <option value="5" {% if cantidadRanking == 5 %}selected{% endif %}>5 ex√°menes</option>
                                <option value="10" {% if cantidadRanking == 10 %}selected{% endif %}>10 ex√°menes</option>
                            </select>
                            <span class="toggle-icon" style="font-size: 1.2rem; user-select: none; margin-left: 0.5rem;">‚ñº</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body" id="ranking-general">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    {% for dificultad, datos in posicionesUsuario %}
                        {% if datos.posicion %}
                            <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                <div style="font-weight: bold; color: var(--color-primary); margin-bottom: 0.25rem;">
                                    {% if dificultad == 'facil' %}F√°cil
                                    {% elseif dificultad == 'moderada' %}Moderada
                                    {% else %}Dif√≠cil
                                    {% endif %}
                                </div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--color-success);">
                                    Posici√≥n {{ datos.posicion }}/{{ datos.totalUsuarios }}
                                </div>
                                {% if datos.notaMedia %}
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                        Media: {{ datos.notaMedia|number_format(2, ',', '.') }}
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                <div style="font-weight: bold; color: var(--color-primary); margin-bottom: 0.25rem;">
                                    {% if dificultad == 'facil' %}F√°cil
                                    {% elseif dificultad == 'moderada' %}Moderada
                                    {% else %}Dif√≠cil
                                    {% endif %}
                                </div>
                                <div style="font-size: 0.9rem; color: #999;">
                                    Sin ex√°menes
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}

    {# Rankings por municipio #}
    {% if rankingsPorMunicipio|length > 0 %}
        <div id="rankings-municipios-container">
            {% for municipioId, datosMunicipio in rankingsPorMunicipio %}
                <div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid #2196F3;">
                    <div class="card-header" style="background-color: #e3f2fd; cursor: pointer;" data-section="ranking-municipio-{{ municipioId }}" onclick="toggleSection('ranking-municipio-{{ municipioId }}')">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <h3 style="margin: 0;">üèÜ Mi Ranking - {{ datosMunicipio.municipio.nombre }}</h3>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="cantidad-ranking-municipio-{{ municipioId }}-select" style="margin-right: 0.5rem; font-size: 0.9rem;">√öltimos:</label>
                                <select id="cantidad-ranking-municipio-{{ municipioId }}-select" class="form-control" style="display: inline-block; width: auto; font-size: 0.9rem;" onchange="window.location.href='{{ path('app_dashboard') }}?cantidad=' + this.value" onclick="event.stopPropagation();">
                                    <option value="2" {% if cantidadRanking == 2 %}selected{% endif %}>2 ex√°menes</option>
                                    <option value="3" {% if cantidadRanking == 3 %}selected{% endif %}>3 ex√°menes</option>
                                    <option value="4" {% if cantidadRanking == 4 %}selected{% endif %}>4 ex√°menes</option>
                                    <option value="5" {% if cantidadRanking == 5 %}selected{% endif %}>5 ex√°menes</option>
                                    <option value="10" {% if cantidadRanking == 10 %}selected{% endif %}>10 ex√°menes</option>
                                </select>
                                <span class="toggle-icon" style="font-size: 1.2rem; user-select: none; margin-left: 0.5rem;">‚ñº</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="ranking-municipio-{{ municipioId }}">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        {% for dificultad, datos in datosMunicipio.posiciones %}
                            {% if datos.posicion %}
                                <div style="text-align: center; padding: 0.75rem; background-color: #e3f2fd; border-radius: 4px;">
                                    <div style="font-weight: bold; color: #1976D2; margin-bottom: 0.25rem;">
                                        {% if dificultad == 'facil' %}F√°cil
                                        {% elseif dificultad == 'moderada' %}Moderada
                                        {% else %}Dif√≠cil
                                        {% endif %}
                                    </div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--color-success);">
                                        Posici√≥n {{ datos.posicion }}/{{ datos.totalUsuarios }}
                                    </div>
                                    {% if datos.notaMedia %}
                                        <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                            Media: {{ datos.notaMedia|number_format(2, ',', '.') }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div style="text-align: center; padding: 0.75rem; background-color: #e3f2fd; border-radius: 4px;">
                                    <div style="font-weight: bold; color: #1976D2; margin-bottom: 0.25rem;">
                                        {% if dificultad == 'facil' %}F√°cil
                                        {% elseif dificultad == 'moderada' %}Moderada
                                        {% else %}Dif√≠cil
                                        {% endif %}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #999;">
                                        Sin ex√°menes
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %}

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card">
            <div class="card-header" style="cursor: pointer;" data-section="mis-examenes" onclick="toggleSection('mis-examenes')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0;">üìö Mis Ex√°menes</h2>
                    <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
                </div>
            </div>
            <div class="card-body" id="mis-examenes">
                <div style="text-align: center; margin-bottom: 1rem;">
                    <a href="{{ path('app_examen_iniciar') }}" class="btn btn-primary" style="font-size: 1.1rem; padding: 0.75rem 1.5rem;">Nuevo Examen</a>
                </div>

                {% if estadisticas.total > 0 %}
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                            <h4 style="color: var(--color-primary); font-size: 1.5rem; margin: 0;">{{ estadisticas.total }}</h4>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem;">Ex√°menes</p>
                        </div>
                        <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                            <h4 style="color: var(--color-primary); font-size: 1.5rem; margin: 0;">{{ estadisticas.promedio|number_format(2, ',', '.') }}</h4>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem;">Promedio</p>
                        </div>
                        <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                            <h4 style="color: var(--color-success); font-size: 1.5rem; margin: 0;">{{ estadisticas.mejorNota|number_format(2, ',', '.') }}</h4>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem;">Mejor Nota</p>
                        </div>
                    </div>
                {% endif %}

                <h4 style="margin-top: 1rem; margin-bottom: 0.75rem; font-size: 1rem;">√öltimos Ex√°menes</h4>

                {% if ultimosExamenes|length > 0 %}
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="table" style="font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Dificultad</th>
                                    <th>Nota</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for examen in ultimosExamenes|slice(0, 5) %}
                                    <tr>
                                        <td>{{ examen.fecha|date('d/m/Y') }}</td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                                {% if examen.municipio %}
                                                    <span class="badge" style="background-color: #e3f2fd; color: #1976D2; border: 1px solid #90caf9; font-size: 0.75rem; padding: 0.25rem 0.5rem;">{{ examen.municipio.nombre }}</span>
                                                {% else %}
                                                    <span class="badge" style="background-color: #f1f8e9; color: #558b2f; border: 1px solid #c5e1a5; font-size: 0.75rem; padding: 0.25rem 0.5rem;">General</span>
                                                {% endif %}
                                                {% if examen.examenSemanal %}
                                                    <span style="font-size: 0.9rem; color: #9C27B0;" title="Examen Semanal: {{ examen.examenSemanal.nombre }}">üìÖ</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td><span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span></td>
                                        <td><strong style="color: var(--color-primary);">{{ examen.nota|number_format(2, ',', '.') }}</strong></td>
                                        <td>
                                            <a href="{{ path('app_examen_detalle', {'id': examen.id}) }}" class="btn btn-sm btn-secondary">Ver</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 0.5rem;">
                        <a href="{{ path('app_examen_historial') }}" class="btn btn-sm btn-secondary">Ver Todos</a>
                    </div>
                {% else %}
                    <p style="text-align: center; color: #666; margin: 1rem 0;">No has realizado ning√∫n examen a√∫n.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="cursor: pointer;" data-section="mis-tareas" onclick="toggleSection('mis-tareas')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0;">üìã Mis Tareas</h2>
                    <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
                </div>
            </div>
            <div class="card-body" id="mis-tareas">
                {% if planificacion %}
                    <div style="margin-bottom: 1rem;">
                        <a href="{{ path('app_planificacion_alumno_index') }}" class="btn btn-primary" style="width: 100%;">Ver Mi Planificaci√≥n</a>
                    </div>
                    
                    {% if resumenTareas.total > 0 %}
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 0.5rem; background-color: #e8f5e9; border-radius: 4px;">
                                <strong style="color: var(--color-success); font-size: 1.2rem;">{{ resumenTareas.completadas }}</strong>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">Completadas</p>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background-color: #fff3cd; border-radius: 4px;">
                                <strong style="color: var(--color-warning); font-size: 1.2rem;">{{ resumenTareas.pendientes }}</strong>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">Pendientes</p>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <p style="text-align: center; color: #666; margin: 1rem 0;">No tienes planificaci√≥n asignada.</p>
                {% endif %}

                <h4 style="margin-top: 1rem; margin-bottom: 0.75rem; font-size: 1rem;">Tareas Pendientes</h4>
                {% if tareasPendientes|length > 0 %}
                    <div style="max-height: 250px; overflow-y: auto;">
                        {% for tareaAsignada in tareasPendientes %}
                            <div style="padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #ddd; border-radius: 4px; background-color: {% if tareaAsignada.franjaHoraria %}#f0f0f0{% else %}#fff{% endif %};">
                                <div style="font-weight: bold; font-size: 0.9rem;">{{ tareaAsignada.tarea.nombre }}</div>
                                <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
                                    Semana: {{ tareaAsignada.tarea.semanaAsignacion|date('d/m/Y') }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div style="text-align: center; margin-top: 0.5rem;">
                        <a href="{{ path('app_planificacion_alumno_index') }}" class="btn btn-sm btn-secondary">Ver Todas</a>
                    </div>
                {% else %}
                    <p style="text-align: center; color: #666; margin: 1rem 0;">¬°No tienes tareas pendientes! üéâ</p>
                {% endif %}
            </div>
        </div>
    </div>

    {# Secci√≥n completa de ex√°menes #}
    <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header" style="cursor: pointer;" data-section="historial-examenes" onclick="toggleSection('historial-examenes')">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="margin: 0;">Historial de Ex√°menes</h1>
                <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
            </div>
        </div>
        <div class="card-body" id="historial-examenes">
            {% if ultimosExamenes|length > 0 %}
                <div class="card">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Dificultad</th>
                                <th>Preguntas</th>
                                <th>Nota</th>
                                <th>Aciertos</th>
                                <th>Errores</th>
                                <th>En blanco</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for examen in ultimosExamenes %}
                                <tr>
                                    <td>{{ examen.fecha|date('d/m/Y H:i') }}</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                                            {% if examen.municipio %}
                                                <span class="badge" style="background-color: #e3f2fd; color: #1976D2; border: 1px solid #90caf9; font-size: 0.75rem; padding: 0.25rem 0.5rem;">{{ examen.municipio.nombre }}</span>
                                            {% else %}
                                                <span class="badge" style="background-color: #f1f8e9; color: #558b2f; border: 1px solid #c5e1a5; font-size: 0.75rem; padding: 0.25rem 0.5rem;">General</span>
                                            {% endif %}
                                            {% if examen.examenSemanal %}
                                                <span style="font-size: 0.9rem; color: #9C27B0;" title="Examen Semanal: {{ examen.examenSemanal.nombre }}">üìÖ</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span>
                                    </td>
                                    <td>{{ examen.numeroPreguntas }}</td>
                                    <td><strong style="font-size: 1.2rem; color: var(--color-primary);">{{ examen.nota|number_format(2, ',', '.') }}</strong></td>
                                    <td style="color: var(--color-success);"><strong>{{ examen.aciertos }}</strong></td>
                                    <td style="color: var(--color-danger);"><strong>{{ examen.errores }}</strong></td>
                                    <td style="color: #999;"><strong>{{ examen.enBlanco }}</strong></td>
                                    <td>
                                        <a href="{{ path('app_examen_detalle', {'id': examen.id}) }}" class="btn btn-secondary btn-sm">Ver</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <a href="{{ path('app_examen_historial') }}" class="btn btn-secondary">Ver Historial Completo</a>
                </div>
            {% else %}
                <div class="card">
                    <div class="card-body text-center">
                        <p>No has realizado ning√∫n examen a√∫n.</p>
                        <a href="{{ path('app_examen_iniciar') }}" class="btn btn-primary">Realizar Primer Examen</a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endif %}
{% endblock %}

