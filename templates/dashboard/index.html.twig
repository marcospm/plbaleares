{% extends 'base.html.twig' %}

{% block title %}Inicio - BISPOL Aula Virtual{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {% if isProfesor and misAlumnos|length > 0 %}
    <style>
        /* Estilos para el select buscable de alumnos */
        #alumno-search {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath fill='%23666' d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04 0.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 16px;
            padding-right: 3rem;
        }
        
        #alumno-results {
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) #f0f0f0;
        }
        
        #alumno-results::-webkit-scrollbar {
            width: 8px;
        }
        
        #alumno-results::-webkit-scrollbar-track {
            background: #f0f0f0;
        }
        
        #alumno-results::-webkit-scrollbar-thumb {
            background-color: var(--color-primary);
            border-radius: 4px;
        }
        
        #alumno-results::-webkit-scrollbar-thumb:hover {
            background-color: #0056b3;
        }
        
        .alumno-result-item:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: -2px;
            background-color: #e3f2fd !important;
        }
        
        @media (max-width: 768px) {
            #alumno-results {
                max-height: 250px;
            }
        }
    </style>
    {% endif %}
    
    <style>
        /* Estilos responsivos para m√≥viles (iPhone) - Dashboard Alumno */
        @media (max-width: 768px) {
            /* Cards principales */
            .card {
                margin: 0.5rem !important;
            }
            
            .card-header h1,
            .card-header h2,
            .card-header h3 {
                font-size: 1.2rem !important;
            }
            
            .card-body {
                padding: 1rem !important;
            }
            
            /* Grid de dos columnas a una columna */
            .dashboard-grid-2cols {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            /* Todos los grids con auto-fit a columna √∫nica */
            div[style*="grid-template-columns: repeat(auto-fit"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Grids de 2 columnas a 1 columna */
            div[style*="grid-template-columns: 1fr 1fr"],
            div[style*="grid-template-columns: 2fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Grids de 3 columnas (rankings) a 1 columna */
            div[style*="grid-template-columns: repeat(3"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Grids de fechas en convocatorias - mantener 3 columnas si cabe */
            div[style*="grid-template-columns: repeat(auto-fit, minmax(120px"] {
                grid-template-columns: repeat(3, 1fr) !important;
            }
            
            /* Informaci√≥n de profesor/grupo - apilar verticalmente */
            .card-body > div[style*="display: flex"] {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 1rem !important;
            }
            
            /* Badges */
            .badge {
                margin: 0.25rem 0 !important;
                display: inline-block !important;
            }
            
            /* Botones */
            .btn,
            a.btn,
            button.btn {
                width: 100% !important;
                padding: 0.75rem 1rem !important;
                font-size: 1rem !important;
                min-height: 48px !important;
                text-align: center !important;
            }
            
            /* Tabla de historial de ex√°menes - sin restricciones de altura */
            #historial-examenes {
                max-height: none !important;
                overflow: visible !important;
            }
            
            #historial-examenes .card {
                max-height: none !important;
                overflow: visible !important;
            }
            
            /* Contenedor de tabla con scroll horizontal */
            #historial-examenes .card > div.table-responsive {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                width: 100%;
                display: block;
                margin: 0;
                padding: 0;
            }
            
            /* Si no hay div con clase table-responsive, aplicar al card directamente */
            #historial-examenes .card {
                overflow: visible !important;
            }
            
            #historial-examenes .card > div {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                width: 100%;
                display: block;
            }
            
            #historial-examenes .table {
                font-size: 0.85rem !important;
                min-width: 700px !important;
                width: auto !important;
                margin: 0;
            }
            
            #historial-examenes .table th,
            #historial-examenes .table td {
                padding: 0.5rem !important;
                white-space: nowrap;
            }
            
            /* Header responsive */
            #historial-examenes .card-header h1 {
                font-size: 1.3rem !important;
                word-wrap: break-word;
            }
            
            /* Ocultar columnas menos importantes en m√≥vil */
            #historial-examenes .table th:nth-child(4),
            #historial-examenes .table td:nth-child(4),
            #historial-examenes .table th:nth-child(6),
            #historial-examenes .table td:nth-child(6),
            #historial-examenes .table th:nth-child(7),
            #historial-examenes .table td:nth-child(7),
            #historial-examenes .table th:nth-child(8),
            #historial-examenes .table td:nth-child(8) {
                display: none !important;
            }
            
            /* Botones en la tabla */
            #historial-examenes .table .btn {
                min-height: 40px;
                font-size: 14px;
                padding: 0.5rem 0.75rem;
                white-space: nowrap;
            }
            
            /* Asegurar que no haya max-height en el listado de ex√°menes */
            #historial-examenes .card-body > .card,
            #historial-examenes > .card,
            .card-body > .card {
                max-height: none !important;
                overflow: visible !important;
                height: auto !important;
            }
            
            /* Remover cualquier max-height del body principal */
            #historial-examenes .card-body {
                max-height: none !important;
                overflow: visible !important;
                height: auto !important;
            }
            
            /* Tabla sin restricciones */
            #historial-examenes table {
                display: table !important;
            }
            
            #historial-examenes tbody {
                display: table-row-group !important;
            }
            
            /* Selects */
            select {
                font-size: 16px !important; /* Previene zoom en iOS */
                min-height: 44px !important;
                padding: 0.5rem !important;
            }
            
            /* Headers con toggle */
            .card-header[style*="cursor: pointer"] {
                padding: 1rem !important;
            }
            
            /* Franjas horarias en planificaci√≥n */
            .card-body > div[style*="display: flex"][style*="flex-direction: column"] > div[style*="padding: 0.75rem"] {
                padding: 0.75rem !important;
            }
            
            /* Cards de convocatorias */
            .card-body > div[style*="display: grid"] > div[style*="border: 1px solid"] {
                padding: 1rem !important;
            }
            
            /* Asegurar que el texto no se desborde */
            * {
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
            }
            
            /* Botones m√°s grandes para facilitar el toque */
            button, .btn, a.btn {
                min-height: 48px !important;
                touch-action: manipulation !important;
            }
        }
        
        /* Estilos espec√≠ficos para iPhone (pantallas muy peque√±as) */
        @media (max-width: 480px) {
            .card-header h1 {
                font-size: 1.1rem !important;
            }
            
            .card-header h2,
            .card-header h3 {
                font-size: 1rem !important;
            }
            
            /* Grids de 3 columnas a 1 columna */
            div[style*="grid-template-columns: repeat(3"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Grids de fechas en convocatorias a 1 columna */
            div[style*="grid-template-columns: repeat(auto-fit, minmax(120px"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Grids de 2 columnas a 1 columna */
            div[style*="grid-template-columns: repeat(2"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Ocultar m√°s columnas en tabla */
            .table th:nth-child(5),
            .table td:nth-child(5) {
                display: none !important;
            }
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        // Funci√≥n para inicializar el estado de las secciones
        function initializeDashboardSections() {
            // Funci√≥n para plegar/desplegar secciones
            function toggleSection(sectionId) {
                const section = document.getElementById(sectionId);
                const icon = document.querySelector(`[data-section="${sectionId}"] .toggle-icon`);
                
                if (section) {
                    const isCollapsed = section.style.display === 'none';
                    section.style.display = isCollapsed ? 'block' : 'none';
                    
                    if (icon) {
                        icon.textContent = isCollapsed ? '‚ñº' : '‚ñ∂';
                    }
                    
                    // Guardar preferencia en localStorage
                    localStorage.setItem(`dashboard_section_${sectionId}`, isCollapsed ? 'expanded' : 'collapsed');
                }
            }
            
            // Restaurar estado de las secciones desde localStorage
            // Secciones principales
            const mainSections = ['convocatorias', 'mi-planificacion', 'mis-tareas', 'historial-examenes'];
            mainSections.forEach(sectionId => {
                const savedState = localStorage.getItem(`dashboard_section_${sectionId}`);
                if (savedState === 'collapsed') {
                    const section = document.getElementById(sectionId);
                    const icon = document.querySelector(`[data-section="${sectionId}"] .toggle-icon`);
                    if (section) {
                        section.style.display = 'none';
                    }
                    if (icon) {
                        icon.textContent = '‚ñ∂';
                    }
                }
            });
            
            // Ranking general - PLEGADO POR DEFECTO
            const rankingGeneralSection = document.getElementById('ranking-general');
            const rankingGeneralHeader = document.querySelector('[data-section="ranking-general"]');
            if (rankingGeneralSection && rankingGeneralHeader) {
                const savedState = localStorage.getItem('dashboard_section_ranking-general');
                const icon = rankingGeneralHeader.querySelector('.toggle-icon');
                
                // Si no hay estado guardado, plegar por defecto
                // Si hay estado guardado, usar ese estado
                if (savedState === null || savedState === 'collapsed') {
                    rankingGeneralSection.style.display = 'none';
                    if (icon) {
                        icon.textContent = '‚ñ∂';
                    }
                    // Guardar como colapsado si no hab√≠a estado previo
                    if (savedState === null) {
                        localStorage.setItem('dashboard_section_ranking-general', 'collapsed');
                    }
                }
            }
            
            // Rankings por convocatoria (IDs din√°micos) - PLEGADAS POR DEFECTO
            const rankingConvocatoriaHeaders = document.querySelectorAll('[data-section^="ranking-convocatoria-"]');
            rankingConvocatoriaHeaders.forEach(header => {
                const sectionId = header.getAttribute('data-section');
                const savedState = localStorage.getItem(`dashboard_section_${sectionId}`);
                const section = document.getElementById(sectionId);
                const icon = header.querySelector('.toggle-icon');
                
                // Si no hay estado guardado, plegar por defecto
                // Si hay estado guardado, usar ese estado
                if (savedState === null || savedState === 'collapsed') {
                    if (section) {
                        section.style.display = 'none';
                    }
                    if (icon) {
                        icon.textContent = '‚ñ∂';
                    }
                    // Guardar como colapsado si no hab√≠a estado previo
                    if (savedState === null) {
                        localStorage.setItem(`dashboard_section_${sectionId}`, 'collapsed');
                    }
                }
            });
            
            // Rankings por municipio dentro de convocatorias (IDs din√°micos) - PLEGADAS POR DEFECTO
            const rankingMunicipioHeaders = document.querySelectorAll('[data-section^="ranking-municipio-"]');
            rankingMunicipioHeaders.forEach(header => {
                const sectionId = header.getAttribute('data-section');
                const savedState = localStorage.getItem(`dashboard_section_${sectionId}`);
                const section = document.getElementById(sectionId);
                const icon = header.querySelector('.toggle-icon');
                
                // Si no hay estado guardado, plegar por defecto
                // Si hay estado guardado, usar ese estado
                if (savedState === null || savedState === 'collapsed') {
                    if (section) {
                        section.style.display = 'none';
                    }
                    if (icon) {
                        icon.textContent = '‚ñ∂';
                    }
                    // Guardar como colapsado si no hab√≠a estado previo
                    if (savedState === null) {
                        localStorage.setItem(`dashboard_section_${sectionId}`, 'collapsed');
                    }
                }
            });
            
            // Hacer la funci√≥n global para que pueda ser llamada desde onclick
            window.toggleSection = toggleSection;
        }
        
        // Ejecutar tanto en carga inicial como en navegaci√≥n Turbo
        document.addEventListener('DOMContentLoaded', initializeDashboardSections);
        document.addEventListener('turbo:load', initializeDashboardSections);
    </script>
    
    {% if isProfesor and misAlumnos|length > 0 %}
    <script>
        // Datos de alumnos disponibles
        const alumnosData = [
            {% for alumno in misAlumnos %}
            {
                id: {{ alumno.id }},
                nombre: "{{ alumno.nombreDisplay|e('js') }}",
                username: "{{ alumno.username|e('js') }}",
                activo: {{ alumno.isActivo ? 'true' : 'false' }},
                url: "{{ path('app_examen_profesor', {'usuario': alumno.id})|e('js') }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Inicializar select buscable de alumnos
        function initAlumnoSearch() {
            const searchInput = document.getElementById('alumno-search');
            const resultsContainer = document.getElementById('alumno-results');
            const selectedInfo = document.getElementById('alumno-selected-info');
            const selectedName = document.getElementById('alumno-selected-name');
            const selectedBadge = document.getElementById('alumno-selected-badge');
            const selectedLink = document.getElementById('alumno-selected-link');
            
            if (!searchInput) return;
            
            let selectedAlumno = null;
            
            // Funci√≥n para filtrar alumnos
            function filterAlumnos(query) {
                if (!query || query.trim() === '') {
                    return [];
                }
                
                const lowerQuery = query.toLowerCase().trim();
                return alumnosData.filter(alumno => {
                    const nombreMatch = alumno.nombre.toLowerCase().includes(lowerQuery);
                    const usernameMatch = alumno.username.toLowerCase().includes(lowerQuery);
                    return nombreMatch || usernameMatch;
                });
            }
            
            // Funci√≥n para mostrar resultados
            function showResults(filtered) {
                if (filtered.length === 0) {
                    resultsContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666;">No se encontraron alumnos</div>';
                    resultsContainer.style.display = 'block';
                    return;
                }
                
                let html = '<div style="display: flex; flex-direction: column;">';
                filtered.forEach(alumno => {
                    html += `
                        <div 
                            class="alumno-result-item" 
                            data-id="${alumno.id}"
                            style="padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s;"
                            onmouseover="this.style.backgroundColor='#e3f2fd'"
                            onmouseout="this.style.backgroundColor='white'"
                            onclick="event.stopPropagation(); selectAlumno(${alumno.id});"
                        >
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: var(--color-primary); font-size: 0.95rem;">${alumno.nombre}</strong>
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">${alumno.username}</div>
                                </div>
                                ${!alumno.activo ? '<span class="badge badge-danger" style="background-color: var(--color-danger); font-size: 0.65rem; padding: 0.15rem 0.4rem;">Inactivo</span>' : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                resultsContainer.innerHTML = html;
                resultsContainer.style.display = 'block';
            }
            
            // Funci√≥n para seleccionar un alumno
            window.selectAlumno = function(id) {
                const alumno = alumnosData.find(a => a.id === id);
                if (!alumno) return;
                
                selectedAlumno = alumno;
                searchInput.value = alumno.nombre;
                resultsContainer.style.display = 'none';
                
                // Mostrar informaci√≥n del alumno seleccionado
                selectedName.textContent = alumno.nombre;
                selectedLink.href = alumno.url;
                
                if (!alumno.activo) {
                    selectedBadge.innerHTML = '<span class="badge badge-danger" style="background-color: var(--color-danger); font-size: 0.7rem; padding: 0.2rem 0.5rem;">Inactivo</span>';
                } else {
                    selectedBadge.innerHTML = '';
                }
                
                selectedInfo.style.display = 'block';
            };
            
            // Event listener para el input de b√∫squeda
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value;
                
                if (query.trim() === '') {
                    resultsContainer.style.display = 'none';
                    selectedInfo.style.display = 'none';
                    selectedAlumno = null;
                    return;
                }
                
                const filtered = filterAlumnos(query);
                showResults(filtered);
            });
            
            // Cerrar resultados al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target) && !selectedInfo.contains(e.target)) {
                    // Solo cerrar si no estamos haciendo clic en un resultado
                    if (!e.target.closest('.alumno-result-item')) {
                        resultsContainer.style.display = 'none';
                    }
                }
            });
            
            // Manejar teclas especiales
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    resultsContainer.style.display = 'none';
                    searchInput.blur();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    const firstResult = resultsContainer.querySelector('.alumno-result-item');
                    if (firstResult) {
                        const id = parseInt(firstResult.getAttribute('data-id'));
                        selectAlumno(id);
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    const items = resultsContainer.querySelectorAll('.alumno-result-item');
                    if (items.length > 0) {
                        const currentFocus = resultsContainer.querySelector('.alumno-result-item:focus');
                        if (currentFocus) {
                            const index = Array.from(items).indexOf(currentFocus);
                            if (index < items.length - 1) {
                                items[index + 1].focus();
                            }
                        } else {
                            items[0].focus();
                        }
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    const items = resultsContainer.querySelectorAll('.alumno-result-item');
                    if (items.length > 0) {
                        const currentFocus = resultsContainer.querySelector('.alumno-result-item:focus');
                        if (currentFocus) {
                            const index = Array.from(items).indexOf(currentFocus);
                            if (index > 0) {
                                items[index - 1].focus();
                            }
                        }
                    }
                }
            });
        }
        
        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', initAlumnoSearch);
        document.addEventListener('turbo:load', initAlumnoSearch);
    </script>
    {% endif %}
{% endblock %}

{% block body %}
{% if isProfesor %}
    {# Dashboard Profesor #}
    <h1 style="margin-bottom: 2rem; color: var(--color-primary);">Panel de Profesor</h1>

    {# Informaci√≥n de Alumnos Asignados #}
    {% if esAdmin %}
        <div class="card" style="margin-bottom: 2rem; border-left: 4px solid #dc3545; background-color: #ffe6e6;">
            <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0; color: #dc3545; font-size: 1.1rem;">üëë Administrador</h3>
                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">Tienes acceso a todos los alumnos del sistema.</p>
                    </div>
                    <a href="{{ path('app_user_index') }}" class="btn btn-primary">Gestionar Usuarios</a>
                </div>
            </div>
        </div>
    {% else %}
        <div class="card" style="margin-bottom: 2rem; border-left: 4px solid var(--color-primary); background-color: #e3f2fd;">
            <div class="card-header" style="background-color: var(--color-primary); color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: white; font-size: 1.2rem;">üë• Mis Alumnos Asignados</h2>
                    {% if is_granted('ROLE_ADMIN') %}
                        <a href="{{ path('app_user_index') }}" class="btn btn-sm" style="background-color: white; color: var(--color-primary); border: none;">Gestionar Asignaciones</a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if misAlumnos|length > 0 %}
                    <div style="margin-bottom: 1rem;">
                        <label for="alumno-search" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Buscar Alumno:</label>
                        <div style="position: relative;">
                            <input 
                                type="text" 
                                id="alumno-search" 
                                class="form-control" 
                                placeholder="Escribe para buscar un alumno..." 
                                autocomplete="off"
                                style="padding: 0.75rem 1rem; font-size: 0.95rem; border: 2px solid #ddd; border-radius: 6px; width: 100%; transition: all 0.3s ease;"
                                onfocus="this.style.borderColor='var(--color-primary)'; this.style.boxShadow='0 0 0 3px rgba(0, 113, 181, 0.1)';"
                                onblur="this.style.borderColor='#ddd'; this.style.boxShadow='none';"
                            >
                            <div id="alumno-results" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid var(--color-primary); border-top: none; border-radius: 0 0 6px 6px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: -2px;"></div>
                        </div>
                    </div>
                    <div id="alumno-selected-info" style="display: none; margin-bottom: 1rem; padding: 1rem; background-color: #e3f2fd; border-left: 4px solid var(--color-primary); border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <strong id="alumno-selected-name" style="color: var(--color-primary); font-size: 1rem;"></strong>
                                <span id="alumno-selected-badge" style="margin-left: 0.5rem;"></span>
                            </div>
                            <a id="alumno-selected-link" href="#" class="btn btn-primary btn-sm" style="font-size: 0.9rem; padding: 0.5rem 1rem;">Ver Ex√°menes</a>
                        </div>
                    </div>
                    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #ddd;">
                        <p style="margin: 0; color: #666; font-size: 0.85rem;">
                            <strong>Total:</strong> {{ misAlumnos|length }} alumno(s) asignado(s).
                            {% if is_granted('ROLE_ADMIN') %}
                                <a href="{{ path('app_user_index') }}" style="margin-left: 1rem; color: var(--color-primary);">Gestionar asignaciones</a>
                            {% endif %}
                        </p>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: #666; margin-bottom: 1rem;">No tienes alumnos asignados actualmente.</p>
                        {% if is_granted('ROLE_ADMIN') %}
                            <a href="{{ path('app_user_index') }}" class="btn btn-primary">Asignar Alumnos</a>
                        {% else %}
                            <p style="color: #999; font-size: 0.85rem;">Contacta con el administrador para que te asigne alumnos.</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}

    {# Estad√≠sticas Generales #}
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="card" style="border-left: 4px solid #2196F3; background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: #2196F3; margin-bottom: 0.5rem;">üë•</div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--color-primary); margin-bottom: 0.25rem;">{{ totalAlumnos }}</div>
                <div style="font-size: 0.9rem; color: #666;">Alumnos Activos</div>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid #4CAF50; background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%);">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: #4CAF50; margin-bottom: 0.5rem;">üìù</div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--color-success); margin-bottom: 0.25rem;">{{ totalExamenes }}</div>
                <div style="font-size: 0.9rem; color: #666;">Total Ex√°menes</div>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid #FF9800; background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%);">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: #FF9800; margin-bottom: 0.5rem;">‚≠ê</div>
                <div style="font-size: 2rem; font-weight: bold; color: #FF9800; margin-bottom: 0.25rem;">{{ promedioGeneral|default(0)|number_format(2, ',', '.') }}</div>
                <div style="font-size: 0.9rem; color: #666;">Promedio General</div>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid #9C27B0; background: linear-gradient(135deg, #f3e5f5 0%, #ffffff 100%);">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: #9C27B0; margin-bottom: 0.5rem;">üìÖ</div>
                <div style="font-size: 2rem; font-weight: bold; color: #9C27B0; margin-bottom: 0.25rem;">{{ examenesHoy|default(0) }}</div>
                <div style="font-size: 0.9rem; color: #666;">Ex√°menes Hoy</div>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid #00BCD4; background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%);">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: #00BCD4; margin-bottom: 0.5rem;">üìä</div>
                <div style="font-size: 2rem; font-weight: bold; color: #00BCD4; margin-bottom: 0.25rem;">{{ examenesSemana|default(0) }}</div>
                <div style="font-size: 0.9rem; color: #666;">Esta Semana</div>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        {# Actividad Reciente #}
        <div class="card">
            <div class="card-header" style="background-color: var(--color-primary); color: white;">
                <h2 style="margin: 0; color: white; font-size: 1.2rem;">üìã √öltimos Ex√°menes Realizados</h2>
            </div>
            <div class="card-body">
                {% if ultimosExamenes|length > 0 %}
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="table" style="font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th>Alumno</th>
                                    <th>Fecha</th>
                                    <th>Dificultad</th>
                                    <th>Nota</th>
                                    <th>Tipo</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for examen in ultimosExamenes %}
                                    <tr>
                                        <td><strong>{{ examen.usuario.nombreDisplay }}</strong></td>
                                        <td>{{ examen.fecha|date('d/m/Y H:i') }}</td>
                                        <td>
                                            <span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span>
                                        </td>
                                        <td><strong style="color: var(--color-primary); font-size: 1.1rem;">{{ examen.nota|number_format(2, ',', '.') }}</strong></td>
                                        <td>
                                            {% if examen.municipio %}
                                                <span class="badge" style="background-color: #2196F3;">{{ examen.municipio.nombre }}</span>
                                            {% else %}
                                                <span class="badge badge-facil">General</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ path('app_examen_detalle', {'id': examen.id}) }}" class="btn btn-sm btn-secondary">Ver</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 1rem;">
                        <a href="{{ path('app_examen_profesor') }}" class="btn btn-primary">Ver Todos los Ex√°menes</a>
                    </div>
                {% else %}
                    <p style="text-align: center; color: #666; padding: 2rem;">No hay ex√°menes realizados a√∫n.</p>
                {% endif %}
            </div>
        </div>

        {# Alumnos M√°s Activos #}
        <div class="card">
            <div class="card-header" style="background-color: var(--color-success); color: white;">
                <h2 style="margin: 0; color: white; font-size: 1.2rem;">üèÜ Alumnos M√°s Activos</h2>
            </div>
            <div class="card-body">
                {% if alumnosActivos|length > 0 %}
                    <div style="max-height: 400px; overflow-y: auto;">
                        {% for alumno in alumnosActivos %}
                            <div style="padding: 1rem; margin-bottom: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <strong style="color: var(--color-primary);">{{ alumno['username'] }}</strong>
                                    <span class="badge" style="background-color: var(--color-primary);">{{ alumno['totalExamenes'] }} ex√°menes</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #666;">
                                    Promedio: <strong style="color: var(--color-success);">{{ alumno['promedio']|number_format(2, ',', '.') }}</strong>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p style="text-align: center; color: #666; padding: 2rem;">No hay datos disponibles.</p>
                {% endif %}
            </div>
        </div>
    </div>

    {# Estad√≠sticas de Contenido #}
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header" style="background-color: var(--color-secondary); color: white;">
            <h2 style="margin: 0; color: white; font-size: 1.2rem;">üìö Estad√≠sticas de Contenido</h2>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                <div style="text-align: center; padding: 1rem; background-color: #e3f2fd; border-radius: 4px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìñ</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: var(--color-primary);">{{ totalTemas }}</div>
                    <div style="font-size: 0.85rem; color: #666;">Temas Generales</div>
                </div>

                <div style="text-align: center; padding: 1rem; background-color: #fff3e0; border-radius: 4px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ùì</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #FF9800;">{{ totalPreguntas }}</div>
                    <div style="font-size: 0.85rem; color: #666;">Total Preguntas</div>
                </div>

                <div style="text-align: center; padding: 1rem; background-color: #e8f5e9; border-radius: 4px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìÑ</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: var(--color-success);">{{ totalArticulos }}</div>
                    <div style="font-size: 0.85rem; color: #666;">Art√≠culos</div>
                </div>

                <div style="text-align: center; padding: 1rem; background-color: #e1f5fe; border-radius: 4px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üèõÔ∏è</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #2196F3;">{{ totalMunicipios }}</div>
                    <div style="font-size: 0.85rem; color: #666;">Municipios Activos</div>
                </div>

                <div style="text-align: center; padding: 1rem; background-color: #f3e5f5; border-radius: 4px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìë</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #9C27B0;">{{ totalTemasMunicipales }}</div>
                    <div style="font-size: 0.85rem; color: #666;">Temas Municipales</div>
                </div>

                <div style="text-align: center; padding: 1rem; background-color: #fff9c4; border-radius: 4px;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìÖ</div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #F57F17;">{{ totalConvocatorias }}</div>
                    <div style="font-size: 0.85rem; color: #666;">Convocatorias</div>
                </div>
            </div>
        </div>
    </div>

    {# Accesos R√°pidos #}
    <div class="card">
        <div class="card-header">
            <h2 style="margin: 0; font-size: 1.2rem;">‚ö° Accesos R√°pidos</h2>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <a href="{{ path('app_tema_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üìö</span>
                    <span>Temas</span>
                </a>

                <a href="{{ path('app_pregunta_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">‚ùì</span>
                    <span>Preguntas</span>
                </a>

                <a href="{{ path('app_articulo_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üìÑ</span>
                    <span>Art√≠culos</span>
                </a>

                <a href="{{ path('app_user_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üë•</span>
                    <span>Usuarios</span>
                </a>

                <a href="{{ path('app_examen_profesor') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üìù</span>
                    <span>Ex√°menes</span>
                </a>

                <a href="{{ path('app_convocatoria_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üìÖ</span>
                    <span>Convocatorias</span>
                </a>

                <a href="{{ path('app_municipio_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üèõÔ∏è</span>
                    <span>Municipios</span>
                </a>

                <a href="{{ path('app_planificacion_semanal_index') }}" class="btn btn-primary" style="padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">üìã</span>
                    <span>Planificaciones</span>
                </a>
            </div>
        </div>
    </div>
{% else %}
    {# Dashboard Usuario Normal #}
    
    {# Informaci√≥n del Profesor Asignado y Grupo #}
    {% if app.user.profesores|length > 0 or app.user.grupos|length > 0 %}
        <div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid var(--color-primary); background-color: #e3f2fd;">
            <div class="card-body">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        {% if app.user.profesores|length > 0 %}
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="font-size: 1.2rem;">üë®‚Äçüè´</div>
                                <div>
                                    <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">Profesor</div>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        {% for profesor in app.user.profesores %}
                                            <span class="badge" style="background-color: var(--color-primary); color: white; padding: 0.25rem 0.75rem; font-size: 0.8rem;">
                                                {{ profesor.nombreDisplay }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        {% if app.user.grupos|length > 0 %}
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="font-size: 1.2rem;">üë•</div>
                                <div>
                                    <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">Grupo</div>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        {% for grupo in app.user.grupos %}
                                            <span class="badge" style="background-color: #28a745; color: white; padding: 0.25rem 0.75rem; font-size: 0.8rem;">
                                                {{ grupo.nombre }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    {% if app.user.profesores|length > 0 %}
                        <a href="{{ path('app_mensaje_alumno_index') }}" 
                           class="btn btn-primary" 
                           style="background-color: var(--color-primary); color: white; padding: 0.5rem 1.5rem; border-radius: 4px; text-decoration: none; border: none; cursor: pointer; font-size: 0.9rem; white-space: nowrap;">
                            üí¨ Enviar Mensaje
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% else %}
        <div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid #ff9800; background-color: #fff3e0;">
            <div class="card-body">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="font-size: 2rem;">‚ö†Ô∏è</div>
                    <div>
                        <h3 style="margin: 0; color: #ff9800; font-size: 1.1rem;">Sin Profesor Asignado</h3>
                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">Contacta con el administrador para que te asigne un profesor.</p>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    {# Secci√≥n de Convocatorias #}
    {% if convocatorias|length > 0 %}
        <div class="card" style="margin-bottom: 1.5rem; border: 2px solid var(--color-primary); background-color: #f0f7ff;">
            <div class="card-header" style="background-color: var(--color-primary); color: white; cursor: pointer;" data-section="convocatorias" onclick="toggleSection('convocatorias')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: white;">üìÖ Mis Convocatorias</h2>
                    <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
                </div>
            </div>
            <div class="card-body" id="convocatorias">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    {% for convocatoria in convocatorias %}
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; background-color: white; border-left: 4px solid #2196F3;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 style="color: var(--color-primary); margin: 0; font-size: 1.1rem;">
                                    {{ convocatoria.nombre }}
                                    {% for municipio in convocatoria.municipios %}
                                        <span class="badge" style="background-color: #2196F3; margin-left: 0.5rem; font-size: 0.8rem;">{{ municipio.nombre }}</span>
                                    {% endfor %}
                                </h3>
                                {% if convocatoria.isActivo %}
                                    <span class="badge" style="background-color: #28a745; color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem;">Activa</span>
                                {% endif %}
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                                <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Te√≥rico</div>
                                    {% if convocatoria.fechaTeorico %}
                                        {% set diasTeorico = (convocatoria.fechaTeorico|date('U') - 'now'|date('U')) / 86400 %}
                                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">{{ convocatoria.fechaTeorico|date('d/m/Y') }}</div>
                                        <div style="font-size: 1.3rem; font-weight: bold; color: {% if diasTeorico < 0 %}#dc3545{% elseif diasTeorico <= 30 %}#ff9800{% else %}#28a745{% endif %};">
                                            {% if diasTeorico < 0 %}
                                                {{ (diasTeorico * -1)|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% else %}
                                                {{ diasTeorico|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div style="font-size: 0.9rem; color: #999; margin-bottom: 0.5rem; font-style: italic;">Pendiente</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: #999;">
                                            ‚Äî<br><small style="font-size: 0.7rem;">por definir</small>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">F√≠sicas</div>
                                    {% if convocatoria.fechaFisicas %}
                                        {% set diasFisicas = (convocatoria.fechaFisicas|date('U') - 'now'|date('U')) / 86400 %}
                                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">{{ convocatoria.fechaFisicas|date('d/m/Y') }}</div>
                                        <div style="font-size: 1.3rem; font-weight: bold; color: {% if diasFisicas < 0 %}#dc3545{% elseif diasFisicas <= 30 %}#ff9800{% else %}#28a745{% endif %};">
                                            {% if diasFisicas < 0 %}
                                                {{ (diasFisicas * -1)|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% else %}
                                                {{ diasFisicas|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div style="font-size: 0.9rem; color: #999; margin-bottom: 0.5rem; font-style: italic;">Pendiente</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: #999;">
                                            ‚Äî<br><small style="font-size: 0.7rem;">por definir</small>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Psicot√©cnico</div>
                                    {% if convocatoria.fechaPsicotecnico %}
                                        {% set diasPsicotecnico = (convocatoria.fechaPsicotecnico|date('U') - 'now'|date('U')) / 86400 %}
                                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">{{ convocatoria.fechaPsicotecnico|date('d/m/Y') }}</div>
                                        <div style="font-size: 1.3rem; font-weight: bold; color: {% if diasPsicotecnico < 0 %}#dc3545{% elseif diasPsicotecnico <= 30 %}#ff9800{% else %}#28a745{% endif %};">
                                            {% if diasPsicotecnico < 0 %}
                                                {{ (diasPsicotecnico * -1)|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% else %}
                                                {{ diasPsicotecnico|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div style="font-size: 0.9rem; color: #999; margin-bottom: 0.5rem; font-style: italic;">Pendiente</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: #999;">
                                            ‚Äî<br><small style="font-size: 0.7rem;">por definir</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% else %}
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid #ddd; background-color: #f8f9fa;">
            <div class="card-body" style="text-align: center; padding: 2rem;">
                <p style="color: #666; margin: 0;">No tienes convocatorias asignadas. Contacta con tu profesor para m√°s informaci√≥n.</p>
            </div>
        </div>
    {% endif %}

    {# Secci√≥n peque√±a de ranking general #}
    {% if posicionesUsuario %}
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header" style="cursor: pointer;" data-section="ranking-general" onclick="toggleSection('ranking-general')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <h3 style="margin: 0;">üèÜ Mi Ranking (Temario General)</h3>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="cantidad-ranking-select" style="margin-right: 0.5rem; font-size: 0.9rem;">√öltimos:</label>
                            <select id="cantidad-ranking-select" class="form-control" style="display: inline-block; width: auto; font-size: 0.9rem;" onchange="window.location.href='{{ path('app_dashboard') }}?cantidad=' + this.value" onclick="event.stopPropagation();">
                                <option value="2" {% if cantidadRanking == 2 %}selected{% endif %}>2 ex√°menes</option>
                                <option value="3" {% if cantidadRanking == 3 %}selected{% endif %}>3 ex√°menes</option>
                                <option value="4" {% if cantidadRanking == 4 %}selected{% endif %}>4 ex√°menes</option>
                                <option value="5" {% if cantidadRanking == 5 %}selected{% endif %}>5 ex√°menes</option>
                                <option value="10" {% if cantidadRanking == 10 %}selected{% endif %}>10 ex√°menes</option>
                            </select>
                            <span class="toggle-icon" style="font-size: 1.2rem; user-select: none; margin-left: 0.5rem;">‚ñ∂</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body" id="ranking-general" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    {% for dificultad, datos in posicionesUsuario %}
                        {% if datos.posicion %}
                            <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                <div style="font-weight: bold; color: var(--color-primary); margin-bottom: 0.25rem;">
                                    {% if dificultad == 'facil' %}F√°cil
                                    {% elseif dificultad == 'moderada' %}Moderada
                                    {% else %}Dif√≠cil
                                    {% endif %}
                                </div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--color-success);">
                                    Posici√≥n {{ datos.posicion }}/{{ datos.totalUsuarios }}
                                </div>
                                {% if datos.notaMedia %}
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                        Media: {{ datos.notaMedia|number_format(2, ',', '.') }}
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                <div style="font-weight: bold; color: var(--color-primary); margin-bottom: 0.25rem;">
                                    {% if dificultad == 'facil' %}F√°cil
                                    {% elseif dificultad == 'moderada' %}Moderada
                                    {% else %}Dif√≠cil
                                    {% endif %}
                                </div>
                                <div style="font-size: 0.9rem; color: #999;">
                                    Sin ex√°menes
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}

    {# Rankings por convocatoria #}
    {% if rankingsPorConvocatoria|length > 0 %}
        <div id="rankings-convocatorias-container">
            {% for convocatoriaId, datosConvocatoria in rankingsPorConvocatoria %}
                <div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid #9C27B0;">
                    <div class="card-header" style="background-color: #f3e5f5; cursor: pointer;" data-section="ranking-convocatoria-{{ convocatoriaId }}" onclick="toggleSection('ranking-convocatoria-{{ convocatoriaId }}')">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <h3 style="margin: 0;">üèÜ Ranking - {{ datosConvocatoria.convocatoria.nombre }}</h3>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="cantidad-ranking-convocatoria-{{ convocatoriaId }}-select" style="margin-right: 0.5rem; font-size: 0.9rem;">√öltimos:</label>
                                <select id="cantidad-ranking-convocatoria-{{ convocatoriaId }}-select" class="form-control" style="display: inline-block; width: auto; font-size: 0.9rem;" onchange="window.location.href='{{ path('app_dashboard') }}?cantidad=' + this.value" onclick="event.stopPropagation();">
                                    <option value="2" {% if cantidadRanking == 2 %}selected{% endif %}>2 ex√°menes</option>
                                    <option value="3" {% if cantidadRanking == 3 %}selected{% endif %}>3 ex√°menes</option>
                                    <option value="4" {% if cantidadRanking == 4 %}selected{% endif %}>4 ex√°menes</option>
                                    <option value="5" {% if cantidadRanking == 5 %}selected{% endif %}>5 ex√°menes</option>
                                    <option value="10" {% if cantidadRanking == 10 %}selected{% endif %}>10 ex√°menes</option>
                                </select>
                                <span class="toggle-icon" style="font-size: 1.2rem; user-select: none; margin-left: 0.5rem;">‚ñ∂</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="ranking-convocatoria-{{ convocatoriaId }}" style="display: none;">
                        {# Ranking general de la convocatoria #}
                        <h4 style="margin-bottom: 1rem; color: #9C27B0; font-size: 1rem;">Ranking General de la Convocatoria</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            {% for dificultad, datos in datosConvocatoria.posiciones %}
                                {% if datos.posicion %}
                                    <div style="text-align: center; padding: 0.75rem; background-color: #f3e5f5; border-radius: 4px;">
                                        <div style="font-weight: bold; color: #9C27B0; margin-bottom: 0.25rem;">
                                            {% if dificultad == 'facil' %}F√°cil
                                            {% elseif dificultad == 'moderada' %}Moderada
                                            {% else %}Dif√≠cil
                                            {% endif %}
                                        </div>
                                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--color-success);">
                                            Posici√≥n {{ datos.posicion }}/{{ datos.totalUsuarios }}
                                        </div>
                                        {% if datos.notaMedia %}
                                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                                Media: {{ datos.notaMedia|number_format(2, ',', '.') }}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div style="text-align: center; padding: 0.75rem; background-color: #f3e5f5; border-radius: 4px;">
                                        <div style="font-weight: bold; color: #9C27B0; margin-bottom: 0.25rem;">
                                            {% if dificultad == 'facil' %}F√°cil
                                            {% elseif dificultad == 'moderada' %}Moderada
                                            {% else %}Dif√≠cil
                                            {% endif %}
                                        </div>
                                        <div style="font-size: 0.9rem; color: #999;">
                                            Sin ex√°menes
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        
                        {# Rankings por municipio dentro de la convocatoria (solo si tiene m√°s de un municipio) #}
                        {% if datosConvocatoria.rankingsPorMunicipio|length > 0 %}
                            <hr style="margin: 1.5rem 0; border: 1px solid #ddd;">
                            <h4 style="margin-bottom: 1rem; color: #9C27B0; font-size: 1rem;">Rankings por Municipio</h4>
                            {% for municipioId, datosMunicipio in datosConvocatoria.rankingsPorMunicipio %}
                                <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f8f9fa; border-radius: 4px; border-left: 3px solid #2196F3;">
                                    <div class="card-header" style="background-color: #e3f2fd; cursor: pointer; margin-bottom: 1rem;" data-section="ranking-municipio-{{ convocatoriaId }}-{{ municipioId }}" onclick="toggleSection('ranking-municipio-{{ convocatoriaId }}-{{ municipioId }}')">
                                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                            <h5 style="margin: 0; color: #1976D2;">üìç {{ datosMunicipio.municipio.nombre }}</h5>
                                            <span class="toggle-icon" style="font-size: 1rem; user-select: none;">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div class="card-body" id="ranking-municipio-{{ convocatoriaId }}-{{ municipioId }}" style="display: none;">
                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                            {% for dificultad, datos in datosMunicipio.posiciones %}
                                                {% if datos.posicion %}
                                                    <div style="text-align: center; padding: 0.75rem; background-color: #e3f2fd; border-radius: 4px;">
                                                        <div style="font-weight: bold; color: #1976D2; margin-bottom: 0.25rem;">
                                                            {% if dificultad == 'facil' %}F√°cil
                                                            {% elseif dificultad == 'moderada' %}Moderada
                                                            {% else %}Dif√≠cil
                                                            {% endif %}
                                                        </div>
                                                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--color-success);">
                                                            Posici√≥n {{ datos.posicion }}/{{ datos.totalUsuarios }}
                                                        </div>
                                                        {% if datos.notaMedia %}
                                                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                                                Media: {{ datos.notaMedia|number_format(2, ',', '.') }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    <div style="text-align: center; padding: 0.75rem; background-color: #e3f2fd; border-radius: 4px;">
                                                        <div style="font-weight: bold; color: #1976D2; margin-bottom: 0.25rem;">
                                                            {% if dificultad == 'facil' %}F√°cil
                                                            {% elseif dificultad == 'moderada' %}Moderada
                                                            {% else %}Dif√≠cil
                                                            {% endif %}
                                                        </div>
                                                        <div style="font-size: 0.9rem; color: #999;">
                                                            Sin ex√°menes
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="dashboard-grid-2cols" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card">
            <div class="card-header" style="cursor: pointer; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-bottom: 2px solid #2196F3;" data-section="mi-planificacion" onclick="toggleSection('mi-planificacion')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: #1565C0;">üìÖ Mi Planificaci√≥n</h2>
                    <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
                </div>
            </div>
            <div class="card-body" id="mi-planificacion" style="background-color: #f8f9fa;">
                {% if franjasHoy|length > 0 or franjasManana|length > 0 %}
                    {# Actividades de Hoy #}
                    {% if franjasHoy|length > 0 %}
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-left: 4px solid #ff9800; border-radius: 4px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.5rem;">üìÜ</span>
                                <h3 style="margin: 0; color: #e65100; font-size: 1.1rem; font-weight: 600;">Hoy ({{ hoy|date('d/m/Y') }})</h3>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                {% for franja in franjasHoy %}
                                    <div style="padding: 0.75rem; background-color: white; border-radius: 4px; border-left: 3px solid {% if franja.tipoActividad == 'repaso_basico' %}#2196F3{% elseif franja.tipoActividad == 'realizar_examenes' %}#FF9800{% else %}#4CAF50{% endif %};">
                                        <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                            <div style="font-weight: 600; color: #333; min-width: 100px;">
                                                üïê {{ franja.horaInicio|date('H:i') }} - {{ franja.horaFin|date('H:i') }}
                                            </div>
                                            <span class="badge" style="background-color: {% if franja.tipoActividad == 'repaso_basico' %}#2196F3{% elseif franja.tipoActividad == 'realizar_examenes' %}#FF9800{% else %}#4CAF50{% endif %}; color: white; font-size: 0.8rem;">
                                                {% if franja.tipoActividad == 'repaso_basico' %}üìö Repaso{% elseif franja.tipoActividad == 'realizar_examenes' %}üìù Realizar Ex√°menes{% else %}üìñ Estudio{% endif %}
                                            </span>
                                            {% if franja.descripcionRepaso %}
                                                <span style="color: #666; font-size: 0.9rem; flex: 1; min-width: 200px;">{{ franja.descripcionRepaso }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f5f5f5; border-left: 4px solid #9e9e9e; border-radius: 4px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">üìÜ</span>
                                <h3 style="margin: 0; color: #616161; font-size: 1.1rem; font-weight: 600;">Hoy ({{ hoy|date('d/m/Y') }})</h3>
                            </div>
                            <p style="margin: 0; color: #757575; font-size: 0.9rem;">No tienes actividades programadas para hoy. ¬°Disfruta del descanso! üéâ</p>
                        </div>
                    {% endif %}

                    {# Actividades de Ma√±ana #}
                    {% if franjasManana|length > 0 %}
                        <div style="padding: 1rem; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 4px solid #4CAF50; border-radius: 4px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.5rem;">üîú</span>
                                <h3 style="margin: 0; color: #2E7D32; font-size: 1.1rem; font-weight: 600;">Ma√±ana ({{ manana|date('d/m/Y') }})</h3>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                {% for franja in franjasManana %}
                                    <div style="padding: 0.75rem; background-color: white; border-radius: 4px; border-left: 3px solid {% if franja.tipoActividad == 'repaso_basico' %}#2196F3{% elseif franja.tipoActividad == 'realizar_examenes' %}#FF9800{% else %}#4CAF50{% endif %};">
                                        <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                            <div style="font-weight: 600; color: #333; min-width: 100px;">
                                                üïê {{ franja.horaInicio|date('H:i') }} - {{ franja.horaFin|date('H:i') }}
                                            </div>
                                            <span class="badge" style="background-color: {% if franja.tipoActividad == 'repaso_basico' %}#2196F3{% elseif franja.tipoActividad == 'realizar_examenes' %}#FF9800{% else %}#4CAF50{% endif %}; color: white; font-size: 0.8rem;">
                                                {% if franja.tipoActividad == 'repaso_basico' %}üìö Repaso{% elseif franja.tipoActividad == 'realizar_examenes' %}üìù Realizar Ex√°menes{% else %}üìñ Estudio{% endif %}
                                            </span>
                                            {% if franja.descripcionRepaso %}
                                                <span style="color: #666; font-size: 0.9rem; flex: 1; min-width: 200px;">{{ franja.descripcionRepaso }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div style="padding: 1rem; background-color: #f5f5f5; border-left: 4px solid #9e9e9e; border-radius: 4px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">üîú</span>
                                <h3 style="margin: 0; color: #616161; font-size: 1.1rem; font-weight: 600;">Ma√±ana ({{ manana|date('d/m/Y') }})</h3>
                            </div>
                            <p style="margin: 0; color: #757575; font-size: 0.9rem;">No tienes actividades programadas para ma√±ana.</p>
                        </div>
                    {% endif %}
                    
                    <div style="text-align: center; margin-top: 1rem;">
                        <a href="{{ path('app_planificacion_alumno_index') }}" class="btn btn-primary btn-sm">Ver Planificaci√≥n Completa</a>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÖ</div>
                        <h3 style="color: #666; margin-bottom: 0.5rem;">No tienes actividades programadas</h3>
                        <p style="color: #999; font-size: 0.9rem; margin-bottom: 1rem;">No hay actividades en tu planificaci√≥n para hoy ni para ma√±ana.</p>
                        <a href="{{ path('app_planificacion_alumno_index') }}" class="btn btn-primary">Ver Mi Planificaci√≥n</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="cursor: pointer;" data-section="mis-tareas" onclick="toggleSection('mis-tareas')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0;">üìã Mis Tareas</h2>
                    <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
                </div>
            </div>
            <div class="card-body" id="mis-tareas">
                {% if planificacion %}
                    <div style="margin-bottom: 1rem;">
                        <a href="{{ path('app_planificacion_alumno_index') }}" class="btn btn-primary" style="width: 100%;">Ver Mi Planificaci√≥n</a>
                    </div>
                    
                    {% if resumenTareas.total > 0 %}
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 0.5rem; background-color: #e8f5e9; border-radius: 4px;">
                                <strong style="color: var(--color-success); font-size: 1.2rem;">{{ resumenTareas.completadas }}</strong>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">Completadas</p>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background-color: #fff3cd; border-radius: 4px;">
                                <strong style="color: var(--color-warning); font-size: 1.2rem;">{{ resumenTareas.pendientes }}</strong>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">Pendientes</p>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <p style="text-align: center; color: #666; margin: 1rem 0;">No tienes planificaci√≥n asignada.</p>
                {% endif %}

                <h4 style="margin-top: 1rem; margin-bottom: 0.75rem; font-size: 1rem;">Tareas Pendientes</h4>
                {% if tareasPendientes|length > 0 %}
                    <div style="max-height: 250px; overflow-y: auto;">
                        {% for tareaAsignada in tareasPendientes %}
                            <div style="padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #ddd; border-radius: 4px; background-color: {% if tareaAsignada.franjaHoraria %}#f0f0f0{% else %}#fff{% endif %};">
                                <div style="font-weight: bold; font-size: 0.9rem;">{{ tareaAsignada.tarea.nombre }}</div>
                                <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
                                    Semana: {{ tareaAsignada.tarea.semanaAsignacion|date('d/m/Y') }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div style="text-align: center; margin-top: 0.5rem;">
                        <a href="{{ path('app_planificacion_alumno_index') }}" class="btn btn-sm btn-secondary">Ver Todas</a>
                    </div>
                {% else %}
                    <p style="text-align: center; color: #666; margin: 1rem 0;">¬°No tienes tareas pendientes! üéâ</p>
                {% endif %}
            </div>
        </div>
    </div>

    {# Secci√≥n completa de ex√°menes #}
    <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header" style="cursor: pointer;" data-section="historial-examenes" onclick="toggleSection('historial-examenes')">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="margin: 0;">Historial de Ex√°menes</h1>
                <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
            </div>
        </div>
        <div class="card-body" id="historial-examenes">
            {% if ultimosExamenes|length > 0 %}
                <div class="card">
                    <div class="table-responsive" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                        <table class="table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Dificultad</th>
                                <th>Preguntas</th>
                                <th>Nota</th>
                                <th>Aciertos</th>
                                <th>Errores</th>
                                <th>En blanco</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for examen in ultimosExamenes %}
                                <tr>
                                    <td>{{ examen.fecha|date('d/m/Y H:i') }}</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                                            {% if examen.municipio %}
                                                <span class="badge" style="background-color: #e3f2fd; color: #1976D2; border: 1px solid #90caf9; font-size: 0.75rem; padding: 0.25rem 0.5rem;">{{ examen.municipio.nombre }}</span>
                                            {% else %}
                                                <span class="badge" style="background-color: #f1f8e9; color: #558b2f; border: 1px solid #c5e1a5; font-size: 0.75rem; padding: 0.25rem 0.5rem;">General</span>
                                            {% endif %}
                                            {% if examen.examenSemanal %}
                                                <span style="font-size: 0.9rem; color: #9C27B0;" title="Examen Semanal: {{ examen.examenSemanal.nombre }}">üìÖ</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span>
                                    </td>
                                    <td>{{ examen.numeroPreguntas }}</td>
                                    <td><strong style="font-size: 1.2rem; color: var(--color-primary);">{{ examen.nota|number_format(2, ',', '.') }}</strong></td>
                                    <td style="color: var(--color-success);"><strong>{{ examen.aciertos }}</strong></td>
                                    <td style="color: var(--color-danger);"><strong>{{ examen.errores }}</strong></td>
                                    <td style="color: #999;"><strong>{{ examen.enBlanco }}</strong></td>
                                    <td>
                                        <a href="{{ path('app_examen_detalle', {'id': examen.id}) }}" class="btn btn-secondary btn-sm">Ver</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <a href="{{ path('app_examen_historial') }}" class="btn btn-secondary">Ver Historial Completo</a>
                </div>
            {% else %}
                <div class="card">
                    <div class="card-body text-center">
                        <p>No has realizado ning√∫n examen a√∫n.</p>
                        <a href="{{ path('app_examen_iniciar') }}" class="btn btn-primary">Realizar Primer Examen</a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endif %}
{% endblock %}

