{% extends 'base.html.twig' %}

{% block title %}Inicio - Sistema de Oposiciones - Polic√≠a Local Illes Balears{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Funci√≥n para plegar/desplegar secciones
            function toggleSection(sectionId) {
                const section = document.getElementById(sectionId);
                const icon = document.querySelector(`[data-section="${sectionId}"] .toggle-icon`);
                
                if (section) {
                    const isCollapsed = section.style.display === 'none';
                    section.style.display = isCollapsed ? 'block' : 'none';
                    
                    if (icon) {
                        icon.textContent = isCollapsed ? '‚ñº' : '‚ñ∂';
                    }
                    
                    // Guardar preferencia en localStorage
                    localStorage.setItem(`dashboard_section_${sectionId}`, isCollapsed ? 'expanded' : 'collapsed');
                }
            }
            
            // Restaurar estado de las secciones desde localStorage
            // Secciones principales
            const mainSections = ['convocatorias', 'ranking-general', 'mis-examenes', 'mis-tareas', 'historial-examenes'];
            mainSections.forEach(sectionId => {
                const savedState = localStorage.getItem(`dashboard_section_${sectionId}`);
                if (savedState === 'collapsed') {
                    const section = document.getElementById(sectionId);
                    const icon = document.querySelector(`[data-section="${sectionId}"] .toggle-icon`);
                    if (section) {
                        section.style.display = 'none';
                    }
                    if (icon) {
                        icon.textContent = '‚ñ∂';
                    }
                }
            });
            
            // Rankings por municipio (IDs din√°micos)
            const rankingMunicipioHeaders = document.querySelectorAll('[data-section^="ranking-municipio-"]');
            rankingMunicipioHeaders.forEach(header => {
                const sectionId = header.getAttribute('data-section');
                const savedState = localStorage.getItem(`dashboard_section_${sectionId}`);
                if (savedState === 'collapsed') {
                    const section = document.getElementById(sectionId);
                    const icon = header.querySelector('.toggle-icon');
                    if (section) {
                        section.style.display = 'none';
                    }
                    if (icon) {
                        icon.textContent = '‚ñ∂';
                    }
                }
            });
            
            // Hacer la funci√≥n global para que pueda ser llamada desde onclick
            window.toggleSection = toggleSection;
        });
    </script>
{% endblock %}

{% block body %}
{% if isProfesor %}
    {# Dashboard Profesor #}
    <div class="card">
        <div class="card-header">
            <h1>Panel de Profesor</h1>
        </div>
        <div class="card-body">
            <p style="font-size: 1.1rem; margin-bottom: 2rem; color: var(--color-text-light);">
                Sistema de gesti√≥n para opositores de Polic√≠a Local de las Illes Balears. Gestiona temas, leyes, art√≠culos y preguntas de examen.
            </p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                <div class="card">
                    <div class="card-body">
                        <h3 style="color: var(--color-primary); margin-bottom: 1rem;">üìö Temas</h3>
                        <p>Gestiona los temas de la oposici√≥n.</p>
                        <a href="{{ path('app_tema_index') }}" class="btn btn-primary" style="margin-top: 1rem;">Ver Temas</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h3 style="color: var(--color-primary); margin-bottom: 1rem;">‚öñÔ∏è Leyes</h3>
                        <p>Administra las leyes relacionadas con los temas.</p>
                        <a href="{{ path('app_ley_index') }}" class="btn btn-primary" style="margin-top: 1rem;">Ver Leyes</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h3 style="color: var(--color-primary); margin-bottom: 1rem;">üìÑ Art√≠culos</h3>
                        <p>Gestiona los art√≠culos de las leyes con sus explicaciones.</p>
                        <a href="{{ path('app_articulo_index') }}" class="btn btn-primary" style="margin-top: 1rem;">Ver Art√≠culos</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h3 style="color: var(--color-primary); margin-bottom: 1rem;">‚ùì Preguntas</h3>
                        <p>Crea y gestiona preguntas de examen con retroalimentaci√≥n.</p>
                        <a href="{{ path('app_pregunta_index') }}" class="btn btn-primary" style="margin-top: 1rem;">Ver Preguntas</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% else %}
    {# Dashboard Usuario Normal #}
    
    {# Secci√≥n de Convocatorias #}
    {% if convocatorias|length > 0 %}
        <div class="card" style="margin-bottom: 1.5rem; border: 2px solid var(--color-primary); background-color: #f0f7ff;">
            <div class="card-header" style="background-color: var(--color-primary); color: white; cursor: pointer;" data-section="convocatorias" onclick="toggleSection('convocatorias')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: white;">üìÖ Mis Convocatorias</h2>
                    <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
                </div>
            </div>
            <div class="card-body" id="convocatorias">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    {% for convocatoria in convocatorias %}
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; background-color: white; {% if convocatoria.municipio %}border-left: 4px solid #2196F3;{% endif %}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 style="color: var(--color-primary); margin: 0; font-size: 1.1rem;">
                                    {{ convocatoria.nombre }}
                                    {% if convocatoria.municipio %}
                                        <span class="badge" style="background-color: #2196F3; margin-left: 0.5rem; font-size: 0.8rem;">{{ convocatoria.municipio.nombre }}</span>
                                    {% endif %}
                                </h3>
                                {% if convocatoria.isActivo %}
                                    <span class="badge" style="background-color: #28a745; color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem;">Activa</span>
                                {% endif %}
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                                <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Te√≥rico</div>
                                    {% if convocatoria.fechaTeorico %}
                                        {% set diasTeorico = (convocatoria.fechaTeorico|date('U') - 'now'|date('U')) / 86400 %}
                                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">{{ convocatoria.fechaTeorico|date('d/m/Y') }}</div>
                                        <div style="font-size: 1.3rem; font-weight: bold; color: {% if diasTeorico < 0 %}#dc3545{% elseif diasTeorico <= 30 %}#ff9800{% else %}#28a745{% endif %};">
                                            {% if diasTeorico < 0 %}
                                                {{ (diasTeorico * -1)|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% else %}
                                                {{ diasTeorico|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div style="font-size: 0.9rem; color: #999; margin-bottom: 0.5rem; font-style: italic;">Pendiente</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: #999;">
                                            ‚Äî<br><small style="font-size: 0.7rem;">por definir</small>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">F√≠sicas</div>
                                    {% if convocatoria.fechaFisicas %}
                                        {% set diasFisicas = (convocatoria.fechaFisicas|date('U') - 'now'|date('U')) / 86400 %}
                                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">{{ convocatoria.fechaFisicas|date('d/m/Y') }}</div>
                                        <div style="font-size: 1.3rem; font-weight: bold; color: {% if diasFisicas < 0 %}#dc3545{% elseif diasFisicas <= 30 %}#ff9800{% else %}#28a745{% endif %};">
                                            {% if diasFisicas < 0 %}
                                                {{ (diasFisicas * -1)|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% else %}
                                                {{ diasFisicas|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div style="font-size: 0.9rem; color: #999; margin-bottom: 0.5rem; font-style: italic;">Pendiente</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: #999;">
                                            ‚Äî<br><small style="font-size: 0.7rem;">por definir</small>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Psicot√©cnico</div>
                                    {% if convocatoria.fechaPsicotecnico %}
                                        {% set diasPsicotecnico = (convocatoria.fechaPsicotecnico|date('U') - 'now'|date('U')) / 86400 %}
                                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">{{ convocatoria.fechaPsicotecnico|date('d/m/Y') }}</div>
                                        <div style="font-size: 1.3rem; font-weight: bold; color: {% if diasPsicotecnico < 0 %}#dc3545{% elseif diasPsicotecnico <= 30 %}#ff9800{% else %}#28a745{% endif %};">
                                            {% if diasPsicotecnico < 0 %}
                                                {{ (diasPsicotecnico * -1)|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% else %}
                                                {{ diasPsicotecnico|round }}<br><small style="font-size: 0.7rem;">d√≠as</small>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div style="font-size: 0.9rem; color: #999; margin-bottom: 0.5rem; font-style: italic;">Pendiente</div>
                                        <div style="font-size: 1rem; font-weight: bold; color: #999;">
                                            ‚Äî<br><small style="font-size: 0.7rem;">por definir</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% else %}
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid #ddd; background-color: #f8f9fa;">
            <div class="card-body" style="text-align: center; padding: 2rem;">
                <p style="color: #666; margin: 0;">No tienes convocatorias asignadas. Contacta con tu profesor para m√°s informaci√≥n.</p>
            </div>
        </div>
    {% endif %}

    {# Secci√≥n peque√±a de ranking general #}
    {% if posicionesUsuario %}
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header" style="cursor: pointer;" data-section="ranking-general" onclick="toggleSection('ranking-general')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <h3 style="margin: 0;">üèÜ Mi Ranking (Temario General)</h3>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="cantidad-ranking-select" style="margin-right: 0.5rem; font-size: 0.9rem;">√öltimos:</label>
                            <select id="cantidad-ranking-select" class="form-control" style="display: inline-block; width: auto; font-size: 0.9rem;" onchange="window.location.href='{{ path('app_dashboard') }}?cantidad=' + this.value" onclick="event.stopPropagation();">
                                <option value="2" {% if cantidadRanking == 2 %}selected{% endif %}>2 ex√°menes</option>
                                <option value="3" {% if cantidadRanking == 3 %}selected{% endif %}>3 ex√°menes</option>
                                <option value="4" {% if cantidadRanking == 4 %}selected{% endif %}>4 ex√°menes</option>
                                <option value="5" {% if cantidadRanking == 5 %}selected{% endif %}>5 ex√°menes</option>
                                <option value="10" {% if cantidadRanking == 10 %}selected{% endif %}>10 ex√°menes</option>
                            </select>
                            <span class="toggle-icon" style="font-size: 1.2rem; user-select: none; margin-left: 0.5rem;">‚ñº</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body" id="ranking-general">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    {% for dificultad, datos in posicionesUsuario %}
                        {% if datos.posicion %}
                            <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                <div style="font-weight: bold; color: var(--color-primary); margin-bottom: 0.25rem;">
                                    {% if dificultad == 'facil' %}F√°cil
                                    {% elseif dificultad == 'moderada' %}Moderada
                                    {% else %}Dif√≠cil
                                    {% endif %}
                                </div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--color-success);">
                                    Posici√≥n {{ datos.posicion }}/{{ datos.totalUsuarios }}
                                </div>
                                {% if datos.notaMedia %}
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                        Media: {{ datos.notaMedia|number_format(2, ',', '.') }}
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                                <div style="font-weight: bold; color: var(--color-primary); margin-bottom: 0.25rem;">
                                    {% if dificultad == 'facil' %}F√°cil
                                    {% elseif dificultad == 'moderada' %}Moderada
                                    {% else %}Dif√≠cil
                                    {% endif %}
                                </div>
                                <div style="font-size: 0.9rem; color: #999;">
                                    Sin ex√°menes
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}

    {# Rankings por municipio #}
    {% if rankingsPorMunicipio|length > 0 %}
        <div id="rankings-municipios-container">
            {% for municipioId, datosMunicipio in rankingsPorMunicipio %}
                <div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid #2196F3;">
                    <div class="card-header" style="background-color: #e3f2fd; cursor: pointer;" data-section="ranking-municipio-{{ municipioId }}" onclick="toggleSection('ranking-municipio-{{ municipioId }}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">üèÜ Mi Ranking - {{ datosMunicipio.municipio.nombre }}</h3>
                            <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
                        </div>
                    </div>
                    <div class="card-body" id="ranking-municipio-{{ municipioId }}">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        {% for dificultad, datos in datosMunicipio.posiciones %}
                            {% if datos.posicion %}
                                <div style="text-align: center; padding: 0.75rem; background-color: #e3f2fd; border-radius: 4px;">
                                    <div style="font-weight: bold; color: #1976D2; margin-bottom: 0.25rem;">
                                        {% if dificultad == 'facil' %}F√°cil
                                        {% elseif dificultad == 'moderada' %}Moderada
                                        {% else %}Dif√≠cil
                                        {% endif %}
                                    </div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--color-success);">
                                        Posici√≥n {{ datos.posicion }}/{{ datos.totalUsuarios }}
                                    </div>
                                    {% if datos.notaMedia %}
                                        <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                            Media: {{ datos.notaMedia|number_format(2, ',', '.') }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div style="text-align: center; padding: 0.75rem; background-color: #e3f2fd; border-radius: 4px;">
                                    <div style="font-weight: bold; color: #1976D2; margin-bottom: 0.25rem;">
                                        {% if dificultad == 'facil' %}F√°cil
                                        {% elseif dificultad == 'moderada' %}Moderada
                                        {% else %}Dif√≠cil
                                        {% endif %}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #999;">
                                        Sin ex√°menes
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %}

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card">
            <div class="card-header" style="cursor: pointer;" data-section="mis-examenes" onclick="toggleSection('mis-examenes')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0;">üìö Mis Ex√°menes</h2>
                    <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
                </div>
            </div>
            <div class="card-body" id="mis-examenes">
                <div style="text-align: center; margin-bottom: 1rem;">
                    <a href="{{ path('app_examen_iniciar') }}" class="btn btn-primary" style="font-size: 1.1rem; padding: 0.75rem 1.5rem;">Nuevo Examen</a>
                </div>

                {% if estadisticas.total > 0 %}
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                            <h4 style="color: var(--color-primary); font-size: 1.5rem; margin: 0;">{{ estadisticas.total }}</h4>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem;">Ex√°menes</p>
                        </div>
                        <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                            <h4 style="color: var(--color-primary); font-size: 1.5rem; margin: 0;">{{ estadisticas.promedio|number_format(2, ',', '.') }}</h4>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem;">Promedio</p>
                        </div>
                        <div style="text-align: center; padding: 0.75rem; background-color: #f8f9fa; border-radius: 4px;">
                            <h4 style="color: var(--color-success); font-size: 1.5rem; margin: 0;">{{ estadisticas.mejorNota|number_format(2, ',', '.') }}</h4>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem;">Mejor Nota</p>
                        </div>
                    </div>
                {% endif %}

                <h4 style="margin-top: 1rem; margin-bottom: 0.75rem; font-size: 1rem;">√öltimos Ex√°menes</h4>

                {% if ultimosExamenes|length > 0 %}
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="table" style="font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Dificultad</th>
                                    <th>Nota</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for examen in ultimosExamenes|slice(0, 5) %}
                                    <tr>
                                        <td>{{ examen.fecha|date('d/m/Y') }}</td>
                                        <td><span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span></td>
                                        <td><strong style="color: var(--color-primary);">{{ examen.nota|number_format(2, ',', '.') }}</strong></td>
                                        <td>
                                            <a href="{{ path('app_examen_detalle', {'id': examen.id}) }}" class="btn btn-sm btn-secondary">Ver</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 0.5rem;">
                        <a href="{{ path('app_examen_historial') }}" class="btn btn-sm btn-secondary">Ver Todos</a>
                    </div>
                {% else %}
                    <p style="text-align: center; color: #666; margin: 1rem 0;">No has realizado ning√∫n examen a√∫n.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="cursor: pointer;" data-section="mis-tareas" onclick="toggleSection('mis-tareas')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0;">üìã Mis Tareas</h2>
                    <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
                </div>
            </div>
            <div class="card-body" id="mis-tareas">
                {% if planificacion %}
                    <div style="margin-bottom: 1rem;">
                        <a href="{{ path('app_planificacion_alumno_index') }}" class="btn btn-primary" style="width: 100%;">Ver Mi Planificaci√≥n</a>
                    </div>
                    
                    {% if resumenTareas.total > 0 %}
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 0.5rem; background-color: #e8f5e9; border-radius: 4px;">
                                <strong style="color: var(--color-success); font-size: 1.2rem;">{{ resumenTareas.completadas }}</strong>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">Completadas</p>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background-color: #fff3cd; border-radius: 4px;">
                                <strong style="color: var(--color-warning); font-size: 1.2rem;">{{ resumenTareas.pendientes }}</strong>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">Pendientes</p>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <p style="text-align: center; color: #666; margin: 1rem 0;">No tienes planificaci√≥n asignada.</p>
                {% endif %}

                <h4 style="margin-top: 1rem; margin-bottom: 0.75rem; font-size: 1rem;">Tareas Pendientes</h4>
                {% if tareasPendientes|length > 0 %}
                    <div style="max-height: 250px; overflow-y: auto;">
                        {% for tareaAsignada in tareasPendientes %}
                            <div style="padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #ddd; border-radius: 4px; background-color: {% if tareaAsignada.franjaHoraria %}#f0f0f0{% else %}#fff{% endif %};">
                                <div style="font-weight: bold; font-size: 0.9rem;">{{ tareaAsignada.tarea.nombre }}</div>
                                <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
                                    Semana: {{ tareaAsignada.tarea.semanaAsignacion|date('d/m/Y') }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div style="text-align: center; margin-top: 0.5rem;">
                        <a href="{{ path('app_planificacion_alumno_index') }}" class="btn btn-sm btn-secondary">Ver Todas</a>
                    </div>
                {% else %}
                    <p style="text-align: center; color: #666; margin: 1rem 0;">¬°No tienes tareas pendientes! üéâ</p>
                {% endif %}
            </div>
        </div>
    </div>

    {# Secci√≥n completa de ex√°menes #}
    <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header" style="cursor: pointer;" data-section="historial-examenes" onclick="toggleSection('historial-examenes')">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="margin: 0;">Historial de Ex√°menes</h1>
                <span class="toggle-icon" style="font-size: 1.2rem; user-select: none;">‚ñº</span>
            </div>
        </div>
        <div class="card-body" id="historial-examenes">
            {% if ultimosExamenes|length > 0 %}
                <div class="card">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Temas</th>
                                <th>Dificultad</th>
                                <th>Preguntas</th>
                                <th>Nota</th>
                                <th>Aciertos</th>
                                <th>Errores</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for examen in ultimosExamenes %}
                                <tr>
                                    <td>{{ examen.fecha|date('d/m/Y H:i') }}</td>
                                    <td>
                                        {% if examen.municipio %}
                                            <span class="badge" style="background-color: #2196F3; margin-bottom: 0.25rem; display: block;">{{ examen.municipio.nombre }}</span>
                                            {% for temaMunicipal in examen.temasMunicipales %}
                                                <span class="badge badge-facil">{{ temaMunicipal.nombre }}</span>
                                            {% endfor %}
                                        {% else %}
                                            {% for tema in examen.temas %}
                                                <span class="badge badge-facil">{{ tema.nombre }}</span>
                                            {% endfor %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-{{ examen.dificultad }}">{{ examen.getDificultadLabel() }}</span>
                                        {% if examen.municipio %}
                                            <br><small style="color: #2196F3; font-size: 0.75rem;">Municipal</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ examen.numeroPreguntas }}</td>
                                    <td><strong style="font-size: 1.2rem; color: var(--color-primary);">{{ examen.nota|number_format(2, ',', '.') }}</strong></td>
                                    <td style="color: var(--color-success);"><strong>{{ examen.aciertos }}</strong></td>
                                    <td style="color: var(--color-danger);"><strong>{{ examen.errores }}</strong></td>
                                    <td>
                                        <a href="{{ path('app_examen_detalle', {'id': examen.id}) }}" class="btn btn-secondary btn-sm">Ver</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <a href="{{ path('app_examen_historial') }}" class="btn btn-secondary">Ver Historial Completo</a>
                </div>
            {% else %}
                <div class="card">
                    <div class="card-body text-center">
                        <p>No has realizado ning√∫n examen a√∫n.</p>
                        <a href="{{ path('app_examen_iniciar') }}" class="btn btn-primary">Realizar Primer Examen</a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endif %}
{% endblock %}

