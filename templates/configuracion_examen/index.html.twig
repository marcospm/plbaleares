{% extends 'base.html.twig' %}

{% block title %}Configuración de Porcentajes por Tema{% endblock %}

{% block body %}
<div class="d-flex justify-content-between mb-4">
    <h1>Configuración de Porcentajes por Tema</h1>
    <form method="post" action="{{ path('app_configuracion_examen_resetear') }}" style="display: inline;">
        <input type="hidden" name="_token" value="{{ csrf_token('resetear_configuracion') }}">
        <button type="submit" class="btn btn-secondary" onclick="return confirm('¿Estás seguro de que quieres resetear todos los porcentajes? Se usará distribución equitativa.')">
            Resetear a Equitativo
        </button>
    </form>
</div>

<div class="card mb-4">
    <div class="card-body">
        <p style="margin-bottom: 0;">
            <strong>Instrucciones:</strong> Configura el porcentaje de preguntas que debe tener cada tema en los exámenes generales.
            Si no configuras un porcentaje o dejas todos en blanco, se usará una distribución equitativa.
            Los porcentajes se normalizarán automáticamente si no suman exactamente 100%.
        </p>
    </div>
</div>

{{ form_start(form, {'attr': {'id': 'configuracion-form'}}) }}

<div class="card">
    <div class="card-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;">Temas del Temario General</h2>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <strong>Total: <span id="suma-total" style="color: {% if sumaTotal == 100 %}var(--color-success){% elseif sumaTotal > 0 %}var(--color-warning){% else %}var(--color-text-light){% endif %};">{{ sumaTotal|number_format(2) }}%</span></strong>
            </div>
        </div>
    </div>
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th style="width: 5%;">ID</th>
                    <th style="width: 60%;">Tema</th>
                    <th style="width: 15%;">Porcentaje (%)</th>
                    <th style="width: 20%;">Distribución Equitativa</th>
                </tr>
            </thead>
            <tbody>
                {% for configuracion in configuraciones %}
                    {% set tema = configuracion.tema %}
                    {% set porcentajeEquitativo = (100 / configuraciones|length)|number_format(2) %}
                    <tr>
                        <td>{{ tema.id }}</td>
                        <td>
                            <strong>{{ tema.nombre }}</strong>
                            {% if tema.descripcion %}
                                <br><small style="color: var(--color-text-light);">{{ tema.descripcion|slice(0, 100) }}{% if tema.descripcion|length > 100 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td>
                            {{ form_widget(form.configuraciones[loop.index0].id) }}
                            {{ form_widget(form.configuraciones[loop.index0].porcentaje, {'attr': {'data-tema-id': tema.id, 'class': 'form-control porcentaje-input'}}) }}
                            {{ form_errors(form.configuraciones[loop.index0].porcentaje) }}
                        </td>
                        <td>
                            <small style="color: var(--color-text-light);">{{ porcentajeEquitativo }}%</small>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="d-flex justify-content-end gap-2 mt-4">
    <a href="{{ path('app_dashboard') }}" class="btn btn-secondary">Cancelar</a>
    <button type="submit" class="btn btn-primary">Guardar Configuración</button>
</div>

{{ form_end(form) }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const porcentajeInputs = document.querySelectorAll('.porcentaje-input');
    const sumaTotalElement = document.getElementById('suma-total');
    
    function calcularSumaTotal() {
        let suma = 0;
        porcentajeInputs.forEach(input => {
            const valor = parseFloat(input.value) || 0;
            suma += valor;
        });
        
        const sumaFormateada = suma.toFixed(2);
        sumaTotalElement.textContent = sumaFormateada + '%';
        
        // Cambiar color según la suma
        if (suma === 100) {
            sumaTotalElement.style.color = 'var(--color-success)';
        } else if (suma > 0) {
            sumaTotalElement.style.color = 'var(--color-warning)';
        } else {
            sumaTotalElement.style.color = 'var(--color-text-light)';
        }
    }
    
    porcentajeInputs.forEach(input => {
        input.addEventListener('input', calcularSumaTotal);
        input.addEventListener('change', calcularSumaTotal);
    });
    
    // Calcular suma inicial
    calcularSumaTotal();
});
</script>

<style>
.porcentaje-input {
    max-width: 120px;
}

.table th {
    background-color: var(--color-bg-secondary);
    font-weight: 600;
}

.table td {
    vertical-align: middle;
}
</style>
{% endblock %}

