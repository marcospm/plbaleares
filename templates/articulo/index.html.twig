{% extends 'base.html.twig' %}

{% block title %}Art√≠culos{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        /* Estilos para paginaci√≥n */
        .pagination {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            gap: 0.25rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .page-item {
            margin: 0;
        }
        
        .page-link {
            display: block;
            padding: 0.5rem 0.75rem;
            color: var(--color-primary);
            text-decoration: none;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            transition: all 0.2s;
            min-width: 40px;
            text-align: center;
            font-weight: 500;
        }
        
        .page-link:hover:not(.disabled):not([aria-disabled="true"]) {
            background-color: #e9ecef;
            border-color: #dee2e6;
            color: var(--color-primary);
            transform: translateY(-1px);
        }
        
        .page-item.active .page-link {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: #fff;
            font-weight: 600;
        }
        
        .page-item.disabled .page-link,
        .page-link[aria-disabled="true"] {
            color: #6c757d;
            pointer-events: none;
            cursor: not-allowed;
            background-color: #fff;
            border-color: #dee2e6;
            opacity: 0.6;
        }
        
        .page-link:focus {
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0, 113, 181, 0.25);
        }
        
        @media (max-width: 768px) {
            /* Paginaci√≥n */
            .pagination {
                gap: 0.15rem;
                flex-wrap: wrap;
            }
            
            .page-link {
                padding: 0.5rem 0.75rem;
                font-size: 16px;
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Formulario de b√∫squeda - apilar elementos verticalmente */
            #filtro-form .card-body > div[style*="display: grid"] {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            /* Inputs y selects m√°s grandes para iPhone */
            #filtro-form input[type="text"],
            #filtro-form select {
                font-size: 16px !important; /* Previene zoom autom√°tico en iOS */
                min-height: 48px !important;
                padding: 0.75rem !important;
                width: 100% !important;
            }
            
            /* Labels */
            #filtro-form .form-label {
                font-size: 0.95rem !important;
                margin-bottom: 0.5rem !important;
                display: block;
            }
            
            /* Botones de acci√≥n */
            #filtro-form > div > div > div[style*="display: flex"] {
                flex-direction: column !important;
                width: 100% !important;
                gap: 0.75rem !important;
            }
            
            #filtro-form > div > div > div[style*="display: flex"] button,
            #filtro-form > div > div > div[style*="display: flex"] a {
                width: 100% !important;
                padding: 0.75rem 1rem !important;
                font-size: 16px !important;
                min-height: 48px !important;
                justify-content: center !important;
            }
            
            /* Filtros activos */
            #filtro-form > div > div > div[style*="margin-top: 1rem"] {
                padding: 0.75rem !important;
            }
            
            #filtro-form > div > div > div[style*="margin-top: 1rem"] > div {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            /* Badges de filtros activos */
            #filtro-form .badge {
                display: block !important;
                width: 100% !important;
                margin: 0.25rem 0 !important;
                padding: 0.5rem !important;
                font-size: 0.9rem !important;
                word-wrap: break-word;
            }
            
            /* Header con bot√≥n nuevo art√≠culo */
            .d-flex.justify-content-between.mb-4 {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 1rem !important;
            }
            
            .d-flex.justify-content-between.mb-4 h1 {
                font-size: 1.5rem !important;
                margin: 0 !important;
                word-wrap: break-word;
            }
            
            .d-flex.justify-content-between.mb-4 a {
                width: 100% !important;
                padding: 0.75rem 1rem !important;
                font-size: 16px !important;
                min-height: 48px !important;
                text-align: center !important;
            }
            
            /* Card header responsive */
            .card-header h3 {
                font-size: 1rem !important;
                word-wrap: break-word;
            }
            
            /* Tabla responsive */
            div[style*="overflow-x: auto"] {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -15px;
                padding: 0 15px;
            }
            
            .table {
                font-size: 0.8rem !important;
                min-width: 800px;
            }
            
            /* Ocultar columnas menos importantes en m√≥vil */
            .table th:nth-child(1),
            .table td:nth-child(1),
            .table th:nth-child(4),
            .table td:nth-child(4),
            .table th:nth-child(5),
            .table td:nth-child(5),
            .table th:nth-child(7),
            .table td:nth-child(7) {
                display: none !important;
            }
            
            /* Botones en tablas */
            .table .btn {
                min-height: 40px;
                font-size: 14px;
                padding: 0.5rem 0.75rem;
                white-space: nowrap;
            }
            
            .table .d-flex.gap-2 {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .table .d-flex.gap-2 .btn,
            .table .d-flex.gap-2 form {
                width: 100%;
            }
            
            .table .d-flex.gap-2 form button {
                width: 100%;
            }
            
            /* Card footer */
            .card-footer {
                padding: 1rem 0.75rem !important;
            }
            
            .card-footer > div[style*="text-align: center"] {
                font-size: 0.85rem;
                word-wrap: break-word;
                padding: 0.5rem;
            }
        }
        
        /* Estilos espec√≠ficos para iPhone (pantallas muy peque√±as) */
        @media (max-width: 480px) {
            .d-flex.justify-content-between.mb-4 h1 {
                font-size: 1.3rem !important;
            }
            
            #filtro-form .card-header h3 {
                font-size: 1rem !important;
            }
        }
        
        /* Estilos para el select de ley */
        select[name="ley"] {
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 0.6rem 1rem;
            font-size: 0.95rem;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%230071B5' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 12px;
            padding-right: 2.5rem;
        }
        
        select[name="ley"]:hover {
            border-color: var(--color-primary);
            box-shadow: 0 2px 4px rgba(0, 113, 181, 0.1);
        }
        
        select[name="ley"]:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 113, 181, 0.15);
        }
        
        select[name="ley"] option {
            padding: 0.75rem 1rem;
            background-color: #fff;
            color: #333;
            font-size: 0.95rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        select[name="ley"] option:hover {
            background-color: #e3f2fd;
            color: var(--color-primary);
        }
        
        select[name="ley"] option:checked {
            background-color: var(--color-primary);
            color: #fff;
            font-weight: 600;
        }
        
        select[name="ley"] option:first-child {
            background-color: #f8f9fa;
            color: #666;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }
    </style>
{% endblock %}

{% block body %}
<div class="d-flex justify-content-between mb-4">
    <h1>Art√≠culos</h1>
    <a href="{{ path('app_articulo_new') }}" class="btn btn-primary">Nuevo Art√≠culo</a>
</div>

<form method="get" action="{{ path('app_articulo_index') }}" style="margin-bottom: 2rem;" id="filtro-form">
    <div class="card" style="border-left: 4px solid var(--color-primary);">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;">
            <h3 style="margin: 0; color: #333; font-size: 1.1rem; font-weight: 600;">
                üîç Filtros de B√∫squeda
            </h3>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-weight: 600; margin-bottom: 0.5rem;">
                        <span style="color: var(--color-primary);">üìù</span> Buscar en contenido:
                    </label>
                    <input type="text" name="search" value="{{ search }}" class="form-control" placeholder="Buscar en n√∫mero, nombre, explicaci√≥n..." style="border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-weight: 600; margin-bottom: 0.5rem;">
                        <span style="color: var(--color-primary);">‚öñÔ∏è</span> Filtrar por Ley:
                    </label>
                    <select name="ley" class="form-control">
                        <option value="0">üìã Todas las leyes</option>
                        {% for ley in leyes %}
                            <option value="{{ ley.id }}" {% if leySeleccionada == ley.id %}selected{% endif %}>
                                {{ ley.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-weight: 600; margin-bottom: 0.5rem;">
                        <span style="color: var(--color-primary);">üî¢</span> N√∫mero de Art√≠culo:
                    </label>
                    <input type="text" name="numero" value="{{ numero }}" class="form-control" placeholder="Ej: 1, 2, 1.1, etc." style="border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem;">
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: end;">
                    <button type="submit" class="btn btn-primary" style="flex: 1; padding: 0.5rem 1rem;">
                        <span>üîç</span> Filtrar
                    </button>
                    <a href="{{ path('app_articulo_index') }}" class="btn btn-secondary" style="padding: 0.5rem 1rem; white-space: nowrap;">
                        <span>üîÑ</span> Limpiar
                    </a>
                </div>
            </div>
            {% if search or leySeleccionada > 0 or numero %}
                <div style="margin-top: 1rem; padding: 0.75rem; background-color: #e7f3ff; border-radius: 4px; border-left: 3px solid var(--color-primary);">
                    <strong style="color: var(--color-primary);">Filtros activos:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                        {% if leySeleccionada > 0 %}
                            {% for ley in leyes %}
                                {% if ley.id == leySeleccionada %}
                                    {% set paramsSinLey = app.request.query.all|merge({'ley': 0}) %}
                                    <span class="badge" style="background-color: var(--color-primary); color: white; padding: 0.25rem 0.5rem; border-radius: 3px;">
                                        Ley: {{ ley.nombre }} <a href="{{ path('app_articulo_index', paramsSinLey) }}" style="color: white; margin-left: 0.5rem; text-decoration: none; font-weight: bold;">√ó</a>
                                    </span>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        {% if numero %}
                            {% set paramsSinNumero = app.request.query.all|merge({'numero': ''}) %}
                            <span class="badge" style="background-color: #28a745; color: white; padding: 0.25rem 0.5rem; border-radius: 3px;">
                                N√∫mero: {{ numero }} <a href="{{ path('app_articulo_index', paramsSinNumero) }}" style="color: white; margin-left: 0.5rem; text-decoration: none; font-weight: bold;">√ó</a>
                            </span>
                        {% endif %}
                        {% if search %}
                            {% set paramsSinSearch = app.request.query.all|merge({'search': ''}) %}
                            <span class="badge" style="background-color: #ffc107; color: #000; padding: 0.25rem 0.5rem; border-radius: 3px;">
                                B√∫squeda: "{{ search }}" <a href="{{ path('app_articulo_index', paramsSinSearch) }}" style="color: #000; margin-left: 0.5rem; text-decoration: none; font-weight: bold;">√ó</a>
                            </span>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</form>

{% if articulos|length > 0 %}
    <div class="card">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                <h3 style="margin: 0; color: #f0f0f0; font-size: 1.1rem; font-weight: 600; word-wrap: break-word;">
                    üìö Art√≠culos encontrados: <strong style="color: #f0f0f0">{{ totalItems }}</strong>
                    {% if totalPages > 1 %}
                        <span style="font-size: 0.9rem; color: #f0f0f0; font-weight: normal; display: block; margin-top: 0.25rem;">
                            (P√°gina {{ currentPage }} de {{ totalPages }})
                        </span>
                    {% endif %}
                </h3>
            </div>
        </div>
        <div style="overflow-x: auto;">
        <table class="table" style="width: 100%; table-layout: fixed;">
            <thead>
                <tr>
                    <th style="width: 5%;">ID</th>
                    <th style="width: 8%;">N√∫mero</th>
                    <th style="width: 15%;">Nombre</th>
                    <th style="width: 10%;">Ley</th>
                    <th style="width: 10%;">Explicaci√≥n</th>
                    <th style="width: 10%;">Preguntas</th>
                    <th style="width: 8%;">Mensajes</th>
                    <th style="width: 8%;">Estado</th>
                    <th style="width: 26%;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for articulo in articulos %}
                    <tr>
                        <td>{{ articulo.id }}</td>
                        <td><strong>Art. {{ articulo.getNumeroCompleto() }}</strong></td>
                        <td>{{ articulo.nombre|default('-') }}</td>
                        <td title="{{ articulo.ley.nombre }}" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ articulo.ley.nombre|slice(0, 10) }}{% if articulo.ley.nombre|length > 10 %}...{% endif %}</td>
                        <td title="{{ articulo.explicacion|default('Sin explicaci√≥n') }}" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ articulo.explicacion|default('Sin explicaci√≥n')|slice(0, 10) }}{% if articulo.explicacion|default('')|length > 10 %}...{% endif %}</td>
                        <td>
                            <span class="badge badge-moderada">{{ articulo.preguntas|length }} pregunta(s)</span>
                        </td>
                        <td>
                            {% set totalMensajes = contadoresMensajes[articulo.id] ?? 0 %}
                            {% if totalMensajes > 0 %}
                                <a href="{{ path('app_articulo_show', {'id': articulo.id}) }}" style="text-decoration: none;">
                                    <span class="badge bg-warning text-dark" style="cursor: pointer;" title="Ver mensajes">
                                        üí¨ {{ totalMensajes }}
                                    </span>
                                </a>
                            {% else %}
                                <span class="badge bg-secondary">0</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if articulo.isActivo %}
                                <span class="badge badge-success" style="background-color: var(--color-success);">Activo</span>
                            {% else %}
                                <span class="badge badge-danger" style="background-color: var(--color-danger);">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                {% set paramsFiltros = {
                                    'search': search,
                                    'ley': leySeleccionada > 0 ? leySeleccionada : 0,
                                    'numero': numero
                                } %}
                                {% if currentPage > 1 %}
                                    {% set paramsFiltros = paramsFiltros|merge({'page': currentPage}) %}
                                {% endif %}
                                <a href="{{ path('app_articulo_show', {'id': articulo.id}|merge(paramsFiltros)) }}" class="btn btn-secondary btn-sm">Ver</a>
                                <a href="{{ path('app_articulo_edit', {'id': articulo.id}|merge(paramsFiltros)) }}" class="btn btn-primary btn-sm">Editar</a>
                                <form method="post" action="{{ path('app_articulo_toggle_activo', {'id': articulo.id}|merge(paramsFiltros)) }}" style="display: inline;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('toggle' ~ articulo.id) }}">
                                    <button type="submit" class="btn btn-sm {% if articulo.isActivo %}btn-warning{% else %}btn-success{% endif %}">
                                        {% if articulo.isActivo %}Desactivar{% else %}Activar{% endif %}
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        
        {% if totalPages > 1 %}
            <div class="card-footer" style="background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 1rem;">
                <nav aria-label="Paginaci√≥n de art√≠culos">
                    <ul class="pagination justify-content-center mb-0" style="flex-wrap: wrap;">
                        {% set paramsBase = {
                            'search': search,
                            'ley': leySeleccionada > 0 ? leySeleccionada : '',
                            'numero': numero
                        } %}
                        {% set paramsBase = paramsBase|filter(v => v != '' and v != 0) %}
                        
                        {# Bot√≥n Anterior #}
                        <li class="page-item {% if currentPage == 1 %}disabled{% endif %}">
                            {% if currentPage > 1 %}
                                {% set pageAnterior = currentPage - 1 %}
                                {% if pageAnterior > 1 %}
                                    {% set paramsAnterior = paramsBase|merge({'page': pageAnterior}) %}
                                {% else %}
                                    {% set paramsAnterior = paramsBase %}
                                {% endif %}
                                <a class="page-link" href="{{ path('app_articulo_index', paramsAnterior) }}">
                            {% else %}
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                            {% endif %}
                                ‚Üê Anterior
                            </a>
                        </li>
                        
                        {# N√∫meros de p√°gina #}
                        {% set startPage = max(1, currentPage - 2) %}
                        {% set endPage = min(totalPages, currentPage + 2) %}
                        
                        {% if startPage > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="{{ path('app_articulo_index', paramsBase) }}">1</a>
                            </li>
                            {% if startPage > 2 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endif %}
                        
                        {% for p in startPage..endPage %}
                            <li class="page-item {% if p == currentPage %}active{% endif %}">
                                {% if p > 1 %}
                                    <a class="page-link" href="{{ path('app_articulo_index', paramsBase|merge({'page': p})) }}">{{ p }}</a>
                                {% else %}
                                    <a class="page-link" href="{{ path('app_articulo_index', paramsBase) }}">{{ p }}</a>
                                {% endif %}
                            </li>
                        {% endfor %}
                        
                        {% if endPage < totalPages %}
                            {% if endPage < totalPages - 1 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                            <li class="page-item">
                                <a class="page-link" href="{{ path('app_articulo_index', paramsBase|merge({'page': totalPages})) }}">{{ totalPages }}</a>
                            </li>
                        {% endif %}
                        
                        {# Bot√≥n Siguiente #}
                        <li class="page-item {% if currentPage == totalPages %}disabled{% endif %}">
                            {% if currentPage < totalPages %}
                                <a class="page-link" href="{{ path('app_articulo_index', paramsBase|merge({'page': currentPage + 1})) }}">
                            {% else %}
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                            {% endif %}
                                Siguiente ‚Üí
                            </a>
                        </li>
                    </ul>
                </nav>
                <div style="text-align: center; margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                    Mostrando {{ ((currentPage - 1) * itemsPerPage) + 1 }} - {{ min(currentPage * itemsPerPage, totalItems) }} de {{ totalItems }} art√≠culos
                </div>
            </div>
        {% endif %}
    </div>
{% else %}
    <div class="card">
        <div class="card-body text-center">
            <p>No hay art√≠culos registrados a√∫n.</p>
            <a href="{{ path('app_articulo_new') }}" class="btn btn-primary">Crear Primer Art√≠culo</a>
        </div>
    </div>
{% endif %}
{% endblock %}

