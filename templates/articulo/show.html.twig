{% extends 'base.html.twig' %}

{% block title %}Art칤culo: {{ articulo.getNumeroCompleto() }}{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <h1>Art칤culo {{ articulo.getNumeroCompleto() }}{% if articulo.nombre %} - {{ articulo.nombre }}{% endif %}</h1>
    </div>
    <div class="card-body">
        <div class="form-group">
            <label class="form-label"><strong>{% if articulo.nombre %}Nombre:{% else %}N칰mero:{% endif %}</strong></label>
            <p style="font-size: 1.1rem; color: var(--color-primary);">
                {% if articulo.nombre %}
                    {{ articulo.nombre }} - {{ articulo.getNumeroCompleto() }}
                {% else %}
                    {{ articulo.getNumeroCompleto() }}
                {% endif %}
            </p>
        </div>
        <div class="form-group">
            <label class="form-label"><strong>Ley:</strong></label>
            <p><a href="{{ path('app_ley_show', {'id': articulo.ley.id}) }}">{{ articulo.ley.nombre }}</a></p>
        </div>

        {% if articulo.tituloLey %}
        <div class="form-group">
            <label class="form-label"><strong>T칤tulo en la Ley:</strong></label>
            <p style="font-size: 1rem; color: #333;">{{ articulo.tituloLey }}</p>
        </div>
        {% endif %}

        {% if articulo.capitulo %}
        <div class="form-group">
            <label class="form-label"><strong>Cap칤tulo:</strong></label>
            <p style="font-size: 1rem; color: #333;">{{ articulo.capitulo }}</p>
        </div>
        {% endif %}

        {% if articulo.seccion %}
        <div class="form-group">
            <label class="form-label"><strong>Secci칩n:</strong></label>
            <p style="font-size: 1rem; color: #333;">{{ articulo.seccion }}</p>
        </div>
        {% endif %}

        <div class="form-group">
            <label class="form-label"><strong>Explicaci칩n para el Opositor:</strong></label>
            <div style="background-color: #f5f5f5; padding: 1rem; border-radius: 4px; border-left: 4px solid var(--color-primary); line-height: 1.6;">
                {{ articulo.explicacion|default('Sin explicaci칩n')|markdown|raw }}
            </div>
        </div>

        {% if articulo.textoLegal %}
        <div class="form-group">
            <label class="form-label"><strong>Texto Legal:</strong></label>
            <div style="background-color: #fff3cd; padding: 1rem; border-radius: 4px; border-left: 4px solid #ffc107; line-height: 1.6;">
                {{ articulo.textoLegal|raw }}
            </div>
        </div>
        {% endif %}

        {% if articulo.video and articulo.video|trim != '' %}
        <div class="form-group">
            <label class="form-label"><strong>Video Explicativo:</strong></label>
            <div style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden; background: #000; margin-top: 0.5rem;">
                <video controls style="width: 100%; display: block;" preload="metadata">
                    <source src="{{ articulo.video }}" type="video/mp4">
                    <source src="{{ articulo.video }}" type="video/webm">
                    <source src="{{ articulo.video }}" type="video/ogg">
                    Tu navegador no soporta el elemento de video.
                </video>
            </div>
        </div>
        {% endif %}

        <div class="form-group">
            <label class="form-label"><strong>Preguntas relacionadas:</strong></label>
            {% if articulo.preguntas|length > 0 %}
                <ul>
                    {% for pregunta in articulo.preguntas %}
                        <li>
                            <a href="{{ path('app_pregunta_show', {'id': pregunta.id}) }}">
                                {{ pregunta.texto|slice(0, 100) }}{% if pregunta.texto|length > 100 %}...{% endif %}
                            </a>
                            <span class="badge badge-{{ pregunta.dificultad }}">{{ pregunta.getDificultadLabel() }}</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p style="color: var(--color-text-light);">No hay preguntas asociadas a este art칤culo.</p>
            {% endif %}
        </div>

        <!-- Secci칩n de Mensajes y Comentarios -->
        <div class="form-group mt-4" style="border-top: 2px solid #ddd; padding-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0; color: var(--color-primary);">
                    游눫 Mensajes y Comentarios
                    {% if totalMensajes > 0 %}
                        <span class="badge bg-primary" style="margin-left: 0.5rem;">{{ totalMensajes }}</span>
                    {% endif %}
                </h3>
            </div>

            {% if mensajes|length > 0 %}
                <div style="display: grid; gap: 1rem;">
                    {% for mensaje in mensajes %}
                        {% set esProfesorMensaje = mensaje.autor.roles|filter(v => v in ['ROLE_PROFESOR', 'ROLE_ADMIN'])|length > 0 %}
                        <div class="card" style="border-left: 4px solid {% if esProfesorMensaje %}#28a745{% else %}var(--color-primary){% endif %}; background-color: {% if esProfesorMensaje %}#f0f9f4{% else %}#fff{% endif %};">
                            <div class="card-header" style="background-color: {% if esProfesorMensaje %}#f0f9f4{% else %}#fff{% endif %}; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: {% if esProfesorMensaje %}#28a745{% else %}var(--color-primary){% endif %};">
                                        {{ mensaje.autor.nombreDisplay }}
                                    </strong>
                                    {% if esProfesorMensaje %}
                                        <span class="badge bg-success" style="margin-left: 0.5rem;">Profesor</span>
                                    {% else %}
                                        <span class="badge bg-primary" style="margin-left: 0.5rem;">Alumno</span>
                                    {% endif %}
                                </div>
                                <small style="color: #999;">{{ mensaje.fechaCreacion|date('d/m/Y H:i') }}</small>
                            </div>
                            <div class="card-body">
                                <p style="margin: 0; white-space: pre-wrap; line-height: 1.6;">{{ mensaje.mensaje }}</p>
                                
                                {% if mensaje.respuestas|length > 0 %}
                                    <div style="margin-top: 1rem; margin-left: 1rem; padding-left: 1rem; border-left: 3px solid #ddd;">
                                        <strong style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; display: block;">Respuestas:</strong>
                                        {% for respuesta in mensaje.respuestas|sort((a, b) => a.fechaCreacion <=> b.fechaCreacion) %}
                                            {% set esProfesorRespuesta = respuesta.autor.roles|filter(v => v in ['ROLE_PROFESOR', 'ROLE_ADMIN'])|length > 0 %}
                                            <div class="card mb-2" style="border-left: 4px solid {% if esProfesorRespuesta %}#28a745{% else %}var(--color-primary){% endif %}; background-color: {% if esProfesorRespuesta %}#f0f9f4{% else %}#fff{% endif %};">
                                                <div class="card-body" style="padding: 0.75rem;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                        <div>
                                                            <strong style="color: {% if esProfesorRespuesta %}#28a745{% else %}var(--color-primary){% endif %}; font-size: 0.9rem;">
                                                                {{ respuesta.autor.nombreDisplay }}
                                                            </strong>
                                                            {% if esProfesorRespuesta %}
                                                                <span class="badge bg-success" style="font-size: 0.7rem; margin-left: 0.5rem;">Profesor</span>
                                                            {% else %}
                                                                <span class="badge bg-primary" style="font-size: 0.7rem; margin-left: 0.5rem;">Alumno</span>
                                                            {% endif %}
                                                        </div>
                                                        <small style="color: #999; font-size: 0.85rem;">{{ respuesta.fechaCreacion|date('d/m/Y H:i') }}</small>
                                                    </div>
                                                    <p style="margin: 0; white-space: pre-wrap; line-height: 1.5; font-size: 0.9rem;">{{ respuesta.mensaje }}</p>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                {% if not esProfesorMensaje %}
                                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                                        <form class="form-responder-mensaje" data-mensaje-id="{{ mensaje.id }}" style="display: flex; gap: 0.5rem; align-items: flex-start;">
                                            <textarea name="respuesta" class="form-control" rows="2" placeholder="Escribe tu respuesta..." required style="flex: 1;"></textarea>
                                            <button type="submit" class="btn btn-success btn-sm" style="white-space: nowrap;">Responder</button>
                                        </form>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    No hay mensajes sobre este art칤culo a칰n.
                </div>
            {% endif %}
        </div>

        <div class="d-flex gap-2 mt-4">
            {% set paramsFiltros = filtros|default({}) %}
            <a href="{{ path('app_articulo_edit', {'id': articulo.id}|merge(paramsFiltros)) }}" class="btn btn-primary">Editar</a>
            <a href="{{ path('app_articulo_index', paramsFiltros) }}" class="btn btn-secondary">Volver</a>
            <form method="post" action="{{ path('app_articulo_delete', {'id': articulo.id}|merge(paramsFiltros)) }}" onsubmit="return confirm('쮼st치s seguro de eliminar este art칤culo?');" style="display: inline;">
                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ articulo.id) }}">
                <button type="submit" class="btn btn-danger">Eliminar</button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejar env칤o de respuestas
    document.addEventListener('submit', function(e) {
        if (e.target.classList.contains('form-responder-mensaje')) {
            e.preventDefault();
            
            const form = e.target;
            const mensajeId = form.dataset.mensajeId;
            const textarea = form.querySelector('[name="respuesta"]');
            const respuesta = textarea.value.trim();
            
            if (!respuesta) {
                alert('Por favor, escribe una respuesta.');
                return;
            }
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';
            
            const formData = new URLSearchParams();
            formData.append('respuesta', respuesta);
            
            console.log('Enviando respuesta para mensaje ID:', mensajeId);
            console.log('Texto de la respuesta:', respuesta);
            
            fetch(`/articulo/mensaje/${mensajeId}/responder`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData.toString()
            })
            .then(response => {
                console.log('Respuesta recibida, status:', response.status);
                if (!response.ok) {
                    return response.json().then(data => {
                        console.error('Error en respuesta:', data);
                        throw new Error(data.error || 'Error en la respuesta del servidor');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Datos recibidos:', data);
                if (data.success) {
                    console.log('Respuesta guardada exitosamente');
                    // Limpiar el formulario
                    textarea.value = '';
                    // Recargar la p치gina para mostrar la nueva respuesta
                    setTimeout(() => {
                        window.location.reload();
                    }, 100);
                } else {
                    console.error('Error en respuesta:', data);
                    alert(data.error || 'Error al enviar la respuesta.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al enviar la respuesta: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        }
    });
});
</script>
{% endblock %}

