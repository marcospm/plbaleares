{% extends 'base.html.twig' %}

{% block title %}Asignar Alumnos - {{ municipio.nombre }}{% endblock %}

{% block body %}
<div class="card">
    <div class="card-header">
        <h1>Asignar Alumnos a: {{ municipio.nombre }}</h1>
    </div>
    <div class="card-body">
        {% if deshabilitado %}
            <div class="alert alert-info" style="margin-bottom: 2rem;">
                <h4 style="margin-top: 0;">ℹ️ Cambio en el Sistema de Asignación</h4>
                <p style="margin-bottom: 0.5rem;">
                    <strong>La asignación directa de alumnos a municipios está deshabilitada.</strong>
                </p>
                <p style="margin-bottom: 0;">
                    Los alumnos ahora se asignan a través de <strong>convocatorias</strong>. Si un alumno está asignado a una convocatoria, automáticamente tiene acceso a todos los municipios de esa convocatoria.
                </p>
            </div>

            <div class="form-group">
                <label class="form-label"><strong>Convocatorias que contienen este municipio:</strong></label>
                {% if convocatorias|length > 0 %}
                    <div style="margin-top: 0.5rem;">
                        <ul style="list-style: none; padding: 0;">
                            {% for convocatoria in convocatorias %}
                                <li style="padding: 0.75rem; margin-bottom: 0.5rem; background-color: #f8f9fa; border-radius: 4px; border-left: 4px solid var(--color-primary);">
                                    <strong>{{ convocatoria.nombre }}</strong>
                                    <div style="margin-top: 0.5rem;">
                                        <a href="{{ path('app_convocatoria_asignar_alumnos', {'id': convocatoria.id}) }}" class="btn btn-sm btn-primary">
                                            Asignar Alumnos a esta Convocatoria
                                        </a>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% else %}
                    <div style="padding: 1rem; background-color: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107; margin-top: 0.5rem;">
                        <p style="margin: 0;">
                            <strong>⚠️ Este municipio no está asignado a ninguna convocatoria activa.</strong>
                        </p>
                        <p style="margin: 0.5rem 0 0 0;">
                            Para que los alumnos tengan acceso a este municipio, primero debes asignarlo a una convocatoria desde la página de edición de la convocatoria.
                        </p>
                    </div>
                {% endif %}
            </div>
        {% else %}
            <form method="post">
                <div class="form-group">
                    <label class="form-label"><strong>Selecciona los alumnos que tendrán acceso a este municipio:</strong></label>
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                        {% for usuario in usuarios %}
                            <div class="form-check" style="padding: 0.5rem;">
                                <input class="form-check-input" type="checkbox" name="usuarios[]" value="{{ usuario.id }}" id="usuario_{{ usuario.id }}"
                                       {% if municipio.usuarios.contains(usuario) %}checked{% endif %}>
                                <label class="form-check-label" for="usuario_{{ usuario.id }}">
                                    {{ usuario.nombreDisplay }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="d-flex gap-2 mt-4">
                    <button type="submit" class="btn btn-primary">Guardar Asignaciones</button>
                    <a href="{{ path('app_municipio_index') }}" class="btn btn-secondary">Cancelar</a>
                </div>
            </form>
        {% endif %}

        <div class="d-flex gap-2 mt-4">
            <a href="{{ path('app_municipio_index') }}" class="btn btn-secondary">Volver</a>
        </div>
    </div>
</div>
{% endblock %}












