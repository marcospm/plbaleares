applications:
  app:
    source:
      root: "/"

    type: "php:8.4"

    web:
      locations:
        "/":
          root: "public"
          passthru: "/index.php"
          scripts: false

        "/build":
          root: "public/build"
          allow: true
          passthru: false
          scripts: false
          expires: 365d

        "/assets":
          root: "public/assets"
          allow: true
          passthru: false
          scripts: false
          expires: 365d

    relationships:
      database: "database:mysql"

    mounts:
      "/var": "shared:files/var"
      "/public/uploads": "shared:files/uploads"

    variables:
      env:
        APP_ENV: "prod"
        APP_DEBUG: "1"
        APP_SECRET: "a4f9fd292b86d214adcd16b1496e853dd56ecc807fae04e316b26a6079690b72"

    hooks:
      build: |
        set -e
        composer install \
          --no-dev \
          --prefer-dist \
          --no-progress \
          --no-interaction \
          --optimize-autoloader \
          --no-scripts

        # Compilar assets (Asset Mapper)
        php bin/console asset-map:compile --env=prod

      deploy: |
        set -e

        # Construir DATABASE_URL desde PLATFORM_RELATIONSHIPS (Upsun)
        export DATABASE_URL="$(php -r '
          $rels = json_decode(base64_decode(getenv("PLATFORM_RELATIONSHIPS")), true);

          if (!isset($rels["database"][0])) {
            fwrite(STDERR, "No relationship named database found.\n");
            exit(1);
          }

          $db = $rels["database"][0];

          $scheme = $db["scheme"] ?? "mysql";
          $user   = rawurlencode($db["username"] ?? "");
          $pass   = rawurlencode($db["password"] ?? "");
          $host   = $db["host"] ?? "";
          $port   = $db["port"] ?? 3306;
          $name   = ltrim(($db["path"] ?? ""), "/");

          $serverVersion = "mariadb-11.4.0";

          echo sprintf(
            "%s://%s:%s@%s:%s/%s?serverVersion=%s",
            $scheme,
            $user,
            $pass,
            $host,
            $port,
            $name,
            $serverVersion
          );
        ')"

        # Cache Symfony
        php bin/console cache:clear --env=prod --no-warmup
        php bin/console cache:warmup --env=prod --no-optional-warmers

        # Migraciones Doctrine
        php bin/console doctrine:migrations:migrate \
          --no-interaction \
          --allow-no-migration
