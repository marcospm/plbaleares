applications:
  app:
    source:
      root: "/"

    type: "php:8.4"

    web:
      locations:
        "/":
          root: "public"
          passthru: "/index.php"
          index:
            - index.php
          scripts: true
          allow: true

        "/build":
          root: "public/build"
          allow: true
          passthru: false
          scripts: false
          expires: 365d

        "/assets":
          root: "public/assets"
          allow: true
          passthru: false
          scripts: false
          expires: 365d

    relationships:
      database: "database:mysql"

    mounts:
      "/var": "shared:files/var"

      # Uploads persistentes (se conservan entre despliegues)
      "/public/uploads": "shared:files/uploads"
      "/public/examenes": "shared:files/examenes"
      "/public/pdf_municipales": "shared:files/pdf_municipales"
      "/public/pdfs": "shared:files/pdfs"
      "/public/recursos_especificos": "shared:files/recursos_especificos"
      "/public/videos": "shared:files/videos"

    variables:
      env:
        APP_ENV: "prod"
        APP_DEBUG: "1"
        APP_SECRET: "a4f9fd292b86d214adcd16b1496e853dd56ecc807fae04e316b26a6079690b72"

    hooks:
      build: |
        set -e

        # Crear directorios (montajes) si no existen
        mkdir -p \
          public/uploads \
          public/examenes \
          public/pdf_municipales \
          public/pdfs \
          public/recursos_especificos \
          public/videos

        composer install \
          --no-dev \
          --prefer-dist \
          --no-progress \
          --no-interaction \
          --optimize-autoloader \
          --no-scripts

        # Compilar assets (Asset Mapper)
        php bin/console asset-map:compile --env=prod

      deploy: |
        set -e

        # Limpiar completamente la caché de Symfony (forzar refresco de HTML)
        echo "Limpiando caché de Symfony..."
        php bin/console cache:clear --env=prod --no-warmup
        
        # Limpiar específicamente la caché de Twig (templates HTML)
        echo "Limpiando caché de Twig..."
        rm -rf var/cache/prod/twig/*
        rm -rf var/cache/prod/twig
        
        # Limpiar también la caché de anotaciones y otros
        rm -rf var/cache/prod/annotations/*
        rm -rf var/cache/prod/doctrine/*
        rm -rf var/cache/prod/pools/*
        
        # Recrear directorio de caché de Twig
        mkdir -p var/cache/prod/twig
        
        # Calentar la caché (esto regenerará todos los templates)
        echo "Recalentando caché..."
        php bin/console cache:warmup --env=prod --no-optional-warmers
        
        # Limpiar opcache de PHP para forzar recarga de clases
        if command -v php >/dev/null 2>&1; then
            echo "Limpiando OPcache..."
            php -r "if (function_exists('opcache_reset')) { opcache_reset(); }"
        fi

        # Migraciones Doctrine
        echo "Ejecutando migraciones..."
        php bin/console doctrine:migrations:migrate \
          --no-interaction \
          --allow-no-migration
        
        echo "Deploy completado - Caché refrescada"